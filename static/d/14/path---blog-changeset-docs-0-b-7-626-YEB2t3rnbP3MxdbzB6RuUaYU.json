{"data":{"site":{"siteMetadata":{"title":"David Bernheisel","author":"David Bernheisel"}},"markdownRemark":{"id":"4ba5273b-5c35-5144-a645-8753a51a0b96","excerpt":"I use Ecto Changesets a lot— a TON! I love them.Specifying the schema in my code reminds me what the database shape looks\nlike. It might…","timeToRead":8,"html":"<p>I use <a href=\"https://hexdocs.pm/ecto/Ecto.Changeset.html\">Ecto Changesets</a> a lot— a TON! I love them.</p>\n<ul>\n<li>Specifying the schema in my code reminds me what the database shape looks\nlike. It might seem tedious at first to write the migration, and then write\nthe schema which is really similar, but it pays off in clarity months and\nyears later.</li>\n<li>It’s easier for me to remember that web forms can represent models that are\nstored across different tables with <code class=\"language-text\">embedded_schema</code>.</li>\n<li>When there are complicated rules for casting values, it’s not difficult to\nwrite my a custom <code class=\"language-text\">Ecto.Type</code> to handle casting the field and value, though\nI try to avoid those situations when I can.</li>\n</ul>\n<p>With several years writing Ecto changesets and schemas, I have some tips.</p>\n<ul>\n<li><a href=\"#extract-boilerplate\">Extract Boilerplate</a></li>\n<li><a href=\"#db-generated-uuids\">DB-generated UUIDs</a></li>\n<li><a href=\"#interpolate-your-docs\">Interpolate Your Docs</a></li>\n<li><a href=\"#compose-changesets\">Compose Changesets</a></li>\n</ul>\n<p><a name=\"extract-boilerplate\"></a></p>\n<h2>Extract Boilerplate</h2>\n<p>I use <a href=\"https://en.wikipedia.org/wiki/Universally_unique_identifier\">UUID</a>s for all my IDs, specifically v4.</p>\n<p>Long ago I managed some legacy codebases that chose (defaulted) integer-based\nIDs, and two times now I’ve had to migrate them to tables with a BigInt as the\nID because we reached our limit of IDs for the table. It’s easy to forget.</p>\n<p>I’d be fine with BigInt, but since I started using Ecto, I found myself using\nUUIDs instead. I’ve been using them out of habit now.</p>\n<p><strong>But what about showing UUIDs in URLs in basic CRUD endpoints?</strong></p>\n<p>Yea, it’s really ugly to show UUIDs in the browser URL bar, especially for\nnested routes. But you know what? You shouldn’t show internal database IDs to\nusers. When using UUIDs, I am constantly reminded to design towards generating\nunique slugs for UX.</p>\n<h3>Let’s default to UUID in Ecto</h3>\n<p>There’s some configuration for Ecto to default to UUIDs.</p>\n<ul>\n<li><a href=\"configure-generators\">Configure Generators</a></li>\n<li><a href=\"configure-migrator\">Configure Migrator</a></li>\n<li><a href=\"configure-schema\">Configure Schema</a></li>\n<li><a href=\"pull-into-macro\">Pull Into Macro</a></li>\n</ul>\n<p><a name=\"configure-generators\"></a></p>\n<h3>Configure Generators</h3>\n<p>If you’re using Phoenix and use its generators, you might care about this\nsection. When you run <code class=\"language-text\">mix phx.gen.schema ARGS</code>, Phoenix and Ecto will throw in\nsome boilerplate into your schemas and migrations. Even if you don’t, it’s\nharmless to put it in just in case things change later, or other developers on\nyour project choose to use the generators.</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\">\n      <pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token comment\">#./config/config.exs</span>\nconfig <span class=\"token atom symbol\">:my_app</span><span class=\"token punctuation\">,</span>\n  <span class=\"token attr-name\">ecto_repos:</span> <span class=\"token punctuation\">[</span>MyApp<span class=\"token punctuation\">.</span>Repo<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token attr-name\">generators:</span> <span class=\"token punctuation\">[</span><span class=\"token attr-name\">binary_id:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># This will tell your Schema that the primary_key is a binary UUID:</span>\n\n<span class=\"token comment\">#./lib/my_app/random_schema.ex</span>\n<span class=\"token attribute variable\">@primary_key</span> <span class=\"token punctuation\">{</span><span class=\"token atom symbol\">:id</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:binary_id</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">autogenerate:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span>\n<span class=\"token attribute variable\">@foreign_key_type</span> <span class=\"token atom symbol\">:binary_id</span>\nschema <span class=\"token string\">\"my_table\"</span> <span class=\"token keyword\">do</span>\n  <span class=\"token comment\"># ...</span>\n<span class=\"token keyword\">end</span></code></pre>\n      </div>\n<p><a name=\"configure-migrator\"></a></p>\n<h3>Configure Migrator</h3>\n<p>When creating tables, you’ll need to specify that it will not generate its own\nIDs (more on this later). Instead, it will use Ecto to generate IDs and your\ndatabase will accept it.</p>\n<p>Since you’re configuring the underlying <code class=\"language-text\">CREATE TABLE</code> SQL to not autogenerate\nIDs, you’ll need to supply primary key column yourself.</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\">\n      <pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token keyword\">defmodule</span> MyApp<span class=\"token punctuation\">.</span>Repo<span class=\"token punctuation\">.</span>Migrations<span class=\"token punctuation\">.</span>CreateUsers <span class=\"token keyword\">do</span>\n  <span class=\"token attribute variable\">@moduledoc</span> <span class=\"token string\">\"Creating Users in the database\"</span>\n  <span class=\"token keyword\">use</span> Ecto<span class=\"token punctuation\">.</span>Migration\n\n  <span class=\"token keyword\">def</span> change <span class=\"token keyword\">do</span>\n    create table<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:users</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">primary_key:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n      add <span class=\"token atom symbol\">:id</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:uuid</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">primary_key:</span> <span class=\"token boolean\">true</span>\n\n      timestamps<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre>\n      </div>\n<p><a name=\"configure-schema\"></a></p>\n<h3>Configure Schema</h3>\n<p>If you’re using the generators above, then they should put these options in for\nyou, but if not, you’ll need to make sure they’re present.</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\">\n      <pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token keyword\">defmodule</span> MyApp<span class=\"token punctuation\">.</span>RandomSchema <span class=\"token keyword\">do</span>\n  <span class=\"token keyword\">use</span> Ecto<span class=\"token punctuation\">.</span>Schema\n  <span class=\"token keyword\">import</span> Ecto<span class=\"token punctuation\">.</span>Changeset\n\n  <span class=\"token attribute variable\">@primary_key</span> <span class=\"token punctuation\">{</span><span class=\"token atom symbol\">:id</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:binary_id</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">autogenerate:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span>\n  <span class=\"token attribute variable\">@foreign_key_type</span> <span class=\"token atom symbol\">:binary_id</span>\n\n  schema <span class=\"token string\">\"users\"</span> <span class=\"token keyword\">do</span>\n    field <span class=\"token atom symbol\">:name</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span>\n\n    timestamps<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre>\n      </div>\n<p>That’s it! It should work.</p>\n<p><a name=\"pull-into-macro\"></a></p>\n<h3>Pull Into Macro</h3>\n<p>But that’s a lot of boilerplate for <em>each schema</em>. Let’s make it easier. Notice\nat the top of the schema definition? And the migration definition?</p>\n<p><code class=\"language-text\">use Ecto.Schema</code> and <code class=\"language-text\">use Ecto.Migration</code>.</p>\n<p>These inject some code into the module. We can do that too!</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\">\n      <pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token keyword\">defmodule</span> MyApp<span class=\"token punctuation\">.</span>Schema <span class=\"token keyword\">do</span>\n  <span class=\"token attribute variable\">@moduledoc</span> <span class=\"token string\">\"Ecto Schema Helpers\"</span>\n\n  defmacro __using__<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n    quote <span class=\"token keyword\">do</span>\n      <span class=\"token keyword\">use</span> Ecto<span class=\"token punctuation\">.</span>Schema\n      <span class=\"token keyword\">import</span> Ecto<span class=\"token punctuation\">.</span>Changeset\n\n      <span class=\"token attribute variable\">@primary_key</span> <span class=\"token punctuation\">{</span><span class=\"token atom symbol\">:id</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:binary_id</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">autogenerate:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span>\n      <span class=\"token attribute variable\">@foreign_key_type</span> <span class=\"token atom symbol\">:binary_id</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre>\n      </div>\n<div class=\"gatsby-highlight\" data-language=\"diff\">\n      <pre class=\"language-diff\"><code class=\"language-diff\">defmodule MyApp.RandomSchema do\n<span class=\"token deleted\">-   use Ecto.Schema</span>\n<span class=\"token deleted\">-   import Ecto.Changeset</span>\n<span class=\"token deleted\">-</span>\n<span class=\"token deleted\">-   @primary_key {:id, :binary_id, autogenerate: true}</span>\n<span class=\"token deleted\">-   @foreign_key_type :binary_id</span>\n<span class=\"token inserted\">+   use MyApp.Schema</span>\n\n  schema \"users\" do\n    field :name, :string\n\n    timestamps()\n  end\nend</code></pre>\n      </div>\n<div class=\"gatsby-highlight\" data-language=\"diff\">\n      <pre class=\"language-diff\"><code class=\"language-diff\"></code></pre>\n      </div>\n<p>Now we don’t have to remember that stuff every time.</p>\n<p><a name=\"db-generated-uuids\"></a></p>\n<h2>DB-Generated UUIDs</h2>\n<p>Maybe you noticed above that we have <code class=\"language-text\">autogenerate: true</code> above. This is telling\n<strong>Ecto</strong> to generate those IDs instead of the database. That bothered me for\nsome reason. I feel like that’s a database responsibility, not an app\nresponsibility.</p>\n<p>Let’s move that into the database. I’m using PostgreSQL, but I’m sure there are\nsimilar tools for other databases.</p>\n<ul>\n<li><a href=\"#enable-pgcrypto\">Enable pgcrypto</a></li>\n<li><a href=\"#use-pgcrypto\">Update our Boilerplate</a></li>\n</ul>\n<p><a name=\"enable-pgcrypto\"></a></p>\n<h3>Enable pgcrypto</h3>\n<p>Postgres unfortunately cannot generate UUIDs simply out of the box. But\n<code class=\"language-text\">postgresql-contrib</code> does ship with functions that you have to enable.</p>\n<p>One of those extensions is <a href=\"https://www.postgresql.org/docs/current/pgcrypto.html\">pgcrypto</a> which supplies <code class=\"language-text\">gen_random_uuid()</code>.</p>\n<p>Let’s create a migration to have Postgres enable the extension.</p>\n<div class=\"gatsby-highlight\" data-language=\"console\">\n      <pre class=\"language-console\"><code class=\"language-console\">$ mix ecto.gen.migration enable_pgcrypto</code></pre>\n      </div>\n<div class=\"gatsby-highlight\" data-language=\"elixir\">\n      <pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token keyword\">defmodule</span> MyApp<span class=\"token punctuation\">.</span>Repo<span class=\"token punctuation\">.</span>Migrations<span class=\"token punctuation\">.</span>AddPgcrypto <span class=\"token keyword\">do</span>\n  <span class=\"token attribute variable\">@moduledoc</span> <span class=\"token string\">\"Add PgCrypto so we can have Postgres generate it's own IDs\"</span>\n  <span class=\"token keyword\">use</span> YouMeet<span class=\"token punctuation\">.</span>Migration\n\n  <span class=\"token keyword\">def</span> change <span class=\"token keyword\">do</span>\n    execute<span class=\"token punctuation\">(</span>\n      <span class=\"token string\">\"CREATE EXTENSION IF NOT EXISTS \\\"pgcrypto\\\"\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"DROP EXTENSION IF EXISTS \\\"pgcrypto\\\"\"</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre>\n      </div>\n<p>This sometimes requires special permissions on the database user. If this\ndoesn’t work for you, then you might need an outside process to enable the\nextension for you. However, this should work for your local database for\ndevelopment.</p>\n<p><a name=\"use-pgcrypto\"></a></p>\n<h3>Use pgcrypto</h3>\n<p>Now that the database can generate it’s own IDs, let’s use it!</p>\n<p>First we’ll tell ID column to default its value. Looking at our earlier\nmigration, let’s modify it.</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\">\n      <pre class=\"language-diff\"><code class=\"language-diff\">defmodule MyApp.Repo.Migrations.CreateUsers do\n  @moduledoc \"Creating Users in the database\"\n  use Ecto.Migration\n\n  def change do\n    create table(:users, primary_key: false) do\n<span class=\"token deleted\">-      add :id, :uuid, primary_key: true</span>\n<span class=\"token inserted\">+      add :id, :uuid, primary_key: true, default: fragment(\"gen_random_uuid()\")</span>\n\n      timestamps()\n    end\n  end\nend</code></pre>\n      </div>\n<p>Now it’ll generate it’s own ID, but <strong>if you stopped here, you’ll notice that\nwhen you insert records with Ecto, none of your returned structs will have an\nID!</strong> What happened?!</p>\n<p>We need to tell Ecto to <a href=\"https://hexdocs.pm/ecto/Ecto.Schema.html#field/3-options\">read the ID back into the struct after\nwriting</a>.\nThankfully, that’s easy. Earlier we pulled some boilerplate into a\n<code class=\"language-text\">MyApp.Schema</code>; let’s modify it:</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\">\n      <pre class=\"language-diff\"><code class=\"language-diff\">defmodule MyApp.Schema do\n  @moduledoc \"Ecto Schema Helpers\"\n\n  defmacro __using__(_) do\n    quote do\n      use Ecto.Schema\n      import Ecto.Changeset\n\n<span class=\"token deleted\">-      @primary_key {:id, :binary_id, autogenerate: true}</span>\n<span class=\"token inserted\">+      @primary_key {:id, :binary_id, read_after_writes: true}</span>\n      @foreign_key_type :binary_id\n    end\n  end\nend</code></pre>\n      </div>\n<p>Now Ecto will pull the database-generated UUID back. Yes!</p>\n<p><a name=\"interpolate-your-docs\"></a></p>\n<h2>Have Elixir Write Docs For You</h2>\n<p>One tedious task I find myself doing is trying to remember what fields I need,\ndon’t need, and which ones have a default value if not supplied when interacting\nwith a changeset function. I’ll constantly flip back and forth between my forms,\ncontexts, and schemas.</p>\n<p>In VIM, I’m using <a href=\"https://github.com/neoclide/coc.nvim\">coc.nvim</a> to enable Language Server integration. You can do\nthis easily in <a href=\"https://marketplace.visualstudio.com/items?itemName=elixir-lsp.elixir-ls\">VSCode</a> as well. One of the great features of this is\nthat you can lookup the documentation on a function with a keypress or hover.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/14bd4015fe1e3172648a2db2fae78c41/1b24b/documentation-hover.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 42.65183124710246%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAB1klEQVQozy2O7WvaUBTG862NrvSDbY0vUZObXG8STTS2RQYza2HM4rCzHd3YuDc3uZoYNS86xgbbH7+7dvDj4TnP4TkcAY6kriMPRleWYzuua7rXwBpAd6y7r3V7BCC0bAeoQNGgYlgdo9eGCGhasynXGw1BR/B6bAwvgWG1hgPT7jlI1ezhVbc/QI6LzL7Zs01N6yPURWZH0TqyrPKqJLUkSZBtx7hbgNkjuLsHswWYztH0w/jp8+XDJ3s2h+/ey2882XsrTzzVu1W8m9bEa3u3be+mOZkIRpyfJXElosc+E/1Q9Bk3R354RF8MO6ZLkTIxYKVwJQarUrB8hieh0P32tZlSKcKNNa7FuB5jiRORWvyfakTOl7jCSIXhM4bLhJQJLmFusKA/TNEPZuyJsffNA4VFgIpASX01JWqKucICwxx3dhweMiWNQLYGWaIXiSDP76XdrhqtLqJIitftXVqL16dBWCb+P/XpK5+eBsEJpSLGIiEipmXCE3ZCQ8H68mT//qNlOTp8V7JcSTOQF7A4qFmu5QUPnZ+/9GLf3R8ayaaZbFvb3fkqEjG/QgTl46KZ5RerqLZOXqgnCX+Bmwpb8oK82fKxGsX1ZPO83TQ2W/4UL/8FT3uKYcgV3WEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Documentation Hover\"\n        title=\"\"\n        src=\"/static/14bd4015fe1e3172648a2db2fae78c41/b9e4f/documentation-hover.png\"\n        srcset=\"/static/14bd4015fe1e3172648a2db2fae78c41/cf440/documentation-hover.png 148w,\n/static/14bd4015fe1e3172648a2db2fae78c41/d2d38/documentation-hover.png 295w,\n/static/14bd4015fe1e3172648a2db2fae78c41/b9e4f/documentation-hover.png 590w,\n/static/14bd4015fe1e3172648a2db2fae78c41/f9b6a/documentation-hover.png 885w,\n/static/14bd4015fe1e3172648a2db2fae78c41/2d849/documentation-hover.png 1180w,\n/static/14bd4015fe1e3172648a2db2fae78c41/1b24b/documentation-hover.png 2157w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>See the screenshot and how it’s listing out the required, optional, and default\nfields? Let’s make that happen.</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\">\n      <pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token keyword\">defmodule</span> MyApp<span class=\"token punctuation\">.</span>RandomSchema <span class=\"token keyword\">do</span>\n  <span class=\"token attribute variable\">@moduledoc</span> <span class=\"token string\">\"The Random Schema.\"</span>\n  <span class=\"token keyword\">use</span> MyApp<span class=\"token punctuation\">.</span>Schema\n\n  <span class=\"token attribute variable\">@defaults</span> <span class=\"token punctuation\">%</span><span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">type:</span> <span class=\"token string\">\"topical\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token attr-name\">is_invite_only:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token attr-name\">is_screening:</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n\n  schema <span class=\"token string\">\"organizations\"</span> <span class=\"token keyword\">do</span>\n    field <span class=\"token atom symbol\">:name</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span>\n    field <span class=\"token atom symbol\">:type</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">default:</span> <span class=\"token attribute variable\">@defaults</span><span class=\"token punctuation\">[</span><span class=\"token atom symbol\">:type</span><span class=\"token punctuation\">]</span>\n\n    field <span class=\"token atom symbol\">:audience_description</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span>\n    field <span class=\"token atom symbol\">:is_invite_only</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:boolean</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">default:</span> <span class=\"token attribute variable\">@defaults</span><span class=\"token punctuation\">[</span><span class=\"token atom symbol\">:is_invite_only</span><span class=\"token punctuation\">]</span>\n    field <span class=\"token atom symbol\">:is_screening</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:boolean</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">default:</span> <span class=\"token attribute variable\">@defaults</span><span class=\"token punctuation\">[</span><span class=\"token atom symbol\">:is_screening</span><span class=\"token punctuation\">]</span>\n\n    timestamps<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token attribute variable\">@optional_fields</span> <span class=\"token string\">~w[is_invite_only is_screening screen_questions]a</span>\n  <span class=\"token attribute variable\">@required_fields</span> <span class=\"token string\">~w[name type audience_description]a</span>\n\n  <span class=\"token attribute variable\">@doc</span> <span class=\"token string\">\"\"\"\n  Required fields: <span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span>inspect <span class=\"token attribute variable\">@required_fields</span><span class=\"token delimiter punctuation\">}</span></span>\n  Optional fields: <span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span>inspect <span class=\"token attribute variable\">@optional_fields</span><span class=\"token delimiter punctuation\">}</span></span>\n  Defaults: <span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span>inspect <span class=\"token attribute variable\">@defaults</span><span class=\"token delimiter punctuation\">}</span></span>\n  \"\"\"</span>\n  <span class=\"token attribute variable\">@spec</span> changeset<span class=\"token punctuation\">(</span><span class=\"token punctuation\">%</span>__MODULE__<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">|</span> Ecto<span class=\"token punctuation\">.</span>Changeset<span class=\"token punctuation\">.</span>t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> map<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span>\n    Ecto<span class=\"token punctuation\">.</span>Changeset<span class=\"token punctuation\">.</span>t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">def</span> changeset<span class=\"token punctuation\">(</span>struct <span class=\"token operator\">\\\\</span> <span class=\"token punctuation\">%</span>__MODULE__<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> attrs<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n    struct\n    <span class=\"token operator\">|></span> cast<span class=\"token punctuation\">(</span>attrs<span class=\"token punctuation\">,</span> <span class=\"token attribute variable\">@optional_fields</span> <span class=\"token operator\">++</span> <span class=\"token attribute variable\">@required_fields</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">|></span> validate_required<span class=\"token punctuation\">(</span><span class=\"token attribute variable\">@required_fields</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre>\n      </div>\n<p>It’s not hard at all! It’s a feature I often forget exists with ExDocs and\nElixir: you can interpolate compiled values into documentation. In this case,\nI’m defining my <code class=\"language-text\">@optional_fields</code>, <code class=\"language-text\">@required_fields</code>, and <code class=\"language-text\">@defaults</code>, and\nthen interpolating them into the changeset docs.</p>\n<p>Easy peasey!</p>\n<p><a name=\"compose-changesets\"></a></p>\n<h2>Compose Changesets</h2>\n<p>Did you know that changesets chain together? Here’s how that can be help.</p>\n<p>For example:</p>\n<p>Let’s say you have a “main” changeset that performs the basic validations. These\nvalidations should occur <em>every single time</em> an insert or update occurs for this\nschema. This happens for both admins and users.</p>\n<p>Let’s also say that you have another changeset that runs additional validations\nif the User is updating the record versus the Admin updating the same record.\nYou don’t have to duplicate that code!</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\">\n      <pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token comment\"># In MySchema</span>\n<span class=\"token attribute variable\">@spec</span> changeset<span class=\"token punctuation\">(</span><span class=\"token punctuation\">%</span>__MODULE__<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">|</span> Ecto<span class=\"token punctuation\">.</span>Changeset<span class=\"token punctuation\">.</span>t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> map<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span>\n  Ecto<span class=\"token punctuation\">.</span>Changeset<span class=\"token punctuation\">.</span>t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> changeset<span class=\"token punctuation\">(</span>struct_or_changeset <span class=\"token operator\">\\\\</span> <span class=\"token punctuation\">%</span>__MODULE__<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> attrs<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n  struct_or_changeset\n  <span class=\"token operator\">|></span> cast<span class=\"token punctuation\">(</span>attrs<span class=\"token punctuation\">,</span> <span class=\"token attribute variable\">@optional_fields</span> <span class=\"token operator\">++</span> <span class=\"token attribute variable\">@required_fields</span><span class=\"token punctuation\">)</span>\n  <span class=\"token operator\">|></span> validate_required<span class=\"token punctuation\">(</span><span class=\"token attribute variable\">@required_fields</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token attribute variable\">@spec</span> additional_restrictions_changeset<span class=\"token punctuation\">(</span><span class=\"token punctuation\">%</span>__MODULE__<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">|</span> Ecto<span class=\"token punctuation\">.</span>Changeset<span class=\"token punctuation\">.</span>t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> map<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span>\n  Ecto<span class=\"token punctuation\">.</span>Changeset<span class=\"token punctuation\">.</span>t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> additional_restrictions_changeset<span class=\"token punctuation\">(</span>struct_or_changeset <span class=\"token operator\">\\\\</span> <span class=\"token punctuation\">%</span>__MODULE__<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> attrs<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n  struct_or_changeset\n  <span class=\"token operator\">|></span> changeset<span class=\"token punctuation\">(</span>attrs<span class=\"token punctuation\">)</span>\n  <span class=\"token operator\">|></span> more_validations<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token comment\">## ... In some other app code</span>\n\n<span class=\"token keyword\">def</span> restricted_create<span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n  MySchema<span class=\"token punctuation\">.</span>additional_restrictions_changeset<span class=\"token punctuation\">(</span><span class=\"token punctuation\">%</span>MySchema<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span></code></pre>\n      </div>\n<p>This way, you can use <code class=\"language-text\">additional_restrictions_changeset/2</code> by itself and get\nall the same logic within <code class=\"language-text\">changeset/2</code>.</p>","frontmatter":{"title":"Ecto Changeset Docs for Yourself","date":"January 19, 2020","tags":["elixir","ecto"],"originalUrl":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/blog/changeset_docs/","previous":{"fields":{"slug":"/blog/date-time-parser-podcast/"},"frontmatter":{"title":"DateTimeParser on Elixir Mix podcast","tags":["elixir"],"originalUrl":null,"excerpt":"I was invited to talk on the Elixir Mix podcast. We talked about the Elixir\ncommunity, how to contribute, and the DateTimeParser library I released.\n"}},"next":null}}