{"data":{"site":{"siteMetadata":{"title":"David Bernheisel","author":"David Bernheisel"}},"markdownRemark":{"id":"d03620f8-f995-5fff-b3f0-b6bc5f287064","excerpt":"\nStructs and maps are easy to work with in Elixir, but if they are stored\nin the database as JSON and accessed via an Ecto Schema, it's not as\nclear how to query them. We're going to explore how to do that, and make\nit clear and easy.\n\n","html":"<p>Structs and maps are easy to work with in Elixir, but if they are stored\nin the database as JSON and accessed via an Ecto Schema, it’s not as\nclear how to query them. We’re going to explore how to do that, and make\nit clear and easy.</p>\n<!-- excerpt -->\n<p>PostgreSQL has <a href=\"https://www.postgresql.org/docs/current/static/functions-json.html\">great support for objects stored as JSON</a>.\nThis is useful for those moments when you need to store data that could\nbe variably structured, such as responses from other services’ APIs, or\ndata that frequently travels together within your relational tables.</p>\n<p>A common trade-off for mixing scalar column data types (like <code class=\"language-text\">varchar</code>\nor <code class=\"language-text\">integer</code>) with column data types that handle more-complicated\nobjects (like <abbr title=\"JavaScript Object Notation\">JSON</abbr>) is\nthat <abbr title=\"Object-relational Mapping\">ORMs</abbr> or data mappers\nsometimes can’t introspect on them for you, which means it becomes much\nharder to query that data.</p>\n<p>Using Ecto’s <code class=\"language-text\">embedded_schema</code> helps introspect on those known values,\nbut it doesn’t really assist you with querying those fields in SQL. This\nis where I became extremely greatful for <a href=\"https://hexdocs.pm/ecto/Ecto.Query.html#module-fragments\">Ecto’s escape\nhatch</a>: <code class=\"language-text\">fragment()</code>.</p>\n<h1>Define the Struct or Map in Ecto</h1>\n<p>Let’s dive into some code as an example:</p>\n<p>I have a <code class=\"language-text\">Vehicle.Photo</code> schema that has several versions of the photo:</p>\n<ul>\n<li>craigslist_ad</li>\n<li>facebook_ad</li>\n<li>facebook_carousel_ad</li>\n<li>extra_large</li>\n<li>extra_small</li>\n<li>large</li>\n<li>medium</li>\n<li>original</li>\n<li>small</li>\n</ul>\n<p>We decided to store the versions’ <abbr title=\"Uniform Resource\nLocators\">URLs</abbr> inside a map in the database,\nbecause we’re going to use a set of the URLs at the same time inside of\nan HTML <code class=\"language-text\">&lt;img srcset /&gt;</code>. <a href=\"https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images\">You can read more about srcset from\nMDN and how it helps with responsive images</a>.</p>\n<p>The Ecto migration looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\"><pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token keyword\">def</span> up <span class=\"token keyword\">do</span>\n  alter table<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:vehicle_photos</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n    add <span class=\"token atom symbol\">:standard_urls</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:map</span>\n    add <span class=\"token atom symbol\">:facebook_urls</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:map</span>\n    add <span class=\"token atom symbol\">:craigslist_urls</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:map</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>The Ecto schema looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\"><pre class=\"language-elixir\"><code class=\"language-elixir\">schema <span class=\"token string\">\"vehicle_photos\"</span> <span class=\"token keyword\">do</span>\n  field<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:file</span><span class=\"token punctuation\">,</span> PhotoUploader<span class=\"token punctuation\">.</span>Type<span class=\"token punctuation\">)</span>\n\n  embeds_one <span class=\"token atom symbol\">:standard_urls</span><span class=\"token punctuation\">,</span> StandardUrls<span class=\"token punctuation\">,</span> <span class=\"token attr-name\">on_replace:</span> <span class=\"token atom symbol\">:update</span> <span class=\"token keyword\">do</span>\n    field<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:extra_large</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span><span class=\"token punctuation\">)</span>\n    field<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:extra_small</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span><span class=\"token punctuation\">)</span>\n    field<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:large</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span><span class=\"token punctuation\">)</span>\n    field<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:medium</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span><span class=\"token punctuation\">)</span>\n    field<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:original</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span><span class=\"token punctuation\">)</span>\n    field<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:small</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n\n  embeds_one <span class=\"token atom symbol\">:facebook_urls</span><span class=\"token punctuation\">,</span> FacebookUrls<span class=\"token punctuation\">,</span> <span class=\"token attr-name\">on_replace:</span> <span class=\"token atom symbol\">:update</span> <span class=\"token keyword\">do</span>\n    field<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:hero_ad</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span><span class=\"token punctuation\">)</span>\n    field<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:carousel_ad</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n\n  embeds_one <span class=\"token atom symbol\">:craigslist_urls</span><span class=\"token punctuation\">,</span> CraigslistUrls<span class=\"token punctuation\">,</span> <span class=\"token attr-name\">on_replace:</span> <span class=\"token atom symbol\">:update</span> <span class=\"token keyword\">do</span>\n    field<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:ad</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:string</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Since this is a known structure, Ecto can introspect on the JSON values and\ncast and dump them to the appropriate Elixir data types, which is immensely\nhelpful. Here I am achieving that by using <code class=\"language-text\">embeds_one</code> and specifying the\nstruct. Once pulled from the database, Ecto will decode them.</p>\n<p>Other times, you may not be able to do this ahead of time, so the schema\nmight look like this (the <code class=\"language-text\">api_response</code> field):</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\"><pre class=\"language-elixir\"><code class=\"language-elixir\">schema <span class=\"token string\">\"vehicle_photos\"</span> <span class=\"token keyword\">do</span>\n  field<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:file</span><span class=\"token punctuation\">,</span> PhotoUploader<span class=\"token punctuation\">.</span>Type<span class=\"token punctuation\">)</span>\n  field<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:api_response</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:map</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<h1>Query the JSON</h1>\n<p>Continuing with the struct example schema, we found out that some of our\nURLs weren’t being populated like we expected, so I had to find those\nphotos and fix them. How do I query for them since they’re stored in\nPostgreSQL as JSON? We need to drop down into raw SQL:</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\"><pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token keyword\">def</span> where_photo_urls_have_a_null<span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n  query\n  <span class=\"token operator\">|></span> where<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>_q<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> fragment<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"\"\"\n    (facebook_urls IS NULL) OR\n    (facebook_urls->>'ad_version' IS NULL) OR\n    (facebook_urls->>'hero_version' IS NULL) OR\n    (craigslist_urls->>'ad' IS NULL)\n    \"\"\"</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>The SQL operator <code class=\"language-text\">-&gt;&gt;</code> will leverage <a href=\"https://www.postgresql.org/docs/current/static/functions-json.html\">PostgreSQL’s JSON\nfunctions</a> to retrieve the text or integers that are stored\nin the JSON. You can access them using this syntax: <code class=\"language-text\">column-&gt;&gt;key</code>. In\nmy case, I needed to find if the column was null, or it wasn’t null,\nthen to ask if the JSON object has any keys that are null.  This will\nwork regardless of whether you use an embedded struct or a map, because\nPostgreSQL sees it as the same thing: JSON.</p>\n<p>Here’s an example that checks for substrings:</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\"><pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token keyword\">def</span> where_photo_url_wrong<span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n  query\n  <span class=\"token operator\">|></span> where<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>_q<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> fragment<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"\"\"\n    (facebook_urls->>'hero_ad' NOT ILIKE ?) OR\n    (facebook_urls->>'carousel_ad' NOT ILIKE ?) OR\n    (craigslist_urls->>'ad' NOT ILIKE ?)\n    \"\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"%facebook_hero_ad%\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"%facebook_carousel_ad%\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"%craigslist_ad%\"</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<h1>Make the Query Composable</h1>\n<p>Above is all I needed for my use case, but I wondered how I could continue\nquerying those fields in a reusable way. For example, how do I chain these\ntogether in an <code class=\"language-text\">OR</code> statement that uses both of these fragments?</p>\n<p>To do that, I’ll need to extract the <code class=\"language-text\">fragment</code> expressions and put them\ninto a macro so they can be used within Ecto’s functions.</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\"><pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token keyword\">defmodule</span> MyProject<span class=\"token punctuation\">.</span>SampleQuery<span class=\"token punctuation\">.</span>Fragments <span class=\"token keyword\">do</span>\n  <span class=\"token keyword\">import</span> Ecto<span class=\"token punctuation\">.</span>Query<span class=\"token punctuation\">.</span>API<span class=\"token punctuation\">,</span> <span class=\"token attr-name\">only:</span> <span class=\"token punctuation\">[</span><span class=\"token attr-name\">fragment:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n\n  defmacro photo_urls_have_a_null <span class=\"token keyword\">do</span>\n    quote <span class=\"token keyword\">do</span>\n      fragment<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"\"\"\n        (facebook_urls IS NULL) OR\n        (facebook_urls->>'ad_version' IS NULL) OR\n        (facebook_urls->>'hero_version' IS NULL) OR\n        (craigslist_urls->>'ad' IS NULL)\n        \"\"\"</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n\n  defmacro photo_urls_not_contain<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>hero_ad_value<span class=\"token punctuation\">,</span> carousel_ad_value<span class=\"token punctuation\">,</span> ad_value<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n    quote <span class=\"token keyword\">do</span>\n      fragment<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"\"\"\n        (facebook_urls->>'hero_ad' NOT ILIKE ?) OR\n        (facebook_urls->>'carousel_ad' NOT ILIKE ?) OR\n        (craigslist_urls->>'ad' NOT ILIKE ?)\n        \"\"\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">^</span><span class=\"token string\">\"%<span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span>unquote<span class=\"token punctuation\">(</span>hero_ad_value<span class=\"token punctuation\">)</span><span class=\"token delimiter punctuation\">}</span></span>%\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">^</span><span class=\"token string\">\"%<span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span>unquote<span class=\"token punctuation\">(</span>carousel_ad_value<span class=\"token punctuation\">)</span><span class=\"token delimiter punctuation\">}</span></span>%\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">^</span><span class=\"token string\">\"%<span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span>unquote<span class=\"token punctuation\">(</span>ad_value<span class=\"token punctuation\">)</span><span class=\"token delimiter punctuation\">}</span></span>%\"</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Now that those fragments are extracted, let’s use them:</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\"><pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token keyword\">import</span> MyProject<span class=\"token punctuation\">.</span>SampleQuery<span class=\"token punctuation\">.</span>Fragments\n<span class=\"token keyword\">alias</span> MyProject<span class=\"token punctuation\">.</span>Photo\n\n<span class=\"token keyword\">defmodule</span> MyProject<span class=\"token punctuation\">.</span>SampleQuery <span class=\"token keyword\">do</span>\n  <span class=\"token keyword\">def</span> find_bad_photos<span class=\"token punctuation\">(</span>query <span class=\"token operator\">\\\\</span> Photo<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n    query\n    <span class=\"token operator\">|></span> where<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>_p<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> photo_urls_have_a_null<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">|></span> or_where<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>_p<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> photo_urls_not_contain<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"facebook_hero_ad\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"facebook_carousel_ad\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"craigslist_ad\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">|></span> Repo<span class=\"token punctuation\">.</span>all\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p><strong>Beautiful.</strong></p>\n<p>If you’d like to check out the code a little more, you can see this\n<a href=\"https://github.com/dbernheisel/sample_json_ecto_queries\">sample Ecto and Phoenix repo with tests</a>.</p>\n<p>This article only explains how to query a JSON object in the database\nand how it works with Ecto querying. If you’re needing to store an array\nof maps or structs, then check out Jon’s post <a href=\"https://robots.thoughtbot.com/why-ecto-s-way-of-storing-embedded-lists-of-maps-makes-querying-hard\">Why Ecto’s Way of\nStoring Embedded Lists of Maps Makes Querying Hard</a>.</p>","frontmatter":{"title":"Querying an Embedded Map in PostgreSQL with Ecto","date":"March 09, 2018","tags":["elixir"],"originalUrl":null}}},"pageContext":{"slug":"/blog/querying-embedded-maps-in-postgresql-with-ecto/","previous":{"fields":{"slug":"/blog/testing-emails-with-bamboo/"},"frontmatter":{"title":"Testing Random Data in Emails with Bamboo","tags":["elixir"],"originalUrl":null}},"next":{"fields":{"slug":"/blog/ruby-rails-and-circle-ci-workflows/"},"frontmatter":{"title":"Ruby, Rails, and CircleCI 2.0 Workflows","tags":["ruby"],"originalUrl":null}}}}