{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/httpoison-decompression/","result":{"data":{"site":{"siteMetadata":{"title":"David Bernheisel","author":"David Bernheisel"}},"markdownRemark":{"id":"c36c46fe-2df1-5ff8-b4eb-bbf80acc7476","excerpt":"Did you know that Ruby’s\nNet::HTTP\nclass automatically decompresses responses? It handles a lot of use cases that\nwe don’t have to remember…","timeToRead":11,"html":"<p>Did you know that Ruby’s\n<a href=\"https://ruby-doc.org/stdlib-2.6.3/libdoc/net/http/rdoc/Net/HTTP.html#class-Net::HTTP-label-Compression\">Net::HTTP</a>\nclass automatically decompresses responses? It handles a lot of use cases that\nwe don’t have to remember ourselves. It’s built into Ruby!</p>\n<p>When I came across a JSON API service that was returning binary, I was a bit\npuzzled; “what is this binary? I’m supposed to be getting text back…” and,\nit’s not consistent either: sometimes I get text <em>on the same exact request</em> a\nminute later. Baffling.</p>\n<p>On top of that, I was using <a href=\"https://github.com/parroty/exvcr\">ExVCR</a> in some tests which serializes the\nrequest/response chain into JSON. ExVCR takes binary responses, encodes it into\nErlang Term format, then Base64 encodes that, and then puts <em>that</em> in the JSON\nfile it writes; and does all that in reverse when it’s replaying the “cassette”\nwhen the tests run.</p>\n<p>I’ve seen text before on this endpoint, and now I’m getting binary\nsometimes; and wait-a-second, don’t HTTP clients decompress responses? I’m\npretty sure I didn’t worry about this with Ruby’s Net::HTTP or HTTParty.</p>\n<p>Turns out, in the Elixir ecosystem, HTTPoison along with other common HTTP\nclients like HTTPotion, the new Mint, Gun, and probably others don’t do this\nautomatically.</p>\n<h2>Let’s back up</h2>\n<p>HTTP requests and responses have some headers that tell the client/server what\nformat of content we’re looking for. The ones we care about here is\n<b><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-Encoding\">Accept-Encoding</a></b> and <b><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Encoding\">Content-Encoding</a></b>. There’s another one\nthat’s related called <b><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type\">Content-Type</a></b>, but that’s not exactly about\ncompression, but we’ll get to this one later.</p>\n<p>Accept-Encoding is what the client will use to say “YO SERVER! I need some of\nthis resource, and I can handle it compressed with <a href=\"https://github.com/google/brotli\">brotli</a>”</p>\n<p>Content-Encoding is what the server will respond with, as in “Oh hay Client!\nNice to see you; here’s your content as requested. I even compressed it in\nbrotli”</p>\n<p>What <em>REALLY</em> happens (in my experience), is that Accept-Encoding is ignored,\nand <strong>the server’s gonna give whatever it wants to you</strong>. To complicate it more,\nthere are layers between the client and server that may compress data and modify\nheaders (or not). So, the server might have sent plaintext and provided a\nContent-Encoding of <code>identity</code> or not a Content-Encoding at all (both of these\nmean there is no compression.), but a load balancer, router, CDN, whatever,\nmight have compressed the body of data on the way back from the server to the\nclient.</p>\n<p>So what’s the client to do? It has to guess. This is probably why some clients\ndon’t automatically decompress data for you.</p>\n<p>Here are some of the options for <code>Content-Encoding</code>:</p>\n<table>\n<thead>\n<tr>\n<th>value</th>\n<th>meaning</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>gzip</code></td>\n<td>Compressed with Lempel-Ziv (LZ77). On desktops, this is a <code>.gz</code> file</td>\n</tr>\n<tr>\n<td><code>x-gzip</code></td>\n<td>Same as above, just an older expression</td>\n</tr>\n<tr>\n<td><code>compress</code></td>\n<td>Compressed with Lempel-Ziv-Welch (LZW)</td>\n</tr>\n<tr>\n<td><code>deflate</code></td>\n<td>Compressed with zlib. On desktops, this is a normal <code>.zip</code> file</td>\n</tr>\n<tr>\n<td><code>br</code></td>\n<td>Compressed with brotli.</td>\n</tr>\n<tr>\n<td><code>identity</code></td>\n<td>No compression</td>\n</tr>\n<tr>\n<td>(missing)</td>\n<td>No compression</td>\n</tr>\n</tbody>\n</table>\n<p>As an interesting sidenote, Phoenix supports compression into Brotli, but\notherwise there’s not yet built-in support for decompressing Brotli in\nErlang/Elixir. There’s also no built-in support for LZW, but that’s ok because\nit’s not as good or popular as the other formats. The only built-ins for Erlang\nand Elixir are <code>gzip</code> and <code>deflate</code> so that’s what I’ll support on this first\niteration.</p>\n<h2>HTTPoison</h2>\n<p>In Elixir, the most popular HTTP client is <a href=\"https://github.com/edgurgel/httpoison\">HTTPoison</a> according to <a href=\"https://hex.pm/packages\">hex.pm</a>.\nActually, let me clarify: HTTPoison itself doesn’t do any HTTP requests itself;\nwhat I mean is it’s a wrapper for the Erlang HTTP client called <a href=\"https://github.com/benoitc/hackney\">hackney</a> which\nactually does the HTTP requests, and HTTPoison wraps around that to make the API\na bit friendlier for Elixir.</p>\n<p>Let me re-word that for my use-case: I’m making a wrapper for a wrapper.</p>\n<p>I’m not the first to notice that it doesn’t decompress responses automatically.\nThere’s been an <a href=\"https://github.com/edgurgel/httpoison/issues/81\">issue</a> open\nsince 2015 for them to auto-decompress, but the author has decided, (me\nparaphrasing), “I’m not going to do it, but hackney is so we’ll get to benefit\nfrom it soon enough!”, and <em>that</em>\n<a href=\"https://github.com/benoitc/hackney/issues/155\">issue</a> has been open for a since\nJan 2015. We’re still waiting. It’s June 2019. 4.5 years.</p>\n<p>Ok, cool, but I need to handle this now, and it doesn’t seem like there’s\nmovement in the popular library of choice.</p>\n<h2>It’s a little unfair</h2>\n<p>It’s unfair for me to suggest these libraries should absolutely support\ndecompression out of the box, because these clients are really powerful. They\nalso support streaming which complicates decompression. But, for simple JSON\nrequest/responses and for most APIs, we’re not streaming.</p>\n<p>Major props for these libraries making my life easier; my issue is that I didn’t\nknow about these concepts before diving in, and through an issue I learned\nabout HTTP decompression.</p>\n<p><img src=\"/3b9749e92576dae35e059a75d733a18d/til.gif\" alt=\"TIL\"></p>\n<h2>One more problem: Character Encoding</h2>\n<p>I am also working with an API service that responds with characters encoded in\nISO-8859-1 sometimes; not in UTF-8. In Elixir, strings are UTF-8 so I need to\nmake sure I can convert those characters to something readable for my logs, and\nultimately the clients. This character encoding is indicated in the HTTP header\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type\">Content-Type</a>, paired with the format of content, like JSON or XML. It’s going\nto look something like <code>text/plain;charset=utf-8</code> or\n<code>application/json;charset=ISO-8859-1</code>.</p>\n<h2>Let’s do it</h2>\n<p>Let’s stick with HTTPoison out of pure laziness. If you’re implementing from\nscratch, I’d recommend you to look at <a href=\"https://github.com/ericmj/mint\">Mint</a> first because it has no\ndependencies and has a better philosophy with OTP, which is a <em>good thing</em>.\n<a href=\"https://github.com/teamon/tesla\">Tesla</a> is also a good HTTP client to consider.</p>\n<p>Let me re-word that again: I’m going to write a wrapper (MyApp.HTTPClient) for a\nwrapper (HTTPoison) of hackney for a wrapper (my layer that covers the 3rd party\nAPI) of a 3rd party service. Exciting.</p>\n<p>Also please know that my project also includes Phoenix and Plug, so you might\nsee some helpers in the tests and implementation. If you’re not using Phoenix or\nPlug, it should be pretty easy to replace these functions with your own.</p>\n<h2>My interface</h2>\n<p>It’s going to be exactly like HTTPoison’s. Creative, I know. But, this way I can\nreplace any usage of <code>HTTPoison.get</code> or <code>HTTPoison.post</code> with my own\n<code>HttpClient.get</code> or <code>HttpClient.post</code>. Easy peasy.</p>\n<p>I’m also going to give room for dependency-injection so I can test this easily.\nAnd, maybe one day I won’t want to use HTTPoison anymore, so this new interface\nmight also help transition my app to another HTTP client without disrupting too\nmuch.</p>\n<p>Let’s write tests first:</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"elixir\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defmodule</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-4 grvsc-t88nfI-1\">MyApp.HttpClientTest</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-7\">use</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">MyApp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">DataCase</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">async:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-7\">import</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">ExUnit</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">CaptureLog</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-7\">alias</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">MyApp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-7\">require</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># I used Erlang&#39;s :zlib.gzip(&quot;Hello&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@gzipped_response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">31</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">139</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">8</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">0</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">0</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">0</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">0</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">0</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">0</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">3</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">243</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">72</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">205</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">201</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">201</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">7</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">0</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">130</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">137</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">209</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">247</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">5</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">0</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">0</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">0</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&gt;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># I used Erlang&#39;s :zlib.zip(&quot;Hello&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@zipped_response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">243</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">72</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">205</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">201</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">201</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">7</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">0</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&gt;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@decoded</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Hello&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  describe </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;get&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    test </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;decompresses a gzipped body&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      requester </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@gzipped_response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Content-Encoding&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;gzip&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      assert {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %{</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@decoded</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPClient</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.get(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, [], </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">requester:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> requester)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    test </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;decompresses a gzipped body with x-gzip header&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      requester </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@gzipped_response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Content-Encoding&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;x-gzip&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      assert {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %{</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@decoded</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPClient</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.get(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, [], </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">requester:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> requester)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    test </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;does not attempt to decompress a plain body with gzip header&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      body </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Hallo&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      requester </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> body,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Content-Encoding&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;gzip&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      assert {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %{</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> ^body}} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPClient</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.get(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, [], </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">requester:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> requester)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    test </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;decompresses a zipped body&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      requester </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@zipped_response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Content-Encoding&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;deflate&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      assert {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %{</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@decoded</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPClient</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.get(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, [], </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">requester:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> requester)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    test </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;emits log when encountering unsupported compression&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      requester </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Hallo&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Content-Encoding&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;br&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      assert capture_log(</span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        assert {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPClient</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.get(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, [], </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">requester:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> requester)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=~</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;No support for decompression of body using &#39;br&#39; algorithm&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    test </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;emits log when failing to decompress&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      requester </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">1</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">2</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">3</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&gt;&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Content-Encoding&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;deflate&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      assert capture_log(</span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        assert {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPClient</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.get(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, [], </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">requester:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> requester)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=~</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Failed to decompress response&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    test </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;re-encodes a latin1 body to UTF-8&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      latin1 </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">163</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">233</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">100</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">117</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">102</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">102</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&gt;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      utf8 </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;£éduff&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      requester </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> latin1,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Content-Type&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;text/plain;charset=ISO-8859-1&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      assert {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %{</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> ^utf8}} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPClient</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.get(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, [], </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">requester:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> requester)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    test </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;does not re-encode utf8 bodies&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      utf8 </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;£éduff&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      requester </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> utf8,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Content-Type&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;text/plain;charset=utf-8&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      assert {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %{</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> ^utf8}} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPClient</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.get(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, [], </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">requester:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> requester)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    test </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;emits log when encountering unknown encoding&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      requester </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Hallo&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Content-Type&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;text/plain;charset=duurf&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      assert capture_log(</span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        assert {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPClient</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.get(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, [], </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">requester:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> requester)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=~</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Need to implement re-encoding support for: duurf&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    test </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;emits log when failing to reencode&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      body </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">163</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">233</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">100</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">117</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">102</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">102</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">833</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">::</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">3</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&gt;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      requester </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> body,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Content-Type&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;text/plain;charset=ISO-8859-1&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      assert capture_log(</span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        assert {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPClient</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.get(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, [], </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">requester:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> requester)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=~</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Failed to re-encode response&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    test </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;does not re-encode un-specified bodies&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      body </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;£éduff&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&lt;&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">163</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">233</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">100</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">117</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">102</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">102</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&gt;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      requester </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> body,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      assert {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %{</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> ^body}} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPClient</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.get(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, [], </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">requester:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> requester)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># copy/paste above, but adjust it for the post/4 function. Or, if you</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># want to be creative, make a macro to generate these tests for you.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span></code></pre>\n<p>Cool. That’s a lot of tests.</p>\n<p>Let’s make those tests pass:</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"elixir\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defmodule</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-4 grvsc-t88nfI-1\">MyApp.HTTPClient</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">@moduledoc &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">  A wrapper around HTTPoison that takes care of post-processing depending on the response, namely:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">    1) decompress the response if gzipped</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">    2) re-encode the body into UTF-8 if ISO-8859-1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">  &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@default_getter</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">&amp;HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.get</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">/</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@default_poster</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">&amp;HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.post</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">/</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@default_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">timeout:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">300_000</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">recv_timeout:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">60_000</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-7\">require</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Logger</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">@doc &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">  GET a URL with headers. Supported options:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">    requester: fn(url, headers, request_options)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">  &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@spec</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> get(</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">String</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t(), </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.headers(), list()) </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">::</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t()} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:error</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Error</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t()}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">def</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">get</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">request_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">\\\\</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> []) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    opts </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> request_options </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">++</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@default_options</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    {get, opts} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Keyword</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.pop(opts, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:requester</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@default_getter</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    url</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> get.(headers, opts)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> process_response</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">@doc &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">  POST a URL with a body, headers. Supported options:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">    requester: fn(url, body, headers, request_options)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">  &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@spec</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> post(</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">String</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t(), </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.body(), </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.headers(), list()) </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">::</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t()} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:error</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">HTTPoison</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Error</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t()}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">def</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">post</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">url</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">request_options</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">\\\\</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> []) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    opts </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> request_options </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">++</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@default_options</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    {post, opts} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Keyword</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.pop(opts, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:requester</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@default_poster</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    url</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> post.(body, headers, opts)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> process_response</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">process_response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    response</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> decompress_response</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> reencode_response_to_utf8</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">decompress_response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">({</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:error</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}), </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">do:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:error</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, response}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">decompress_response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">({</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">status</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %{</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">try</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      decompressed_body </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        headers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> find_header(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;content-encoding&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> decompress_body(body)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      {status, %{response </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> decompressed_body}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">rescue</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Logger</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.error(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Failed to decompress response: </span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">#{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">inspect response</span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">}</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {status, response}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">reencode_response_to_utf8</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">({</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:error</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}), </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">do:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:error</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, response}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">reencode_response_to_utf8</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">({</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">status</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %{</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">headers:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">response</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">try</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      reencoded_body </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        headers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> find_header(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;content-type&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> parse_charset()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> reencode_body(body)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      {status, %{response </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">body:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> reencoded_body}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">rescue</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Logger</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.error(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Failed to re-encode response: </span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">#{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">inspect response</span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">}</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        {status, response}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">find_header</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">headers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">header_name</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Enum</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.find_value(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      headers,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">fn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> {name, value} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        name </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=~</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-6\">~r/</span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">#{</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-6\">header_name</span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">}</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-6\">/i</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&amp;&amp;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">String</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.downcase(value)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># gzip&#39;s magic header is 0x1F 0x8B, with the 3rd byte specifying the compression method, 0x08</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># meaning &quot;deflate&quot;. More info https://en.wikipedia.org/wiki/Gzip</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">decompress_body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">), </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">do:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">decompress_body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;identity&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">), </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">do:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">decompress_body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;gzip&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">31</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">139</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">8</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">::</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">binary</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&gt;&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">), </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">do:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:zlib</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.gunzip(body)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">decompress_body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;gzip&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">), </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">do:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">decompress_body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;x-gzip&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">31</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">139</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">8</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">::</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">binary</span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&gt;&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">), </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">do:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:zlib</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.gunzip(body)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">decompress_body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;x-gzip&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">), </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">do:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">decompress_body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;deflate&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">), </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">do:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:zlib</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.unzip(body)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">decompress_body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">other</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Logger</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.error(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;No support for decompression of body using &#39;</span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">#{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">other</span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">}</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&#39; algorithm.&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">parse_charset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">), </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">do:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">parse_charset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">content_type</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">with</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:ok</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, %{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;charset&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> charset}} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">&lt;-</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Plug</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Conn</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Utils</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.content_type(content_type) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">cond</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        charset </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=~</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-6\">~r/utf-?8/</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:utf8</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        charset </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=~</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-6\">~r/iso-?8859-?1/</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:latin1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">true</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> charset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># When the header isn&#39;t sent, the RFC spec says we should assume ISO-8859-1, but the default is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># actually different per format, eg, XML should be assumed UTF-8. We&#39;re going to not re-encode</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># if it&#39;s not sent and assume UTF-8. This should be safe for most cases.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">reencode_body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">nil</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">), </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">do:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">reencode_body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:utf8</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">), </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">do:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">reencode_body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:latin1</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">case</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:unicode</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.characters_to_binary(body, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:latin1</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:utf8</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:error</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, binary, rest} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Logger</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.error(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Failed to re-encode text. BODY: </span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">#{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">inspect binary</span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">}</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\"> REST: </span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">#{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">inspect rest</span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">}</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:incomplete</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, reencoded_text, rest} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Logger</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.warn(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Failed to re-encode entire text. Dropping characters: </span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">#{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">inspect rest</span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">}</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        reencoded_text</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      reencoded_text </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        reencoded_text</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">reencode_body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">other</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">body</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Logger</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.error(</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;Need to implement re-encoding support for: </span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">#{</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">other</span><span class=\"grvsc-t5WxC3-15 grvsc-t88nfI-6\">}</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span></code></pre>\n<h2>and… Done!</h2>\n<p>Hope this helps. Hit me up at <a href=\"https://twitter.com/bernheisel\">@bernheisel</a> if I\nmissed anything or you have another cool idea.</p>\n<p>I’m not really interested in pulling this into a library, because that’s exactly\nwhat we don’t need: yet another HTTP client. But, if you found yourself needing\nto decompress responses with HTTPoison, then this will be a good start.</p>\n<p>You’ll notice that this doesn’t implement all the calls (we’re missing the ones\nlike <code>delete</code> and <code>head</code>), nor is it the smartest way to solve the problem. I’ll\nleave the gaps to inspire you.</p>\n<h2>Or use <a href=\"https://github.com/teamon/tesla\">Tesla</a></h2>\n<p>Tesla supports decompression out of the box; so if you started on that HTTP\nclient, you probably didn’t have to worry about any of this :)</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .atom-one-light {\n    background-color: #FAFAFA;\n    color: #383A42;\n  }\n  .atom-one-light .grvsc-t5WxC3-i { font-style: italic; }\n  .atom-one-light .grvsc-t5WxC3-14 { color: #A626A4; }\n  .atom-one-light .grvsc-t5WxC3-1 { color: #383A42; }\n  .atom-one-light .grvsc-t5WxC3-4 { color: #C18401; }\n  .atom-one-light .grvsc-t5WxC3-9 { color: #4078F2; }\n  .atom-one-light .grvsc-t5WxC3-5 { color: #E45649; }\n  .atom-one-light .grvsc-t5WxC3-8 { color: #0184BC; }\n  .atom-one-light .grvsc-t5WxC3-7 { color: #A0A1A7; }\n  .atom-one-light .grvsc-t5WxC3-6 { color: #986801; }\n  .atom-one-light .grvsc-t5WxC3-10 { color: #50A14F; }\n  .atom-one-light .grvsc-t5WxC3-15 { color: #CA1243; }\n  .atom-one-light .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(0, 0, 0, 0.05));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(0, 0, 0, 0.2));\n  }\n  \n  /* Monokai Phoenix */\n  @media (prefers-color-scheme: dark) {\n    .grvsc-mm-t88nfI {\n      background-color: #1e1e1e;\n      color: #F8F8F2;\n    }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-7 { color: #F92672; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-1 { color: #F8F8F2; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-4 { color: #AE81FF; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-3 { color: #75715E; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-6 { color: #E6DB74; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-5 { color: #A6E22E; }\n    .grvsc-mm-t88nfI .grvsc-line-highlighted::before {\n      background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n      box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n    }\n  }\n</style>","frontmatter":{"title":"HTTPoison and Decompression","date":"June 01, 2019","tags":["elixir"],"originalUrl":null}}},"pageContext":{"slug":"/blog/httpoison-decompression/","previous":{"fields":{"slug":"/blog/ruby-rails-and-circle-ci-workflows/"},"frontmatter":{"title":"Ruby, Rails, and CircleCI 2.0 Workflows","tags":["ruby"],"originalUrl":"https://www.viget.com/articles/ruby-rails-and-circle-ci-2-0/","excerpt":"Know your tools -- CircleCI 2.0 Workflows\n"}},"next":{"fields":{"slug":"/blog/vim-workflow/"},"frontmatter":{"title":"VIM Testing and Workflow","tags":["elixir","ruby","vim"],"originalUrl":null,"excerpt":null}}}}}