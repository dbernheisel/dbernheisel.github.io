{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/ruby-rails-and-circle-ci-workflows/","result":{"data":{"site":{"siteMetadata":{"title":"David Bernheisel","author":"David Bernheisel"}},"markdownRemark":{"id":"afbd5255-2f32-5cc1-927d-b2468ff8b6b6","excerpt":"There‚Äôs a movement lately in the development world that I‚Äôve really enjoyed: ‚ÄúKnow your tools‚Äù\n‚Äî Tool authors, probably It‚Äôs encouraged me‚Ä¶","timeToRead":14,"html":"<p>There‚Äôs a movement lately in the development world that I‚Äôve really enjoyed:</p>\n<blockquote>\n<p>‚ÄúKnow your tools‚Äù\n‚Äî Tool authors, probably</p>\n</blockquote>\n<p>It‚Äôs encouraged me to dive deeper into the tools that I use every day and\nunderstand more how they work.</p>\n<ul>\n<li>Ruby? I should know how <a href=\"https://medium.com/@farsi_mehdi/openstruct-in-ruby-ab6ba3aff9a4\">OpenStruct works</a>.</li>\n<li>Rails? I should understand the <a href=\"https://www.rubypigeon.com/posts/examining-internals-of-rails-request-response-cycle/\">request cycle</a>.</li>\n<li>SQL? I should understand <a href=\"https://www.postgresql.org/docs/current/static/tutorial-views.html\">database views</a> and <a href=\"https://www.postgresql.org/docs/10/static/sql-createtrigger.html\">triggers</a>.</li>\n<li>Git? I should understand <a href=\"https://git-scm.com/docs/git-rebase\">how to rebase</a>.</li>\n<li>CI? I should understand my <strong>tool of choice</strong>.</li>\n</ul>\n<p>Why? Because it makes me a better developer. I expose myself to new patterns,\nlearn new concepts, and have those solution-patterns in my toolbox for when\nI need to solve problems.</p>\n<p>Today, I want to talk about my tool of choice for Continuous Integration.</p>\n<h2>CircleCI 2.0</h2>\n<p>My tool of choice for Continuous Integration lately is CircleCI 2.0. I‚Äôve\nreally enjoyed it. I don‚Äôt think I went out of my way to pick them, honestly,\nbut a couple of co-workers before me setup projects that I work on with\nCircleCI; I think they made a good choice.</p>\n<p>Depending on how long ago the project was setup for CI, you might be using\nCircleCI 1.0 configurations, which is <a href=\"https://circleci.com/sunset1-0/\">deprecating on EOD August 31,\n2018</a>.</p>\n<p>Enter my problem: I had a project using CircleCI 1.0, so I needed to migrated\nquickly. Our deployment process also happens via CI, so I didn‚Äôt want that to\nstop.</p>\n<p>Time for me to dive into CircleCI.</p>\n<h3>What is CircleCI?</h3>\n<p>I‚Äôll keep it short here, <a href=\"https://circleci.com/product/\">because they do a better job explaining who they\nare</a>. CircleCI is a service that uses containers to build your code,\ntest your code, and deploy your code.</p>\n<p>What are containers? <a href=\"https://www.docker.com/resources/what-container\">They are isolated environments that run\nsoftware.</a> CircleCI 2.0 uses containers to manage your code, and\nextends that container configurability to your projects.</p>\n<h3>How do I configure <em>my</em> container?</h3>\n<p>This is the ‚Äúknow your tools‚Äù part. Thankfully, CircleCI provides a lot of\ngreat <a href=\"https://circleci.com/docs/2.0/\">documentation</a> and <a href=\"https://circleci.com/docs/2.0/tutorials/\">samples</a>. Since this is an article about Ruby and\nRails, using their <a href=\"https://circleci.com/docs/2.0/language-ruby/\">Rails tutorial</a> will be enough to get you going.</p>\n<p>In their <a href=\"https://circleci.com/docs/2.0/language-ruby/\">Rails tutorial</a>, they are using one container to build your project\nand test your code. I could modify it to also deploy my project; it‚Äôs simple to\nadd another step:</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"yaml\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># replace &quot;production&quot; with integration, staging, or whatever else environment</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># you need to deploy.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">- </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">git config --global user.name &quot;CircleCI&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">- </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle exec cap production deploy</span></span></span></code></pre>\n<p>Using Capistrano makes it easy to deploy for most Rails applications. Above\nassumes you‚Äôve configured the CircleCI project to <a href=\"https://circleci.com/docs/2.0/add-ssh-key/\">have the appropriate SSH\nkeys</a>, so it can log into the server and perform the needed steps.</p>\n<p>At this point you you could be done if you‚Äôre in the same boat as me and need\nto move off of CircleCI 1.0 and onto CircleCI 2.0. But, this isn‚Äôt really about\nmigrating from CircleCI 1.0 to CircleCI 2.0; we‚Äôre here to learn!</p>\n<h2>Not everything has to be together</h2>\n<p>I decided to explore a little further and use another CircleCI feature:\n<a href=\"https://circleci.com/docs/2.0/jobs-steps/#section=getting-started\">workflows</a></p>\n<p>In my development environment, everything happens on my machine. I like my\nmachine because it‚Äôs the way I made it. I like using <a href=\"https://brew.sh/\">brew</a> to install\ndependencies, but the CI environment runs Linux, which my production\nenvironment also runs.</p>\n<p>CircleCI leverages containers to help keep ‚Äúsoftware units‚Äù separate and pure.\nThis is smart because I need these environments to be accurately reproducible\nand not fragile to some other dependency being introduced. Have you ever\ninstalled a different version of OpenSSL to ‚Äúfix‚Äù one project, but totally\nborked other projects on your machine? Containers prevent this problem.</p>\n<p>When you think about what your CI process does, there‚Äôs probably a couple of\nlarge tasks happening:</p>\n<ul>\n<li>Install language versions</li>\n<li>Install dependencies outside of your language (like imagemagick)</li>\n<li>Install dependencies in your language (with bundler)</li>\n<li>Install dependencies in your <em>other</em> language (with npm)</li>\n<li>Precompile assets</li>\n<li>Run Ruby tests</li>\n<li>Run JavaScript tests (you wrote those, right?)</li>\n<li>Run linting checks (your team agrees on the same style, right?)</li>\n<li>Deploy the working code</li>\n</ul>\n<p>With containers, we can separate these tasks. This has some benefits because we\ncan run some of these in parallel instead of serially; that might give us\na speed boost; more importantly, it communicates better where the failure is\nhappening, if it happens ü§û</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6d7c1279d405358a7fc1420c1fea0a29/3fe45/circleci2-github.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.72972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA+klEQVQY022R627DIAxG8/6PuB9blybNDTCGJE2A5KtBarRNs3SEQfKxLarR19DqA1Y9hEZoQdMdjgY5a7BusHqDHOd5Fn5GOk6wDzB2x7xGVHqVQj+ADYGMAlsD0gqWDBwTUtyQUvgleYszhxDigShkeXVKQdt0qO8tJk3QxsKyh7UOzi/QxOWupaEhCz8vIkjYQ7yIKYHcVqi28ETdNLh91xhGha4fC/0wgUSaGyhpZMppyttfYYgRmjcYzkKZ8PPrVoS5cFIa46SKyPlZpuKSv+Xz8vxXeE24h00mm/Do+mutLLXsipAsl5xlbRL5todLGC5hko/ZCy8Btc1Bt8rVDQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"GitHub Integration\"\n        title=\"GitHub Integration\"\n        src=\"/static/6d7c1279d405358a7fc1420c1fea0a29/fcda8/circleci2-github.png\"\n        srcset=\"/static/6d7c1279d405358a7fc1420c1fea0a29/12f09/circleci2-github.png 148w,\n/static/6d7c1279d405358a7fc1420c1fea0a29/e4a3f/circleci2-github.png 295w,\n/static/6d7c1279d405358a7fc1420c1fea0a29/fcda8/circleci2-github.png 590w,\n/static/6d7c1279d405358a7fc1420c1fea0a29/3fe45/circleci2-github.png 699w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Also, what if your ruby tests fail‚Äî wouldn‚Äôt you also like to know if your\nJavaScript tests fail? Most of the CI scripts I‚Äôve seen will stop on the first\nfailed command which doesn‚Äôt give you a complete picture.</p>\n<h2>Gotta keep ‚Äòem separated</h2>\n<p>For installing the language versions, I used to rely on tools like <a href=\"https://github.com/asdf-vm/asdf\">asdf</a> and\n<a href=\"https://github.com/creationix/nvm\">nvm</a> and <a href=\"https://github.com/rbenv/rbenv\">rbenv</a>, but I realized that I <em>shouldn‚Äôt</em> need to use those tools\nwhen using containers. I need those tools for my local development environment\nso I can switch between projects, but not when I can use a container image that\nhas the language versions I need already installed for <em>this</em> project.</p>\n<p>Enter: <a href=\"https://circleci.com/docs/2.0/circleci-images\">CircleCI docker images</a>.</p>\n<p>CircleCI provides some great container images with good tools included like\n<a href=\"https://github.com/jwilder/dockerize\">dockerize</a>, <a href=\"https://packages.debian.org/stretch/xvfb\">xvfb</a>, and <a href=\"http://chromedriver.chromium.org/\">chromedriver</a>, which saves you from having to worry\nabout installing those manually. Let‚Äôs use their images.</p>\n<p><strong>What is <a href=\"https://github.com/jwilder/dockerize\">Dockerize</a>?</strong>\nIt‚Äôs a small bash utility that is used to wait on database containers to be\nready <em>before</em> trying to have tests run against them.</p>\n<p><strong>What is <a href=\"https://packages.debian.org/stretch/xvfb\">xvfb</a> and <a href=\"http://chromedriver.chromium.org/\">chromedriver</a>?</strong>\nGood question, I don‚Äôt really understand it, but I know I need it to allow some\nbrowser tests to run. Just roll with it.</p>\n<p>In my case, my project is using Ruby 2.5.1 but unfortunately requires Node 6.x\nbecause of an older node-based asset pipeline; CircleCI‚Äôs Ruby image\n<a href=\"https://github.com/CircleCI-Public/circleci-dockerfiles/blob/16a3d488ce42027c38f6ef5f419e2eaf9df2f35b/ruby/images/2.5.1-stretch/node/Dockerfile#L36\">Dockerfile</a> includes Node 8.x. I can‚Äôt run <code>npm install</code> under Node 8.x.\nThat‚Äôs OK though, because we can separate them with containers.</p>\n<h2>Let‚Äôs try this out</h2>\n<p>According to CircleCI docs, I‚Äôll need to define multiple jobs. I‚Äôll try to keep\nthe jobs focused on one task. Let‚Äôs start with two tasks:</p>\n<ol>\n<li>Bundle Install</li>\n<li>NPM Install. The production environment doesn‚Äôt use Yarn, so I shouldn‚Äôt\neither in CI yet. Also, Node 6.x doesn‚Äôt ship with npm that supports\n<code>package-lock.json</code>. ::sigh:: I‚Äôll leave some commented-out code though in\ncase you can use it.</li>\n</ol>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"yaml\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">jobs</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">bundle-install</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">working_directory</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">docker</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">image</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">circleci/ruby:2.5.1-node-browsers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">environment</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_JOBS</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_RETRY</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_PATH</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">vendor/bundle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">DATABASE_URL</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;postgresql://root@localhost/my_project_test?pool=5&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">checkout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">attach_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">at</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">restore_cache</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">keys</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle-{{ arch }}-{{ checksum &quot;Gemfile.lock&quot; }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># We add &quot;arch&quot; as a key since some gems compile native code, like</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># nokogiri. If for whatever reason CircleCI runs the job on a machine</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># with a different architecture, the cache would be invalid.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">save_cache</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">paths</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">./vendor/bundle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">key</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle-{{ arch }}-{{ checksum &quot;Gemfile.lock&quot; }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">persist_to_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">root</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">paths</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">vendor/bundle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">npm-install</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">working_directory</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">docker</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">image</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">circleci/node:6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">checkout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">attach_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">at</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># Enable when using npm5+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># - restore_cache:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#     keys:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#     - node-modules-{{ arch }}-{{ checksum &quot;package-lock.json&quot; }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#       We add &quot;arch&quot; as a key since some packages compile native code, like</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#       node-sass. If for whatever reason CircleCI runs the job on a machine</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#       with a different architecture, the cache would be invalid.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">npm --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">node --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">npm install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">mkdir -p public/assets/frontend</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">npm run production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># Enable when using npm5+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># - save_cache:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#     paths:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#       - node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#     key: node-modules-{{ arch }}-{{ checksum &quot;package-lock.lock&quot; }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">persist_to_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">root</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">paths</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">public/assets/frontend</span></span></span></code></pre>\n<p>Looking good so far. I‚Äôm not doing anything special but there are a couple of\nconcepts we should know:</p>\n<ul>\n<li>Cache: This is used to save dependencies across runs.</li>\n<li>Workspace: This is used to save data as the workflow continues, so the next\nstep can use the results of a previous step like <code>node_modules</code> and\n<code>vendor/bundle</code>. We attach the workspace at the beginning, and then persist\nsome resulting files to the workspace at the end of the task.</li>\n</ul>\n<p>For my project, we when we run <code>npm run production</code>, it compiles assets into\nthe folder <code>public/assets/frontend</code>. I need that to run my tests later.</p>\n<p>Let‚Äôs move on to the test step:</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"yaml\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">test</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">working_directory</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">docker</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># The first image is the primary image. This is where the commands below</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># will run within.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">image</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">circleci/ruby:2.5.1-node-browsers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">environment</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_JOBS</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_RETRY</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_PATH</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">vendor/bundle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">DATABASE_URL</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;postgresql://root@localhost/my_project_test?pool=5&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># For more information about how these images work, check our their READMEs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># https://hub.docker.com/r/circleci/ruby/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># https://hub.docker.com/r/circleci/postgres/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># https://hub.docker.com/_/postgres/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">image</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">circleci/postgres:9.3-alpine-ram</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">environment</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">POSTGRES_USER</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">root</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">POSTGRES_DB</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">my_project_test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">checkout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">attach_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">at</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">dockerize -wait tcp://localhost:5432 -timeout 1m</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">cp config/secrets.yml{.example,}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">cp config/database.yml{.example,}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">RAILS_ENV=test bundle exec rake db:schema:load --trace</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">mkdir -p ~/repo/tmp/test-results/rspec</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle exec rspec --profile 10 --format RspecJunitFormatter --out ~/repo/tmp/test-results/rspec/results.xml --format progress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">store_artifacts</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">path</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo/tmp/screenshots</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">destination</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">test-screenshots</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">store_test_results</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">path</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo/tmp/test-results</span></span></span></code></pre>\n<p>Since we‚Äôre attaching the workspace, we can assume that we have our\n<code>node_modules</code> and <code>vendor/bundle</code> already present. We still run <code>bundle install</code>, but it‚Äôs incredibly quick since the workspace already has the info‚Äî\nbundler just needs to recognize it.</p>\n<p>I want to point out another CircleCI feature: <a href=\"https://circleci.com/docs/2.0/collect-test-data/\">collecting test metadata</a>.</p>\n<p>There‚Äôs a popular XML format for expressing test outputs and metadata, like the\ntime it took to run each test; <a href=\"https://www.ibm.com/support/knowledgecenter/en/SSQ2R2_14.1.0/com.ibm.rsar.analysis.codereview.cobol.doc/topics/cac_useresults_junit.html\">JUnit</a> popularized this format. To get it for\nyour tests, you can install a gem. All of the information is on the CircleCI\nsite.</p>\n<p>This feature gives us this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b861095cab0966295bbe2e97e6b499e8/7e881/circleci2-failures.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACiUlEQVQ4y4XQW08TURAH8P0MBqUUoUC30G6BFjR2G1KIYCqXAt4+hsWEi4nyoOU7iEEfvNWARoXIxYQHTHggQgJtARPR+GRMSne7bUloaaH8nXNaKuCDD7+cOTOzu7MjaIE1KKqKWCwGjUQoVlUFiUQCiqIgHA5D0WKIUo3lkru72M1jsapp9HwU8cQO9cQhpAGk0hnspdNIZzJcMplEKpXCwcFBTjaL7OEhDkmWxcdRjtX393N9wg59NUMvydALI5EIF6dpotEoVJowEY/T9Bq2t7ehUY7dVfqLQkw9R32MEFv+gsTaKlLrIezlpTfWuVQoyO+sdhTvsfxR7/GYJH98h7Dw2o/PE+NYfPsGK1OT3DIzOYnA7AxCn+YQmptFYGb6X1Rfnf6IpffvqP8DfgcDEKqMVbA3NnD1dhusdbWos9UX2BvsPC/VWgvMFgssVokzSxLP1UgW+J8+gdBxpQ23entwM+9GtycX93RzPR0dpB29nZ241tXJ69c9nlwf1bvbr6LL7UZbczOm/K8gDPd5MXJ3CL6hQfgGc0YofjgwgOE7fbjv9WK47+/po7xvMGeEeh/09+Oe9zY/V+bnIRgqDPyXasxmiCYTKqsqodPrUZKnLy1FCeEn3c8VF5+k00FXoseZoiI8G30EwUZ7amlphsvVBKdThiw7cKGxERLtxGIxQ6J9MVbalZl91GiEKIonmEQTysrL4R8bg8AmstJSq2uq+YRGkR4wiaiorEC5wVCY9PjEp5WVnYeu+CxePB6F4G69DA8t1t3aCha30bRNDgdcsgyX00nkk+RTKHfR0QSL7RImnr+EEAkGEf26iegms8GpzMb/KSS2uY7FpS2ML/zE1rdf+AOXM6a7OjtTggAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Test metadata at the top\"\n        title=\"Test metadata at the top\"\n        src=\"/static/b861095cab0966295bbe2e97e6b499e8/fcda8/circleci2-failures.png\"\n        srcset=\"/static/b861095cab0966295bbe2e97e6b499e8/12f09/circleci2-failures.png 148w,\n/static/b861095cab0966295bbe2e97e6b499e8/e4a3f/circleci2-failures.png 295w,\n/static/b861095cab0966295bbe2e97e6b499e8/fcda8/circleci2-failures.png 590w,\n/static/b861095cab0966295bbe2e97e6b499e8/efc66/circleci2-failures.png 885w,\n/static/b861095cab0966295bbe2e97e6b499e8/c83ae/circleci2-failures.png 1180w,\n/static/b861095cab0966295bbe2e97e6b499e8/7e881/circleci2-failures.png 1521w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>One more CircleCI feature: <a href=\"https://circleci.com/docs/2.0/artifacts/\">storing artifacts</a>. I think this is normally for\ncompiled binaries of your app, but I‚Äôm going to use it for storing screenshots\nof failed browser-based tests. <a href=\"https://guides.rubyonrails.org/v5.1/testing.html#screenshot-helper\">Rails 5.1 system specs</a> will do this\nautomatically, but you can also add it to older Rails projects with\n<a href=\"https://github.com/mattheworiordan/capybara-screenshot\">capybara-screenshot</a>. All we have to do is tell CircleCI where to find\nartifacts.</p>\n<p>Ideally, you could set up two more jobs here:</p>\n<ul>\n<li>job: <code>lint-rubocop</code></li>\n<li>job: <code>lint-eslint</code></li>\n</ul>\n<p>But that‚Äôs up to you.</p>\n<p>Lastly, we need to deploy the app:</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"yaml\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">deploy-integration</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">docker</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">image</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">circleci/ruby:2.5.1-node-browsers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">environment</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_JOBS</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_RETRY</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_PATH</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">vendor/bundle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">DATABASE_URL</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;postgresql://root@localhost/my_project_test?pool=5&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">image</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">circleci/postgres:9.3-alpine-ram</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">environment</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">POSTGRES_USER</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">root</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">POSTGRES_DB</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">my_project_test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">checkout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">attach_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">at</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">git config --global user.name &quot;CircleCI&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle exec cap integration deploy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># copy and paste and modify for each environment</span></span></span></code></pre>\n<p>Nothing special here, but I do want to have CI identify itself as CircleCI for\nthe Capistrano process that uses git. Just like before, above assumes you‚Äôve\nconfigured the CircleCI project to <a href=\"https://circleci.com/docs/2.0/add-ssh-key/\">have the appropriate SSH keys</a>, so it\ncan log into the server and perform the needed steps.</p>\n<p>We‚Äôve described the jobs, but we haven‚Äôt described the workflow. Let‚Äôs do that\nnow.</p>\n<h2>Putting it together</h2>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"yaml\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">workflows</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">version</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">build-test-deploy</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">jobs</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle-install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">npm-install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">test</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">requires</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle-install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">npm-install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">deploy-integration</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">requires</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">filters</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">branches</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">              </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">only</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">master</span></span></span></code></pre>\n<p>This describes the shape of your workflow. <code>bundle-install</code> and <code>npm-install</code>\ndon‚Äôt have any requirements, so they can run in parallel. <code>test</code> requires the\ninstallation steps to succeed before it can run, and <code>deploy-integration</code>\nrequires the test step to succeed, and only run when CI is running from\na commit on the <code>master</code> branch.</p>\n<p>That gives us this shape:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/58ccf7797fc4cc56b820c8fc2f00bf88/96e92/circleci2-workflow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.567567567567565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAA8klEQVQoz5VSyXKFMAzj//+TgRSy2wF6UW0XyvJ64aCZTGRLip1uGAY45wx93yPGiNYaiAjM/BrdOI6Y5xnTNJmoCqpYrdWg5wPH3RNE57nTNMwNjZs5HMmIHyKl7hztHO9GLPxp2oWvLKkSok8iumJtG3LKCK7KXcG6bNiWbwNTE67AjwXBR6SY4ecAKmyh1Khzc4UPIpgkBS0ogiSCJRJKJixtEawGbdI0OZAJF0mttZrSBDWhk0YfInJlpEIIUqhN3PhvBFfY8NtzGScnM2T8zvFedBM4QJ8GxxyN0yf/X0A311ffhmyjF9Bl0/T+H/4AajG0vQ2TUXIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Workflow Shape\"\n        title=\"Workflow Shape\"\n        src=\"/static/58ccf7797fc4cc56b820c8fc2f00bf88/fcda8/circleci2-workflow.png\"\n        srcset=\"/static/58ccf7797fc4cc56b820c8fc2f00bf88/12f09/circleci2-workflow.png 148w,\n/static/58ccf7797fc4cc56b820c8fc2f00bf88/e4a3f/circleci2-workflow.png 295w,\n/static/58ccf7797fc4cc56b820c8fc2f00bf88/fcda8/circleci2-workflow.png 590w,\n/static/58ccf7797fc4cc56b820c8fc2f00bf88/96e92/circleci2-workflow.png 779w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Remember, if you also linted the code and had JavaScript tests, you could have\n4 jobs running in parallel since they don‚Äôt depend on each other (only\n<code>npm-install</code> and/or <code>bundle-install</code>)</p>\n<h2>YAML</h2>\n<p>We can make it a little better with a little bit of <a href=\"https://en.wikipedia.org/wiki/YAML\">YAML</a> knowledge. With\nworkflows, you‚Äôll repeat a lot of the same steps, and some of those steps can\nbe verbose. We can help that.</p>\n<p>For example, we repeated <code>working_directory: ~/repo</code> a lot, as well as the\ndocker images for several jobs. Let‚Äôs shorten it with a named anchor.</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"yaml\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">defaults</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">&amp;</span><span class=\"grvsc-t5WxC3-4 grvsc-t88nfI-1\">defaults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">working_directory</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">docker</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">image</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">circleci/ruby:2.5.1-node-browsers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">environment</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_JOBS</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_RETRY</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_PATH</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">vendor/bundle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">DATABASE_URL</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;postgresql://root@localhost/my_project_test?pool=5&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">image</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">circleci/postgres:9.3-alpine-ram</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">environment</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">POSTGRES_USER</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">root</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">POSTGRES_DB</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">my_project_test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">## and then use it like this:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">jobs</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">bundle-install</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">*</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">defaults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">test</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">*</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">defaults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">deploy-integration</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">*</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">defaults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">...</span></span></span></code></pre>\n<p>Nice!</p>\n<h2>Encore: What if I fork the repo from the client?</h2>\n<p>CircleCI is so helpful; they provide <a href=\"https://circleci.com/docs/2.0/env-vars/\">environment variables</a> for you to check\nfor situations like this. We can ask some questions against those variables\nwith something like this:</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"yaml\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">deploy-integration</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">*</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">defaults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">checkout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">attach_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">at</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">set -e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># only deploy from upstream</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">if [ &quot;$CIRCLE_PROJECT_USERNAME&quot; == &quot;ClientName&quot; ]; then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">git config --global user.name &quot;CircleCI&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle exec cap integration deploy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">fi</span></span></span></code></pre>\n<p>Just add a dash of bash to make it work.</p>\n<h2>Wrapping up</h2>\n<p>That concludes this episode of ‚Äúknow your tools‚Äù. If you find anything wrong,\nanother cool feature, or an alternative approach, then tweet <a href=\"https://twitter.com/bernheisel\">@bernheisel</a> with\nyour recommendation.</p>\n<p>By the way, there are other great CI platforms like <a href=\"https://travis-ci.org/\">Travis CI</a>, <a href=\"https://about.gitlab.com/features/gitlab-ci-cd/\">GitLab</a>,\n<a href=\"https://cloud.google.com/cloud-build/\">Google Cloud Build</a>, and more. Today I‚Äôm using <a href=\"https://circleci.com/product/\">CircleCI</a>, but tomorrow\nI might be trying out another platform. If above is way too much for you,\nI would consider looking at <a href=\"https://travis-ci.org/\">Travis CI</a>; they did a great job simplifying to\nthe essentials.</p>\n<hr>\n<p>Here‚Äôs the entire config file for my project. Feel free to modify it for yours!</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"yaml\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># Ruby CircleCI 2.0 configuration file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># Check https://circleci.com/docs/2.0/language-ruby/ for more details</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">version</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">defaults</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">&amp;</span><span class=\"grvsc-t5WxC3-4 grvsc-t88nfI-1\">defaults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">working_directory</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">docker</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">image</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">circleci/ruby:2.5.1-node-browsers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">environment</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_JOBS</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_RETRY</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">BUNDLE_PATH</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">vendor/bundle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">DATABASE_URL</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;postgresql://root@localhost/project_test?pool=5&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">image</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">circleci/postgres:9.3-alpine-ram</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">environment</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">POSTGRES_USER</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">root</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">        </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">POSTGRES_DB</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">project_test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">jobs</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">bundle-install</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">*</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">defaults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">checkout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">attach_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">at</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">restore_cache</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">keys</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle-{{ arch }}-{{ checksum &quot;Gemfile.lock&quot; }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">save_cache</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">paths</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">./vendor/bundle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">key</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle-{{ arch }}-{{ checksum &quot;Gemfile.lock&quot; }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">persist_to_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">root</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">paths</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">vendor/bundle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">npm-install</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">working_directory</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">docker</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">image</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">circleci/node:6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">checkout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">attach_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">at</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># Enable when using npm5+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># - restore_cache:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#     keys:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#     - node-modules-{{ arch }}-{{ checksum &quot;package-lock.json&quot; }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">npm --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">node --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">npm install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">mkdir -p public/assets/frontend</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">npm run production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># Enable when using npm5+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># - save_cache:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#     paths:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#       - node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#     key: node-modules-{{ arch }}-{{ checksum &quot;package-lock.lock&quot; }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">persist_to_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">root</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">paths</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">public/assets/frontend</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">test</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">*</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">defaults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">checkout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">attach_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">at</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">dockerize -wait tcp://localhost:5432 -timeout 1m</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">cp config/secrets.yml{.example,}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">cp config/database.yml{.example,}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">RAILS_ENV=test bundle exec rake db:schema:load --trace</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">mkdir -p ~/repo/tmp/test-results/rspec</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle exec rspec --profile 10 --format RspecJunitFormatter --out ~/repo/tmp/test-results/rspec/results.xml --format progress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">store_artifacts</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">path</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo/tmp/screenshots</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">destination</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">test-screenshots</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">store_test_results</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">path</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo/tmp/test-results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">deploy-integration</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">*</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">defaults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">checkout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">attach_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">at</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">set -e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># only deploy from upstream</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">if [ &quot;$CIRCLE_PROJECT_USERNAME&quot; == &quot;ClientName&quot; ]; then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">git config --global user.name &quot;CircleCI&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle exec cap integration deploy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">deploy-staging</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">*</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">defaults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">checkout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">attach_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">at</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">set -e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># only deploy from upstream</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">if [ &quot;$CIRCLE_PROJECT_USERNAME&quot; == &quot;ClientName&quot; ]; then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">git config --global user.name &quot;CircleCI&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle exec cap staging deploy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">deploy-production</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">&lt;&lt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">*</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">defaults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">steps</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">checkout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">attach_workspace</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">at</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~/repo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">run</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">set -e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># only deploy from upstream</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">if [ &quot;$CIRCLE_PROJECT_USERNAME&quot; == &quot;ClientName&quot; ]; then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">git config --global user.name &quot;CircleCI&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle exec cap production deploy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">workflows</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">version</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">build-test-deploy</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">jobs</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle-install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">npm-install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">test</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">requires</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">bundle-install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">npm-install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">deploy-integration</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">requires</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">filters</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">branches</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">              </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">only</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">master</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">deploy-staging</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">requires</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">filters</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">branches</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">              </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">only</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">staging</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      - </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">deploy-production</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">requires</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            - </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">          </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">filters</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">            </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">branches</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">              </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">only</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">: </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">production</span></span></span></code></pre>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .atom-one-light {\n    background-color: #FAFAFA;\n    color: #383A42;\n  }\n  .atom-one-light .grvsc-t5WxC3-i { font-style: italic; }\n  .atom-one-light .grvsc-t5WxC3-7 { color: #A0A1A7; }\n  .atom-one-light .grvsc-t5WxC3-1 { color: #383A42; }\n  .atom-one-light .grvsc-t5WxC3-5 { color: #E45649; }\n  .atom-one-light .grvsc-t5WxC3-10 { color: #50A14F; }\n  .atom-one-light .grvsc-t5WxC3-6 { color: #986801; }\n  .atom-one-light .grvsc-t5WxC3-14 { color: #A626A4; }\n  .atom-one-light .grvsc-t5WxC3-4 { color: #C18401; }\n  .atom-one-light .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(0, 0, 0, 0.05));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(0, 0, 0, 0.2));\n  }\n  \n  /* Monokai Phoenix */\n  @media (prefers-color-scheme: dark) {\n    .grvsc-mm-t88nfI {\n      background-color: #1e1e1e;\n      color: #F8F8F2;\n    }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-3 { color: #75715E; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-1 { color: #F8F8F2; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-7 { color: #F92672; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-6 { color: #E6DB74; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-4 { color: #AE81FF; }\n    .grvsc-mm-t88nfI .grvsc-line-highlighted::before {\n      background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n      box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n    }\n  }\n</style>","frontmatter":{"title":"Ruby, Rails, and CircleCI 2.0 Workflows","date":"August 26, 2018","tags":["ruby"],"originalUrl":"https://www.viget.com/articles/ruby-rails-and-circle-ci-2-0/"}}},"pageContext":{"slug":"/blog/ruby-rails-and-circle-ci-workflows/","previous":{"fields":{"slug":"/blog/querying-embedded-maps-in-postgresql-with-ecto/"},"frontmatter":{"title":"Querying an Embedded Map in PostgreSQL with Ecto","tags":["elixir"],"originalUrl":"https://robots.thoughtbot.com/querying-embedded-maps-in-postgresql-with-ecto","excerpt":null}},"next":{"fields":{"slug":"/blog/httpoison-decompression/"},"frontmatter":{"title":"HTTPoison and Decompression","tags":["elixir"],"originalUrl":null,"excerpt":"I learned the hard way that the popular HTTP client for Elixir doesn't\nautomatically decompress or re-encode responses. I had to fix it myself.\n"}}}}}