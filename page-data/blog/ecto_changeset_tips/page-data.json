{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/ecto_changeset_tips/","result":{"data":{"site":{"siteMetadata":{"title":"David Bernheisel","author":"David Bernheisel"}},"markdownRemark":{"id":"e770461a-6af5-5afb-b0e0-11b4f235a88c","excerpt":"I use Ecto Changesets a lot— a TON! and I love them. Since I’ve\nbeen using them for a couple years now, I’ve noticed some patterns and now I…","timeToRead":9,"html":"<p>I use <a href=\"https://hexdocs.pm/ecto/Ecto.Changeset.html\">Ecto Changesets</a> a lot— a TON! and I love them. Since I’ve\nbeen using them for a couple years now, I’ve noticed some patterns and now I\nhave a couple tips to share.</p>\n<ul>\n<li><a href=\"#extract-boilerplate\">Extract Boilerplate</a></li>\n<li><a href=\"#db-generated-uuids\">DB-generated UUIDs</a></li>\n<li><a href=\"#interpolate-your-docs\">Interpolate Your Docs</a></li>\n<li><a href=\"#compose-changesets\">Compose Changesets</a></li>\n</ul>\n<p><a name=\"extract-boilerplate\"></a></p>\n<h2>Extract Boilerplate</h2>\n<p>I use <a href=\"https://en.wikipedia.org/wiki/Universally_unique_identifier\">UUID</a>s for all my IDs, specifically v4.</p>\n<p>Long ago I managed some legacy codebases that chose (defaulted) integer-based\nIDs, and two times now I’ve had to migrate them to tables with a BigSerial as\nthe ID because we reached our limit of IDs for the table. It’s easy to forget.</p>\n<p>I’d be fine with BigSerial, but since I started using Ecto, I found myself using\nUUIDs instead, and now it’s become a habit.</p>\n<p><strong>What about showing UUIDs in URLs in basic CRUD endpoints?</strong></p>\n<p>Yea, it’s really ugly to show UUIDs in the browser URL bar, especially for\nnested routes. But, should you show internal database IDs to users? I don’t\nthink so, so when using UUIDs I am constantly reminded to design towards\ngenerating unique slugs for UX. If you see a UUID in the browser URL, I feel\nlike I should replace it with a human-readable unique slug instead. IDs are for\nmachines, slugs are for humans. URLs are for humans too, though I understand\nsome may not agree with that.</p>\n<h3>Let’s default to UUID in Ecto</h3>\n<p>There’s some configuration for Ecto to default to UUIDs:</p>\n<ol>\n<li><a href=\"#configure-generators\">Configure Generators</a></li>\n<li><a href=\"#configure-migrations\">Configure Migrations</a></li>\n<li><a href=\"#configure-schema\">Configure Schema</a></li>\n</ol>\n<p>Then lastly, we’ll wrap that up and make it easier by <a href=\"#pull-into-macro\">pulling it into a\nmacro</a></p>\n<p><a name=\"configure-generators\"></a></p>\n<h3>Configure Generators</h3>\n<p>If you’re using Phoenix and use its generators, you might care about this\nsection. When you run <code>mix phx.gen.schema ARGS</code>, Phoenix and Ecto will throw in\nsome boilerplate into your schemas and migrations. Even if you don’t, it’s\nharmless to configure it just in case things change later, or other developers\non your project choose to use the generators.</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"elixir\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#./config/config.exs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">config </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:my_app</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">ecto_repos:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">MyApp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Repo</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">generators:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> [</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">binary_id:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">true</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># This will tell your Schema that the primary_key is a binary UUID:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">#./lib/my_app/random_schema.ex</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@primary_key</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:id</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:binary_id</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">autogenerate:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">true</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@foreign_key_type</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:binary_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">schema </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;my_table&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span></code></pre>\n<p><a name=\"configure-migrations\"></a></p>\n<h3>Configure Migrations</h3>\n<p>When creating tables through a migration, you’ll need to specify that it should\nnot create an ID column that generates it’s own IDs (more on this later).\nInstead, we’ll supply our own primary key column called <code>id</code>.</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"elixir\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defmodule</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-4 grvsc-t88nfI-1\">MyApp.Repo.Migrations.CreateUsers</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">@moduledoc &quot;Creating Users in the database&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-7\">use</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Migration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">def</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">change</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    create table(</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:users</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">primary_key:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">false</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      add </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:id</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:binary_id</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">primary_key:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      timestamps()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span></code></pre>\n<p>In Ecto 3.x, you can also <a href=\"https://hexdocs.pm/ecto_sql/Ecto.Migration.html#module-repo-configuration\">reconfigure default ID column\nsettings</a>\nwith <code>:migration_primary_key</code> so you wouldn’t even have to <code>add :id</code> yourself,\nbut unfortunately it does not play well with Ecto macros that I will end up\nusing since it’s via Mix config.</p>\n<p><a name=\"configure-schema\"></a></p>\n<h3>Configure Schema</h3>\n<p>If you’re using the generators above, then they should insert these options in\nfor you, but if not, you’ll need to make sure they’re present.</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"elixir\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defmodule</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-4 grvsc-t88nfI-1\">MyApp.RandomSchema</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-7\">use</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Schema</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-7\">import</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Changeset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@primary_key</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:id</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:binary_id</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">autogenerate:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">true</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@foreign_key_type</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:binary_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  schema </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;users&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    field </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:name</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    timestamps()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span></code></pre>\n<p>That’s it! It should work. Ecto’s <code>schema</code> macro will use the module attributes\nto configure how it should treat the primary key. <a href=\"https://hexdocs.pm/ecto/Ecto.Schema.html#module-schema-attributes\">The documentation has more\ninformation if you want to read more</a>.</p>\n<p><a name=\"pull-into-macro\"></a></p>\n<h3>Pull Into Macro</h3>\n<p>That’s a lot of boilerplate for <em>each schema</em>. Let’s make it easier. Notice at\nthe top of the schema definition? <code>use Ecto.Schema</code>.</p>\n<p>This injects some code into the module. We can do that too! Let’s create our own\nschema file that injects our boilerplate.</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"elixir\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defmodule</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-4 grvsc-t88nfI-1\">MyApp.Schema</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">@moduledoc &quot;Ecto Schema Helpers&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defmacro</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">__using__</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">_</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">quote</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-7\">use</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Schema</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-7\">import</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Changeset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@primary_key</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> {</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:id</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:binary_id</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">autogenerate:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">true</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@foreign_key_type</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:binary_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"diff\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">defmodule MyApp.RandomSchema do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">-   use Ecto.Schema</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">-   import Ecto.Changeset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">-   @primary_key {:id, :binary_id, autogenerate: true}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">-   @foreign_key_type :binary_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-5\">+   use MyApp.Schema</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  schema &quot;users&quot; do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    field :name, :string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    timestamps()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">end</span></span></span></code></pre>\n<p>Now for each of your schemas, use this new module and you don’t have to\nremember the boilerplate anymore.</p>\n<p><a name=\"db-generated-uuids\"></a></p>\n<h2>DB-Generated UUIDs</h2>\n<p>Maybe you noticed above that we have <code>autogenerate: true</code> above. This is telling\n<strong>Ecto</strong> to generate those ID UUIDs instead of the database. That bothered me; I\nfeel like that’s a database responsibility, not an app responsibility.</p>\n<p>Let’s move that into the database. I’m using PostgreSQL, but I’m sure there are\nsimilar tools for other databases.</p>\n<ol>\n<li><a href=\"#enable-pgcrypto\">Enable pgcrypto</a></li>\n<li><a href=\"#use-pgcrypto\">Update our Boilerplate</a></li>\n</ol>\n<p><a name=\"enable-pgcrypto\"></a></p>\n<h3>Enable pgcrypto</h3>\n<p>Postgres unfortunately cannot generate UUIDs simply out of the box, but it does\nship with functions that you can enable. You can get away with creating a\nfunction that’ll generate UUIDs, but I prefer some battle-tested code that ships\nwith <a href=\"https://www.postgresql.org/docs/current/contrib.html\">postgres contrib</a>.</p>\n<p>One of those extensions is <a href=\"https://www.postgresql.org/docs/current/pgcrypto.html\">pgcrypto</a> which supplies a function\n<code>gen_random_uuid()</code>.</p>\n<p>Let’s create a migration to have Postgres enable the extension.</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"sh\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">$ mix ecto.gen.migration add_pgcrypto</span></span></span></code></pre>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"elixir\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defmodule</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-4 grvsc-t88nfI-1\">MyApp.Repo.Migrations.AddPgcrypto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">@moduledoc &quot;Add PgCrypto so we can have Postgres generate it&#39;s own IDs&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-7\">use</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Migration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">def</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">change</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    execute(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;CREATE EXTENSION IF NOT EXISTS </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">\\&quot;</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">pgcrypto</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">\\&quot;</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;DROP EXTENSION IF EXISTS </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">\\&quot;</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">pgcrypto</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">\\&quot;</span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span></code></pre>\n<p>This sometimes requires special permissions on the database user. If this\ndoesn’t work for you, then you might need an additional procedure to enable the\nextension for you. However, this should work for your local database for\ndevelopment.</p>\n<p><a name=\"use-pgcrypto\"></a></p>\n<h3>Use pgcrypto</h3>\n<p>Now that the database can generate UUIDs, let’s use it our ID columns!</p>\n<p>First we’ll tell ID column to default its value. Looking at our earlier\nmigration, let’s modify it.</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"diff\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">defmodule MyApp.Repo.Migrations.CreateUsers do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  @moduledoc &quot;Creating Users in the database&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  use Ecto.Migration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  def change do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    create table(:users, primary_key: false) do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">-      add :id, :binary_id, primary_key: true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-5\">+      add :id, :binary_id, primary_key: true, default: fragment(&quot;gen_random_uuid()&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      timestamps()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">end</span></span></span></code></pre>\n<p>Now it’ll generate it’s own ID. <strong>If you stopped here, you’ll notice that\nwhen you insert records with Ecto, none of your returned structs will have an\nID!</strong> What happened?!</p>\n<p>We need to tell Ecto to <a href=\"https://hexdocs.pm/ecto/Ecto.Schema.html#field/3-options\">read the ID back into the struct after\nwriting</a>.\nThankfully, that’s easy. Earlier we pulled some boilerplate into a\n<code>MyApp.Schema</code>; let’s modify it:</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"diff\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">defmodule MyApp.Schema do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  @moduledoc &quot;Ecto Schema Helpers&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  defmacro __using__(_) do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    quote do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      use Ecto.Schema</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      import Ecto.Changeset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-7\">-      @primary_key {:id, :binary_id, autogenerate: true}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-5\">+      @primary_key {:id, :binary_id, read_after_writes: true}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">      @foreign_key_type :binary_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">end</span></span></span></code></pre>\n<p>Now Ecto will pull the database-generated UUID back. Yes! Now we have IDs\ngenerated in the database again.</p>\n<h3>Avoiding Collisions</h3>\n<p>Ok, so it’s works, but what happens in the low low chance that it generated a\nduplicate UUID? It will fail to insert since the primary key is unique. In this\ncase, you’ll need to handle retrying with application code to retry once. The\nprobability of it failing a second time is galaxy-scale low. Probably not worth\nhandling in new code for smallish tables, and worth revisiting if you have very\nlarge-scale tables in the millions or billions.</p>\n<p><a name=\"interpolate-your-docs\"></a></p>\n<h2>Have Elixir Write Docs For You</h2>\n<p>One tedious task I find myself doing is trying to remember what fields I need,\ndon’t need, and which ones have a default value if not supplied when interacting\nwith a changeset function. I’ll constantly flip back and forth between my forms,\ncontexts, and schemas.</p>\n<p>In VIM, I’m using <a href=\"https://github.com/neoclide/coc.nvim\">coc.nvim</a> to enable Language Server integration. You can do\nthis easily in <a href=\"https://marketplace.visualstudio.com/items?itemName=elixir-lsp.elixir-ls\">VSCode</a> as well. One of the great features of this is\nthat you can lookup the documentation on a function with a keypress or hover.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/14bd4015fe1e3172648a2db2fae78c41/d6bb7/documentation-hover.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.567567567567565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAB1klEQVQozy2O7WvaUBTG862NrvSDbY0vUZObXG8STTS2RQYza2HM4rCzHd3YuDc3uZoYNS86xgbbH7+7dvDj4TnP4TkcAY6kriMPRleWYzuua7rXwBpAd6y7r3V7BCC0bAeoQNGgYlgdo9eGCGhasynXGw1BR/B6bAwvgWG1hgPT7jlI1ezhVbc/QI6LzL7Zs01N6yPURWZH0TqyrPKqJLUkSZBtx7hbgNkjuLsHswWYztH0w/jp8+XDJ3s2h+/ey2882XsrTzzVu1W8m9bEa3u3be+mOZkIRpyfJXElosc+E/1Q9Bk3R354RF8MO6ZLkTIxYKVwJQarUrB8hieh0P32tZlSKcKNNa7FuB5jiRORWvyfakTOl7jCSIXhM4bLhJQJLmFusKA/TNEPZuyJsffNA4VFgIpASX01JWqKucICwxx3dhweMiWNQLYGWaIXiSDP76XdrhqtLqJIitftXVqL16dBWCb+P/XpK5+eBsEJpSLGIiEipmXCE3ZCQ8H68mT//qNlOTp8V7JcSTOQF7A4qFmu5QUPnZ+/9GLf3R8ayaaZbFvb3fkqEjG/QgTl46KZ5RerqLZOXqgnCX+Bmwpb8oK82fKxGsX1ZPO83TQ2W/4UL/8FT3uKYcgV3WEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Documentation Hover\"\n        title=\"Documentation Hover\"\n        src=\"/static/14bd4015fe1e3172648a2db2fae78c41/fcda8/documentation-hover.png\"\n        srcset=\"/static/14bd4015fe1e3172648a2db2fae78c41/12f09/documentation-hover.png 148w,\n/static/14bd4015fe1e3172648a2db2fae78c41/e4a3f/documentation-hover.png 295w,\n/static/14bd4015fe1e3172648a2db2fae78c41/fcda8/documentation-hover.png 590w,\n/static/14bd4015fe1e3172648a2db2fae78c41/efc66/documentation-hover.png 885w,\n/static/14bd4015fe1e3172648a2db2fae78c41/c83ae/documentation-hover.png 1180w,\n/static/14bd4015fe1e3172648a2db2fae78c41/d6bb7/documentation-hover.png 2157w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>See the screenshot and how it’s listing out the required, optional, and default\nfields? Let’s make that happen.</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"elixir\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">defmodule</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-4 grvsc-t88nfI-1\">MyApp.RandomSchema</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">@moduledoc &quot;The Random Schema.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-7\">use</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">MyApp</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Schema</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@defaults</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> %{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">type:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;topical&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">is_invite_only:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">false</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">is_screening:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  schema </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">&quot;organizations&quot;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    field </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:name</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    field </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:type</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:string</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">default:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@defaults</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">[</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:type</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    field </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:audience_description</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    field </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:is_invite_only</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:boolean</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">default:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@defaults</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">[</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:is_invite_only</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    field </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:is_screening</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:boolean</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">default:</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@defaults</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">[</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:is_screening</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    timestamps()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@optional_fields</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~w[is_invite_only is_screening screen_questions]a</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@required_fields</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-10 grvsc-t88nfI-6\">~w[name type audience_description]a</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">@doc &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">  Required fields: </span><span class=\"grvsc-t5WxC3-15 grvsc-t5WxC3-i grvsc-t88nfI-3\">#{</span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">inspect </span><span class=\"grvsc-t5WxC3-5 grvsc-t5WxC3-i grvsc-t88nfI-3\">@required_fields</span><span class=\"grvsc-t5WxC3-15 grvsc-t5WxC3-i grvsc-t88nfI-3\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">  Optional fields: </span><span class=\"grvsc-t5WxC3-15 grvsc-t5WxC3-i grvsc-t88nfI-3\">#{</span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">inspect </span><span class=\"grvsc-t5WxC3-5 grvsc-t5WxC3-i grvsc-t88nfI-3\">@optional_fields</span><span class=\"grvsc-t5WxC3-15 grvsc-t5WxC3-i grvsc-t88nfI-3\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">  Defaults: </span><span class=\"grvsc-t5WxC3-15 grvsc-t5WxC3-i grvsc-t88nfI-3\">#{</span><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">inspect </span><span class=\"grvsc-t5WxC3-5 grvsc-t5WxC3-i grvsc-t88nfI-3\">@defaults</span><span class=\"grvsc-t5WxC3-15 grvsc-t5WxC3-i grvsc-t88nfI-3\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">  &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@spec</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> changeset(%</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-12\">__MODULE__</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t(), map()) </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">::</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">def</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">struct</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">\\\\</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-12\">__MODULE__</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{}, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">attrs</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    struct</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> cast(attrs, </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@optional_fields</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">++</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@required_fields</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">    </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> validate_required(</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@required_fields</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span></code></pre>\n<p>It’s not hard at all! It’s a feature I often forget exists with ExDocs and\nElixir: you can interpolate compiled values into documentation. In this case,\nI’m defining my <code>@optional_fields</code>, <code>@required_fields</code>, and <code>@defaults</code>, and\nthen interpolating them into the changeset docs.</p>\n<p>Easy peasy!</p>\n<p><a name=\"compose-changesets\"></a></p>\n<h2>Compose Changesets</h2>\n<p>Did you know that changesets can chain together?</p>\n<p>For example:</p>\n<p>Let’s say you have a “main” changeset that performs the basic validations. These\nvalidations should occur <em>every single time</em> an insert or update occurs for this\nschema. This happens for both admins and users.</p>\n<p>Let’s also say that you have another changeset that runs additional validations\nif the User is updating the record versus the Admin updating the same record.\nYou don’t have to duplicate that code!</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"elixir\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># In MySchema</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@spec</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> changeset(%</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-12\">__MODULE__</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t(), map()) </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">::</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">def</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">struct_or_changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">\\\\</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-12\">__MODULE__</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{}, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">attrs</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  struct_or_changeset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> cast(attrs, </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@optional_fields</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">++</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@required_fields</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> validate_required(</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@required_fields</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@spec</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> additional_restrictions_changeset(%</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-12\">__MODULE__</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t(), map()) </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">::</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">def</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">additional_restrictions_changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">struct_or_changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">\\\\</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-12\">__MODULE__</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{}, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">attrs</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  struct_or_changeset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> changeset(attrs)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> more_validations()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@spec</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> user_changeset(%</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-12\">__MODULE__</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t(), map()) </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">::</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">def</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">user_changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">attrs</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  changeset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> cast(attrs, [</span><span class=\"grvsc-t5WxC3-8 grvsc-t88nfI-4\">:some_more_fields</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> even_more_validations()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\">## ... In some other app code</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">def</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">create</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">params</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">MySchema</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.changeset(%</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">MySchema</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{}, params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">def</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">restricted_create</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">params</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">MySchema</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.additional_restrictions_changeset(%</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">MySchema</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{}, params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">def</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">user_create</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(</span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">params</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  %</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">MySchema</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">MySchema</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.changeset(params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">MySchema</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.user_changeset(params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span></code></pre>\n<p>This way, you can use <code>additional_restrictions_changeset/2</code> by itself and get\nall the same logic within <code>changeset/2</code>. Or alternatively, compose them together\nfrom the outside like in <code>user_create/1</code></p>\n<p>A common mistake that prevents changesets from being composable is that we’ll\nwrite our function signatures to require the struct as the first param:</p>\n<pre class=\"grvsc-container atom-one-light grvsc-mm-t88nfI\" data-language=\"elixir\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3\"># don&#39;t do this:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@spec</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> changeset(%</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-12\">__MODULE__</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{}, map()) </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">::</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Ecto</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">Changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">.t()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">def</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-9 grvsc-t88nfI-5\">changeset</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">(%</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-12\">__MODULE__</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">{} </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">=</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">struct</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">, </span><span class=\"grvsc-t5WxC3-6 grvsc-t5WxC3-i grvsc-t88nfI-1\">attrs</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">) </span><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  struct</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> cast(attrs, </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@optional_fields</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">++</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> </span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@required_fields</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">  </span><span class=\"grvsc-t5WxC3-6 grvsc-t88nfI-7\">|&gt;</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\"> validate_required(</span><span class=\"grvsc-t5WxC3-5 grvsc-t88nfI-1\">@required_fields</span><span class=\"grvsc-t5WxC3-1 grvsc-t88nfI-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t5WxC3-14 grvsc-t88nfI-7\">end</span></span></span></code></pre>\n<p>This makes it more restrictive and keeps it from being composable.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .atom-one-light {\n    background-color: #FAFAFA;\n    color: #383A42;\n  }\n  .atom-one-light .grvsc-t5WxC3-i { font-style: italic; }\n  .atom-one-light .grvsc-t5WxC3-7 { color: #A0A1A7; }\n  .atom-one-light .grvsc-t5WxC3-1 { color: #383A42; }\n  .atom-one-light .grvsc-t5WxC3-8 { color: #0184BC; }\n  .atom-one-light .grvsc-t5WxC3-5 { color: #E45649; }\n  .atom-one-light .grvsc-t5WxC3-9 { color: #4078F2; }\n  .atom-one-light .grvsc-t5WxC3-10 { color: #50A14F; }\n  .atom-one-light .grvsc-t5WxC3-14 { color: #A626A4; }\n  .atom-one-light .grvsc-t5WxC3-4 { color: #C18401; }\n  .atom-one-light .grvsc-t5WxC3-15 { color: #CA1243; }\n  .atom-one-light .grvsc-t5WxC3-6 { color: #986801; }\n  .atom-one-light .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(0, 0, 0, 0.05));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(0, 0, 0, 0.2));\n  }\n  \n  /* Monokai Phoenix */\n  @media (prefers-color-scheme: dark) {\n    .grvsc-mm-t88nfI {\n      background-color: #1e1e1e;\n      color: #F8F8F2;\n    }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-3 { color: #75715E; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-1 { color: #F8F8F2; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-4 { color: #AE81FF; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-6 { color: #E6DB74; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-7 { color: #F92672; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-5 { color: #A6E22E; }\n    .grvsc-mm-t88nfI .grvsc-t88nfI-12 { color: #64D9EA; }\n    .grvsc-mm-t88nfI .grvsc-line-highlighted::before {\n      background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n      box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n    }\n  }\n</style>","frontmatter":{"title":"Ecto Tips: UUID Boilerplate, Docs, and Composing Changesets","date":"January 19, 2020","tags":["elixir","ecto"],"originalUrl":null}}},"pageContext":{"slug":"/blog/ecto_changeset_tips/","previous":{"fields":{"slug":"/blog/date-time-parser-podcast/"},"frontmatter":{"title":"DateTimeParser on Elixir Mix podcast","tags":["elixir","podcast"],"originalUrl":null,"excerpt":"I was invited to talk on the Elixir Mix podcast. We talked about the Elixir\ncommunity, how to contribute, and the DateTimeParser library I released.\n"}},"next":{"fields":{"slug":"/blog/vim-elixir-ls-plug/"},"frontmatter":{"title":"Managing ElixirLS updates in Neovim with asdf and vim-plug","tags":["elixir","vim"],"originalUrl":null,"excerpt":"How I manage ElixirLS, neovim, and coc.nvim with vim-plug."}}}}}