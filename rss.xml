<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[David Bernheisel]]></title><description><![CDATA[A blog about development]]></description><link>https://bernheisel.com</link><generator>RSS for Node</generator><lastBuildDate>Sun, 23 Sep 2018 02:19:24 GMT</lastBuildDate><item><title><![CDATA[Ruby, Rails, and CircleCI 2.0 Workflows]]></title><description><![CDATA[There‚Äôs a movement lately in the development world that I‚Äôve really enjoyed: ‚ÄúKnow your tools‚Äù
‚Äî Tool authors, probably It‚Äôs encouraged me‚Ä¶]]></description><link>https://bernheisel.com/blog/ruby-rails-and-circle-ci-workflows/</link><guid isPermaLink="false">https://bernheisel.com/blog/ruby-rails-and-circle-ci-workflows/</guid><pubDate>Sun, 26 Aug 2018 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;There‚Äôs a movement lately in the development world that I‚Äôve really enjoyed:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;‚ÄúKnow your tools‚Äù
‚Äî Tool authors, probably&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;It‚Äôs encouraged me to dive deeper into the tools that I use every day and
understand more how they work.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Ruby? I should know how &lt;a href=&quot;https://medium.com/@farsi_mehdi/openstruct-in-ruby-ab6ba3aff9a4&quot;&gt;OpenStruct works&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;Rails? I should understand the &lt;a href=&quot;https://www.rubypigeon.com/posts/examining-internals-of-rails-request-response-cycle/&quot;&gt;request cycle&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;SQL? I should understand &lt;a href=&quot;https://www.postgresql.org/docs/current/static/tutorial-views.html&quot;&gt;database views&lt;/a&gt; and &lt;a href=&quot;https://www.postgresql.org/docs/10/static/sql-createtrigger.html&quot;&gt;triggers&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;Git? I should understand &lt;a href=&quot;https://git-scm.com/docs/git-rebase&quot;&gt;how to rebase&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;CI? I should understand my &lt;strong&gt;tool of choice&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Why? Because it makes me a better developer. I expose myself to new patterns,
learn new concepts, and have those solution-patterns in my toolbox for when
I need to solve problems.&lt;/p&gt;
&lt;p&gt;Today, I want to talk about my tool of choice for Continuous Integration.&lt;/p&gt;
&lt;h2&gt;CircleCI 2.0&lt;/h2&gt;
&lt;p&gt;My tool of choice for Continuous Integration lately is CircleCI 2.0. I‚Äôve
really enjoyed it. I don‚Äôt think I went out of my way to pick them, honestly,
but a couple of co-workers before me setup projects that I work on with
CircleCI; I think they made a good choice.&lt;/p&gt;
&lt;p&gt;Depending on how long ago the project was setup for CI, you might be using
CircleCI 1.0 configurations, which is &lt;a href=&quot;https://circleci.com/sunset1-0/&quot;&gt;deprecating on EOD August 31,
2018&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Enter my problem: I had a project using CircleCI 1.0, so I needed to migrated
quickly. Our deployment process also happens via CI, so I didn‚Äôt want that to
stop.&lt;/p&gt;
&lt;p&gt;Time for me to dive into CircleCI.&lt;/p&gt;
&lt;h3&gt;What is CircleCI?&lt;/h3&gt;
&lt;p&gt;I‚Äôll keep it short here, &lt;a href=&quot;https://circleci.com/product/&quot;&gt;because they do a better job explaining who they
are&lt;/a&gt;. CircleCI is a service that uses containers to build your code,
test your code, and deploy your code.&lt;/p&gt;
&lt;p&gt;What are containers? &lt;a href=&quot;https://www.docker.com/resources/what-container&quot;&gt;They are isolated environments that run
software.&lt;/a&gt; CircleCI 2.0 uses containers to manage your code, and
extends that container configurability to your projects.&lt;/p&gt;
&lt;h3&gt;How do I configure &lt;em&gt;my&lt;/em&gt; container?&lt;/h3&gt;
&lt;p&gt;This is the ‚Äúknow your tools‚Äù part. Thankfully, CircleCI provides a lot of
great &lt;a href=&quot;https://circleci.com/docs/2.0/&quot;&gt;documentation&lt;/a&gt; and &lt;a href=&quot;https://circleci.com/docs/2.0/tutorials/&quot;&gt;samples&lt;/a&gt;. Since this is an article about Ruby and
Rails, using their &lt;a href=&quot;https://circleci.com/docs/2.0/language-ruby/&quot;&gt;Rails tutorial&lt;/a&gt; will be enough to get you going.&lt;/p&gt;
&lt;p&gt;In their &lt;a href=&quot;https://circleci.com/docs/2.0/language-ruby/&quot;&gt;Rails tutorial&lt;/a&gt;, they are using one container to build your project
and test your code. I could modify it to also deploy my project; it‚Äôs simple to
add another step:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# replace &quot;production&quot; with integration, staging, or whatever else environment&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# you need to deploy.&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; git config &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;global user.name &quot;CircleCI&quot;
&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bundle exec cap production deploy&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Using Capistrano makes it easy to deploy for most Rails applications. Above
assumes you‚Äôve configured the CircleCI project to &lt;a href=&quot;https://circleci.com/docs/2.0/add-ssh-key/&quot;&gt;have the appropriate SSH
keys&lt;/a&gt;, so it can log into the server and perform the needed steps.&lt;/p&gt;
&lt;p&gt;At this point you you could be done if you‚Äôre in the same boat as me and need
to move off of CircleCI 1.0 and onto CircleCI 2.0. But, this isn‚Äôt really about
migrating from CircleCI 1.0 to CircleCI 2.0; we‚Äôre here to learn!&lt;/p&gt;
&lt;h2&gt;Not everything has to be together&lt;/h2&gt;
&lt;p&gt;I decided to explore a little further and use another CircleCI feature:
&lt;a href=&quot;https://circleci.com/docs/2.0/jobs-steps/#section=getting-started&quot;&gt;workflows&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;In my development environment, everything happens on my machine. I like my
machine because it‚Äôs the way I made it. I like using &lt;a href=&quot;https://brew.sh/&quot;&gt;brew&lt;/a&gt; to install
dependencies, but the CI environment runs Linux, which my production
environment also runs.&lt;/p&gt;
&lt;p&gt;CircleCI leverages containers to help keep ‚Äúsoftware units‚Äù separate and pure.
This is smart because I need these environments to be accurately reproducible
and not fragile to some other dependency being introduced. Have you ever
installed a different version of OpenSSL to ‚Äúfix‚Äù one project, but totally
borked other projects on your machine? Containers prevent this problem.&lt;/p&gt;
&lt;p&gt;When you think about what your CI process does, there‚Äôs probably a couple of
large tasks happening:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Install language versions&lt;/li&gt;
&lt;li&gt;Install dependencies outside of your language (like imagemagick)&lt;/li&gt;
&lt;li&gt;Install dependencies in your language (with bundler)&lt;/li&gt;
&lt;li&gt;Install dependencies in your &lt;em&gt;other&lt;/em&gt; language (with npm)&lt;/li&gt;
&lt;li&gt;Precompile assets&lt;/li&gt;
&lt;li&gt;Run Ruby tests&lt;/li&gt;
&lt;li&gt;Run JavaScript tests (you wrote those, right?)&lt;/li&gt;
&lt;li&gt;Run linting checks (your team agrees on the same style, right?)&lt;/li&gt;
&lt;li&gt;Deploy the working code&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;With containers, we can separate these tasks. This has some benefits because we
can run some of these in parallel instead of serially; that might give us
a speed boost; more importantly, it communicates better where the failure is
happening, if it happens ü§û&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/circleci2-github-6d7c1279d405358a7fc1420c1fea0a29-28d9a.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 30.04291845493562%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA+klEQVQY022R627DIAxG8/6PuB9blybNDTCGJE2A5KtBarRNs3SEQfKxLarR19DqA1Y9hEZoQdMdjgY5a7BusHqDHOd5Fn5GOk6wDzB2x7xGVHqVQj+ADYGMAlsD0gqWDBwTUtyQUvgleYszhxDigShkeXVKQdt0qO8tJk3QxsKyh7UOzi/QxOWupaEhCz8vIkjYQ7yIKYHcVqi28ETdNLh91xhGha4fC/0wgUSaGyhpZMppyttfYYgRmjcYzkKZ8PPrVoS5cFIa46SKyPlZpuKSv+Xz8vxXeE24h00mm/Do+mutLLXsipAsl5xlbRL5todLGC5hko/ZCy8Btc1Bt8rVDQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;GitHub Integration&quot;
        title=&quot;&quot;
        src=&quot;/static/circleci2-github-6d7c1279d405358a7fc1420c1fea0a29-fb8a0.png&quot;
        srcset=&quot;/static/circleci2-github-6d7c1279d405358a7fc1420c1fea0a29-1a291.png 148w,
/static/circleci2-github-6d7c1279d405358a7fc1420c1fea0a29-2bc4a.png 295w,
/static/circleci2-github-6d7c1279d405358a7fc1420c1fea0a29-fb8a0.png 590w,
/static/circleci2-github-6d7c1279d405358a7fc1420c1fea0a29-28d9a.png 699w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;Also, what if your ruby tests fail‚Äî wouldn‚Äôt you also like to know if your
JavaScript tests fail? Most of the CI scripts I‚Äôve seen will stop on the first
failed command which doesn‚Äôt give you a complete picture.&lt;/p&gt;
&lt;h2&gt;Gotta keep ‚Äòem separated&lt;/h2&gt;
&lt;p&gt;For installing the language versions, I used to rely on tools like &lt;a href=&quot;https://github.com/asdf-vm/asdf&quot;&gt;asdf&lt;/a&gt; and
&lt;a href=&quot;https://github.com/creationix/nvm&quot;&gt;nvm&lt;/a&gt; and &lt;a href=&quot;https://github.com/rbenv/rbenv&quot;&gt;rbenv&lt;/a&gt;, but I realized that I &lt;em&gt;shouldn‚Äôt&lt;/em&gt; need to use those tools
when using containers. I need those tools for my local development environment
so I can switch between projects, but not when I can use a container image that
has the language versions I need already installed for &lt;em&gt;this&lt;/em&gt; project.&lt;/p&gt;
&lt;p&gt;Enter: &lt;a href=&quot;https://circleci.com/docs/2.0/circleci-images&quot;&gt;CircleCI docker images&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;CircleCI provides some great container images with good tools included like
&lt;a href=&quot;https://github.com/jwilder/dockerize&quot;&gt;dockerize&lt;/a&gt;, &lt;a href=&quot;https://packages.debian.org/stretch/xvfb&quot;&gt;xvfb&lt;/a&gt;, and &lt;a href=&quot;http://chromedriver.chromium.org/&quot;&gt;chromedriver&lt;/a&gt;, which saves you from having to worry
about installing those manually. Let‚Äôs use their images.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;What is &lt;a href=&quot;https://github.com/jwilder/dockerize&quot;&gt;Dockerize&lt;/a&gt;?&lt;/strong&gt;
It‚Äôs a small bash utility that is used to wait on database containers to be
ready &lt;em&gt;before&lt;/em&gt; trying to have tests run against them.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;What is &lt;a href=&quot;https://packages.debian.org/stretch/xvfb&quot;&gt;xvfb&lt;/a&gt; and &lt;a href=&quot;http://chromedriver.chromium.org/&quot;&gt;chromedriver&lt;/a&gt;?&lt;/strong&gt;
Good question, I don‚Äôt really understand it, but I know I need it to allow some
browser tests to run. Just roll with it.&lt;/p&gt;
&lt;p&gt;In my case, my project is using Ruby 2.5.1 but unfortunately requires Node 6.x
because of an older node-based asset pipeline; CircleCI‚Äôs Ruby image
&lt;a href=&quot;https://github.com/CircleCI-Public/circleci-dockerfiles/blob/16a3d488ce42027c38f6ef5f419e2eaf9df2f35b/ruby/images/2.5.1-stretch/node/Dockerfile#L36&quot;&gt;Dockerfile&lt;/a&gt; includes Node 8.x. I can‚Äôt run &lt;code class=&quot;language-text&quot;&gt;npm install&lt;/code&gt; under Node 8.x.
That‚Äôs OK though, because we can separate them with containers.&lt;/p&gt;
&lt;h2&gt;Let‚Äôs try this out&lt;/h2&gt;
&lt;p&gt;According to CircleCI docs, I‚Äôll need to define multiple jobs. I‚Äôll try to keep
the jobs focused on one task. Let‚Äôs start with two tasks:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Bundle Install&lt;/li&gt;
&lt;li&gt;NPM Install. The production environment doesn‚Äôt use Yarn, so I shouldn‚Äôt
either in CI yet. Also, Node 6.x doesn‚Äôt ship with npm that supports
&lt;code class=&quot;language-text&quot;&gt;package-lock.json&lt;/code&gt;. ::sigh:: I‚Äôll leave some commented-out code though in
case you can use it.&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;jobs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;bundle-install&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;working_directory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
    &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/ruby&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;2.5.1&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;browsers
        &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_JOBS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_RETRY&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_PATH&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; vendor/bundle
          &lt;span class=&quot;token key atrule&quot;&gt;DATABASE_URL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;postgresql://root@localhost/my_project_test?pool=5&quot;&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;restore_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; bundle&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; arch &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; checksum &quot;Gemfile.lock&quot; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;# We add &quot;arch&quot; as a key since some gems compile native code, like&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;# nokogiri. If for whatever reason CircleCI runs the job on a machine&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;# with a different architecture, the cache would be invalid.&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bundle install
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;save_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; ./vendor/bundle
          &lt;span class=&quot;token key atrule&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bundle&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; arch &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; checksum &quot;Gemfile.lock&quot; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;persist_to_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; .
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; vendor/bundle

  &lt;span class=&quot;token key atrule&quot;&gt;npm-install&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;working_directory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
    &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/node&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
      &lt;span class=&quot;token comment&quot;&gt;# Enable when using npm5+&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;# - restore_cache:&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#     keys:&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#     - node-modules-{{ arch }}-{{ checksum &quot;package-lock.json&quot; }}&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#       We add &quot;arch&quot; as a key since some packages compile native code, like&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#       node-sass. If for whatever reason CircleCI runs the job on a machine&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#       with a different architecture, the cache would be invalid.&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; npm &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;version
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; node &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;version
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; npm install
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; mkdir &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;p public/assets/frontend
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; npm run production
      &lt;span class=&quot;token comment&quot;&gt;# Enable when using npm5+&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;# - save_cache:&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#     paths:&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#       - node_modules&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#     key: node-modules-{{ arch }}-{{ checksum &quot;package-lock.lock&quot; }}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;persist_to_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; .
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; node_modules
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; public/assets/frontend&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Looking good so far. I‚Äôm not doing anything special but there are a couple of
concepts we should know:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Cache: This is used to save dependencies across runs.&lt;/li&gt;
&lt;li&gt;Workspace: This is used to save data as the workflow continues, so the next
step can use the results of a previous step like &lt;code class=&quot;language-text&quot;&gt;node_modules&lt;/code&gt; and
&lt;code class=&quot;language-text&quot;&gt;vendor/bundle&lt;/code&gt;. We attach the workspace at the beginning, and then persist
some resulting files to the workspace at the end of the task.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For my project, we when we run &lt;code class=&quot;language-text&quot;&gt;npm run production&lt;/code&gt;, it compiles assets into
the folder &lt;code class=&quot;language-text&quot;&gt;public/assets/frontend&lt;/code&gt;. I need that to run my tests later.&lt;/p&gt;
&lt;p&gt;Let‚Äôs move on to the test step:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;working_directory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
  &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# The first image is the primary image. This is where the commands below&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# will run within.&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/ruby&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;2.5.1&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;browsers
      &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_JOBS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_RETRY&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_PATH&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; vendor/bundle
        &lt;span class=&quot;token key atrule&quot;&gt;DATABASE_URL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;postgresql://root@localhost/my_project_test?pool=5&quot;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# For more information about how these images work, check our their READMEs&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# https://hub.docker.com/r/circleci/ruby/&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# https://hub.docker.com/r/circleci/postgres/&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# https://hub.docker.com/_/postgres/&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/postgres&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;9.3&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;alpine&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ram
      &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;POSTGRES_USER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; root
        &lt;span class=&quot;token key atrule&quot;&gt;POSTGRES_DB&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; my_project_test
  &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; dockerize &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;wait tcp&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//localhost&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;5432 &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;timeout 1m
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; cp config/secrets.yml&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;.example&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; cp config/database.yml&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;.example&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bundle install
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; RAILS_ENV=test bundle exec rake db&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;schema&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;load &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;trace
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token scalar string&quot;&gt;
        mkdir -p ~/repo/tmp/test-results/rspec
        bundle exec rspec --profile 10 --format RspecJunitFormatter --out ~/repo/tmp/test-results/rspec/results.xml --format progress&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;store_artifacts&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo/tmp/screenshots
        &lt;span class=&quot;token key atrule&quot;&gt;destination&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;screenshots
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;store_test_results&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo/tmp/test&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;results&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Since we‚Äôre attaching the workspace, we can assume that we have our
&lt;code class=&quot;language-text&quot;&gt;node_modules&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;vendor/bundle&lt;/code&gt; already present. We still run &lt;code class=&quot;language-text&quot;&gt;bundle
install&lt;/code&gt;, but it‚Äôs incredibly quick since the workspace already has the info‚Äî
bundler just needs to recognize it.&lt;/p&gt;
&lt;p&gt;I want to point out another CircleCI feature: &lt;a href=&quot;https://circleci.com/docs/2.0/collect-test-data/&quot;&gt;collecting test metadata&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;There‚Äôs a popular XML format for expressing test outputs and metadata, like the
time it took to run each test; &lt;a href=&quot;https://www.ibm.com/support/knowledgecenter/en/SSQ2R2_14.1.0/com.ibm.rsar.analysis.codereview.cobol.doc/topics/cac_useresults_junit.html&quot;&gt;JUnit&lt;/a&gt; popularized this format. To get it for
your tests, you can install a gem. All of the information is on the CircleCI
site.&lt;/p&gt;
&lt;p&gt;This feature gives us this:&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/circleci2-failures-b861095cab0966295bbe2e97e6b499e8-c1211.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 62.52465483234714%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACiUlEQVQ4y4XQW08TURAH8P0MBqUUoUC30G6BFjR2G1KIYCqXAt4+hsWEi4nyoOU7iEEfvNWARoXIxYQHTHggQgJtARPR+GRMSne7bUloaaH8nXNaKuCDD7+cOTOzu7MjaIE1KKqKWCwGjUQoVlUFiUQCiqIgHA5D0WKIUo3lkru72M1jsapp9HwU8cQO9cQhpAGk0hnspdNIZzJcMplEKpXCwcFBTjaL7OEhDkmWxcdRjtX393N9wg59NUMvydALI5EIF6dpotEoVJowEY/T9Bq2t7ehUY7dVfqLQkw9R32MEFv+gsTaKlLrIezlpTfWuVQoyO+sdhTvsfxR7/GYJH98h7Dw2o/PE+NYfPsGK1OT3DIzOYnA7AxCn+YQmptFYGb6X1Rfnf6IpffvqP8DfgcDEKqMVbA3NnD1dhusdbWos9UX2BvsPC/VWgvMFgssVokzSxLP1UgW+J8+gdBxpQ23entwM+9GtycX93RzPR0dpB29nZ241tXJ69c9nlwf1bvbr6LL7UZbczOm/K8gDPd5MXJ3CL6hQfgGc0YofjgwgOE7fbjv9WK47+/po7xvMGeEeh/09+Oe9zY/V+bnIRgqDPyXasxmiCYTKqsqodPrUZKnLy1FCeEn3c8VF5+k00FXoseZoiI8G30EwUZ7amlphsvVBKdThiw7cKGxERLtxGIxQ6J9MVbalZl91GiEKIonmEQTysrL4R8bg8AmstJSq2uq+YRGkR4wiaiorEC5wVCY9PjEp5WVnYeu+CxePB6F4G69DA8t1t3aCha30bRNDgdcsgyX00nkk+RTKHfR0QSL7RImnr+EEAkGEf26iegms8GpzMb/KSS2uY7FpS2ML/zE1rdf+AOXM6a7OjtTggAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Test metadata at the top&quot;
        title=&quot;&quot;
        src=&quot;/static/circleci2-failures-b861095cab0966295bbe2e97e6b499e8-fb8a0.png&quot;
        srcset=&quot;/static/circleci2-failures-b861095cab0966295bbe2e97e6b499e8-1a291.png 148w,
/static/circleci2-failures-b861095cab0966295bbe2e97e6b499e8-2bc4a.png 295w,
/static/circleci2-failures-b861095cab0966295bbe2e97e6b499e8-fb8a0.png 590w,
/static/circleci2-failures-b861095cab0966295bbe2e97e6b499e8-526de.png 885w,
/static/circleci2-failures-b861095cab0966295bbe2e97e6b499e8-fa2eb.png 1180w,
/static/circleci2-failures-b861095cab0966295bbe2e97e6b499e8-c1211.png 1521w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;One more CircleCI feature: &lt;a href=&quot;https://circleci.com/docs/2.0/artifacts/&quot;&gt;storing artifacts&lt;/a&gt;. I think this is normally for
compiled binaries of your app, but I‚Äôm going to use it for storing screenshots
of failed browser-based tests. &lt;a href=&quot;https://guides.rubyonrails.org/v5.1/testing.html#screenshot-helper&quot;&gt;Rails 5.1 system specs&lt;/a&gt; will do this
automatically, but you can also add it to older Rails projects with
&lt;a href=&quot;https://github.com/mattheworiordan/capybara-screenshot&quot;&gt;capybara-screenshot&lt;/a&gt;. All we have to do is tell CircleCI where to find
artifacts.&lt;/p&gt;
&lt;p&gt;Ideally, you could set up two more jobs here:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;job: &lt;code class=&quot;language-text&quot;&gt;lint-rubocop&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;job: &lt;code class=&quot;language-text&quot;&gt;lint-eslint&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;But that‚Äôs up to you.&lt;/p&gt;
&lt;p&gt;Lastly, we need to deploy the app:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;deploy-integration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/ruby&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;2.5.1&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;browsers
      &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_JOBS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_RETRY&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_PATH&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; vendor/bundle
        &lt;span class=&quot;token key atrule&quot;&gt;DATABASE_URL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;postgresql://root@localhost/my_project_test?pool=5&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/postgres&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;9.3&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;alpine&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ram
      &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;POSTGRES_USER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; root
        &lt;span class=&quot;token key atrule&quot;&gt;POSTGRES_DB&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; my_project_test
  &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bundle install
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token scalar string&quot;&gt;
        git config --global user.name &quot;CircleCI&quot;
        bundle exec cap integration deploy&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# copy and paste and modify for each environment&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Nothing special here, but I do want to have CI identify itself as CircleCI for
the Capistrano process that uses git. Just like before, above assumes you‚Äôve
configured the CircleCI project to &lt;a href=&quot;https://circleci.com/docs/2.0/add-ssh-key/&quot;&gt;have the appropriate SSH keys&lt;/a&gt;, so it
can log into the server and perform the needed steps.&lt;/p&gt;
&lt;p&gt;We‚Äôve described the jobs, but we haven‚Äôt described the workflow. Let‚Äôs do that
now.&lt;/p&gt;
&lt;h2&gt;Putting it together&lt;/h2&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;workflows&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;build-test-deploy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;jobs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; bundle&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;install
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; npm&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;install
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;requires&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; bundle&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;install
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; npm&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;install
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;deploy-integration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;requires&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; test
          &lt;span class=&quot;token key atrule&quot;&gt;filters&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;branches&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;token key atrule&quot;&gt;only&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; master&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This describes the shape of your workflow. &lt;code class=&quot;language-text&quot;&gt;bundle-install&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;npm-install&lt;/code&gt;
don‚Äôt have any requirements, so they can run in parallel. &lt;code class=&quot;language-text&quot;&gt;test&lt;/code&gt; requires the
installation steps to succeed before it can run, and &lt;code class=&quot;language-text&quot;&gt;deploy-integration&lt;/code&gt;
requires the test step to succeed, and only run when CI is running from
a commit on the &lt;code class=&quot;language-text&quot;&gt;master&lt;/code&gt; branch.&lt;/p&gt;
&lt;p&gt;That gives us this shape:&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/circleci2-workflow-58ccf7797fc4cc56b820c8fc2f00bf88-4dedc.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 42.87548138639281%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAA8klEQVQoz5VSyXKFMAzj//+TgRSy2wF6UW0XyvJ64aCZTGRLip1uGAY45wx93yPGiNYaiAjM/BrdOI6Y5xnTNJmoCqpYrdWg5wPH3RNE57nTNMwNjZs5HMmIHyKl7hztHO9GLPxp2oWvLKkSok8iumJtG3LKCK7KXcG6bNiWbwNTE67AjwXBR6SY4ecAKmyh1Khzc4UPIpgkBS0ogiSCJRJKJixtEawGbdI0OZAJF0mttZrSBDWhk0YfInJlpEIIUqhN3PhvBFfY8NtzGScnM2T8zvFedBM4QJ8GxxyN0yf/X0A311ffhmyjF9Bl0/T+H/4AajG0vQ2TUXIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Workflow Shape&quot;
        title=&quot;&quot;
        src=&quot;/static/circleci2-workflow-58ccf7797fc4cc56b820c8fc2f00bf88-fb8a0.png&quot;
        srcset=&quot;/static/circleci2-workflow-58ccf7797fc4cc56b820c8fc2f00bf88-1a291.png 148w,
/static/circleci2-workflow-58ccf7797fc4cc56b820c8fc2f00bf88-2bc4a.png 295w,
/static/circleci2-workflow-58ccf7797fc4cc56b820c8fc2f00bf88-fb8a0.png 590w,
/static/circleci2-workflow-58ccf7797fc4cc56b820c8fc2f00bf88-4dedc.png 779w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;Remember, if you also linted the code and had JavaScript tests, you could have
4 jobs running in parallel since they don‚Äôt depend on each other (only
&lt;code class=&quot;language-text&quot;&gt;npm-install&lt;/code&gt; and/or &lt;code class=&quot;language-text&quot;&gt;bundle-install&lt;/code&gt;)&lt;/p&gt;
&lt;h2&gt;YAML&lt;/h2&gt;
&lt;p&gt;We can make it a little better with a little bit of &lt;a href=&quot;https://en.wikipedia.org/wiki/YAML&quot;&gt;YAML&lt;/a&gt; knowledge. With
workflows, you‚Äôll repeat a lot of the same steps, and some of those steps can
be verbose. We can help that.&lt;/p&gt;
&lt;p&gt;For example, we repeated &lt;code class=&quot;language-text&quot;&gt;working_directory: ~/repo&lt;/code&gt; a lot, as well as the
docker images for several jobs. Let‚Äôs shorten it with a named anchor.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;defaults&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token important&quot;&gt;&amp;amp;defaults&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;working_directory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
  &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/ruby&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;2.5.1&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;browsers
      &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_JOBS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_RETRY&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_PATH&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; vendor/bundle
        &lt;span class=&quot;token key atrule&quot;&gt;DATABASE_URL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;postgresql://root@localhost/my_project_test?pool=5&quot;&lt;/span&gt;

    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/postgres&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;9.3&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;alpine&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ram
      &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;POSTGRES_USER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; root
        &lt;span class=&quot;token key atrule&quot;&gt;POSTGRES_DB&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; my_project_test


&lt;span class=&quot;token comment&quot;&gt;## and then use it like this:&lt;/span&gt;

&lt;span class=&quot;token key atrule&quot;&gt;jobs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;bundle-install&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token important&quot;&gt;*defaults&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;...&lt;/span&gt;

  &lt;span class=&quot;token key atrule&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token important&quot;&gt;*defaults&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;...&lt;/span&gt;

  &lt;span class=&quot;token key atrule&quot;&gt;deploy-integration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token important&quot;&gt;*defaults&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Nice!&lt;/p&gt;
&lt;h2&gt;Encore: What if I fork the repo from the client?&lt;/h2&gt;
&lt;p&gt;CircleCI is so helpful; they provide &lt;a href=&quot;https://circleci.com/docs/2.0/env-vars/&quot;&gt;environment variables&lt;/a&gt; for you to check
for situations like this. We can ask some questions against those variables
with something like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;deploy-integration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token important&quot;&gt;*defaults&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token scalar string&quot;&gt;
        set -e
        # only deploy from upstream
        if [ &quot;$CIRCLE_PROJECT_USERNAME&quot; == &quot;ClientName&quot; ]; then
          git config --global user.name &quot;CircleCI&quot;
          bundle install
          bundle exec cap integration deploy
        fi&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Just add a dash of bash to make it work.&lt;/p&gt;
&lt;h2&gt;Wrapping up&lt;/h2&gt;
&lt;p&gt;That concludes this episode of ‚Äúknow your tools‚Äù. If you find anything wrong,
another cool feature, or an alternative approach, then tweet &lt;a href=&quot;https://twitter.com/bernheisel&quot;&gt;@bernheisel&lt;/a&gt; with
your recommendation.&lt;/p&gt;
&lt;p&gt;By the way, there are other great CI platforms like &lt;a href=&quot;https://travis-ci.org/&quot;&gt;Travis CI&lt;/a&gt;, &lt;a href=&quot;https://about.gitlab.com/features/gitlab-ci-cd/&quot;&gt;GitLab&lt;/a&gt;,
&lt;a href=&quot;https://cloud.google.com/cloud-build/&quot;&gt;Google Cloud Build&lt;/a&gt;, and more. Today I‚Äôm using &lt;a href=&quot;https://circleci.com/product/&quot;&gt;CircleCI&lt;/a&gt;, but tomorrow
I might be trying out another platform. If above is way too much for you,
I would consider looking at &lt;a href=&quot;https://travis-ci.org/&quot;&gt;Travis CI&lt;/a&gt;; they did a great job simplifying to
the essentials.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;Here‚Äôs the entire config file for my project. Feel free to modify it for yours!&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Ruby CircleCI 2.0 configuration file&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# Check https://circleci.com/docs/2.0/language-ruby/ for more details&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;

&lt;span class=&quot;token key atrule&quot;&gt;defaults&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token important&quot;&gt;&amp;amp;defaults&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;working_directory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
  &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/ruby&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;2.5.1&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;browsers
      &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_JOBS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_RETRY&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;BUNDLE_PATH&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; vendor/bundle
        &lt;span class=&quot;token key atrule&quot;&gt;DATABASE_URL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;postgresql://root@localhost/project_test?pool=5&quot;&lt;/span&gt;

    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/postgres&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;9.3&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;alpine&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ram
      &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;POSTGRES_USER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; root
        &lt;span class=&quot;token key atrule&quot;&gt;POSTGRES_DB&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; project_test

&lt;span class=&quot;token key atrule&quot;&gt;jobs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;bundle-install&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token important&quot;&gt;*defaults&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;restore_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; bundle&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; arch &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; checksum &quot;Gemfile.lock&quot; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bundle install
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;save_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; ./vendor/bundle
          &lt;span class=&quot;token key atrule&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bundle&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; arch &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; checksum &quot;Gemfile.lock&quot; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;persist_to_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; .
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; vendor/bundle

  &lt;span class=&quot;token key atrule&quot;&gt;npm-install&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;working_directory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
    &lt;span class=&quot;token key atrule&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; circleci/node&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
      &lt;span class=&quot;token comment&quot;&gt;# Enable when using npm5+&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;# - restore_cache:&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#     keys:&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#     - node-modules-{{ arch }}-{{ checksum &quot;package-lock.json&quot; }}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; npm &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;version
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; node &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;version
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; npm install
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; mkdir &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;p public/assets/frontend
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; npm run production
      &lt;span class=&quot;token comment&quot;&gt;# Enable when using npm5+&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;# - save_cache:&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#     paths:&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#       - node_modules&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;#     key: node-modules-{{ arch }}-{{ checksum &quot;package-lock.lock&quot; }}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;persist_to_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; .
          &lt;span class=&quot;token key atrule&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; node_modules
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; public/assets/frontend

  &lt;span class=&quot;token key atrule&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token important&quot;&gt;*defaults&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; dockerize &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;wait tcp&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//localhost&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;5432 &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;timeout 1m
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; cp config/secrets.yml&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;.example&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; cp config/database.yml&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;.example&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bundle install
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; RAILS_ENV=test bundle exec rake db&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;schema&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;load &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;trace
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token scalar string&quot;&gt;
          mkdir -p ~/repo/tmp/test-results/rspec
          bundle exec rspec --profile 10 --format RspecJunitFormatter --out ~/repo/tmp/test-results/rspec/results.xml --format progress&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;store_artifacts&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo/tmp/screenshots
          &lt;span class=&quot;token key atrule&quot;&gt;destination&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;screenshots
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;store_test_results&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo/tmp/test&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;results

  &lt;span class=&quot;token key atrule&quot;&gt;deploy-integration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token important&quot;&gt;*defaults&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token scalar string&quot;&gt;
          set -e
          # only deploy from upstream
          if [ &quot;$CIRCLE_PROJECT_USERNAME&quot; == &quot;ClientName&quot; ]; then
            git config --global user.name &quot;CircleCI&quot;
            bundle install
            bundle exec cap integration deploy
          fi&lt;/span&gt;

  &lt;span class=&quot;token key atrule&quot;&gt;deploy-staging&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token important&quot;&gt;*defaults&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token scalar string&quot;&gt;
          set -e
          # only deploy from upstream
          if [ &quot;$CIRCLE_PROJECT_USERNAME&quot; == &quot;ClientName&quot; ]; then
            git config --global user.name &quot;CircleCI&quot;
            bundle install
            bundle exec cap staging deploy
          fi&lt;/span&gt;

  &lt;span class=&quot;token key atrule&quot;&gt;deploy-production&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token important&quot;&gt;*defaults&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; checkout
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;attach_workspace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ~/repo
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token scalar string&quot;&gt;
          set -e
          # only deploy from upstream
          if [ &quot;$CIRCLE_PROJECT_USERNAME&quot; == &quot;ClientName&quot; ]; then
            git config --global user.name &quot;CircleCI&quot;
            bundle install
            bundle exec cap production deploy
          fi&lt;/span&gt;

&lt;span class=&quot;token key atrule&quot;&gt;workflows&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;build-test-deploy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;jobs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; bundle&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;install
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; npm&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;install
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;requires&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; bundle&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;install
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; npm&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;install
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;deploy-integration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;requires&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; test
          &lt;span class=&quot;token key atrule&quot;&gt;filters&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;branches&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;token key atrule&quot;&gt;only&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; master
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;deploy-staging&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;requires&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; test
          &lt;span class=&quot;token key atrule&quot;&gt;filters&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;branches&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;token key atrule&quot;&gt;only&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; staging
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;deploy-production&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;requires&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; test
          &lt;span class=&quot;token key atrule&quot;&gt;filters&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;branches&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;token key atrule&quot;&gt;only&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; production&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[Querying an Embedded Map in PostgreSQL with Ecto]]></title><description><![CDATA[
Structs and maps are easy to work with in Elixir, but if they are stored
in the database as JSON and accessed via an Ecto Schema, it's not as
clear how to query them. We're going to explore how to do that, and make
it clear and easy.

]]></description><link>https://bernheisel.com/blog/querying-embedded-maps-in-postgresql-with-ecto/</link><guid isPermaLink="false">https://bernheisel.com/blog/querying-embedded-maps-in-postgresql-with-ecto/</guid><pubDate>Fri, 09 Mar 2018 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Structs and maps are easy to work with in Elixir, but if they are stored
in the database as JSON and accessed via an Ecto Schema, it‚Äôs not as
clear how to query them. We‚Äôre going to explore how to do that, and make
it clear and easy.&lt;/p&gt;
&lt;!-- excerpt --&gt;
&lt;p&gt;PostgreSQL has &lt;a href=&quot;https://www.postgresql.org/docs/current/static/functions-json.html&quot;&gt;great support for objects stored as JSON&lt;/a&gt;.
This is useful for those moments when you need to store data that could
be variably structured, such as responses from other services‚Äô APIs, or
data that frequently travels together within your relational tables.&lt;/p&gt;
&lt;p&gt;A common trade-off for mixing scalar column data types (like &lt;code class=&quot;language-text&quot;&gt;varchar&lt;/code&gt;
or &lt;code class=&quot;language-text&quot;&gt;integer&lt;/code&gt;) with column data types that handle more-complicated
objects (like &lt;abbr title=&quot;JavaScript Object Notation&quot;&gt;JSON&lt;/abbr&gt;) is
that &lt;abbr title=&quot;Object-relational Mapping&quot;&gt;ORMs&lt;/abbr&gt; or data mappers
sometimes can‚Äôt introspect on them for you, which means it becomes much
harder to query that data.&lt;/p&gt;
&lt;p&gt;Using Ecto‚Äôs &lt;code class=&quot;language-text&quot;&gt;embedded_schema&lt;/code&gt; helps introspect on those known values,
but it doesn‚Äôt really assist you with querying those fields in SQL. This
is where I became extremely greatful for &lt;a href=&quot;https://hexdocs.pm/ecto/Ecto.Query.html#module-fragments&quot;&gt;Ecto‚Äôs escape
hatch&lt;/a&gt;: &lt;code class=&quot;language-text&quot;&gt;fragment()&lt;/code&gt;.&lt;/p&gt;
&lt;h1&gt;Define the Struct or Map in Ecto&lt;/h1&gt;
&lt;p&gt;Let‚Äôs dive into some code as an example:&lt;/p&gt;
&lt;p&gt;I have a &lt;code class=&quot;language-text&quot;&gt;Vehicle.Photo&lt;/code&gt; schema that has several versions of the photo:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;craigslist_ad&lt;/li&gt;
&lt;li&gt;facebook_ad&lt;/li&gt;
&lt;li&gt;facebook_carousel_ad&lt;/li&gt;
&lt;li&gt;extra_large&lt;/li&gt;
&lt;li&gt;extra_small&lt;/li&gt;
&lt;li&gt;large&lt;/li&gt;
&lt;li&gt;medium&lt;/li&gt;
&lt;li&gt;original&lt;/li&gt;
&lt;li&gt;small&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;We decided to store the versions‚Äô &lt;abbr title=&quot;Uniform Resource
Locators&quot;&gt;URLs&lt;/abbr&gt; inside a map in the database,
because we‚Äôre going to use a set of the URLs at the same time inside of
an HTML &lt;code class=&quot;language-text&quot;&gt;&amp;lt;img srcset /&amp;gt;&lt;/code&gt;. &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images&quot;&gt;You can read more about srcset from
MDN and how it helps with responsive images&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The Ecto migration looks like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; up &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  alter table&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:vehicle_photos&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    add &lt;span class=&quot;token atom symbol&quot;&gt;:standard_urls&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:map&lt;/span&gt;
    add &lt;span class=&quot;token atom symbol&quot;&gt;:facebook_urls&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:map&lt;/span&gt;
    add &lt;span class=&quot;token atom symbol&quot;&gt;:craigslist_urls&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:map&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The Ecto schema looks like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;schema &lt;span class=&quot;token string&quot;&gt;&quot;vehicle_photos&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  field&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:file&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PhotoUploader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

  embeds_one &lt;span class=&quot;token atom symbol&quot;&gt;:standard_urls&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; StandardUrls&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;on_replace:&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:update&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    field&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:extra_large&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    field&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:extra_small&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    field&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:large&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    field&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:medium&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    field&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:original&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    field&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:small&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  embeds_one &lt;span class=&quot;token atom symbol&quot;&gt;:facebook_urls&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FacebookUrls&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;on_replace:&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:update&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    field&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:hero_ad&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    field&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:carousel_ad&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  embeds_one &lt;span class=&quot;token atom symbol&quot;&gt;:craigslist_urls&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; CraigslistUrls&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;on_replace:&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:update&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    field&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:ad&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Since this is a known structure, Ecto can introspect on the JSON values and
cast and dump them to the appropriate Elixir data types, which is immensely
helpful. Here I am achieving that by using &lt;code class=&quot;language-text&quot;&gt;embeds_one&lt;/code&gt; and specifying the
struct. Once pulled from the database, Ecto will decode them.&lt;/p&gt;
&lt;p&gt;Other times, you may not be able to do this ahead of time, so the schema
might look like this (the &lt;code class=&quot;language-text&quot;&gt;api_response&lt;/code&gt; field):&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;schema &lt;span class=&quot;token string&quot;&gt;&quot;vehicle_photos&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  field&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:file&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PhotoUploader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  field&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:api_response&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h1&gt;Query the JSON&lt;/h1&gt;
&lt;p&gt;Continuing with the struct example schema, we found out that some of our
URLs weren‚Äôt being populated like we expected, so I had to find those
photos and fix them. How do I query for them since they‚Äôre stored in
PostgreSQL as JSON? We need to drop down into raw SQL:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; where_photo_urls_have_a_null&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;query&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  query
  &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; where&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_q&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fragment&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&quot;
    (facebook_urls IS NULL) OR
    (facebook_urls-&gt;&gt;&apos;ad_version&apos; IS NULL) OR
    (facebook_urls-&gt;&gt;&apos;hero_version&apos; IS NULL) OR
    (craigslist_urls-&gt;&gt;&apos;ad&apos; IS NULL)
    &quot;&quot;&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The SQL operator &lt;code class=&quot;language-text&quot;&gt;-&amp;gt;&amp;gt;&lt;/code&gt; will leverage &lt;a href=&quot;https://www.postgresql.org/docs/current/static/functions-json.html&quot;&gt;PostgreSQL‚Äôs JSON
functions&lt;/a&gt; to retrieve the text or integers that are stored
in the JSON. You can access them using this syntax: &lt;code class=&quot;language-text&quot;&gt;column-&amp;gt;&amp;gt;key&lt;/code&gt;. In
my case, I needed to find if the column was null, or it wasn‚Äôt null,
then to ask if the JSON object has any keys that are null.  This will
work regardless of whether you use an embedded struct or a map, because
PostgreSQL sees it as the same thing: JSON.&lt;/p&gt;
&lt;p&gt;Here‚Äôs an example that checks for substrings:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; where_photo_url_wrong&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;query&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  query
  &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; where&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_q&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fragment&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&quot;
    (facebook_urls-&gt;&gt;&apos;hero_ad&apos; NOT ILIKE ?) OR
    (facebook_urls-&gt;&gt;&apos;carousel_ad&apos; NOT ILIKE ?) OR
    (craigslist_urls-&gt;&gt;&apos;ad&apos; NOT ILIKE ?)
    &quot;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;%facebook_hero_ad%&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;%facebook_carousel_ad%&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;%craigslist_ad%&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h1&gt;Make the Query Composable&lt;/h1&gt;
&lt;p&gt;Above is all I needed for my use case, but I wondered how I could continue
querying those fields in a reusable way. For example, how do I chain these
together in an &lt;code class=&quot;language-text&quot;&gt;OR&lt;/code&gt; statement that uses both of these fragments?&lt;/p&gt;
&lt;p&gt;To do that, I‚Äôll need to extract the &lt;code class=&quot;language-text&quot;&gt;fragment&lt;/code&gt; expressions and put them
into a macro so they can be used within Ecto‚Äôs functions.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyProject&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;SampleQuery&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Fragments &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; Ecto&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Query&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;API&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;only:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;fragment:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

  defmacro photo_urls_have_a_null &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    quote &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
      fragment&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&quot;
        (facebook_urls IS NULL) OR
        (facebook_urls-&gt;&gt;&apos;ad_version&apos; IS NULL) OR
        (facebook_urls-&gt;&gt;&apos;hero_version&apos; IS NULL) OR
        (craigslist_urls-&gt;&gt;&apos;ad&apos; IS NULL)
        &quot;&quot;&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  defmacro photo_urls_not_contain&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;hero_ad_value&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; carousel_ad_value&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ad_value&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    quote &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
      fragment&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&quot;
        (facebook_urls-&gt;&gt;&apos;hero_ad&apos; NOT ILIKE ?) OR
        (facebook_urls-&gt;&gt;&apos;carousel_ad&apos; NOT ILIKE ?) OR
        (craigslist_urls-&gt;&gt;&apos;ad&apos; NOT ILIKE ?)
        &quot;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;#{&lt;/span&gt;unquote&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hero_ad_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;%&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;#{&lt;/span&gt;unquote&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;carousel_ad_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;%&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;#{&lt;/span&gt;unquote&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ad_value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;%&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that those fragments are extracted, let‚Äôs use them:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; MyProject&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;SampleQuery&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Fragments
&lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyProject&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Photo

&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyProject&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;SampleQuery &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; find_bad_photos&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;query &lt;span class=&quot;token operator&quot;&gt;\\&lt;/span&gt; Photo&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    query
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; where&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_p&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; photo_urls_have_a_null&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; or_where&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_p&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; photo_urls_not_contain&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;facebook_hero_ad&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;facebook_carousel_ad&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;craigslist_ad&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; Repo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;all
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Beautiful.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;If you‚Äôd like to check out the code a little more, you can see this
&lt;a href=&quot;https://github.com/dbernheisel/sample_json_ecto_queries&quot;&gt;sample Ecto and Phoenix repo with tests&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This article only explains how to query a JSON object in the database
and how it works with Ecto querying. If you‚Äôre needing to store an array
of maps or structs, then check out Jon‚Äôs post &lt;a href=&quot;https://robots.thoughtbot.com/why-ecto-s-way-of-storing-embedded-lists-of-maps-makes-querying-hard&quot;&gt;Why Ecto‚Äôs Way of
Storing Embedded Lists of Maps Makes Querying Hard&lt;/a&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Testing Random Data in Emails with Bamboo]]></title><description><![CDATA[
Testing a scenario where an app sends an email is easy, but how do you
test something random in an email, like a password reset token? When we
test a function that intentionally returns random data, it's a little
tougher.

]]></description><link>https://bernheisel.com/blog/testing-emails-with-bamboo/</link><guid isPermaLink="false">https://bernheisel.com/blog/testing-emails-with-bamboo/</guid><pubDate>Mon, 16 Oct 2017 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Testing a scenario where an app sends an email is easy, but how do you
test something random in an email, like a password reset token? When we
test a function that intentionally returns random data, it‚Äôs a little
tougher.&lt;/p&gt;
&lt;!-- excerpt --&gt;
&lt;p&gt;In those times, we often tackle the problem by:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Testing behavior and static data, ignoring the dynamic data.&lt;/li&gt;
&lt;li&gt;Using a mock to rid the randomized data, and then test everything.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Let‚Äôs walk through how to do this with
&lt;a href=&quot;https://github.com/thoughtbot/bamboo&quot;&gt;Bamboo&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Bamboo provides test helpers to help you assert behavior and data in
your app. A really common email scenario is sending users password reset
links. The idea behind these reset links is that they‚Äôre &lt;em&gt;secure&lt;/em&gt; and
&lt;em&gt;unique&lt;/em&gt;, and we ensure this by generating a random token and signing it
with user‚Äôs data to make it secure. How do we test this then?&lt;/p&gt;
&lt;p&gt;There are two ways!&lt;/p&gt;
&lt;h2&gt;Use regex to cover the static text and skip dynamic text.&lt;/h2&gt;
&lt;p&gt;Here we are testing the behavior and static data, ignoring the dynamic
data.  Bamboo provides &lt;code class=&quot;language-text&quot;&gt;assert_email_delivered_with()&lt;/code&gt; which accepts a
keyword list of parts of the email, and what those parts should match.
We can match the email entirely by supplying a string like &lt;code class=&quot;language-text&quot;&gt;[subject:
&amp;quot;Password reset link for MyApp&amp;quot;]&lt;/code&gt;, or we can supply a regex, &lt;code class=&quot;language-text&quot;&gt;[text:
~r/reset_token=/)&lt;/code&gt;, and the assertion will check if the regex matches.&lt;/p&gt;
&lt;p&gt;Here‚Äôs a fuller integration test example:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;test &lt;span class=&quot;token string&quot;&gt;&quot;customers can request a password reset link&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;session:&lt;/span&gt; session&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  customer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; insert&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:customer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  session &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
    session
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; visit&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;password_reset_path&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Endpoint&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; fill_in&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:password_reset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:email&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;with:&lt;/span&gt; customer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;email&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; click_on&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Send link&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

  assert_email_delivered_with&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;subject:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Password reset link for MyApp&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  assert_email_delivered_with&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;text_body:&lt;/span&gt; &lt;span class=&quot;token regex&quot;&gt;~r/reset_token=/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  assert_email_delivered_with&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;html_body:&lt;/span&gt; &lt;span class=&quot;token regex&quot;&gt;~r/reset_token=/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Use a mock to rid the random data, and test the whole thing!&lt;/h2&gt;
&lt;p&gt;Here you can guarantee the behavior and (mocked) data, but it‚Äôs a little
more setup.&lt;/p&gt;
&lt;p&gt;Here‚Äôs an example:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# lib/mock_token_generator.ex&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;MockTokenGenerator &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token attribute variable&quot;&gt;@token&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;123&quot;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;# This should match the interface of the real TokenGenerator&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; generate&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;do:&lt;/span&gt; &lt;span class=&quot;token attribute variable&quot;&gt;@token&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;# We&apos;re going to expose this in the mock so we can get the assertion&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;# right&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; token&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;do:&lt;/span&gt; &lt;span class=&quot;token attribute variable&quot;&gt;@token&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;


&lt;span class=&quot;token comment&quot;&gt;# config/config.exs&lt;/span&gt;
config &lt;span class=&quot;token atom symbol&quot;&gt;:my_app&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;token_generator:&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TokenGenerator


&lt;span class=&quot;token comment&quot;&gt;# config/test.exs&lt;/span&gt;
config &lt;span class=&quot;token atom symbol&quot;&gt;:my_app&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;token_generator:&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;MockTokenGenerator


&lt;span class=&quot;token comment&quot;&gt;# web/controllers/password_reset_controller.ex&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PasswordResetController &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token attribute variable&quot;&gt;@generator&lt;/span&gt; Application&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get_env&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:my_app&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:token_generator&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; create&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; params&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;#...&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# use the @generator.generate function&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# do your email thing&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;#...&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;


&lt;span class=&quot;token comment&quot;&gt;# test/features/password_reset_test.exs&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# ...&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;MockTokenGenerator

test &lt;span class=&quot;token string&quot;&gt;&quot;customers can request a password reset link&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;session:&lt;/span&gt; session&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  customer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; insert&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:customer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  session &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
    session
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; visit&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;password_reset_path&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Endpoint&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:new&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; fill_in&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:password_reset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:email&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;with:&lt;/span&gt; customer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;email&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; click_on&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Send link&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

  assert_email_delivered_with&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;subject:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Password reset link for MyApp&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  assert_email_delivered_with&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;text_body:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&quot;
    Here&apos;s the entire body of the text email. You might test the entire
    text version of the email, and use regex to test the HTML version

    Here&apos;s your password reset link: https://myapp.com/password?reset_token=&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;#{&lt;/span&gt;MockTokenGenerator&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;token&lt;span class=&quot;token delimiter punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
  &quot;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  assert_email_delivered_with&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;html_body:&lt;/span&gt; &lt;span class=&quot;token regex&quot;&gt;~r|https://myapp.com/password?reset_token=#{MockTokenGenerator.token}|&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;See? &lt;a href=&quot;https://github.com/thoughtbot/bamboo&quot;&gt;Bamboo&lt;/a&gt; makes it easy. Give
it a shot and let us know what you think.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Lessons From Using Phoenix 1.3]]></title><description><![CDATA[
Phoenix 1.3 introduces contexts, which has been met with some resistance. I've
developed an application using it and learned some lessons.

]]></description><link>https://bernheisel.com/blog/lessons-from-using-phoenix-1-3/</link><guid isPermaLink="false">https://bernheisel.com/blog/lessons-from-using-phoenix-1-3/</guid><pubDate>Tue, 01 Aug 2017 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Phoenix 1.3 introduces contexts, which has been met with some resistance. I‚Äôve
developed an application using it and learned some lessons.&lt;/p&gt;
&lt;!-- excerpt --&gt;
&lt;p&gt;&lt;strong&gt;[WARNING]&lt;/strong&gt; I like contexts.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/homer-backing-up-8b9d64dd7a997f9c55116b167429a478.gif&quot; alt=&quot;me, now, ashamed and hiding because I am probably going against the grain that
other smarter-than-me people likely established already&quot;&gt;&lt;/p&gt;
&lt;p&gt;Phew‚Ä¶ I just wanted to admit that up front. Now that I got that out of the
way, I am going to share my journey about using Phoenix 1.3.0 and contexts.&lt;/p&gt;
&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#experience&quot;&gt;My context&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Lessons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#dontgenerators&quot;&gt;Don‚Äôt use the generators&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#dothedomain&quot;&gt;Embrace the domain vocabulary&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bloated&quot;&gt;Avoid the bloat&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#maybeumbrella&quot;&gt;Consider before umbrellas&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#giveitago&quot;&gt;You should give it a shot&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a name=&quot;experience&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;Experience&lt;/h2&gt;
&lt;p&gt;I worked on a greenfield project and had an opportunity to use Phoenix
1.3.0-rc2. With Phoenix 1.3.0 just released, I thought it might be timely to
inform other developers what it‚Äôs like to work with contexts, and some
recommendations I have after working on a project using contexts for several
months.&lt;/p&gt;
&lt;p&gt;If you don‚Äôt know what a context is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://youtu.be/tMO28ar0lW8?t=12m21s&quot;&gt;watch Chris McCord talk about
it&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;or &lt;a href=&quot;https://martinfowler.com/bliki/BoundedContext.html&quot;&gt;read Martin Fowler‚Äôs explanation of Bounded
Context&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;or &lt;a href=&quot;http://phoenixframework.org/blog/phoenix-1-3-0-released&quot;&gt;read the Phoenix 1.3 release
post&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;or read my tldr version:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;A context is a module that defines the interface between a set of
inter-related models/schemas to the rest of the application (like other
contexts). A context is an internal API that provides opportunity to name
things better and organize code.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A practical example: instead of your controller talking to the database, your
controller will talk to the context, and the context will interface with
necessary functions and schemas and modules to accomplish the task.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;NOTE:&lt;/strong&gt; I did not use 1.3.0-rc3 which changes the &lt;code class=&quot;language-text&quot;&gt;Web&lt;/code&gt; namespace, so I will
skip that part. I think that‚Äôs a good change, but I have no real experience with
those tweaks yet.&lt;/p&gt;
&lt;h2&gt;Lessons&lt;/h2&gt;
&lt;p&gt;&lt;a name=&quot;dontgenerators&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;Don‚Äôt use the generators more than once&lt;/h3&gt;
&lt;p&gt;With Phoenix 1.3, I only recommend using the &lt;code class=&quot;language-text&quot;&gt;phx&lt;/code&gt; generators ONCE in a
greenfield project. After that, ditch them. Ditch them because once you‚Äôve
adjusted the code to your liking (and you‚Äôll definitely need to edit the
generated code), using the generators again may &lt;em&gt;&lt;strong&gt;inject&lt;/strong&gt;&lt;/em&gt; generated code into
your existing files, which likely don‚Äôt follow your patterns anymore.&lt;/p&gt;
&lt;p&gt;Since I‚Äôm recommending against something, let‚Äôs jump into examples and find out
why.&lt;/p&gt;
&lt;p&gt;Here‚Äôs what I had to do with the generated files:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Rewrite the tests because they setup a fixture for the schema.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;This isn‚Äôt a bad idea in itself, but I wanted to use
&lt;a href=&quot;https://github.com/thoughtbot/ex_machina&quot;&gt;ex_machina&lt;/a&gt; for setting up test
scenarios. At first, I thought the generated fixture was a great idea.  I‚Äôm
providing an interface for creating widgets, so I should use it in my tests,
right?&lt;/p&gt;
&lt;p&gt;Here‚Äôs the problem:&lt;/p&gt;
&lt;p&gt;Imagine if someone introduced a bug in &lt;code class=&quot;language-text&quot;&gt;create_widget()&lt;/code&gt;‚Äî now all your tests
that involve inserting a &lt;code class=&quot;language-text&quot;&gt;widget&lt;/code&gt; breaks. That‚Äôs unreasonable, because I‚Äôm not
testing &lt;em&gt;getting to that state&lt;/em&gt; most of the time, I‚Äôm testing the unit of
functionality or integration between functions. Instead, I want the tests for
&lt;code class=&quot;language-text&quot;&gt;create_widget()&lt;/code&gt; to fail (and any reliant integration tests), as opposed to
the &lt;strong&gt;WHOLE TEST SUITE&lt;/strong&gt; breaking and thus freaking me out. When the whole
test suite breaks, it‚Äôs harder to discern where the problem is.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Separate the schema-specific tests into their own test file.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The new context organization only generates a test file for the &lt;em&gt;context&lt;/em&gt;, and
not a schema. As I kept building the application, it became evident that the
context file and context test file were getting too large. I felt compelled to
isolate and organize this big bag-o‚Äô-functions into smaller bags-o‚Äô-functions.
I decided to start splitting the tests into different schema-related files,
like &lt;code class=&quot;language-text&quot;&gt;{context}/{schema}_test.exs&lt;/code&gt;. Since I split the test files, it became
clearer where I should place tests for custom changeset functions as well.&lt;/p&gt;
&lt;p&gt;I also want to be more careful about how I use &lt;code class=&quot;language-text&quot;&gt;describe&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;test&lt;/code&gt; blocks,
since ExUnit doesn‚Äôt support nested &lt;code class=&quot;language-text&quot;&gt;describe&lt;/code&gt; or context blocks.  The
generated test names were also a bit long for my taste, so I moved the
function name to the &lt;code class=&quot;language-text&quot;&gt;describe&lt;/code&gt; block, and then used the test title to
describe the context and the expected result.&lt;/p&gt;
&lt;p&gt;Lastly, the generated style was ‚Ä¶ different.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I don‚Äôt like aliasing modules in the middle of the file. I feel
they belong at the top of the file.&lt;/li&gt;
&lt;li&gt;I keep module attributes near the top of the file.&lt;/li&gt;
&lt;li&gt;I avoid the function parenthesis unless I need them.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Here is an example of how I changed things:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# BEFORE&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# test/my_app/things_test.exs&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ThingsTest &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;use&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DataCase
&lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Things

describe &lt;span class=&quot;token string&quot;&gt;&quot;widgets&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Things&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Widget

  &lt;span class=&quot;token attribute variable&quot;&gt;@valid_attrs&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token attribute variable&quot;&gt;@update_attrs&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token attribute variable&quot;&gt;@invalid_attrs&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; widget_fixture&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;attrs &lt;span class=&quot;token operator&quot;&gt;\\&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; widget&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
      attrs
      &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; Enum&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;into&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attribute variable&quot;&gt;@valid_attrs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; Things&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;create_widget&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    widget
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  test &lt;span class=&quot;token string&quot;&gt;&quot;list_widgets/0 returns all widgets&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    widget_one &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; widget_fixture&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    widget_two &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; widget_fixture&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    assert Things&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;list_widgets&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;widget_one&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; widget_two&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;# I added this, just to go along with their style and to show&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;# what a typical new developer would do with this existing pattern&lt;/span&gt;
  test &lt;span class=&quot;token string&quot;&gt;&quot;list_widgets/1 returns all widgets limited by list of id&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    widget_one &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; widget_fixture&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    _widget_two &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; widget_fixture&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    assert Things&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;list_widgets&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;widget_one&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;widget_one&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;#...&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# AFTER&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# test/my_app/things/widget_test.exs&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Things&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;WidgetTest &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;use&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DataCase
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Factory
&lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Things
&lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Things&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Widget

describe &lt;span class=&quot;token string&quot;&gt;&quot;list_widgets&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  test &lt;span class=&quot;token string&quot;&gt;&quot;returns all widgets&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;widget_one&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; widget_two&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; insert_pair&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:widget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    assert Things&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;list_widgets &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;widget_one&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; widget_two&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  test &lt;span class=&quot;token string&quot;&gt;&quot;when given list of ids, returns all widgets in ids&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;widget_one&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _widget_two&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; insert_pair&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:widget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    assert Things&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;list_widgets&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;widget_one&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;widget_one&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;#...&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I like this so much better, and I‚Äôm afraid that just going with the generated
pattern will lead newer developers down a path of bloated files.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;It‚Äôs more apparent to me in Phoenix 1.3.0 that the generators are much more a
teaching tool for new developers than meant to be used in an ongoing fashion
throughout a project‚Äôs lifetime. If you‚Äôve formed your opinion, or your
organization has a coding style within Phoenix, then you might appreciate
knowing you can customize the templates that the generators will use. You can do
this by copying them out of &lt;code class=&quot;language-text&quot;&gt;deps/phoenix/priv/templates&lt;/code&gt; and into your
project‚Äôs &lt;code class=&quot;language-text&quot;&gt;priv/templates&lt;/code&gt; folder. That‚Äôs pretty awesome.&lt;/p&gt;
&lt;p&gt;Recap: for new developers, Phoenix‚Äôs new generators are a great learning tool,
but I don‚Äôt recommend using them after the first use.&lt;/p&gt;
&lt;p&gt;&lt;a name=&quot;dothedomain&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;Embrace the domain vocabulary&lt;/h3&gt;
&lt;p&gt;I realized that my understanding of contexts at the time was flawed, and that
many of the examples out in the blog-o-sphere were not helpful for me when I was
in the trenches myself.&lt;/p&gt;
&lt;p&gt;I imagine that most (all?) projects have their own domain AND vocabulary, and to
be readable for folks in that domain it is helpful to share that vocabulary.&lt;/p&gt;
&lt;p&gt;This coming example may not apply to you, but this is the beauty of contexts:
your needs WILL differ and your domain vocabulary will help determine how to
organize your code.&lt;/p&gt;
&lt;p&gt;The project I was working on had different terms for their warehouse workers:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Operators&lt;/li&gt;
&lt;li&gt;Supervisors&lt;/li&gt;
&lt;li&gt;Admins&lt;/li&gt;
&lt;li&gt;SalesAssociate&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This roughly corresponds with a typical &lt;code class=&quot;language-text&quot;&gt;User&lt;/code&gt; schema that &lt;code class=&quot;language-text&quot;&gt;belongs_to&lt;/code&gt; a &lt;code class=&quot;language-text&quot;&gt;Role&lt;/code&gt;
schema. I placed both schemas into a new context called &lt;code class=&quot;language-text&quot;&gt;Accounts&lt;/code&gt;, and all
user-related functions are in that context file. I hesitated with the domain
vocabulary thinking that generic terms were going to be more flexible later.&lt;/p&gt;
&lt;p&gt;As the project evolved, that decision turned out to be a mistake&lt;/p&gt;
&lt;p&gt;Instead of something like this (using a generic term &lt;code class=&quot;language-text&quot;&gt;Accounts&lt;/code&gt; as the context):&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Accounts &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Accounts&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;User

  &lt;span class=&quot;token attribute variable&quot;&gt;@operator_role_id&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
  &lt;span class=&quot;token attribute variable&quot;&gt;@supervisor_role_id&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; list_operators&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryable &lt;span class=&quot;token operator&quot;&gt;\\&lt;/span&gt; User&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    queryable &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; where&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;u&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; u&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;role_id &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;token attribute variable&quot;&gt;@operator_role&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; list_supervisors&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryable &lt;span class=&quot;token operator&quot;&gt;\\&lt;/span&gt; User&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    queryable &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; where&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;u&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; u&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;role_id &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;token attribute variable&quot;&gt;@supervisor_role&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;# ...&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I could have done this (using domain vocabulary as context boundaries):&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Operators &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Accounts&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;User

  &lt;span class=&quot;token attribute variable&quot;&gt;@role_id&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; list&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryable &lt;span class=&quot;token operator&quot;&gt;\\&lt;/span&gt; User&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    queryable &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; where&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;u&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; u&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;role_id &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;token attribute variable&quot;&gt;@role_id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;# ...&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# notice the namespace difference&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Supervisors &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Accounts&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;User

  &lt;span class=&quot;token attribute variable&quot;&gt;@role_id&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; list&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryable &lt;span class=&quot;token operator&quot;&gt;\\&lt;/span&gt; User&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    queryable &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; where&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;u&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; u&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;role_id &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;token attribute variable&quot;&gt;@role_id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;# ...&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This example is really simple, but it starts to show its strength later when you
have other conditionals and need to ask your data more questions.&lt;/p&gt;
&lt;p&gt;With the example above, I‚Äôd actually argue that having one combined context is
preferable because it‚Äôs all we need‚Äîbut, knowing how the application &lt;strong&gt;will&lt;/strong&gt;
grow, and how a lot of questions are asked against the user‚Äôs role, then it‚Äôll
be more apparent having the separated context &lt;strong&gt;will&lt;/strong&gt; be helpful.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Operators &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Activities&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Event

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; update_event&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; params&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    event
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; prepare_event&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;params&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; Repo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;update
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; prepare_event&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; params&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    event &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; Event&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;operator_changeset&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;params&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;# ...&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Supervisors &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Activities&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Event

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; update_event&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; params&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    event
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; prepare_event&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;params&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; Repo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;update
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;# Notice that we&apos;re calling a different changeset&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; prepare_event&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; params&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    event &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; Event&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;supervisor_changeset&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;params&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;# ...&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Above we‚Äôre adding another function that has different permissions regarding
what the user may update on an event. The &lt;code class=&quot;language-text&quot;&gt;supervisor_changeset&lt;/code&gt; will cast all
params, whereas the &lt;code class=&quot;language-text&quot;&gt;operator_changeset&lt;/code&gt; will cast only a subset of params. This
would also be reflected for preparing any forms in templates.&lt;/p&gt;
&lt;p&gt;All the above &lt;em&gt;requires&lt;/em&gt; you to understand the vocabulary before building, which
is the critique I usually hear about contexts: ‚ÄúIt requires more up-front
cognitive thought before I can be productive.‚Äù Prior to 1.3, not knowing domain
up front might not hurt so much because it‚Äôs not built into the structure, but
with 1.3 and presumably later, it may hurt more. Despite that, it‚Äôs &lt;em&gt;totally&lt;/em&gt;
worth it.&lt;/p&gt;
&lt;h3&gt;Avoid the bloat&lt;a name=&quot;bloated&quot;&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Above, I glossed-over what contexts help us achieve: making interfaces between
your abstractions. A context (aka domain interface) will help organize actions.
I &lt;em&gt;love&lt;/em&gt; this.&lt;/p&gt;
&lt;p&gt;I decided in this experiment to &lt;em&gt;really&lt;/em&gt; give contexts a go and roll with the
philosophy. At the same time, I &lt;em&gt;hated&lt;/em&gt; the bloated context that it had become
after needing to interact with several schemas in the same context. At some
point, I had several hundred lines in a context file; it was easy to let the
context file grow. &lt;strong&gt;RESIST&lt;/strong&gt;. Use domain-related vocabulary to keep contexts
small. I had to determine how to organize the code better.&lt;/p&gt;
&lt;p&gt;A technique that helped keep contexts small was to limit them a set of action
verbs, like &lt;code class=&quot;language-text&quot;&gt;list&lt;/code&gt; &lt;code class=&quot;language-text&quot;&gt;prepare&lt;/code&gt; &lt;code class=&quot;language-text&quot;&gt;create&lt;/code&gt; &lt;code class=&quot;language-text&quot;&gt;update&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;delete&lt;/code&gt; (some semblance to
CRUD actions). Outside of those verbs, I put them into supporting modules. For
example, &lt;code class=&quot;language-text&quot;&gt;def list&lt;/code&gt; actually hits the database and returns the list of things‚Äî
it did not return an Ecto query that I could further modify. I saved those
query-building functions for a &lt;code class=&quot;language-text&quot;&gt;Context.Query&lt;/code&gt; module. This helped keep my
&lt;code class=&quot;language-text&quot;&gt;list&lt;/code&gt; function simple, and helped me make composable queries.&lt;/p&gt;
&lt;p&gt;My controllers and other services then &lt;em&gt;only&lt;/em&gt; call functions in context modules.&lt;/p&gt;
&lt;p&gt;For example:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Operators &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;# MyApp.Accounts is now a namespace for schemas, not a context&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Accounts&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;User
  &lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Accounts&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Role
  &lt;span class=&quot;token keyword&quot;&gt;alias&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Operators&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Query

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; list&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryable &lt;span class=&quot;token operator&quot;&gt;\\&lt;/span&gt; User&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    queryable
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;where_operator
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; Repo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;all
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; list_by_latest_event&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryable &lt;span class=&quot;token operator&quot;&gt;\\&lt;/span&gt; User&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    queryable
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;order_by_event_date
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; list
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; list_currently_assigned&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryable &lt;span class=&quot;token operator&quot;&gt;\\&lt;/span&gt; User&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    queryable
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;where_assigned
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; list
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; list_currently_assigned_for_activity&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryable &lt;span class=&quot;token operator&quot;&gt;\\&lt;/span&gt; User&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; activity&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    queryable
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;where_activity&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;activity&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; list_currently_assigned
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;# ...&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;defmodule&lt;/span&gt; MyApp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Operators&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Query &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; Ecto&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Query
  &lt;span class=&quot;token attribute variable&quot;&gt;@role_id&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; where_operator&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryable&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    queryable
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; where&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;q&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; q&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;role_id &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;token attribute variable&quot;&gt;@role_id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; order_by_event_date&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryable&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    queryable
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; join&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:left&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;q&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; event &lt;span class=&quot;token operator&quot;&gt;in&lt;/span&gt; assoc&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;q&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:event&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; order_by&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; event&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;desc:&lt;/span&gt; event&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;inserted_at&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; where_assigned&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryable&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    queryable
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; where&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;q&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; is_nil&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;q&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;unassigned_at&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; where_activity&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryable&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; activity&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    queryable
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; join&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token atom symbol&quot;&gt;:inner&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;q&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; assignment &lt;span class=&quot;token operator&quot;&gt;in&lt;/span&gt; assoc&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;q&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:assignments&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; where&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; assignment&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; assignment&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;activity_id &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt;activity_id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This has been my preferred way of organizing code so far. It encourages less
god-modules that I‚Äôve learned to dislike so much. I believe that Phoenix will
need to be more careful about their generators accidentally encouraging
god-modules, lest they start to look like monolith Rails applications with
models that know too much about the application, except now in a context.&lt;/p&gt;
&lt;p&gt;&lt;a name=&quot;maybeumbrella&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;Consider Before Umbrellas&lt;/h3&gt;
&lt;p&gt;Elixir allows applications to live in umbrellas, which is an awesome concept. If
you‚Äôre not familiar with umbrellas, &lt;a href=&quot;https://elixir-lang.org/getting-started/mix-otp/dependencies-and-umbrella-apps.html&quot;&gt;read up about
it&lt;/a&gt;.
What I love about umbrellas is that it allows me to draw boundaries between
related applications. This is difficult to do in other frameworks and languages,
so the fact that &lt;code class=&quot;language-text&quot;&gt;mix&lt;/code&gt; gives this tool for free is &lt;em&gt;incredible&lt;/em&gt;. Before I heard
about Phoenix contexts, I was drawn to organize my application via umbrellas
because I didn‚Äôt see other tools that made it easy.&lt;/p&gt;
&lt;p&gt;Umbrellas, in a sense, help accomplish the same thing as contexts: it helps you
draw boundaries. The difference is that umbrella applications are about
separating applications instead of APIs.&lt;/p&gt;
&lt;p&gt;A lot of typical web applications don‚Äôt need separated sub-applications. If
you‚Äôre considering one, determine if having separately-deployable applications
fixes or avoids problems, or if the boundaries need to be large enough to
deserve a separation. Avoid jumping to umbrellas like I did earlier if you only
need to organize yourself.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://youtu.be/tMO28ar0lW8?t=27m54s&quot;&gt;Chris gives some good examples of when umbrellas could be a good
option&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;Give It a Shot&lt;a name=&quot;giveitago&quot;&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;At thoughtbot, we pride ourselves in the practices of designing experiences, and
&lt;em&gt;then&lt;/em&gt; developing; &lt;a href=&quot;https://thoughtbot.com/playbook&quot;&gt;that‚Äôs what makes thoughtbot
different&lt;/a&gt;. That process also helps establish
where these boundaries are up front, and it‚Äôs up to the artist to determine
whether it‚Äôs a new context, just a new schema, maybe a new application
altogether, maybe a support module, or none of the above.  Regardless, I believe
Phoenix 1.3 teaches &lt;em&gt;great&lt;/em&gt; ideas that will win in the long run and make
developers think before doing.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Simple Phoenix Text Inputs with Formulator]]></title><description><![CDATA[
Ugh... three lines for a simple text input for a form in Phoenix? How about one
with Formulator?

]]></description><link>https://bernheisel.com/blog/simple-phoenix-text-inputs-with-formulator/</link><guid isPermaLink="false">https://bernheisel.com/blog/simple-phoenix-text-inputs-with-formulator/</guid><pubDate>Fri, 30 Jun 2017 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Ugh‚Ä¶ three lines for a simple text input for a form in Phoenix? How about one
with Formulator?&lt;/p&gt;
&lt;!-- excerpt --&gt;
&lt;p&gt;tldr:&lt;/p&gt;
&lt;p&gt;instead of&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&amp;lt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; label form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:email_address&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; email_input form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:email_address&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; error_tag form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:email_address&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;

&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; label form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:first_name&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; text_input form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:first_name&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; error_tag form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:first_name&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;

&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; label form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:last_name&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; text_input form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:last_name&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; error_tag form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:last_name&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;do this with Formulator:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&amp;lt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:email_address&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;as:&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:email&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:first_name&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:last_name&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!--excerpt--&gt;
&lt;p&gt;&lt;a href=&quot;http://blog.plataformatec.com.br/2016/09/dynamic-forms-with-phoenix/&quot;&gt;Platformatec has a great post about dynamic forms with
Phoenix&lt;/a&gt;
that teaches developers how to extract some common steps out to their own
functions.  This is helpful because developers can skip the tedious parts that
they tend to repeat, which also helps keep style consistent across a larger
framework for an application.&lt;/p&gt;
&lt;p&gt;Other times, developers don‚Äôt need (or want) to build CSS classes into the
back-end, or they want to give more flexibility to designers later, or they just
don‚Äôt want to start from scratch again when they start another application.
(It‚Äôs hard to find that balance sometimes, isn‚Äôt it?)&lt;/p&gt;
&lt;p&gt;Enter: &lt;a href=&quot;https://hexdocs.pm/formulator&quot;&gt;Formulator&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Formulator brings some simplicity to making form inputs for Phoenix, while still
giving the developer some customization options.&lt;/p&gt;
&lt;p&gt;For example, need a specific class for an input field?&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&amp;lt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:email_address&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;as:&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:email&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;class:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;magical-email-input&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;or need to class up a label?&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;elixir&quot;&gt;&lt;pre class=&quot;language-elixir&quot;&gt;&lt;code class=&quot;language-elixir&quot;&gt;&amp;lt;&lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input form&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:email_address&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;as:&lt;/span&gt; &lt;span class=&quot;token atom symbol&quot;&gt;:email&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;class:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;magical-email-input&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;label:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;class:&lt;/span&gt;
&lt;span class=&quot;token string&quot;&gt;&quot;magical-email-label&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you‚Äôre a Rails developer and new to Phoenix, you‚Äôll soon discover that
Phoenix tries to get the form errors closer to the input tags themselves, as
opposed to Rails where error messages are typically flashed near the top of a
page. Getting used to this difference is like putting my toothbrush on the other
side of the sink, I tend to forget the &lt;code class=&quot;language-text&quot;&gt;error_tag&lt;/code&gt; when making a new form and
wonder for about 5 minutes why my test can‚Äôt find the error text I‚Äôm expecting.
Formulator saves me some keystrokes and keeps me from forgetting error tags.&lt;/p&gt;
&lt;p&gt;We made Formulator because we realized we were repeating ourselves waaaay too
much for simple stuff. It‚Äôs a ridiculously simple library (just check out the
&lt;a href=&quot;https://github.com/thoughtbot/formulator&quot;&gt;source code&lt;/a&gt;). Give it and try and
let us know what you think!&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Introduction to Elixir, Phoenix, and Umbrella Apps]]></title><description><![CDATA[Presentation]]></description><link>https://bernheisel.com/blog/intro-to-elixir-phoenix-and-umbrellas/</link><guid isPermaLink="false">https://bernheisel.com/blog/intro-to-elixir-phoenix-and-umbrellas/</guid><pubDate>Mon, 06 Feb 2017 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://docs.google.com/presentation/d/1VQoM62tjpJy_SBwX-6q2GJmW9V09zxquLADxwZ6s0e4/edit?usp=sharing&quot;&gt;Presentation&lt;/a&gt;&lt;/p&gt;
&lt;div&gt;
          &lt;div
            class=&quot;gatsby-resp-iframe-wrapper&quot;
            style=&quot;padding-bottom: 62.291666666666664%; position: relative; height: 0; overflow: hidden;margin-bottom: 1.0725rem&quot;
          &gt;
            &lt;iframe src=&quot;https://docs.google.com/presentation/d/e/2PACX-1vQBgBVnoYhtAco7dG0roWlc6pnaECZ3M1pfYVwAC9VDlFj_PShrAEW0SCydVKGufM5EAWPM04Cxm6By/embed?start=false&amp;amp;loop=false&amp;amp;delayms=3000&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;true&quot; mozallowfullscreen=&quot;true&quot; webkitallowfullscreen=&quot;true&quot; style=&quot;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
          &quot;&gt;&lt;/iframe&gt;
          &lt;/div&gt;
          &lt;/div&gt;</content:encoded></item><item><title><![CDATA[Developer Life After A Bootcamp]]></title><description><![CDATA[Presentation]]></description><link>https://bernheisel.com/blog/developer-life-after-boot-camp/</link><guid isPermaLink="false">https://bernheisel.com/blog/developer-life-after-boot-camp/</guid><pubDate>Mon, 28 Mar 2016 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://docs.google.com/presentation/d/1UK91lesVdxyekFZOMWrd1_oxJj7tGURZcnmNuk3Qjd0/edit?usp=sharing&quot;&gt;Presentation&lt;/a&gt;&lt;/p&gt;
&lt;div&gt;
          &lt;div
            class=&quot;gatsby-resp-iframe-wrapper&quot;
            style=&quot;padding-bottom: 62.291666666666664%; position: relative; height: 0; overflow: hidden;margin-bottom: 1.0725rem&quot;
          &gt;
            &lt;iframe src=&quot;https://docs.google.com/presentation/d/e/2PACX-1vRooaUphFuVbw288iqfBNiH5nwsbAZlTDvYRU7jSINQkLiWcEvqoCnfp4EDMSQPtYoqDTohcpKQQRiF/embed?start=false&amp;amp;loop=false&amp;amp;delayms=3000&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;true&quot; mozallowfullscreen=&quot;true&quot; webkitallowfullscreen=&quot;true&quot; style=&quot;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
          &quot;&gt;&lt;/iframe&gt;
          &lt;/div&gt;
          &lt;/div&gt;</content:encoded></item><item><title><![CDATA[Refactor]]></title><description><![CDATA[
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

Refactoring is scary. I've seen some comments on Twitter indicating that it's generally something really risky, sending tremors through the rest of the team. It's true, it's risky, but it's generally for the better. But I often need to refactor something a bit more scary: <b>life</b>.

]]></description><link>https://bernheisel.com/blog/refactor/</link><guid isPermaLink="false">https://bernheisel.com/blog/refactor/</guid><pubDate>Thu, 24 Sep 2015 00:00:00 GMT</pubDate><content:encoded>&lt;script async src=&quot;//platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
&lt;p&gt;Refactoring is scary. I‚Äôve seen some comments on Twitter indicating that it‚Äôs generally something really risky, sending tremors through the rest of the team. It‚Äôs true, it‚Äôs risky, but it‚Äôs generally for the better. But I often need to refactor something a bit more scary: &lt;b&gt;life&lt;/b&gt;.&lt;/p&gt;
&lt;!-- excerpt --&gt;
&lt;p&gt;Here‚Äôs what I see:&lt;/p&gt;
&lt;blockquote class=&quot;twitter-tweet tw-align-center&quot; lang=&quot;en&quot;&gt;&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;Don&amp;#39;t you hate it when one of your bits of code is pivotal, but also a big scary mess? I need to edit it, but I&amp;#39;m scared to refactor. *sob*&lt;/p&gt;&amp;mdash; Hayden Scott-Baron (@docky) &lt;a href=&quot;https://twitter.com/docky/status/622462937849036800&quot;&gt;July 18, 2015&lt;/a&gt;&lt;/blockquote&gt;
&lt;blockquote class=&quot;twitter-tweet tw-align-center&quot; lang=&quot;en&quot;&gt;&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;&amp;quot;I&amp;#39;m scared. I just did a 40 file refactor and it worked.&amp;quot; -me&amp;#10;&amp;quot;First time?&amp;quot; -&lt;a href=&quot;https://twitter.com/sangster&quot;&gt;@sangster&lt;/a&gt;&amp;#10;&amp;quot;First compile&amp;quot; -me&amp;#10;&amp;quot;...thats not good&amp;quot; - &lt;a href=&quot;https://twitter.com/sangster&quot;&gt;@sangster&lt;/a&gt;&lt;/p&gt;&amp;mdash; Will Long (@DerailedLogic) &lt;a href=&quot;https://twitter.com/DerailedLogic/status/509788312953815040&quot;&gt;September 10, 2014&lt;/a&gt;&lt;/blockquote&gt;
&lt;blockquote class=&quot;twitter-tweet tw-align-center&quot; lang=&quot;en&quot;&gt;&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;One of the reasons I love TDD, Java, and IntelliJ: you are never scared to rename and refactor anything. Big refactorings done in seconds.&lt;/p&gt;&amp;mdash; Sandro Mancuso (@sandromancuso) &lt;a href=&quot;https://twitter.com/sandromancuso/status/621435441271672832&quot;&gt;July 15, 2015&lt;/a&gt;&lt;/blockquote&gt;
&lt;p&gt;Oy. Too bad there aren‚Äôt automated tests for life.&lt;/p&gt;
&lt;p&gt;
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABnElEQVQoz2NgYmBgYWAAkswM2AAjIzsDg72mdHyoY0KoU5CdviQjAyNYC1wFUA2IlhLktVST0ZEWFeDhAnKZmUCiDurirw71Xd/YuH9i2s9r85ti7YCCTMxMcNNBihSF+TbkBB6rjp4UbF3moK0gzAcylYEh3Nfy/5fdMwLN0niZft1bsmBmBUgzE0IziBTi5e50018VbLo1zv50glWwrCBENtBJ/9+rLZsqgzodVH/dWTarNxdFM9yFOlKCzxdVvp9TerQ6eo+Hihw/N1BQhZlhY7HPw11t1zfV/76/YlZPDqrNYIKHlXmqp8anNQ1nWlJf1gZ+TNA1UlMAStirSeyu9GnUEyhV4vt5Z8n86WUIzRAPS4sLnvKU+pRgfKkz9dmy2v8VVrfznJU01YFSTlrSb87Murml9cCEtB/X5tdF2yFpBoY7G7u8uGC8HLefvlaovUGMu0m4Mq+RjBAwTIHSbAwMVkriEUF2ESH2XjY6ooxwx0I8zMzMxAxUx4IsiBzXqOKMOJUAA46JiZGJkRHiHQiACgIBsiiFAACWGGpZZg9zOQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Continue&quot;
        title=&quot;&quot;
        src=&quot;/static/continue-ea4f88855c673ffc797b11b54acecae3-fb8a0.png&quot;
        srcset=&quot;/static/continue-ea4f88855c673ffc797b11b54acecae3-1a291.png 148w,
/static/continue-ea4f88855c673ffc797b11b54acecae3-2bc4a.png 295w,
/static/continue-ea4f88855c673ffc797b11b54acecae3-fb8a0.png 590w,
/static/continue-ea4f88855c673ffc797b11b54acecae3-8e918.png 640w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  &lt;/p&gt;
&lt;h2&gt;Summary&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;TL;DR&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Find what you enjoy.&lt;/li&gt;
&lt;li&gt;Trim what‚Äôs in the way.&lt;/li&gt;
&lt;li&gt;Leaps of faith&lt;/li&gt;
&lt;li&gt;Go camping to get feedback.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Why life is worth retrying&lt;/h2&gt;
&lt;p&gt;I‚Äôve been chasing something for 10 years, but haven‚Äôt quite figured out what it is. I suppose I still don‚Äôt &lt;em&gt;really&lt;/em&gt; know, but it‚Äôs a journey.&lt;/p&gt;
&lt;p&gt;Something clicked in college. College: that time when all your social structure upends from high school and you really ‚Äúfind yourself;‚Äù It‚Äôs a real Louis-and-Clark moment for determining what life should be for yourself. TLC would suggest that you need to &lt;a href=&quot;https://www.youtube.com/watch?v=8WEtxJ4-sh4&quot;&gt;stick to the lakes and the rivers that you‚Äôre used to&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I didn‚Äôt though; I wanted to be a better person. One of my friends once told me that I had zero tact. Guess I was a little too rough around the edges. So I went to Johnson University to chase a Church Leadership and Preaching degree. Didn‚Äôt care much for being a pastor, but I knew that they often possessed the skills for navigating the one thing I was apparently terrible at: &lt;em&gt;people&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Then graduation from college, but I had no real career path. Again, my social structure upended. I found a job at a book company working with eBooks. It‚Äôs pretty neat.&lt;/p&gt;
&lt;p&gt;Reaching back to my interests, computers and logical flow always seemed to pull me in. I exceled at work because it was techy and computer-y. There was a ton of vacuum that I was able to explore and fill the vacuum.&lt;/p&gt;
&lt;p&gt;But that‚Äôs not WHY yet‚Ä¶&lt;/p&gt;
&lt;p&gt;I found what I enjoyed. Once you find what you enjoy, life becomes worth retrying. It‚Äôs not something you chase, it‚Äôs an outcome of enjoying who you are, enjoying what you do, and being enjoyed. Life‚Äôs worth it. I wanted more of it.&lt;/p&gt;
&lt;p&gt;Sorry it‚Äôs not more philosophical, but on the other hand, do you really want it to be? I like simplicity.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/thispleasesme-dcfae71b17ccbbf43a3f86ef029e68a1.gif&quot; alt=&quot;This pleases me&quot;&gt;&lt;/p&gt;
&lt;h2&gt;What are the big blockers?&lt;/h2&gt;
&lt;p&gt;My experience: the blockers are yourself and fear. I think I started caring too much about what other people thought and had a deep problem called &lt;a href=&quot;https://en.wikipedia.org/wiki/Impostor_syndrome&quot;&gt;Imposter Syndrome&lt;/a&gt;. Ultimately, I reasoned somehow that my accomplishments weren‚Äôt valid, and that I constantly needed to be &lt;del&gt;liked&lt;/del&gt; &lt;del&gt;cared&lt;/del&gt; &lt;strong&gt;LOVED&lt;/strong&gt; by everyone. When that happens, you stop knowing about yourself and what &lt;em&gt;you‚Äôre&lt;/em&gt; about since you‚Äôre constantly thinking about what others want.&lt;/p&gt;
&lt;p&gt;Tough place to be.&lt;/p&gt;
&lt;p&gt;Naming the issue helped me. Articulating it. Talking about it. Sharing it. Pushing your emotional boundaries and revealing yourself a bit more---but you know that will come with its own set of risks. That‚Äôs where the fear feels intense.&lt;/p&gt;
&lt;p&gt;It took me &lt;em&gt;years&lt;/em&gt; to do this.&lt;/p&gt;
&lt;h2&gt;Who‚Äôs helping, who‚Äôs not?&lt;/h2&gt;
&lt;p&gt;I‚Äôve been really lucky; I have a distint (not the lucky part) but encouraging family. When I think about families, I have this ideology that they‚Äôre close, bonded, and ‚Äòall up in yo businass‚Äô; but I didn‚Äôt get born into that family. Yes my family cares, but they have their own lives and interests, and time only adds more distance if effort isn‚Äôt applied. In my case, not much effort (regrettably) has been applied.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;They help&lt;/em&gt;. Regardless of all above, they care and they help so they‚Äôre sticking around and I always remind myself to add effort to the relationships. Same goes for friendships.&lt;/p&gt;
&lt;p&gt;At work, there are certain folks that are really enjoyable to be around in moments. They really rock at their jobs and they‚Äôre pleasant to work around. That‚Äôs where it stops though, because on the personal level they are absolute &lt;em&gt;drags&lt;/em&gt; to be around. Debbie-downers, Dan-drowners.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;They don‚Äôt help&lt;/em&gt;. They‚Äôre at work, so you can‚Äôt toss them, and they‚Äôre definitely not worthless. They‚Äôre just not helping you refactor your life to find joy. Honestly, they might just need to refactor their own lives. If you are drawn to them, then help identify areas of refactoring-need but try to remember that they are not a charity, they are people.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/newman-ad29174f306197a6cac334eb40e5d213.gif&quot; alt=&quot;Newman.&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;TL;DR&lt;/strong&gt;: Stay with those that encourage and help you. Lose the ones that don‚Äôt enourage you and add needless stress. Stress is definitely something that needs to refactored OUT.&lt;/p&gt;
&lt;h2&gt;When to refactor life&lt;/h2&gt;
&lt;p&gt;You‚Äôll know. It‚Äôs when you determine if you‚Äôre unhappy or depressed. Pretty simple. No long section here.&lt;/p&gt;
&lt;h2&gt;How I did it&lt;/h2&gt;
&lt;p&gt;Refactor sometimes means &lt;code class=&quot;language-text&quot;&gt;.strip&lt;/code&gt;. Sometimes it means &lt;code class=&quot;language-text&quot;&gt;.sort&lt;/code&gt; or even &lt;code class=&quot;language-text&quot;&gt;.sort!&lt;/code&gt;, or &lt;code class=&quot;language-text&quot;&gt;.order&lt;/code&gt;-ing your priorities according to their &lt;code class=&quot;language-text&quot;&gt;:worth&lt;/code&gt; so you can make &lt;code class=&quot;language-text&quot;&gt;self.satisfied?&lt;/code&gt; true.&lt;/p&gt;
&lt;p&gt;
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; ; max-width: 320px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAADJElEQVQozwEZA+b8AIkwi3owgIEyho4oio0sjXg8iH87jIMwhokohYkphoolg4VDlnR1sJMjiH8xg4AxhHswgIUyioYpg1q/0wBjb51L4eBR3+RkcJpcX4FmlrtfoL9H9Oxek7ViUoddlLVwRolqVI5oQX9GqrRJxMpHy85WnLaFHXlZscgAZYCsUP//V///dIa0bH6be1mXiDKNfoHAaZvCTvr3U///aL/dZ3emSOfkSuvoR+nlRvfuU7fIgBtzWbPJAI40klyauHB9sYgUeGVYkW5rpIknhIsmhHE5f0359G2o0IA4imF0oF/X6U/W21+/11nN3WagxIcffFqzygB8MoJccZ1Rz8lWkZVSs7NZo6BYi6lliLJVqL1J//9nh7N1Lnlar8dsZJtZrsVtW5ZsXJZ3RI17H3NZssgAjjWTeUCLdp7PaKG1dYmsZZauaZKyiTSQgy+GbpnFgmKrezmGX63IapS+W8LWc3SuZYKtXKbBhSN+WrLIAHBOj1OPqYIZdGhUjndboWs0cVLVymCxzmF6pHhEjpgbhnVIjWt9rooigVWwxGZ9qmF6pWikyockgFuxyQBiha9bxMxhg5xU1OBXtLlhkpNj7ehonMZbiKpcpcGKIYBzSIxmh7ODKYBH3d5K//9U2uaKQ5p3JnVXs8gAZHyoaXCjYXmfWN7Wc4WijWSceLXaW7TNeG6sXq/KanCjfSt+ZYawjimJcY2/dKzYeHm1jAxyUJ2xUvr5AGSBrUzn32GhpV2pqmKewmZKgV50kl2rx2Zek199pl61z1p8o2iQuoQifWRbj2Vll2RnmGNtnFbV4VT//wCJOpJfiKB4eKV+QotYpb5umr+FSI+AXqZliLJM8ehaycFT49FlnL6EJX1J4OBR//9Q/f1Q//5V/PtX+voAgSyIbFGWYZ7IZ3WsY466gUGZbTeFblOXfyB+YKfJa5m8baPFcHCtgRt8SNbcT///T/j7T/n8Tv39TP7+ALiVxKh2o6x+rLiPvKR4p6p1pK2owpqku6Rwnq17q7OEtZ5uoLCArrmRuYfGyJLi4pPf347a2o3a2pfk5EN9qshdYHhkAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Just movin boxes&quot;
        title=&quot;&quot;
        src=&quot;/static/sokoban-e444c3c5237b5853176d54b7675bfbee-b3535.png&quot;
        srcset=&quot;/static/sokoban-e444c3c5237b5853176d54b7675bfbee-ee42e.png 148w,
/static/sokoban-e444c3c5237b5853176d54b7675bfbee-1dd3b.png 295w,
/static/sokoban-e444c3c5237b5853176d54b7675bfbee-b3535.png 320w&quot;
        sizes=&quot;(max-width: 320px) 100vw, 320px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  &lt;/p&gt;
&lt;h3&gt;Leap of faith&lt;/h3&gt;
&lt;p&gt;I think this one is universal. You‚Äôll have to take some leapy faiths if you want change. This will look like a couple things:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Leaving behind someone you‚Äôve known for years.&lt;/li&gt;
&lt;li&gt;Moving.&lt;/li&gt;
&lt;li&gt;Get a different job.&lt;/li&gt;
&lt;li&gt;Going somewhere you‚Äôve never been.&lt;/li&gt;
&lt;li&gt;Being social, like going to a meetup.&lt;/li&gt;
&lt;li&gt;Spending gobs of money to go back to school.&lt;/li&gt;
&lt;li&gt;Counseling. Yes, this is a leap of faith.&lt;/li&gt;
&lt;li&gt;Talking about your darkness to someone you don‚Äôt know whether you trust yet.&lt;/li&gt;
&lt;li&gt;Talking about your bright moments to someone in the dark. (careful)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Out of these experiences, you‚Äôll naturally have to refactor. Moving and going to school is obvious. The others are just risking your ‚Äúperfect image‚Äù you‚Äôve crafted. Believe me, it‚Äôs worth breaking that mirror. There is no perfection of self. &lt;a href=&quot;http://www.esvbible.org/Ecclesiastes+1/&quot;&gt;Don‚Äôt chase after the wind&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Be careful about talking about your bright moments to someone who‚Äôs depressed; this may not have the result you‚Äôre hoping. Depression is a maze of confusion.&lt;/p&gt;
&lt;h3&gt;Trim&lt;/h3&gt;
&lt;p&gt;Once you‚Äôve faithfully leaped toward experiences, you‚Äôll have a better idea of what wasn‚Äôt helping. This is your moment to take another leap of faith and &lt;code class=&quot;language-text&quot;&gt;self.strip!&lt;/code&gt; out some of the things that weren‚Äôt helping.&lt;/p&gt;
&lt;p&gt;You know another big thing I trimmed? My beard.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/cutitout-a1e2db0990f168b8ad402e6673c5625d.gif&quot; alt=&quot;Cut it out&quot;&gt;&lt;/p&gt;
&lt;p&gt;Don‚Äôt just keep reflecting on your experiences. Take action on those and keep doing the things you enjoy, and stop doing the things that are not enjoyable (except for adulting; unfortunately that is the curse of adulthood).&lt;/p&gt;
&lt;p&gt;
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 65.17006802721087%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMFBP/EABUBAQEAAAAAAAAAAAAAAAAAAAAC/9oADAMBAAIQAxAAAAHAyYy1ElEv/8QAGxAAAQQDAAAAAAAAAAAAAAAAAQACAxEEECH/2gAIAQEAAQUCZIKEvDktGi4lWv/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABYRAAMAAAAAAAAAAAAAAAAAAAEQEv/aAAgBAgEBPwGyv//EABsQAAEEAwAAAAAAAAAAAAAAAAEAAhARITOR/9oACAEBAAY/ArQtptaj2Mx//8QAGxAAAgMAAwAAAAAAAAAAAAAAABEBIUExUZH/2gAIAQEAAT8hu1ISzS3BIuC2hEk25eUN2f/aAAwDAQACAAMAAAAQgN//xAAWEQEBAQAAAAAAAAAAAAAAAAABABH/2gAIAQMBAT8QAC2//8QAFxEBAQEBAAAAAAAAAAAAAAAAAQARUf/aAAgBAgEBPxBS17f/xAAcEAEBAAIDAQEAAAAAAAAAAAABEQAhMUFhUXH/2gAIAQEAAT8QuC0B1gkoVj1JX8yVSyrce4TjEE86x2CwIIZxox+rXuf/2Q==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Go camping&quot;
        title=&quot;&quot;
        src=&quot;/static/camping-f43c4b7ef9325e335757c1a58c06266f-f8fb9.jpg&quot;
        srcset=&quot;/static/camping-f43c4b7ef9325e335757c1a58c06266f-e8976.jpg 148w,
/static/camping-f43c4b7ef9325e335757c1a58c06266f-63df2.jpg 295w,
/static/camping-f43c4b7ef9325e335757c1a58c06266f-f8fb9.jpg 590w,
/static/camping-f43c4b7ef9325e335757c1a58c06266f-85e3d.jpg 885w,
/static/camping-f43c4b7ef9325e335757c1a58c06266f-d1924.jpg 1180w,
/static/camping-f43c4b7ef9325e335757c1a58c06266f-9452e.jpg 1770w,
/static/camping-f43c4b7ef9325e335757c1a58c06266f-1179d.jpg 2940w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  &lt;/p&gt;
&lt;h3&gt;Go Camping&lt;/h3&gt;
&lt;p&gt;Short feedback loops are good. Don‚Äôt spend too much time exploring and trimming without knowing the path is good.&lt;/p&gt;
&lt;p&gt;For example, when you‚Äôre hiking, if you choose a 10 mile route, you‚Äôre pretty much stuck on that path until you decide it‚Äôs not the one, or you reach the end of it, or you go off the path entirely. I‚Äôm not saying don‚Äôt take long hikes, I‚Äôm just saying that you need to hike 1 mile and decide if the journey is worth it, and if not then you‚Äôve only gone 1 mile and not 10. Turn around and try a different path or make your own.&lt;/p&gt;
&lt;p&gt;Camping is one of those excellent moments to get some feedback from yourself and others. I don‚Äôt know what it is, but something about staring into a fire and eating marshmallows causes a group to talk about deep stuff.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Don‚Äôt trust everything though. Some feedback is biased&lt;/em&gt;.&lt;/p&gt;
&lt;h3&gt;Conclusion&lt;/h3&gt;
&lt;p&gt;I really hope this helps someone out there! Hit me up &lt;a href=&quot;https://twitter.com/bernheisel&quot;&gt;@bernheisel&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Syncing an External USB Drive with a Network NAS]]></title><description><![CDATA[
I recently bought a MacBook Pro with a limited 256GB SSD. It's great, btw, but it requires me to now store all my music, movies, and archival-type files on an external drive. It scares me a bit to have all that stuff on a single USB-powered drive, so I also set up a network NAS that contains 2 mirrored 1TB drives (I salvaged these from my desktop that I sold to buy my MacBook).

Enter problem: I'm lazy. I don't like manually backing everything up. I just want to manage the stuff I put on the external drive, not the NAS drive. Enter solution: BASH script, and launchd.

]]></description><link>https://bernheisel.com/blog/syncing-external-drive-with-network-nas/</link><guid isPermaLink="false">https://bernheisel.com/blog/syncing-external-drive-with-network-nas/</guid><pubDate>Sun, 02 Jun 2013 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;I recently bought a MacBook Pro with a limited 256GB SSD. It‚Äôs great, btw, but it requires me to now store all my music, movies, and archival-type files on an external drive. It scares me a bit to have all that stuff on a single USB-powered drive, so I also set up a network NAS that contains 2 mirrored 1TB drives (I salvaged these from my desktop that I sold to buy my MacBook).&lt;/p&gt;
&lt;p&gt;Enter problem: I‚Äôm lazy. I don‚Äôt like manually backing everything up. I just want to manage the stuff I put on the external drive, not the NAS drive. Enter solution: BASH script, and launchd.&lt;/p&gt;
&lt;!-- excerpt --&gt;
&lt;h2&gt;Overview&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;I write BASH scripts at work, so this was my goto place for automating something I don‚Äôt want to do.&lt;/li&gt;
&lt;li&gt;I use a mac, so I used launchd to kick off the script when relevant&lt;/li&gt;
&lt;li&gt;I want to know when its running, so I used an icon I found on the internet to make it look pretty, and placed the lock folder on my desktop.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Getting the core logic:&lt;/h2&gt;
&lt;p&gt;Here‚Äôs the BASH Script in its entirety:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;
remote&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;/Volumes/Volume_1&quot;&lt;/span&gt;
local&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;/Volumes/Storage&quot;&lt;/span&gt;
LOCK&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;~/Desktop/Syncing
logging&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;~/backup-rsync-log.txt
sleeptime&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;20
maxthreads&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;20
&lt;span class=&quot;token keyword&quot;&gt;set&lt;/span&gt; -e

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; cleanup &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Removing Syncing folder&quot;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;rm&lt;/span&gt; -rf &lt;span class=&quot;token variable&quot;&gt;$LOCK&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;trap&lt;/span&gt; cleanup EXIT
&lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$LOCK&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Backup already running&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;exit&lt;/span&gt; 1 &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
Rez -append ~/backup.rsrc -o ~/Desktop/Syncing/$&lt;span class=&quot;token string&quot;&gt;&apos;Icon\r&apos;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# set the icon to lock folder&lt;/span&gt;
SetFile -a C ~/Desktop/Syncing &lt;span class=&quot;token comment&quot;&gt;# initiate the icon&lt;/span&gt;
SetFile -a V ~/Desktop/Syncing/$&lt;span class=&quot;token string&quot;&gt;&apos;Icon\r&apos;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# hide the icon file&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;sleep&lt;/span&gt; 15 &lt;span class=&quot;token comment&quot;&gt;# give time for mounting&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Check if external drive is mounted&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mount&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;on &lt;span class=&quot;token variable&quot;&gt;${local}&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; /dev/null&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Storage drive is mounted&quot;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;# Check if network NAS is mounted&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mount&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;on &lt;span class=&quot;token variable&quot;&gt;${remote}&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; /dev/null&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Remote NAS is mounted&quot;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Running rsync&quot;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;# loop over all root external drive folders and do an rsync for each, up to a limit&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;dir&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$local&lt;/span&gt;&quot;&lt;/span&gt;/*/&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
      folder&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;basename&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dir&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;# create the folder if it doesn&apos;t exist, keeping permissions&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt; -d &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${remote}&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;${folder}&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; -p &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$remote&lt;/span&gt;&quot;&lt;/span&gt;/&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$folder&lt;/span&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;chown&lt;/span&gt; --reference&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dir&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${remote}&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;${folder}&lt;/span&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;chmod&lt;/span&gt; --reference&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dir&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;${remote}&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;${folder}&lt;/span&gt;&quot;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;token string&quot;&gt;&quot;\nStarting rsync &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;date&lt;/span&gt; +%Y%m%d_%H%M%S&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; of&quot;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$dir&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$logging&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;# don&apos;t go crazy with rsync, so limit it&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ps&lt;/span&gt; -ef &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; -c &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;sync&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt; -gt &lt;span class=&quot;token variable&quot;&gt;${maxthreads}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;sleep&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;${sleeptime}&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;# start rsync parallel threads.&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;nohup&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rsync&lt;/span&gt; -avh --delete &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$dir&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$remote&lt;/span&gt;&quot;&lt;/span&gt;/&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$folder&lt;/span&gt;&quot;&lt;/span&gt;/ &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$logging&lt;/span&gt; 2&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;amp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;amp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;wait&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Done&quot;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Remote NAS is NOT mounted&quot;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Storage drive is NOT mounted&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There‚Äôs a good amount of logic in there, so let‚Äôs go through it.&lt;/p&gt;
&lt;p&gt;I don‚Äôt like hardcoding stuff I have to say over and over, so I start by naming the variables in case I need to reuse this code later. The variables are&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;My external hard drive, put into &lt;code class=&quot;language-text&quot;&gt;$local&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;My network NAS drive, put into &lt;code class=&quot;language-text&quot;&gt;$remote&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;My rsync limiter, put into &lt;code class=&quot;language-text&quot;&gt;$maxthreads&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;How long I want rsync to wait before trying to launch another thread, put into &lt;code class=&quot;language-text&quot;&gt;$sleeptime&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Where I want the double-purposed folder, 1) to ensure I only have one of these scripts running at a time, and 2) visually tell me when the script is running; this is put into &lt;code class=&quot;language-text&quot;&gt;$LOCK&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Lastly, so I can debug if needed, I log all the actions into a text file, put into &lt;code class=&quot;language-text&quot;&gt;$logging&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So now that I have everything named. Now it‚Äôs time for some real logic.&lt;/p&gt;
&lt;p&gt;I start out by checking whether my script is already running. I check by attempting to create a folder. If the folder is already created, it‚Äôll fail, and then exit the script. Pretty simple. I can‚Äôt tell you the specifics, but creating a folder is a great way of setting up a lock without conflicts, from what I‚Äôve read online. In my script, I also used the folder as a status to inform me when the script is running. I also thought about creating a simple menubar app that‚Äôll show a spinning gear, but I don‚Äôt really feel like overengineering this.&lt;/p&gt;
&lt;p&gt;So, I have my safety set so I‚Äôm not executing this script over on top of itself. Now I need to determine whether my necessary drives are mounted, I do this by nesting two if statements; one to check if the external drive is mounted, and another to check if the NAS is mounted. Obviously, I don‚Äôt want anything to happen unless the drives are mounted. If they‚Äôre not mounted, I exit.&lt;/p&gt;
&lt;p&gt;Next, I go through the folders in the root of the external drive. I want to be somewhat recursive, so I do a for loop over the root folders on the drive, and start an rsync on each folder. For that to work, I need to make sure the destination folder is created, preferably with the same permissions.&lt;/p&gt;
&lt;p&gt;If you have one root folder with a bunch of subfolders (for example a Music folder with a bunch of Artist subfolders), then it might be good for you to start your loop there so this is a more-effective script.&lt;/p&gt;
&lt;p&gt;Inside every folder, I start an rsync thread distributed among the folders. However, I don‚Äôt want to stress my computer out with a thousand rsync threads, so before I start a new thread, I check to see how many there are and possibly limit it (for me, I arbitrarily chose a 20 thread cap). I determine this by counting how many rsync processes there are, so I execute ps, pipe it to grep to grab what I need. the grep -c flag counts them. Then, I compare it to my previously-defined cap. If it‚Äôs at the limit, then I put it in a while loop that sleeps until the thread count is back down.&lt;/p&gt;
&lt;p&gt;If you‚Äôre familiar with command line operations, then you should read up on the rsync manual (run ‚Äúman rsync‚Äù in the terminal). There‚Äôs a lot of nifty things you can do with this, for example, you can backup over SSH or SFTP. I opted for the flags -a (archive, aka carry over all the permissions and recurse any subdirectories), -v (be verbose, I want this so I can catch everything it‚Äôs doing and redirect that to my log file in &lt;code class=&quot;language-text&quot;&gt;$logging&lt;/code&gt;), and -h (output human-readable stuff, so I don‚Äôt have to count the zeros in all the file sizes).&lt;/p&gt;
&lt;p&gt;Lastly (as far as the script goes), I want to make sure that whenever my script exits, be it because of an error or anything else, I want my lock/status folder is removed. To accomplish this, I just trapped any kind of exit by executing a small function that removes the lock folder. I put it near the top since it needs to be defined before it could be used. Sometimes I forget that you can create functions in BASH.&lt;/p&gt;
&lt;p&gt;This can be optimized more, but this is where I‚Äôm finished since it achieves my goal of lazily backing up my external hard drive. If you have ideas, drop them in the comments or link out to your explanation!&lt;/p&gt;
&lt;h2&gt;Launching it when I need to.&lt;/h2&gt;
&lt;p&gt;So far, we just have a script that we have to manually kick off in order for it to work. I am still too lazy and instead want my $2000 computer to do the work for me. I was tempted to just use cron to have this script run automatically every 5 minutes, but I thought that was wasteful, since it‚Äôs probable that this script will fail most times it‚Äôs launched. I read around and found Mac‚Äôs tool called launchd, which watches for events, and then launches actions.&lt;/p&gt;
&lt;p&gt;I‚Äôm unfamiliar with plists still, so I really just piggybacked on the &lt;a href=&quot;http://rajeev.name/2008/09/01/automated-osx-backups-with-launchd-and-rsync/&quot;&gt;backs of other giants&lt;/a&gt;. Step 3 on this page shows me how to do this (btw, this  guy solves the same problem here, but does it differently; check his solution out if you‚Äôre interested). Summed up, create a plist, place it in your ~/Library/LaunchAgents folder (tilde represents your home folder), and you‚Äôre done!&lt;/p&gt;
&lt;p&gt;The important bits of the .plist file are the&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Program&lt;/li&gt;
&lt;li&gt;WatchPaths&lt;/li&gt;
&lt;li&gt;LowPriorityIO&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For the program key, I‚Äôm putting the path to the BASH script I created above.&lt;/p&gt;
&lt;p&gt;For the WatchPaths key, I‚Äôm putting in /Volumes directory, since I want this script to launch every time something changes in /Volumes. You could change this to the specific name of your drive as well‚Äîit should work the same and probably better.&lt;/p&gt;
&lt;p&gt;For the LowPriorityIO key, I‚Äôm putting the ‚ÄúYES‚Äù value, so I can tell my computer to not really give a lot of resources to this script. Again, I want this to be nearly invisible to me‚ÄîI‚Äôd hate to feel my computer choke just because of a backup script.&lt;/p&gt;
&lt;p&gt;You still need to add a label to the plist, so call it whatever you want.&lt;/p&gt;
&lt;p&gt;Save it, and place it in your ~/Library/LaunchAgents folder. Restart.&lt;/p&gt;
&lt;p&gt;Now you should have a fully working solution.&lt;/p&gt;
&lt;h2&gt;Making it look &lt;em&gt;slightly&lt;/em&gt; better&lt;/h2&gt;
&lt;p&gt;I‚Äôm not &lt;em&gt;quite&lt;/em&gt; finished yet. I wanted to have my lock folder be pretty with an icon, so I went back to my BASH script and added a couple lines to set the folder icon. I found the commands here &lt;a href=&quot;http://apple.stackexchange.com/questions/6901/changing-a-file-or-folder-icon-using-the-terminal&quot;&gt;Stack Exchange&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;First, grab an icon you want. I supplied one already, but you might have a different preference. I found mine by googling, and you might find it helpful to google with ‚Äúfiletype:png‚Äù so you find an icon with transparency. Then go to &lt;a href=&quot;http://iconverticons.com/online/&quot;&gt;http://iconverticons.com/online/&lt;/a&gt; and convert it to Mac-compatible .icns.&lt;/p&gt;
&lt;p&gt;Second, create a new temporary folder. We‚Äôre going to apply this icon to it so we can grab a file we need from it once it‚Äôs set. Then, right-click the folder, and drag-and-drop the .icns file to the Icon in the top left.&lt;/p&gt;
&lt;p&gt;Third, run a command-line tool against the folder.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DeRez -only icns path/to/tempfolder/$&amp;#39;Icon\r&amp;#39; &amp;gt; backup.rsrc&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;This will give you what you need in order to set the lock folder icon. Store this file somewhere you don‚Äôt look often (I stored mine next to the backup script in my home folder). You can delete the temporary folder now and the original image you downloaded.&lt;/p&gt;
&lt;p&gt;Fourth, modify the backup script to apply the icon.&lt;/p&gt;
&lt;p&gt;After the line where we make the lock folder, run a Rez command and a couple SetFile commands.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Rez -append ~/backup.rsrc -o ~/Desktop/Syncing/$&amp;#39;Icon\r&amp;#39; # set the icon to lock folder&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SetFile -a C ~/Desktop/Syncing # initiate the icon&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SetFile -a V ~/Desktop/Syncing/$&amp;#39;Icon\r&amp;#39; # hide the icon file&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;The first command adds the icon to the lock directory.&lt;/p&gt;
&lt;p&gt;The second command sets the folder attributes, which allows Finder to appreciate your new icon (otherwise, it won‚Äôt recognize that cool icon you added)&lt;/p&gt;
&lt;p&gt;The third command sets the folder to invisible. This is totally optional, but if you ever double-click the ‚ÄúSyncing‚Äù folder you‚Äôll find the icon resource, and that just seems ugly to me‚Äîso let‚Äôs hide it.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;OK! YOU‚ÄôRE DONE!&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;I guess I‚Äôm not so lazy after all.&lt;/p&gt;</content:encoded></item></channel></rss>