<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.9841c30ca4b98edfc4a4.css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}main{display:block}h1{font-size:2em;margin:.67em 0}a{background-color:transparent}img{border-style:none}button{font-family:inherit;font-size:100%;line-height:1.15;margin:0;overflow:visible;text-transform:none}[type=button],[type=reset],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[hidden]{display:none}h1,h2,p{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}ul{list-style:none;margin:0;padding:0}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Droid Sans,Helvetica Neue,Fira Sans,sans-serif;line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid}img{border-style:solid}button{cursor:pointer}h1,h2{font-size:inherit;font-weight:inherit}a{text-decoration:inherit}a,button{color:inherit}button{padding:0;line-height:inherit}img,object,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}ul{list-style-type:disc;padding-left:1rem}body{background:#22292f;color:#fefefe;font-weight:300;margin:0;line-height:1.5;letter-spacing:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Droid Sans,Helvetica Neue,Fira Sans,sans-serif}h1,h2{margin-top:2rem;margin-bottom:1rem;color:#ed6a5a}h1{font-size:1.875rem}h2{font-size:1.5rem}h1:before,h2:before{color:#f6bbb4;margin-right:1rem}h1:before{content:"#";margin-left:-2.25rem}h2:before{content:"##"}p{margin-top:1rem;margin-bottom:1rem}article a{text-decoration:none}article a,article a:focus,article a:visited{color:#f6bbb4}article a:hover{color:#f6bbb4;border-bottom-width:1px;border-color:#31708e;text-decoration:none}nav a{color:#ed6a5a}nav a:focus,nav a:visited{color:#fefefe}nav a:hover{text-decoration:none;border-width:0}.post-header{font-size:1.875rem;font-weight:600}.post-header a{color:#ed6a5a;text-decoration:none}.frontmatter{color:#dae1e7;font-size:.75rem}.frontmatter a{color:#f6bbb4;text-decoration:none}.button{padding:.5rem 1rem;border-radius:.25rem}.bg-red{background-color:#ed6a5a}.bg-teal{background-color:#31708e}.bg-blue-dark{background-color:#324a69}.bg-purple-darker{background-color:#bc9cc2}.hover\:bg-blue-darker:hover{background-color:#1c293b}.border-teal-light{border-color:#568aa2}.hover\:border-white:hover{border-color:#fefefe}.hover\:border-blue-darker:hover{border-color:#1c293b}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.border-2{border-width:2px}.border{border-width:1px}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.inline-flex{display:inline-flex}.hidden{display:none}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-between{justify-content:space-between}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.font-medium{font-weight:500}.font-black{font-weight:900}.h-3{height:.75rem}.h-6{height:1.5rem}.h-7{height:1.75rem}.leading-normal{line-height:1.5}.m-auto{margin:auto}.mx-2{margin-left:.5rem;margin-right:.5rem}.mt-0{margin-top:0}.mb-0{margin-bottom:0}.mr-2{margin-right:.5rem}.mb-2{margin-bottom:.5rem}.ml-2{margin-left:.5rem}.mt-4{margin-top:1rem}.mr-4{margin-right:1rem}.mb-8{margin-bottom:2rem}.max-w-lg{max-width:50rem}.p-2{padding:.5rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.shadow{box-shadow:0 2px 4px 0 rgba(0,0,0,.1)}.shadow-md{box-shadow:0 4px 8px 0 rgba(0,0,0,.12),0 2px 4px 0 rgba(0,0,0,.08)}.fill-current{fill:currentColor}.text-gray-light{color:#afadae}.hover\:text-white:hover,.text-white{color:#fefefe}.text-lg{font-size:1.125rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.hover\:no-underline:hover,.no-underline{text-decoration:none}.align-middle{vertical-align:middle}.w-3{width:.75rem}.w-6{width:1.5rem}.w-16{width:4rem}.w-full{width:100%}@media (min-width:576px){.sm\:text-4xl{font-size:2.25rem}}@media (min-width:992px){.lg\:inline-block{display:inline-block}.lg\:flex{display:flex}.lg\:hidden{display:none}.lg\:items-center{align-items:center}.lg\:h-32{height:8rem}.lg\:mt-0{margin-top:0}.lg\:text-5xl{font-size:3rem}.lg\:w-32{width:8rem}.lg\:w-auto{width:auto}.lg\:w-1\/2{width:50%}}code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.20.9"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script>
  
  
  if(!(parseInt(navigator.doNotTrack) === 1 || parseInt(window.doNotTrack) === 1 || parseInt(navigator.msDoNotTrack) === 1 || navigator.doNotTrack === "yes")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-9152758-1', 'auto', {});
      
      
      
      
      
      }</script><link rel="alternate" type="application/rss+xml" title="David Bernheisel&#x27;s Blog RSS Feed" href="/rss.xml"/><link rel="icon" href="/android-chrome-36x36.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="36x36" href="/android-chrome-36x36.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="48x48" href="/android-chrome-48x48.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="72x72" href="/android-chrome-72x72.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="96x96" href="/android-chrome-96x96.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="144x144" href="/android-chrome-144x144.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="192x192" href="/android-chrome-192x192.png?v=611230f76b9c00b58e5b99e8a179a99d"/><title data-react-helmet="true">Phoenix LiveView: Multi-step forms | David Bernheisel</title><meta data-react-helmet="true" name="description" content="Phoenix LiveView has been a dream to work with so far. I really recommend
looking at it for your next web application. Building Tailwind…"/><link as="script" rel="preload" href="/styles-48fa8a050a65bb8447bd.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-2780d9b33f550a804e84.js"/><link as="script" rel="preload" href="/1777bc0a756dace6068a54d243c7071eee1627a0-9e9727b36538e6264ac4.js"/><link as="script" rel="preload" href="/framework-1cbcc4f69858806ac5db.js"/><link as="script" rel="preload" href="/app-e49f8733b8aee9471acf.js"/><link as="script" rel="preload" href="/webpack-runtime-41d54de024c2d1f9252e.js"/><link as="fetch" rel="preload" href="/page-data/blog/liveview-multi-step-form/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><nav class="flex flex-wrap items-center justify-between p-4 shadow-md bg-teal"><a class="text-white no-underline" href="/"><div class="flex items-center flex-shrink-0 mr-6 text-white"><img src="/static/profile-picture-977b63cbce04bae4479e3185b22bfb1a.jpg" alt="David Bernheisel" class="w-16 h-16 mr-4 border-2 rounded-full shadow-md lg:w-32 lg:h-32 border-teal-light"/><span class="text-2xl font-black sm:text-4xl lg:text-5xl">David Bernheisel</span></div></a><div class="block lg:hidden"><button class="flex items-center px-3 py-2 border rounded text-gray-light border-teal-light hover:text-white hover:border-white"><svg class="w-3 h-3 fill-current" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg></button></div><div class="w-full block lg:mt-0 mt-4 lg:flex lg:items-center lg:w-auto hidden"><a class="text-white no-underline bg-blue-dark hover:border-blue-darker hover:bg-blue-darker text-white font-medium block lg:inline-block mt-4 mr-4 lg:mt-0 shadow rounded py-1 px-3" href="/">Blog</a><a class="text-white no-underline bg-blue-dark hover:border-blue-darker hover:bg-blue-darker text-white font-medium block lg:inline-block mt-4 mr-4 lg:mt-0 shadow rounded py-1 px-3" href="/projects/">Projects</a><a class="block px-3 py-1 mt-4 mr-4 font-medium text-white no-underline rounded shadow bg-blue-dark hover:border-blue-darker hover:bg-blue-darker lg:inline-block lg:mt-0 hover:no-underline" href="https://twitter.com/bernheisel">Twitter</a><div class="py-1 mt-4 lg:mt-0"><a href="/rss.xml"><img class="align-middle h-7" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICAgaWQ9IlJTU2ljb24iCiAgICAgdmlld0JveD0iMCAwIDggOCIgd2lkdGg9IjI1NiIgaGVpZ2h0PSIyNTYiPgoKICA8dGl0bGU+UlNTIGZlZWQgaWNvbjwvdGl0bGU+CgogIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAgICAuYnV0dG9uIHtzdHJva2U6IG5vbmU7IGZpbGw6IG9yYW5nZTt9CiAgICAuc3ltYm9sIHtzdHJva2U6IG5vbmU7IGZpbGw6IHdoaXRlO30KICA8L3N0eWxlPgoKICA8cmVjdCAgIGNsYXNzPSJidXR0b24iIHdpZHRoPSI4IiBoZWlnaHQ9IjgiIHJ4PSIxLjUiIC8+CiAgPGNpcmNsZSBjbGFzcz0ic3ltYm9sIiBjeD0iMiIgY3k9IjYiIHI9IjEiIC8+CiAgPHBhdGggICBjbGFzcz0ic3ltYm9sIiBkPSJtIDEsNCBhIDMsMyAwIDAgMSAzLDMgaCAxIGEgNCw0IDAgMCAwIC00LC00IHoiIC8+CiAgPHBhdGggICBjbGFzcz0ic3ltYm9sIiBkPSJtIDEsMiBhIDUsNSAwIDAgMSA1LDUgaCAxIGEgNiw2IDAgMCAwIC02LC02IHoiIC8+Cgo8L3N2Zz4=" alt="RSS"/></a></div></div></nav><main class="max-w-lg p-4 m-auto text-lg"><article class="blog-post"><h1 class="mb-0 text-3xl">Phoenix LiveView: Multi-step forms</h1><p class="mt-0 mb-8 text-sm frontmatter"><span>Published on <!-- -->May 13, 2020</span><span><span class="mx-2">|</span>14<!-- -->m read</span></p><div><p><a href="https://github.com/phoenixframework/phoenix_live_view">Phoenix LiveView</a> has been a dream to work with so far. I <em>really</em> recommend
looking at it for your next web application. Building Tailwind, Elixir, and
Phoenix LiveView with some Vue sprinklings has been the most enjoyable tech
stack I’ve used in a long while.</p>
<p>One of the benefits I love about LiveView is that it enables me to consolidate
some of common front-end logic into the backend, where the source of truth
belongs. A great example is a form, especially long-running or multi-step forms.</p>
<p>Let me show you what I mean.</p>
<p>
		<video
			src=/long-form-demo.mp4
			width="auto"
			height="auto"
			preload="auto"
			muted="true"
			title="Demo of Multi-step form"
			autoplay
			playsinline
			controls
			loop
		></video>
	</p>
<p>This is accomplished without any AJAX calls, no SPAs, and no page reloads.</p>
<p>I coded this form twice. Let me share with you my journey and some techniques I
used to help organize code.</p>
<h2>The Ugly Way (First pass)</h2>
<p>I coded it all with a single LiveView.</p>
<p>It become quite ugly.</p>
<p>I was still trying to figure out what I wanted on the form and still learning
LiveView generally. Eventually, this LiveView became an ugly 1000+-line horror
show that managed state in multiple places.</p>
<p>It was a single <code class="language-text">&lt;form&gt;</code> that handled all the fields for the database-backed
record, and each step was hidden until you hit “next”, so every change in the
form sends the entire form values.</p>
<p>The EEX was something like this:</p>
<div class="gatsby-highlight" data-language="erb"><pre class="language-erb"><code class="language-erb"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> f <span class="token operator">=</span> form_for<span class="token punctuation">(</span><span class="token variable">@changeset</span><span class="token punctuation">,</span> phx_validate<span class="token punctuation">:</span> <span class="token symbol">:validate</span><span class="token punctuation">,</span> phx_save<span class="token punctuation">:</span> <span class="token symbol">:save</span> <span class="token delimiter punctuation">%></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> <span class="token keyword">unless</span> <span class="token variable">@progress</span><span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"who"</span><span class="token punctuation">,</span> <span class="token keyword">do</span><span class="token punctuation">:</span> <span class="token string">"hidden"</span> <span class="token delimiter punctuation">%></span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%</span><span class="token comment"># my Who-related form inputs </span><span class="token delimiter punctuation">%></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> <span class="token keyword">unless</span> <span class="token variable">@progress</span><span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"what"</span><span class="token punctuation">,</span> <span class="token keyword">do</span><span class="token punctuation">:</span> <span class="token string">"hidden"</span> <span class="token delimiter punctuation">%></span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%</span><span class="token comment"># my What-related form inputs </span><span class="token delimiter punctuation">%></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> <span class="token keyword">unless</span> <span class="token variable">@progress</span><span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"when"</span><span class="token punctuation">,</span> <span class="token keyword">do</span><span class="token punctuation">:</span> <span class="token string">"hidden"</span> <span class="token delimiter punctuation">%></span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%</span><span class="token comment"># my When-related form inputs </span><span class="token delimiter punctuation">%></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre></div>
<p>This is fine when the form is smaller and simpler (but if it’s this simple, you
probably don’t want a multi-step form?). However, I quickly found that
<strong>calculated fields</strong> complicates things pretty quickly.</p>
<p>For example, I need to persist two DateTimes with timezones, but I don’t want to
present that to the user as <code class="language-text">datetime_select</code>s and have them select a timezone
from a drop-down.</p>
<p>Instead I want a date picker, and then separately collect the times and merge it
with the user’s detected timezone (this will later be improved to allow them to
select a timezone and prefer a user’s set timezone while registering). Something
like this:</p>
<div class="gatsby-highlight" data-language="erb"><pre class="language-erb"><code class="language-erb"><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> date_select f<span class="token punctuation">,</span> <span class="token symbol">:date</span> <span class="token delimiter punctuation">%></span></span>
<span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> time_input f<span class="token punctuation">,</span> <span class="token symbol">:start_time</span> <span class="token delimiter punctuation">%></span></span>
<span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> time_input f<span class="token punctuation">,</span> <span class="token symbol">:end_time</span> <span class="token delimiter punctuation">%></span></span></code></pre></div>
<p>so in my params, I would receive something like this:</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">def</span> handle_event<span class="token punctuation">(</span><span class="token string">"validate"</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token string">"myform"</span> <span class="token operator">=></span> params<span class="token punctuation">}</span><span class="token punctuation">,</span> socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
  IO<span class="token punctuation">.</span>inspect params<span class="token punctuation">,</span> <span class="token attr-name">label:</span> <span class="token string">"PARAMS"</span>
  <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span> socket<span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token comment">#=> PARAMS: %{</span>
<span class="token comment">#  "date" => %{"year" => 2020, "month" => 1, "day" => 1},</span>
<span class="token comment">#  "start_time" => "08:00",</span>
<span class="token comment"># " end_time" => "10:00"</span>
<span class="token comment"># }</span></code></pre></div>
<p>There’s a complicated mechanism in the time pickers that made it harder. I
needed to detect what changed:</p>
<ol>
<li>Was it the <code class="language-text">end_time</code>? Then let’s extend the duration as well and accept the
new <code class="language-text">end_time</code>.</li>
<li>Was it the <code class="language-text">start_time</code>? Then let’s back the <code class="language-text">end_time</code> up to the same
duration away from the <code class="language-text">start_time</code>.</li>
<li>At some point, if we accept user input for <code class="language-text">duration</code>, then we we’d want to
extend the <code class="language-text">end_time</code> with the new duration.</li>
</ol>
<p>Now I have some fields, I need to compute them into my event record somehow.
This is how it needs to end up:</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir">record<span class="token punctuation">.</span>start_at_tz <span class="token comment">#=> "America/New_York"</span>
record<span class="token punctuation">.</span>start_at_wall <span class="token comment">#=> ~N[2020-01-01T08:00:00]</span>
record<span class="token punctuation">.</span>start_at_utc <span class="token comment">#=> ~U[2020-01-01T13:00:00Z]</span>

record<span class="token punctuation">.</span>end_at_tz <span class="token comment">#=> "America/New_York"</span>
record<span class="token punctuation">.</span>end_at_wall <span class="token comment">#=> ~N[2020-01-01T10:00:00]</span>
record<span class="token punctuation">.</span>end_at_utc <span class="token comment">#=> ~U[2020-01-01T15:00:00Z]</span>

record<span class="token punctuation">.</span>duration <span class="token comment">#=> 7200 # seconds which is 2 hours</span></code></pre></div>
<p>This is going to be a lot of work!</p>
<p>Here are some drawbacks to having all this logic on the same form with hidden
steps:</p>
<ul>
<li>When the user hits “enter”, the form will try to submit. If you’re on the
first step, you probably don’t want that to submitted yet until they’re
on the last step. You can override this with some JavaScript, but this
non-standard behavior made things more complicated than it should be. I’ll
need the JavaScript to know which step is last, and track which step it’s
currently on. Ugh… I did this and it wasn’t great. I wanted to delete
myself.</li>
<li>When the user is on a different step, you still need to manage all the “state”
of other steps. This is a lot of “weight” to worry about and ensure
<em>doesn’t</em> change.</li>
<li>Testing this was difficult.</li>
</ul>
<p>Let’s not have the giant form all be in one template, or even partials; let’s
split the form up into components.</p>
<h2>Managing the form progress</h2>
<p>I managed the form step progress by defining a <code class="language-text">%Step{}</code> and then writing the
order out in the liveview as a module attribute.</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> MyAppWeb<span class="token punctuation">.</span>EventLive<span class="token punctuation">.</span>Step <span class="token keyword">do</span>
  <span class="token attribute variable">@moduledoc</span> <span class="token string">"Describe a step in the multi-step form and where it can go."</span>
  <span class="token keyword">defstruct</span> <span class="token punctuation">[</span><span class="token atom symbol">:name</span><span class="token punctuation">,</span> <span class="token atom symbol">:prev</span><span class="token punctuation">,</span> <span class="token atom symbol">:next</span><span class="token punctuation">]</span>
<span class="token keyword">end</span>

<span class="token comment"># in the liveview</span>

<span class="token keyword">defmodule</span> MyAppWeb<span class="token punctuation">.</span>EventLive<span class="token punctuation">.</span>New <span class="token keyword">do</span>
  <span class="token attribute variable">@steps</span> <span class="token punctuation">[</span>
    <span class="token punctuation">%</span>Step<span class="token punctuation">{</span><span class="token attr-name">name:</span> <span class="token string">"who"</span><span class="token punctuation">,</span> <span class="token attr-name">prev:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token attr-name">next:</span> <span class="token string">"what"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">%</span>Step<span class="token punctuation">{</span><span class="token attr-name">name:</span> <span class="token string">"what"</span><span class="token punctuation">,</span> <span class="token attr-name">prev:</span> <span class="token string">"who"</span><span class="token punctuation">,</span> <span class="token attr-name">next:</span> <span class="token string">"when"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">%</span>Step<span class="token punctuation">{</span><span class="token attr-name">name:</span> <span class="token string">"when"</span><span class="token punctuation">,</span> <span class="token attr-name">prev:</span> <span class="token string">"what"</span><span class="token punctuation">,</span> <span class="token attr-name">next:</span> <span class="token string">"where"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">%</span>Step<span class="token punctuation">{</span><span class="token attr-name">name:</span> <span class="token string">"where"</span><span class="token punctuation">,</span> <span class="token attr-name">prev:</span> <span class="token string">"when"</span><span class="token punctuation">,</span> <span class="token attr-name">next:</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>

  <span class="token keyword">def</span> mount<span class="token punctuation">(</span>_params<span class="token punctuation">,</span> session<span class="token punctuation">,</span> socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
    socket <span class="token operator">=</span> authenticate<span class="token punctuation">(</span>socket<span class="token punctuation">,</span> session<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom symbol">:with_organizations</span><span class="token punctuation">,</span> <span class="token atom symbol">:with_profile</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    first_step <span class="token operator">=</span> List<span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token attribute variable">@steps</span><span class="token punctuation">)</span>
    event <span class="token operator">=</span> <span class="token punctuation">%</span>Event<span class="token punctuation">{</span><span class="token punctuation">}</span>
    params <span class="token operator">=</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">creator_id:</span> socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span>current_user<span class="token punctuation">.</span>id<span class="token punctuation">}</span>

    <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span>
      socket
      <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:event</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span>
      <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:params</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span>
      <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:changeset</span><span class="token punctuation">,</span> Event<span class="token punctuation">.</span>changeset<span class="token punctuation">(</span>event<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:progress</span><span class="token punctuation">,</span> first_step<span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token keyword">end</span>

  <span class="token comment"># ...snip...</span>
<span class="token keyword">end</span></code></pre></div>
<p>When the underlying live components are finished, they’ll send a message to the
liveview and it will re-assign <code class="language-text">:progress</code>, and the conditionals in the template
will apply/remove the “hidden” class. You’ll see that as you read on.</p>
<p>Let’s chop up the form.</p>
<h2>Extract to LiveComponents</h2>
<p>All this ugly-but-necessary logic should live in “form objects”. In Ecto-land
these can be managed with embedded schemas. These form objects can be
responsible for the state of their own fields, and compute their own values
without affecting other steps’ values.</p>
<p>When the form is submitted, the “save” event the LiveComponent can pass the
completed params up to its parent LiveView. The parent LiveView can track these
params separately, sitting on it until final save, persisted as a draft, or
whatever you need.</p>
<p>This has some benefits:</p>
<ul>
<li>form submission (hitting enter) no longer needs to override default behavior.</li>
<li>isolates testing to it’s own form and LiveComponent.</li>
<li>your form’s “domain” has clearer boundaries.</li>
</ul>
<p>The multi-step form now looks like this:</p>
<div class="gatsby-highlight" data-language="erb"><pre class="language-erb"><code class="language-erb"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> <span class="token keyword">unless</span> <span class="token variable">@progress</span><span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"who"</span><span class="token punctuation">,</span> <span class="token keyword">do</span><span class="token punctuation">:</span> <span class="token string">"hidden"</span> <span class="token delimiter punctuation">%></span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> live_component <span class="token variable">@socket</span><span class="token punctuation">,</span> <span class="token constant">WhoComponent</span><span class="token punctuation">,</span>
      id<span class="token punctuation">:</span> <span class="token string">"who"</span><span class="token punctuation">,</span>
      event<span class="token punctuation">:</span> <span class="token variable">@event</span><span class="token punctuation">,</span>
      current_user<span class="token punctuation">:</span> <span class="token variable">@current_user</span>
    <span class="token delimiter punctuation">%></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> <span class="token keyword">unless</span> <span class="token variable">@progress</span><span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"what"</span><span class="token punctuation">,</span> <span class="token keyword">do</span><span class="token punctuation">:</span> <span class="token string">"hidden"</span> <span class="token delimiter punctuation">%></span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> live_component <span class="token variable">@socket</span><span class="token punctuation">,</span> <span class="token constant">WhatComponent</span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> <span class="token string">"what"</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token variable">@event</span> <span class="token delimiter punctuation">%></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> <span class="token keyword">unless</span> <span class="token variable">@progress</span><span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"when"</span><span class="token punctuation">,</span> <span class="token keyword">do</span><span class="token punctuation">:</span> <span class="token string">"hidden"</span> <span class="token delimiter punctuation">%></span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> live_component <span class="token variable">@socket</span><span class="token punctuation">,</span> <span class="token constant">WhenComponent</span><span class="token punctuation">,</span>
      id<span class="token punctuation">:</span> <span class="token string">"when"</span><span class="token punctuation">,</span>
      event<span class="token punctuation">:</span> <span class="token variable">@event</span><span class="token punctuation">,</span>
      current_user<span class="token punctuation">:</span> <span class="token variable">@current_user</span>
    <span class="token delimiter punctuation">%></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> <span class="token keyword">unless</span> <span class="token variable">@progress</span><span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"where"</span><span class="token punctuation">,</span> <span class="token keyword">do</span><span class="token punctuation">:</span> <span class="token string">"hidden"</span> <span class="token delimiter punctuation">%></span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> live_component <span class="token variable">@socket</span><span class="token punctuation">,</span> <span class="token constant">WhereComponent</span><span class="token punctuation">,</span>
      id<span class="token punctuation">:</span> <span class="token string">"where"</span><span class="token punctuation">,</span>
      submit_text<span class="token punctuation">:</span> t<span class="token punctuation">(</span><span class="token string">"Create"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      event<span class="token punctuation">:</span> <span class="token variable">@event</span>
    <span class="token delimiter punctuation">%></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre></div>
<p>Let’s focus on the <code class="language-text">WhenComponent</code>.</p>
<p>Here’s the big idea:</p>
<ul>
<li>Inside of the WhenComponent, we need our <code class="language-text">embedded_schema</code> to represent and
store the fields we care about on the step.</li>
<li>When loading/updating the component itself, we’re going to initialize the
changeset with the fields from the record.</li>
<li>When handling validation events, we’re going to throw the params into the
changeset and assign the new changeset back.</li>
<li>The computed values will be updated in the changeset and can be assigned
into the socket.</li>
<li>When handling the save event, we’re going to
<code class="language-text">Ecto.Changeset.apply_action(changeset)</code> and ensure it’s valid, and if so,
then tell the parent LiveView that we’re good to proceed. We’ll send the
schema up to the parent LiveView. This schema will contain the computed
fields so it should be easier for the parent to stitch these steps’ params
together into the final schema.</li>
</ul>
<p>Again, the flow should look like this:</p>
<ol>
<li>On mounting, take the Event and pluck the relevant fields out of it to create
a WhenComponent form backed by an embedded_schema.</li>
<li>When the user is on the step, take the changes as they come and let the user
iterate on the form until it’s valid.</li>
<li>When the changeset is valid and the user tries to submit it, pass the final
schema up to the parent LiveView. The parent LiveView can then switch to the
next step.</li>
</ol>
<p>Here the component code:</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> MyAppWeb<span class="token punctuation">.</span>EventLive<span class="token punctuation">.</span>WhenComponent <span class="token keyword">do</span>
  <span class="token keyword">use</span> MyAppWeb<span class="token punctuation">,</span> <span class="token atom symbol">:live_component</span>

  <span class="token attribute variable">@primary_key</span> <span class="token boolean">false</span>
  embedded_schema <span class="token keyword">do</span>
    field <span class="token atom symbol">:timezone</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span>
    field <span class="token atom symbol">:start_at_date</span><span class="token punctuation">,</span> <span class="token atom symbol">:date</span>
    field <span class="token atom symbol">:start_at_time</span><span class="token punctuation">,</span> <span class="token atom symbol">:time</span>
    field <span class="token atom symbol">:start_at</span><span class="token punctuation">,</span> <span class="token atom symbol">:utc_datetime</span>  <span class="token comment"># Not on the form. This is computed</span>

    field <span class="token atom symbol">:end_at_date</span><span class="token punctuation">,</span> <span class="token atom symbol">:date</span>
    field <span class="token atom symbol">:end_at_time</span><span class="token punctuation">,</span> <span class="token atom symbol">:time</span>
    field <span class="token atom symbol">:end_at</span><span class="token punctuation">,</span> <span class="token atom symbol">:utc_datetime</span>  <span class="token comment"># Not on the form. This is computed</span>

    field <span class="token atom symbol">:duration</span><span class="token punctuation">,</span> <span class="token atom symbol">:integer</span>  <span class="token comment"># Not on the form. This is computed and displayed</span>
  <span class="token keyword">end</span>

  <span class="token attribute variable">@impl</span> Phoenix<span class="token punctuation">.</span>LiveComponent
  <span class="token keyword">def</span> update<span class="token punctuation">(</span>assigns<span class="token punctuation">,</span> socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
    whenevent <span class="token operator">=</span> from_event<span class="token punctuation">(</span>assigns<span class="token punctuation">.</span>event<span class="token punctuation">,</span> assigns<span class="token punctuation">.</span>current_user<span class="token punctuation">.</span>profile<span class="token punctuation">.</span>timezone<span class="token punctuation">)</span>
    params <span class="token operator">=</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    changeset <span class="token operator">=</span> changeset<span class="token punctuation">(</span>whenevent<span class="token punctuation">,</span> params<span class="token punctuation">)</span>

    <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span>
      socket
      <span class="token operator">|></span> assign<span class="token punctuation">(</span>assigns<span class="token punctuation">)</span>
      <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:when</span><span class="token punctuation">,</span> whenevent<span class="token punctuation">)</span>
      <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:when_changeset</span><span class="token punctuation">,</span> changeset<span class="token punctuation">)</span>
      <span class="token operator">|></span> assign_computed<span class="token punctuation">(</span>changeset<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">end</span>

  <span class="token attribute variable">@impl</span> Phoenix<span class="token punctuation">.</span>LiveComponent
  <span class="token keyword">def</span> handle_event<span class="token punctuation">(</span><span class="token string">"validate"</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token string">"when_component"</span> <span class="token operator">=></span> params<span class="token punctuation">}</span><span class="token punctuation">,</span> socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
    adjusted_params <span class="token operator">=</span> adjust_time_params<span class="token punctuation">(</span>params<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span>when_changeset<span class="token punctuation">)</span>
    changeset <span class="token operator">=</span> changeset<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span><span class="token keyword">when</span><span class="token punctuation">,</span> adjusted_params<span class="token punctuation">)</span>

    <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span>
      socket
      <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:when_changeset</span><span class="token punctuation">,</span> changeset<span class="token punctuation">)</span>
      <span class="token operator">|></span> assign_computed<span class="token punctuation">(</span>changeset<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">end</span>

  <span class="token attribute variable">@impl</span> Phoenix<span class="token punctuation">.</span>LiveComponent
  <span class="token keyword">def</span> handle_event<span class="token punctuation">(</span><span class="token string">"save"</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token string">"when_component"</span> <span class="token operator">=></span> params<span class="token punctuation">}</span><span class="token punctuation">,</span> socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
    socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span><span class="token keyword">when</span>
    <span class="token operator">|></span> changeset<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    <span class="token operator">|></span> Changeset<span class="token punctuation">.</span>apply_action<span class="token punctuation">(</span><span class="token atom symbol">:insert</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> <span class="token keyword">case</span> <span class="token keyword">do</span>
      <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> record<span class="token punctuation">}</span> <span class="token operator">-></span>
        send<span class="token punctuation">(</span>self<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token atom symbol">:proceed</span><span class="token punctuation">,</span> record<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span> socket<span class="token punctuation">}</span>
      <span class="token punctuation">{</span><span class="token atom symbol">:error</span><span class="token punctuation">,</span> changeset<span class="token punctuation">}</span> <span class="token operator">-></span>
        <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span>
          socket
          <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:when_changeset</span><span class="token punctuation">,</span> changeset<span class="token punctuation">)</span>
          <span class="token operator">|></span> assign_computed<span class="token punctuation">(</span>changeset<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token attribute variable">@impl</span> Phoenix<span class="token punctuation">.</span>LiveComponent
  <span class="token keyword">def</span> handle_event<span class="token punctuation">(</span><span class="token string">"timezone"</span><span class="token punctuation">,</span> detected_timezone<span class="token punctuation">,</span> socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
    params <span class="token operator">=</span> Map<span class="token punctuation">.</span>put<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span>when_changeset<span class="token punctuation">.</span>params<span class="token punctuation">,</span> <span class="token string">"timezone"</span><span class="token punctuation">,</span> detected_timezone<span class="token punctuation">)</span>
    changeset <span class="token operator">=</span> changeset<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span>when_changeset<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span>
      socket
      <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:when_changeset</span><span class="token punctuation">,</span> changeset<span class="token punctuation">)</span>
      <span class="token operator">|></span> assign_computed<span class="token punctuation">(</span>changeset<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">end</span>

  <span class="token attribute variable">@fields</span> <span class="token string">~w[timezone start_at_date start_at_time end_at_date end_at_time duration]a</span>
  <span class="token keyword">def</span> changeset<span class="token punctuation">(</span>whenevent<span class="token punctuation">,</span> params<span class="token punctuation">)</span> <span class="token keyword">do</span>
    whenevent
    <span class="token operator">|></span> Changeset<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token attribute variable">@fields</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> put_stitched_datetime<span class="token punctuation">(</span><span class="token atom symbol">:start_at</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> put_stitched_datetime<span class="token punctuation">(</span><span class="token atom symbol">:end_at</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> ensure_duration<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defp</span> put_stitched_datetime<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> field<span class="token punctuation">)</span> <span class="token keyword">do</span>
    timezone <span class="token operator">=</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:timezone</span><span class="token punctuation">)</span>
    date <span class="token operator">=</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> :<span class="token string">"<span class="token interpolation"><span class="token delimiter punctuation">#{</span>field<span class="token delimiter punctuation">}</span></span>_date"</span><span class="token punctuation">)</span>
    time <span class="token operator">=</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> :<span class="token string">"<span class="token interpolation"><span class="token delimiter punctuation">#{</span>field<span class="token delimiter punctuation">}</span></span>_time"</span><span class="token punctuation">,</span> ~T<span class="token punctuation">[</span><span class="token number">00</span><span class="token atom symbol">:00</span><span class="token atom symbol">:00</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> ndt<span class="token punctuation">}</span> <span class="token operator">=</span> NaiveDateTime<span class="token punctuation">.</span>new<span class="token punctuation">(</span>date<span class="token punctuation">,</span> time<span class="token punctuation">)</span>

    Changeset<span class="token punctuation">.</span>put_change<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> field<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>from_naive!<span class="token punctuation">(</span>ndt<span class="token punctuation">,</span> timezone<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> from_event<span class="token punctuation">(</span>event<span class="token punctuation">,</span> profile_timezone<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token punctuation">%</span>__MODULE__<span class="token punctuation">{</span><span class="token attr-name">timezone:</span> event<span class="token punctuation">.</span>start_at_tz <span class="token operator">||</span> profile_timezone <span class="token operator">||</span> <span class="token string">"Etc/UTC"</span><span class="token punctuation">}</span>
    <span class="token operator">|></span> put_start_at_date<span class="token punctuation">(</span>to_date<span class="token punctuation">(</span>event<span class="token punctuation">.</span>start_at<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> put_start_at_time<span class="token punctuation">(</span>to_time<span class="token punctuation">(</span>event<span class="token punctuation">.</span>start_at<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> put_end_at_date<span class="token punctuation">(</span>to_date<span class="token punctuation">(</span>event<span class="token punctuation">.</span>end_at<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> put_end_at_time<span class="token punctuation">(</span>to_time<span class="token punctuation">(</span>event<span class="token punctuation">.</span>end_at<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> put_end_at<span class="token punctuation">(</span>event<span class="token punctuation">.</span>end_at<span class="token punctuation">)</span>
    <span class="token operator">|></span> put_start_at<span class="token punctuation">(</span>event<span class="token punctuation">.</span>start_at<span class="token punctuation">)</span>
    <span class="token operator">|></span> put_duration<span class="token punctuation">(</span>calc_duration<span class="token punctuation">(</span>event<span class="token punctuation">.</span>start_at<span class="token punctuation">,</span> event<span class="token punctuation">.</span>end_at<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defp</span> ensure_duration<span class="token punctuation">(</span>changeset<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:duration</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
      changeset
    <span class="token keyword">else</span>
      start_at <span class="token operator">=</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:start_at</span><span class="token punctuation">)</span>
      end_at <span class="token operator">=</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:end_at</span><span class="token punctuation">)</span>
      Changeset<span class="token punctuation">.</span>put_change<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:duration</span><span class="token punctuation">,</span> calc_duration<span class="token punctuation">(</span>start_at<span class="token punctuation">,</span> end_at<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defp</span> assign_computed<span class="token punctuation">(</span>socket<span class="token punctuation">,</span> changeset<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token comment"># I need the start_at for the DatePicker component that I render from this</span>
    <span class="token comment"># component. I render the timezone and duration on the form. Lastly I</span>
    <span class="token comment"># compute and render some autocomplete suggestions from the values in the</span>
    <span class="token comment"># changeset.</span>
    socket
    <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:timezone</span><span class="token punctuation">,</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:timezone</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:start_at</span><span class="token punctuation">,</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:start_at</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:duration</span><span class="token punctuation">,</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:duration</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:start_time_autocomplete</span><span class="token punctuation">,</span> start_autocompletes<span class="token punctuation">(</span>changeset<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:end_time_autocomplete</span><span class="token punctuation">,</span> end_autocompletes<span class="token punctuation">(</span>changeset<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token comment"># I'll leave some of these helper functions out, but they're essentially</span>
  <span class="token comment"># providing nil-safety, applying defaults, and calculating from other fields</span>
<span class="token keyword">end</span></code></pre></div>
<h2>Getting the user’s timezone with <code class="language-text">phx-hook</code></h2>
<p>We can estimate what the user’s timezone is by asking the browser. <strong>NOTE</strong> I
don’t recommend you do what I’m doing here. This is a placeholder until I can
spend more time with it. Use it as a learning exercise!</p>
<p>Let’s get the timezone. We’ll need some JavaScript.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">window<span class="token punctuation">.</span>userTimezone <span class="token operator">=</span> Intl<span class="token punctuation">.</span><span class="token function">DateTimeFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolvedOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>timeZone

<span class="token comment">// initialize the Phoenix LiveView socket, and pass this in as a hook:</span>

hooks<span class="token punctuation">.</span>UserTimeZone <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> phoenix <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>phoenixTarget<span class="token punctuation">;</span>
    <span class="token keyword">const</span> els <span class="token operator">=</span> phoenix<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> el <span class="token keyword">of</span> els<span class="token punctuation">)</span> <span class="token punctuation">{</span> el<span class="token punctuation">.</span>value <span class="token operator">=</span> window<span class="token punctuation">.</span>userTimezone<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    phoenix<span class="token punctuation">.</span><span class="token function">pushEventTo</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">"timezone"</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>userTimezone<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<div class="gatsby-highlight" data-language="erb"><pre class="language-erb"><code class="language-erb"><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%</span><span class="token comment"># Timezone in the WhenComponent form </span><span class="token delimiter punctuation">%></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">phx-hook</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserTimeZone<span class="token punctuation">"</span></span> <span class="token attr-name">data-phoenix-target</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> <span class="token variable">@id</span> <span class="token delimiter punctuation">%></span></span><span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user-time-zone<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">phx-update</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ignore<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> hidden_input f<span class="token punctuation">,</span> <span class="token symbol">:timezone</span> <span class="token delimiter punctuation">%></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre></div>
<p>Now when the page is rendered, I’ll get a <code class="language-text">hidden_input</code> populated with the
detected timezone. This will be included in further form changes and params sent
to the LiveView process. Remember to wrap it with a <code class="language-text">phx-update=&quot;ignore&quot;</code> so the
JavaScript-mutated value isn’t overwritten by the backend.</p>
<p>You’ll notice that I’m also using <code class="language-text">pushEventTo</code> after mounting. This is needed
because the user may not have interacted with the form yet to trigger a change,
so until then, I won’t have user’s timezone! I want it pushed immediately so I
can update the form’s changeset.</p>
<p>When handling the event, we’ll merge the timezone with the existing params of
the changeset, and then re-apply the changeset and re-compute fields.</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token attribute variable">@impl</span> Phoenix<span class="token punctuation">.</span>LiveComponent
<span class="token keyword">def</span> handle_event<span class="token punctuation">(</span><span class="token string">"timezone"</span><span class="token punctuation">,</span> detected_timezone<span class="token punctuation">,</span> socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
  params <span class="token operator">=</span> Map<span class="token punctuation">.</span>put<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span>when_changeset<span class="token punctuation">.</span>params<span class="token punctuation">,</span> <span class="token string">"timezone"</span><span class="token punctuation">,</span> detected_timezone<span class="token punctuation">)</span>
  changeset <span class="token operator">=</span> changeset<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span>when_changeset<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span>
    socket
    <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:when_changeset</span><span class="token punctuation">,</span> changeset<span class="token punctuation">)</span>
    <span class="token operator">|></span> assign_computed<span class="token punctuation">(</span>changeset<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token keyword">end</span></code></pre></div>
<h2>Handling sub-form change events</h2>
<p>Handling form change events doesn’t change with this embedded_schema and
component-ized approach. It’s standard Phoenix and Ecto changeset forms, so it’s
not as interesting to look at.</p>
<p>However in my case I need to adjust the parameters that come in, so we’ll look
at that! I need to check to see what changed, and then apply new parameters
based on what changed.</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token attribute variable">@impl</span> Phoenix<span class="token punctuation">.</span>LiveComponent
<span class="token keyword">def</span> handle_event<span class="token punctuation">(</span><span class="token string">"validate"</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token string">"when_component"</span> <span class="token operator">=></span> params<span class="token punctuation">}</span><span class="token punctuation">,</span> socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
  adjusted_params <span class="token operator">=</span> adjust_time_params<span class="token punctuation">(</span>params<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span>when_changeset<span class="token punctuation">)</span>
  changeset <span class="token operator">=</span> changeset<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span><span class="token keyword">when</span><span class="token punctuation">,</span> adjusted_params<span class="token punctuation">)</span>

  <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span>
    socket
    <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:when_changeset</span><span class="token punctuation">,</span> changeset<span class="token punctuation">)</span>
    <span class="token operator">|></span> assign_computed<span class="token punctuation">(</span>changeset<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token keyword">defp</span> assign_computed<span class="token punctuation">(</span>socket<span class="token punctuation">,</span> changeset<span class="token punctuation">)</span> <span class="token keyword">do</span>
  <span class="token comment"># I need the start_at for the DatePicker component that I render from this</span>
  <span class="token comment"># component. I render the timezone and duration on the form. Lastly I</span>
  <span class="token comment"># compute and render some autocomplete suggestions from the values in the</span>
  <span class="token comment"># changeset</span>
  socket
  <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:timezone</span><span class="token punctuation">,</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:timezone</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:start_at</span><span class="token punctuation">,</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:start_at</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:duration</span><span class="token punctuation">,</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:duration</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:start_time_autocomplete</span><span class="token punctuation">,</span> start_autocompletes<span class="token punctuation">(</span>changeset<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:end_time_autocomplete</span><span class="token punctuation">,</span> end_autocompletes<span class="token punctuation">(</span>changeset<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">defp</span> adjust_time_params<span class="token punctuation">(</span>params<span class="token punctuation">,</span> changeset<span class="token punctuation">)</span> <span class="token keyword">do</span>
  start_at_time <span class="token operator">=</span> params_to_time<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token string">"start_at_time"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  end_at_time <span class="token operator">=</span> params_to_time<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token string">"end_at_time"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">cond</span> <span class="token keyword">do</span>
    end_at_time <span class="token operator">!=</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:end_at_time</span><span class="token punctuation">)</span> <span class="token operator">-></span>
      params_from_new_end_time<span class="token punctuation">(</span>start_at_time<span class="token punctuation">,</span> end_at_time<span class="token punctuation">,</span> params<span class="token punctuation">)</span>

    start_at_time <span class="token operator">!=</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:start_at_time</span><span class="token punctuation">)</span> <span class="token operator">-></span>
      duration <span class="token operator">=</span> Changeset<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>changeset<span class="token punctuation">,</span> <span class="token atom symbol">:duration</span><span class="token punctuation">)</span>
      params_from_new_start_time<span class="token punctuation">(</span>start_at_time<span class="token punctuation">,</span> duration<span class="token punctuation">,</span> params<span class="token punctuation">)</span>

    <span class="token boolean">true</span> <span class="token operator">-></span>
      params
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<p>Remember, we’re in a LiveComponent so we want to target the changes to itself
and not the parent LiveView. This is accomplished with <code class="language-text">phx-target</code> on the form.</p>
<div class="gatsby-highlight" data-language="erb"><pre class="language-erb"><code class="language-erb"><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> f <span class="token operator">=</span> form_for <span class="token variable">@when_changeset</span><span class="token punctuation">,</span> <span class="token string">"#"</span><span class="token punctuation">,</span>
  phx_change<span class="token punctuation">:</span> <span class="token symbol">:validate</span><span class="token punctuation">,</span>
  phx_target<span class="token punctuation">:</span> <span class="token string">"#<span class="token interpolation"><span class="token comment">#{@id}</span></span>"</span><span class="token punctuation">,</span>
  phx_submit<span class="token punctuation">:</span> <span class="token symbol">:save</span><span class="token punctuation">,</span>
  id<span class="token punctuation">:</span> <span class="token variable">@id</span> <span class="token delimiter punctuation">%></span></span>

  <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%</span><span class="token comment"># all my form inputs </span><span class="token delimiter punctuation">%></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code></pre></div>
<h2>Handling the sub-form submission</h2>
<p>When the user tries to submit the form, either by hitting “enter” or clicking on
the submit button, I need to validate the form once again, and if it’s good tell
the parent LiveView that it’s ok to proceed and supply all the nice computed
values.</p>
<p>This time we’ll check if the changeset is valid with
<a href="https://hexdocs.pm/ecto/Ecto.Changeset.html#apply_action/2"><code class="language-text">Ecto.Changeset.apply_action/2</code></a>. Based on that result, we’ll let the
LiveComponent send a message to <del>itself</del>. Actually, a LiveComponent doesn’t
run in its own process, instead it’s running inside the parent LiveView’s
process. So <code class="language-text">self()</code> is actually the LiveView and not the LiveComponent. This is
how we can send the parent LiveView the result!</p>
<p>You can <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveComponent.html#module-liveview-as-the-source-of-truth">read more about LiveComponent and sources of truth</a>.</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token attribute variable">@impl</span> Phoenix<span class="token punctuation">.</span>LiveComponent
<span class="token keyword">def</span> handle_event<span class="token punctuation">(</span><span class="token string">"save"</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token string">"when_component"</span> <span class="token operator">=></span> params<span class="token punctuation">}</span><span class="token punctuation">,</span> socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
  socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span><span class="token keyword">when</span>
  <span class="token operator">|></span> changeset<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
  <span class="token operator">|></span> Changeset<span class="token punctuation">.</span>apply_action<span class="token punctuation">(</span><span class="token atom symbol">:insert</span><span class="token punctuation">)</span>
  <span class="token operator">|></span> <span class="token keyword">case</span> <span class="token keyword">do</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> record<span class="token punctuation">}</span> <span class="token operator">-></span>
      send<span class="token punctuation">(</span>self<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token atom symbol">:proceed</span><span class="token punctuation">,</span> record<span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span> socket<span class="token punctuation">}</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:error</span><span class="token punctuation">,</span> changeset<span class="token punctuation">}</span> <span class="token operator">-></span>
      <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span>
        socket
        <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:when_changeset</span><span class="token punctuation">,</span> changeset<span class="token punctuation">)</span>
        <span class="token operator">|></span> assign_computed<span class="token punctuation">(</span>changeset<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment"># and caught in the parent LiveView:</span>

<span class="token attribute variable">@impl</span> Phoenix<span class="token punctuation">.</span>LiveView
<span class="token keyword">def</span> handle_info<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token atom symbol">:proceed</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>MyAppWeb<span class="token punctuation">.</span>EventLive<span class="token punctuation">.</span>WhenComponent<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">=</span> form<span class="token punctuation">}</span><span class="token punctuation">,</span> socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
  <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> start_at_wall<span class="token punctuation">}</span> <span class="token operator">=</span> NaiveDateTime<span class="token punctuation">.</span>new<span class="token punctuation">(</span>form<span class="token punctuation">.</span>start_at_date<span class="token punctuation">,</span> form<span class="token punctuation">.</span>start_at_time<span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> end_at_wall<span class="token punctuation">}</span> <span class="token operator">=</span> NaiveDateTime<span class="token punctuation">.</span>new<span class="token punctuation">(</span>form<span class="token punctuation">.</span>end_at_date<span class="token punctuation">,</span> form<span class="token punctuation">.</span>end_at_time<span class="token punctuation">)</span>

  params <span class="token operator">=</span> <span class="token punctuation">%</span><span class="token punctuation">{</span>
    <span class="token attr-name">start_at_utc:</span> form<span class="token punctuation">.</span>start_at<span class="token punctuation">,</span>
    <span class="token attr-name">start_at_wall:</span> start_at_wall<span class="token punctuation">,</span>
    <span class="token attr-name">start_at_tz:</span> form<span class="token punctuation">.</span>timezone<span class="token punctuation">,</span>
    <span class="token attr-name">end_at_utc:</span> form<span class="token punctuation">.</span>end_at<span class="token punctuation">,</span>
    <span class="token attr-name">end_at_wall:</span> end_at_wall<span class="token punctuation">,</span>
    <span class="token attr-name">end_at_tz:</span> form<span class="token punctuation">.</span>timezone
  <span class="token punctuation">}</span>

  <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span>
    socket
    <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:params</span><span class="token punctuation">,</span> Map<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span>params<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> assign_step<span class="token punctuation">(</span><span class="token atom symbol">:next</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token keyword">end</span></code></pre></div>
<h2>Handling the overall form submission</h2>
<p>You’ll notice that I have a function <code class="language-text">assign_step</code> above. Let’s go to the parent
LiveView and figure out how to change steps, except on the last step we want to
persist. We’ll look for the steps in the <code class="language-text">@steps</code> module attribute, assign it,
and that should swap-out the form for the next one!</p>
<p>If there isn’t a next step, then that must mean that we’re finished, so we
should try to save.</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> YouMeetWeb<span class="token punctuation">.</span>EventLive<span class="token punctuation">.</span>Step <span class="token keyword">do</span>
  <span class="token attribute variable">@moduledoc</span> <span class="token string">"Describe a step in the multi-step form"</span>
  <span class="token keyword">defstruct</span> <span class="token punctuation">[</span><span class="token atom symbol">:name</span><span class="token punctuation">,</span> <span class="token atom symbol">:prev</span><span class="token punctuation">,</span> <span class="token atom symbol">:next</span><span class="token punctuation">]</span>
<span class="token keyword">end</span>

<span class="token keyword">defmodule</span> YouMeetWeb<span class="token punctuation">.</span>EventLive<span class="token punctuation">.</span>New <span class="token keyword">do</span>
  <span class="token comment"># ..snip..</span>

  <span class="token keyword">defp</span> assign_step<span class="token punctuation">(</span>socket<span class="token punctuation">,</span> step<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> new_step <span class="token operator">=</span> Enum<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token attribute variable">@steps</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span> <span class="token argument variable">&amp;1</span><span class="token punctuation">.</span>name <span class="token operator">==</span> Map<span class="token punctuation">.</span>get<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span>progress<span class="token punctuation">,</span> step<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
      assign<span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token atom symbol">:progress</span><span class="token punctuation">,</span> new_step<span class="token punctuation">)</span>
    <span class="token keyword">else</span>
      save<span class="token punctuation">(</span>socket<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> save<span class="token punctuation">(</span>socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token comment"># remember we've merged all params together, so this should be the complete</span>
    <span class="token comment"># picture.</span>
    <span class="token keyword">case</span> Schedule<span class="token punctuation">.</span>create_event<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>assigns<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token keyword">do</span>
      <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> event<span class="token punctuation">}</span> <span class="token operator">-></span>
          socket
          <span class="token operator">|></span> put_flash<span class="token punctuation">(</span><span class="token atom symbol">:info</span><span class="token punctuation">,</span> t<span class="token punctuation">(</span><span class="token string">"Event Created"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token operator">|></span> push_redirect<span class="token punctuation">(</span><span class="token attr-name">to:</span> Routes<span class="token punctuation">.</span>live_path<span class="token punctuation">(</span>socket<span class="token punctuation">,</span> EventLive<span class="token punctuation">.</span>Show<span class="token punctuation">,</span> event<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token punctuation">{</span><span class="token atom symbol">:error</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>Changeset<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">=</span> changeset<span class="token punctuation">}</span> <span class="token operator">-></span>
         socket
         <span class="token operator">|></span> assign<span class="token punctuation">(</span><span class="token atom symbol">:changeset</span><span class="token punctuation">,</span> changeset<span class="token punctuation">)</span>
         <span class="token operator">|></span> put_flash<span class="token punctuation">(</span><span class="token atom symbol">:error</span><span class="token punctuation">,</span> <span class="token string">"There is an issue with what you filled in"</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token attribute variable">@impl</span> Phoenix<span class="token punctuation">.</span>LiveView
  <span class="token keyword">def</span> handle_event<span class="token punctuation">(</span><span class="token string">"prev-step"</span><span class="token punctuation">,</span> _content<span class="token punctuation">,</span> socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span> assign_step<span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token atom symbol">:prev</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<div class="gatsby-highlight" data-language="erb"><pre class="language-erb"><code class="language-erb"><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> <span class="token constant">MyAppWeb</span><span class="token punctuation">.</span><span class="token constant">Components</span><span class="token punctuation">.</span>secondary_button<span class="token punctuation">(</span>t<span class="token punctuation">(</span><span class="token string">"Back"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> phx_click<span class="token punctuation">:</span> <span class="token string">"prev-step"</span><span class="token punctuation">)</span> <span class="token delimiter punctuation">%></span></span>
<span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> <span class="token constant">MyAppWeb</span><span class="token punctuation">.</span><span class="token constant">Components</span><span class="token punctuation">.</span>primary_button<span class="token punctuation">(</span>t<span class="token punctuation">(</span><span class="token string">"Next"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> phx_disable_with<span class="token punctuation">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span> submit<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token delimiter punctuation">%></span></span></code></pre></div>
<p>Back buttons are easy too. Add <code class="language-text">phx-click=&quot;prev-step&quot;</code> and handle the event in
the same way, except using <code class="language-text">:prev</code>. Make sure there’s no back button on the
first step! (otherwise you’ll mistakenly try to save).</p>
<h2>Conclusion</h2>
<p>I hope this helps you out in your endeavors to tackle long and complicated
forms. Tweet me <a href="https://twitter.com/bernheisel">@bernheisel</a> if you have suggestions or enjoyed this post!</p></div></article><div class="flex flex-wrap justify-between"><div class="w-full p-2 lg:w-1/2"><a class="text-white no-underline inline-flex items-center flex-1 button bg-purple-darker" href="/blog/elixir-mix-ecto-changeset-podcast/"><svg class="w-6 h-6 mr-2 fill-current" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1408 960v-128q0-26-19-45t-45-19h-502l189-189q19-19 19-45t-19-45l-91-91q-18-18-45-18t-45 18l-362 362-91 91q-18 18-18 45t18 45l91 91 362 362q18 18 45 18t45-18l91-91q18-18 18-45t-18-45l-189-189h502q26 0 45-19t19-45zm256-64q0 209-103 385.5t-279.5 279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5 385.5-103 385.5 103 279.5 279.5 103 385.5z"></path></svg><span>Ecto Changesets on Elixir Mix podcast</span></a></div></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/liveview-multi-step-form/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-e49f8733b8aee9471acf.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-8dc5b1de7df84c955e11.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-2780d9b33f550a804e84.js"],"component---src-pages-404-js":["/component---src-pages-404-js-f9633554493dddb1c536.js"],"component---src-pages-index-js":["/component---src-pages-index-js-da8729d9d0343d295966.js"],"component---src-pages-projects-js":["/component---src-pages-projects-js-757737b55f5d38274a17.js"]};/*]]>*/</script><script src="/webpack-runtime-41d54de024c2d1f9252e.js" async=""></script><script src="/app-e49f8733b8aee9471acf.js" async=""></script><script src="/framework-1cbcc4f69858806ac5db.js" async=""></script><script src="/1777bc0a756dace6068a54d243c7071eee1627a0-9e9727b36538e6264ac4.js" async=""></script><script src="/component---src-templates-blog-post-js-2780d9b33f550a804e84.js" async=""></script><script src="/styles-48fa8a050a65bb8447bd.js" async=""></script></body></html>