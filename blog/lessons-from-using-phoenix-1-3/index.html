<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.9841c30ca4b98edfc4a4.css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}main{display:block}h1{font-size:2em;margin:.67em 0}a{background-color:transparent}img{border-style:none}button{font-family:inherit;font-size:100%;line-height:1.15;margin:0;overflow:visible;text-transform:none}[type=button],[type=reset],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[hidden]{display:none}h1,h2,p{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}ul{list-style:none;margin:0;padding:0}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Droid Sans,Helvetica Neue,Fira Sans,sans-serif;line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid}img{border-style:solid}button{cursor:pointer}h1,h2{font-size:inherit;font-weight:inherit}a{text-decoration:inherit}a,button{color:inherit}button{padding:0;line-height:inherit}img,object,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}ul{list-style-type:disc;padding-left:1rem}body{background:#22292f;color:#fefefe;font-weight:300;margin:0;line-height:1.5;letter-spacing:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Droid Sans,Helvetica Neue,Fira Sans,sans-serif}h1,h2{margin-top:2rem;margin-bottom:1rem;color:#ed6a5a}h1{font-size:1.875rem}h2{font-size:1.5rem}h1:before,h2:before{color:#f6bbb4;margin-right:1rem}h1:before{content:"#";margin-left:-2.25rem}h2:before{content:"##"}p{margin-top:1rem;margin-bottom:1rem}article a{text-decoration:none}article a,article a:focus,article a:visited{color:#f6bbb4}article a:hover{color:#f6bbb4;border-bottom-width:1px;border-color:#31708e;text-decoration:none}nav a{color:#ed6a5a}nav a:focus,nav a:visited{color:#fefefe}nav a:hover{text-decoration:none;border-width:0}.post-header{font-size:1.875rem;font-weight:600}.post-header a{color:#ed6a5a;text-decoration:none}.frontmatter{color:#dae1e7;font-size:.75rem}.frontmatter a{color:#f6bbb4;text-decoration:none}.button{padding:.5rem 1rem;border-radius:.25rem}.bg-red{background-color:#ed6a5a}.bg-teal{background-color:#31708e}.bg-blue-dark{background-color:#324a69}.bg-purple-darker{background-color:#bc9cc2}.hover\:bg-blue-darker:hover{background-color:#1c293b}.border-teal-light{border-color:#568aa2}.hover\:border-white:hover{border-color:#fefefe}.hover\:border-blue-darker:hover{border-color:#1c293b}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.border-2{border-width:2px}.border{border-width:1px}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.inline-flex{display:inline-flex}.hidden{display:none}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-between{justify-content:space-between}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.font-medium{font-weight:500}.font-black{font-weight:900}.h-3{height:.75rem}.h-6{height:1.5rem}.h-7{height:1.75rem}.leading-normal{line-height:1.5}.m-auto{margin:auto}.mx-2{margin-left:.5rem;margin-right:.5rem}.mt-0{margin-top:0}.mb-0{margin-bottom:0}.mr-2{margin-right:.5rem}.mb-2{margin-bottom:.5rem}.ml-2{margin-left:.5rem}.mt-4{margin-top:1rem}.mr-4{margin-right:1rem}.mb-8{margin-bottom:2rem}.max-w-lg{max-width:50rem}.p-2{padding:.5rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.shadow{box-shadow:0 2px 4px 0 rgba(0,0,0,.1)}.shadow-md{box-shadow:0 4px 8px 0 rgba(0,0,0,.12),0 2px 4px 0 rgba(0,0,0,.08)}.fill-current{fill:currentColor}.text-gray-light{color:#afadae}.hover\:text-white:hover,.text-white{color:#fefefe}.text-lg{font-size:1.125rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.hover\:no-underline:hover,.no-underline{text-decoration:none}.align-middle{vertical-align:middle}.w-3{width:.75rem}.w-6{width:1.5rem}.w-16{width:4rem}.w-full{width:100%}@media (min-width:576px){.sm\:text-4xl{font-size:2.25rem}}@media (min-width:992px){.lg\:inline-block{display:inline-block}.lg\:flex{display:flex}.lg\:hidden{display:none}.lg\:items-center{align-items:center}.lg\:h-32{height:8rem}.lg\:mt-0{margin-top:0}.lg\:text-5xl{font-size:3rem}.lg\:w-32{width:8rem}.lg\:w-auto{width:auto}.lg\:w-1\/2{width:50%}}code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.20.9"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script>
  
  
  if(!(parseInt(navigator.doNotTrack) === 1 || parseInt(window.doNotTrack) === 1 || parseInt(navigator.msDoNotTrack) === 1 || navigator.doNotTrack === "yes")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-9152758-1', 'auto', {});
      
      
      
      
      
      }</script><link rel="alternate" type="application/rss+xml" title="David Bernheisel&#x27;s Blog RSS Feed" href="/rss.xml"/><link rel="icon" href="/android-chrome-36x36.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="36x36" href="/android-chrome-36x36.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="48x48" href="/android-chrome-48x48.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="72x72" href="/android-chrome-72x72.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="96x96" href="/android-chrome-96x96.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="144x144" href="/android-chrome-144x144.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="192x192" href="/android-chrome-192x192.png?v=611230f76b9c00b58e5b99e8a179a99d"/><title data-react-helmet="true">Lessons From Using Phoenix 1.3 | David Bernheisel</title><meta data-react-helmet="true" name="description" content="Phoenix 1.3 introduces contexts, which has been met with some resistance. I’ve
developed an application using it and learned some lessons."/><link as="script" rel="preload" href="/styles-48fa8a050a65bb8447bd.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-2780d9b33f550a804e84.js"/><link as="script" rel="preload" href="/1777bc0a756dace6068a54d243c7071eee1627a0-9e9727b36538e6264ac4.js"/><link as="script" rel="preload" href="/framework-1cbcc4f69858806ac5db.js"/><link as="script" rel="preload" href="/app-e49f8733b8aee9471acf.js"/><link as="script" rel="preload" href="/webpack-runtime-41d54de024c2d1f9252e.js"/><link as="fetch" rel="preload" href="/page-data/blog/lessons-from-using-phoenix-1-3/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><nav class="flex flex-wrap items-center justify-between p-4 shadow-md bg-teal"><a class="text-white no-underline" href="/"><div class="flex items-center flex-shrink-0 mr-6 text-white"><img src="/static/profile-picture-977b63cbce04bae4479e3185b22bfb1a.jpg" alt="David Bernheisel" class="w-16 h-16 mr-4 border-2 rounded-full shadow-md lg:w-32 lg:h-32 border-teal-light"/><span class="text-2xl font-black sm:text-4xl lg:text-5xl">David Bernheisel</span></div></a><div class="block lg:hidden"><button class="flex items-center px-3 py-2 border rounded text-gray-light border-teal-light hover:text-white hover:border-white"><svg class="w-3 h-3 fill-current" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg></button></div><div class="w-full block lg:mt-0 mt-4 lg:flex lg:items-center lg:w-auto hidden"><a class="text-white no-underline bg-blue-dark hover:border-blue-darker hover:bg-blue-darker text-white font-medium block lg:inline-block mt-4 mr-4 lg:mt-0 shadow rounded py-1 px-3" href="/">Blog</a><a class="text-white no-underline bg-blue-dark hover:border-blue-darker hover:bg-blue-darker text-white font-medium block lg:inline-block mt-4 mr-4 lg:mt-0 shadow rounded py-1 px-3" href="/projects/">Projects</a><a class="block px-3 py-1 mt-4 mr-4 font-medium text-white no-underline rounded shadow bg-blue-dark hover:border-blue-darker hover:bg-blue-darker lg:inline-block lg:mt-0 hover:no-underline" href="https://twitter.com/bernheisel">Twitter</a><div class="py-1 mt-4 lg:mt-0"><a href="/rss.xml"><img class="align-middle h-7" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICAgaWQ9IlJTU2ljb24iCiAgICAgdmlld0JveD0iMCAwIDggOCIgd2lkdGg9IjI1NiIgaGVpZ2h0PSIyNTYiPgoKICA8dGl0bGU+UlNTIGZlZWQgaWNvbjwvdGl0bGU+CgogIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAgICAuYnV0dG9uIHtzdHJva2U6IG5vbmU7IGZpbGw6IG9yYW5nZTt9CiAgICAuc3ltYm9sIHtzdHJva2U6IG5vbmU7IGZpbGw6IHdoaXRlO30KICA8L3N0eWxlPgoKICA8cmVjdCAgIGNsYXNzPSJidXR0b24iIHdpZHRoPSI4IiBoZWlnaHQ9IjgiIHJ4PSIxLjUiIC8+CiAgPGNpcmNsZSBjbGFzcz0ic3ltYm9sIiBjeD0iMiIgY3k9IjYiIHI9IjEiIC8+CiAgPHBhdGggICBjbGFzcz0ic3ltYm9sIiBkPSJtIDEsNCBhIDMsMyAwIDAgMSAzLDMgaCAxIGEgNCw0IDAgMCAwIC00LC00IHoiIC8+CiAgPHBhdGggICBjbGFzcz0ic3ltYm9sIiBkPSJtIDEsMiBhIDUsNSAwIDAgMSA1LDUgaCAxIGEgNiw2IDAgMCAwIC02LC02IHoiIC8+Cgo8L3N2Zz4=" alt="RSS"/></a></div></div></nav><main class="max-w-lg p-4 m-auto text-lg"><article class="blog-post"><h1 class="mb-0 text-3xl">Lessons From Using Phoenix 1.3</h1><p class="mt-0 mb-8 text-sm frontmatter"><span>Published on <!-- -->August 01, 2017</span><span><span class="mx-2">|</span><a href="https://robots.thoughtbot.com/lessons-from-using-phoenix-1-3">Original Publishing</a></span><span><span class="mx-2">|</span>11<!-- -->m read</span></p><div><p>Phoenix 1.3 introduces contexts, which has been met with some resistance. I’ve
developed an application using it and learned some lessons.</p>
<!-- excerpt -->
<p><strong>[WARNING]</strong> I like contexts.</p>
<p><img src="/8b9d64dd7a997f9c55116b167429a478/homer-backing-up.gif" alt="me, now, ashamed and hiding because I am probably going against the grain that
other smarter-than-me people likely established already"></p>
<p>Phew… I just wanted to admit that up front. Now that I got that out of the
way, I am going to share my journey about using Phoenix 1.3.0 and contexts.</p>
<hr>
<ul>
<li><a href="#experience">My context</a></li>
<li>
<p>Lessons:</p>
<ul>
<li><a href="#dontgenerators">Don’t use the generators</a></li>
<li><a href="#dothedomain">Embrace the domain vocabulary</a></li>
<li><a href="#bloated">Avoid the bloat</a></li>
<li><a href="#maybeumbrella">Consider before umbrellas</a></li>
</ul>
</li>
<li><a href="#giveitago">You should give it a shot</a></li>
</ul>
<p><a name="experience"></a></p>
<h2>Experience</h2>
<p>I worked on a greenfield project and had an opportunity to use Phoenix
1.3.0-rc2. With Phoenix 1.3.0 just released, I thought it might be timely to
inform other developers what it’s like to work with contexts, and some
recommendations I have after working on a project using contexts for several
months.</p>
<p>If you don’t know what a context is:</p>
<ul>
<li><a href="https://youtu.be/tMO28ar0lW8?t=12m21s">watch Chris McCord talk about
it</a></li>
<li>or <a href="https://martinfowler.com/bliki/BoundedContext.html">read Martin Fowler’s explanation of Bounded
Context</a></li>
<li>or <a href="http://phoenixframework.org/blog/phoenix-1-3-0-released">read the Phoenix 1.3 release
post</a></li>
<li>
<p>or read my tldr version:</p>
<blockquote>
<p>A context is a module that defines the interface between a set of
inter-related models/schemas to the rest of the application (like other
contexts). A context is an internal API that provides opportunity to name
things better and organize code.</p>
</blockquote>
</li>
</ul>
<p>A practical example: instead of your controller talking to the database, your
controller will talk to the context, and the context will interface with
necessary functions and schemas and modules to accomplish the task.</p>
<p><strong>NOTE:</strong> I did not use 1.3.0-rc3 which changes the <code class="language-text">Web</code> namespace, so I will
skip that part. I think that’s a good change, but I have no real experience with
those tweaks yet.</p>
<h2>Lessons</h2>
<p><a name="dontgenerators"></a></p>
<h3>Don’t use the generators more than once</h3>
<p>With Phoenix 1.3, I only recommend using the <code class="language-text">phx</code> generators ONCE in a
greenfield project. After that, ditch them. Ditch them because once you’ve
adjusted the code to your liking (and you’ll definitely need to edit the
generated code), using the generators again may <em><strong>inject</strong></em> generated code into
your existing files, which likely don’t follow your patterns anymore.</p>
<p>Since I’m recommending against something, let’s jump into examples and find out
why.</p>
<p>Here’s what I had to do with the generated files:</p>
<ul>
<li>
<p><strong>Rewrite the tests because they setup a fixture for the schema.</strong></p>
<p>This isn’t a bad idea in itself, but I wanted to use
<a href="https://github.com/thoughtbot/ex_machina">ex_machina</a> for setting up test
scenarios. At first, I thought the generated fixture was a great idea.  I’m
providing an interface for creating widgets, so I should use it in my tests,
right?</p>
<p>Here’s the problem:</p>
<p>Imagine if someone introduced a bug in <code class="language-text">create_widget()</code>— now all your tests
that involve inserting a <code class="language-text">widget</code> breaks. That’s unreasonable, because I’m not
testing <em>getting to that state</em> most of the time, I’m testing the unit of
functionality or integration between functions. Instead, I want the tests for
<code class="language-text">create_widget()</code> to fail (and any reliant integration tests), as opposed to
the <strong>WHOLE TEST SUITE</strong> breaking and thus freaking me out. When the whole
test suite breaks, it’s harder to discern where the problem is.</p>
</li>
<li>
<p><strong>Separate the schema-specific tests into their own test file.</strong></p>
<p>The new context organization only generates a test file for the <em>context</em>, and
not a schema. As I kept building the application, it became evident that the
context file and context test file were getting too large. I felt compelled to
isolate and organize this big bag-o’-functions into smaller bags-o’-functions.
I decided to start splitting the tests into different schema-related files,
like <code class="language-text">{context}/{schema}_test.exs</code>. Since I split the test files, it became
clearer where I should place tests for custom changeset functions as well.</p>
<p>I also want to be more careful about how I use <code class="language-text">describe</code> and <code class="language-text">test</code> blocks,
since ExUnit doesn’t support nested <code class="language-text">describe</code> or context blocks.  The
generated test names were also a bit long for my taste, so I moved the
function name to the <code class="language-text">describe</code> block, and then used the test title to
describe the context and the expected result.</p>
<p>Lastly, the generated style was … different.</p>
<ul>
<li>I don’t like aliasing modules in the middle of the file. I feel
they belong at the top of the file.</li>
<li>I keep module attributes near the top of the file.</li>
<li>I avoid the function parenthesis unless I need them.</li>
</ul>
<p>Here is an example of how I changed things:</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token comment"># BEFORE</span>
<span class="token comment"># test/my_app/things_test.exs</span>
<span class="token keyword">defmodule</span> MyApp<span class="token punctuation">.</span>ThingsTest <span class="token keyword">do</span>
<span class="token keyword">use</span> MyApp<span class="token punctuation">.</span>DataCase
<span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>Things

describe <span class="token string">"widgets"</span> <span class="token keyword">do</span>
  <span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>Things<span class="token punctuation">.</span>Widget

  <span class="token attribute variable">@valid_attrs</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token attribute variable">@update_attrs</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token attribute variable">@invalid_attrs</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">def</span> widget_fixture<span class="token punctuation">(</span>attrs <span class="token operator">\\</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> widget<span class="token punctuation">}</span> <span class="token operator">=</span>
      attrs
      <span class="token operator">|></span> Enum<span class="token punctuation">.</span>into<span class="token punctuation">(</span><span class="token attribute variable">@valid_attrs</span><span class="token punctuation">)</span>
      <span class="token operator">|></span> Things<span class="token punctuation">.</span>create_widget<span class="token punctuation">(</span><span class="token punctuation">)</span>

    widget
  <span class="token keyword">end</span>

  test <span class="token string">"list_widgets/0 returns all widgets"</span> <span class="token keyword">do</span>
    widget_one <span class="token operator">=</span> widget_fixture<span class="token punctuation">(</span><span class="token punctuation">)</span>
    widget_two <span class="token operator">=</span> widget_fixture<span class="token punctuation">(</span><span class="token punctuation">)</span>

    assert Things<span class="token punctuation">.</span>list_widgets<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">[</span>widget_one<span class="token punctuation">,</span> widget_two<span class="token punctuation">]</span>
  <span class="token keyword">end</span>

  <span class="token comment"># I added this, just to go along with their style and to show</span>
  <span class="token comment"># what a typical new developer would do with this existing pattern</span>
  test <span class="token string">"list_widgets/1 returns all widgets limited by list of id"</span> <span class="token keyword">do</span>
    widget_one <span class="token operator">=</span> widget_fixture<span class="token punctuation">(</span><span class="token punctuation">)</span>
    _widget_two <span class="token operator">=</span> widget_fixture<span class="token punctuation">(</span><span class="token punctuation">)</span>

    assert Things<span class="token punctuation">.</span>list_widgets<span class="token punctuation">(</span><span class="token punctuation">[</span>widget_one<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">[</span>widget_one<span class="token punctuation">]</span>
  <span class="token keyword">end</span>

  <span class="token comment">#...</span>
<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment"># AFTER</span>
<span class="token comment"># test/my_app/things/widget_test.exs</span>
<span class="token keyword">defmodule</span> MyApp<span class="token punctuation">.</span>Things<span class="token punctuation">.</span>WidgetTest <span class="token keyword">do</span>
<span class="token keyword">use</span> MyApp<span class="token punctuation">.</span>DataCase
<span class="token keyword">import</span> MyApp<span class="token punctuation">.</span>Factory
<span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>Things
<span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>Things<span class="token punctuation">.</span>Widget

describe <span class="token string">"list_widgets"</span> <span class="token keyword">do</span>
  test <span class="token string">"returns all widgets"</span> <span class="token keyword">do</span>
    <span class="token punctuation">[</span>widget_one<span class="token punctuation">,</span> widget_two<span class="token punctuation">]</span> <span class="token operator">=</span> insert_pair<span class="token punctuation">(</span><span class="token atom symbol">:widget</span><span class="token punctuation">)</span>

    assert Things<span class="token punctuation">.</span>list_widgets <span class="token operator">==</span> <span class="token punctuation">[</span>widget_one<span class="token punctuation">,</span> widget_two<span class="token punctuation">]</span>
  <span class="token keyword">end</span>

  test <span class="token string">"when given list of ids, returns all widgets in ids"</span> <span class="token keyword">do</span>
    <span class="token punctuation">[</span>widget_one<span class="token punctuation">,</span> _widget_two<span class="token punctuation">]</span> <span class="token operator">=</span> insert_pair<span class="token punctuation">(</span><span class="token atom symbol">:widget</span><span class="token punctuation">)</span>

    assert Things<span class="token punctuation">.</span>list_widgets<span class="token punctuation">(</span><span class="token punctuation">[</span>widget_one<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">[</span>widget_one<span class="token punctuation">]</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">#...</span>
<span class="token keyword">end</span></code></pre></div>
<p>I like this so much better, and I’m afraid that just going with the generated
pattern will lead newer developers down a path of bloated files.</p>
</li>
</ul>
<p>It’s more apparent to me in Phoenix 1.3.0 that the generators are much more a
teaching tool for new developers than meant to be used in an ongoing fashion
throughout a project’s lifetime. If you’ve formed your opinion, or your
organization has a coding style within Phoenix, then you might appreciate
knowing you can customize the templates that the generators will use. You can do
this by copying them out of <code class="language-text">deps/phoenix/priv/templates</code> and into your
project’s <code class="language-text">priv/templates</code> folder. That’s pretty awesome.</p>
<p>Recap: for new developers, Phoenix’s new generators are a great learning tool,
but I don’t recommend using them after the first use.</p>
<p><a name="dothedomain"></a></p>
<h3>Embrace the domain vocabulary</h3>
<p>I realized that my understanding of contexts at the time was flawed, and that
many of the examples out in the blog-o-sphere were not helpful for me when I was
in the trenches myself.</p>
<p>I imagine that most (all?) projects have their own domain AND vocabulary, and to
be readable for folks in that domain it is helpful to share that vocabulary.</p>
<p>This coming example may not apply to you, but this is the beauty of contexts:
your needs WILL differ and your domain vocabulary will help determine how to
organize your code.</p>
<p>The project I was working on had different terms for their warehouse workers:</p>
<ul>
<li>Operators</li>
<li>Supervisors</li>
<li>Admins</li>
<li>SalesAssociate</li>
</ul>
<p>This roughly corresponds with a typical <code class="language-text">User</code> schema that <code class="language-text">belongs_to</code> a <code class="language-text">Role</code>
schema. I placed both schemas into a new context called <code class="language-text">Accounts</code>, and all
user-related functions are in that context file. I hesitated with the domain
vocabulary thinking that generic terms were going to be more flexible later.</p>
<p>As the project evolved, that decision turned out to be a mistake</p>
<p>Instead of something like this (using a generic term <code class="language-text">Accounts</code> as the context):</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> MyApp<span class="token punctuation">.</span>Accounts <span class="token keyword">do</span>
  <span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>Accounts<span class="token punctuation">.</span>User

  <span class="token attribute variable">@operator_role_id</span> <span class="token number">2</span>
  <span class="token attribute variable">@supervisor_role_id</span> <span class="token number">1</span>

  <span class="token keyword">def</span> list_operators<span class="token punctuation">(</span>queryable <span class="token operator">\\</span> User<span class="token punctuation">)</span> <span class="token keyword">do</span>
    queryable <span class="token operator">|></span> where<span class="token punctuation">(</span><span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>role_id <span class="token operator">==</span> <span class="token operator">^</span><span class="token attribute variable">@operator_role</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> list_supervisors<span class="token punctuation">(</span>queryable <span class="token operator">\\</span> User<span class="token punctuation">)</span> <span class="token keyword">do</span>
    queryable <span class="token operator">|></span> where<span class="token punctuation">(</span><span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>role_id <span class="token operator">==</span> <span class="token operator">^</span><span class="token attribute variable">@supervisor_role</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token comment"># ...</span>
<span class="token keyword">end</span></code></pre></div>
<p>I could have done this (using domain vocabulary as context boundaries):</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> MyApp<span class="token punctuation">.</span>Operators <span class="token keyword">do</span>
  <span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>Accounts<span class="token punctuation">.</span>User

  <span class="token attribute variable">@role_id</span> <span class="token number">2</span>

  <span class="token keyword">def</span> list<span class="token punctuation">(</span>queryable <span class="token operator">\\</span> User<span class="token punctuation">)</span> <span class="token keyword">do</span>
    queryable <span class="token operator">|></span> where<span class="token punctuation">(</span><span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>role_id <span class="token operator">==</span> <span class="token operator">^</span><span class="token attribute variable">@role_id</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token comment"># ...</span>
<span class="token keyword">end</span>

<span class="token comment"># notice the namespace difference</span>
<span class="token keyword">defmodule</span> MyApp<span class="token punctuation">.</span>Supervisors <span class="token keyword">do</span>
  <span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>Accounts<span class="token punctuation">.</span>User

  <span class="token attribute variable">@role_id</span> <span class="token number">1</span>

  <span class="token keyword">def</span> list<span class="token punctuation">(</span>queryable <span class="token operator">\\</span> User<span class="token punctuation">)</span> <span class="token keyword">do</span>
    queryable <span class="token operator">|></span> where<span class="token punctuation">(</span><span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>role_id <span class="token operator">==</span> <span class="token operator">^</span><span class="token attribute variable">@role_id</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token comment"># ...</span>
<span class="token keyword">end</span></code></pre></div>
<p>This example is really simple, but it starts to show its strength later when you
have other conditionals and need to ask your data more questions.</p>
<p>With the example above, I’d actually argue that having one combined context is
preferable because it’s all we need—but, knowing how the application <strong>will</strong>
grow, and how a lot of questions are asked against the user’s role, then it’ll
be more apparent having the separated context <strong>will</strong> be helpful.</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> MyApp<span class="token punctuation">.</span>Operators <span class="token keyword">do</span>
  <span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>Activities<span class="token punctuation">.</span>Event

  <span class="token keyword">def</span> update_event<span class="token punctuation">(</span>event<span class="token punctuation">,</span> params<span class="token punctuation">)</span> <span class="token keyword">do</span>
    event
    <span class="token operator">|></span> prepare_event<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    <span class="token operator">|></span> Repo<span class="token punctuation">.</span>update
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> prepare_event<span class="token punctuation">(</span>event<span class="token punctuation">,</span> params<span class="token punctuation">)</span> <span class="token keyword">do</span>
    event <span class="token operator">|></span> Event<span class="token punctuation">.</span>operator_changeset<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token comment"># ...</span>
<span class="token keyword">end</span>

<span class="token keyword">defmodule</span> MyApp<span class="token punctuation">.</span>Supervisors <span class="token keyword">do</span>
  <span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>Activities<span class="token punctuation">.</span>Event

  <span class="token keyword">def</span> update_event<span class="token punctuation">(</span>event<span class="token punctuation">,</span> params<span class="token punctuation">)</span> <span class="token keyword">do</span>
    event
    <span class="token operator">|></span> prepare_event<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    <span class="token operator">|></span> Repo<span class="token punctuation">.</span>update
  <span class="token keyword">end</span>

  <span class="token comment"># Notice that we're calling a different changeset</span>
  <span class="token keyword">def</span> prepare_event<span class="token punctuation">(</span>event<span class="token punctuation">,</span> params<span class="token punctuation">)</span> <span class="token keyword">do</span>
    event <span class="token operator">|></span> Event<span class="token punctuation">.</span>supervisor_changeset<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token comment"># ...</span>
<span class="token keyword">end</span></code></pre></div>
<p>Above we’re adding another function that has different permissions regarding
what the user may update on an event. The <code class="language-text">supervisor_changeset</code> will cast all
params, whereas the <code class="language-text">operator_changeset</code> will cast only a subset of params. This
would also be reflected for preparing any forms in templates.</p>
<p>All the above <em>requires</em> you to understand the vocabulary before building, which
is the critique I usually hear about contexts: “It requires more up-front
cognitive thought before I can be productive.” Prior to 1.3, not knowing domain
up front might not hurt so much because it’s not built into the structure, but
with 1.3 and presumably later, it may hurt more. Despite that, it’s <em>totally</em>
worth it.</p>
<h3>Avoid the bloat<a name="bloated"></a></h3>
<p>Above, I glossed-over what contexts help us achieve: making interfaces between
your abstractions. A context (aka domain interface) will help organize actions.
I <em>love</em> this.</p>
<p>I decided in this experiment to <em>really</em> give contexts a go and roll with the
philosophy. At the same time, I <em>hated</em> the bloated context that it had become
after needing to interact with several schemas in the same context. At some
point, I had several hundred lines in a context file; it was easy to let the
context file grow. <strong>RESIST</strong>. Use domain-related vocabulary to keep contexts
small. I had to determine how to organize the code better.</p>
<p>A technique that helped keep contexts small was to limit them a set of action
verbs, like <code class="language-text">list</code> <code class="language-text">prepare</code> <code class="language-text">create</code> <code class="language-text">update</code> and <code class="language-text">delete</code> (some semblance to
CRUD actions). Outside of those verbs, I put them into supporting modules. For
example, <code class="language-text">def list</code> actually hits the database and returns the list of things—
it did not return an Ecto query that I could further modify. I saved those
query-building functions for a <code class="language-text">Context.Query</code> module. This helped keep my
<code class="language-text">list</code> function simple, and helped me make composable queries.</p>
<p>My controllers and other services then <em>only</em> call functions in context modules.</p>
<p>For example:</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> MyApp<span class="token punctuation">.</span>Operators <span class="token keyword">do</span>
  <span class="token comment"># MyApp.Accounts is now a namespace for schemas, not a context</span>
  <span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>Accounts<span class="token punctuation">.</span>User
  <span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>Accounts<span class="token punctuation">.</span>Role
  <span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>Operators<span class="token punctuation">.</span>Query

  <span class="token keyword">def</span> list<span class="token punctuation">(</span>queryable <span class="token operator">\\</span> User<span class="token punctuation">)</span> <span class="token keyword">do</span>
    queryable
    <span class="token operator">|></span> Query<span class="token punctuation">.</span>where_operator
    <span class="token operator">|></span> Repo<span class="token punctuation">.</span>all
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> list_by_latest_event<span class="token punctuation">(</span>queryable <span class="token operator">\\</span> User<span class="token punctuation">)</span> <span class="token keyword">do</span>
    queryable
    <span class="token operator">|></span> Query<span class="token punctuation">.</span>order_by_event_date
    <span class="token operator">|></span> list
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> list_currently_assigned<span class="token punctuation">(</span>queryable <span class="token operator">\\</span> User<span class="token punctuation">)</span> <span class="token keyword">do</span>
    queryable
    <span class="token operator">|></span> Query<span class="token punctuation">.</span>where_assigned
    <span class="token operator">|></span> list
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> list_currently_assigned_for_activity<span class="token punctuation">(</span>queryable <span class="token operator">\\</span> User<span class="token punctuation">,</span> activity<span class="token punctuation">)</span> <span class="token keyword">do</span>
    queryable
    <span class="token operator">|></span> Query<span class="token punctuation">.</span>where_activity<span class="token punctuation">(</span>activity<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token operator">|></span> list_currently_assigned
  <span class="token keyword">end</span>

  <span class="token comment"># ...</span>
<span class="token keyword">end</span>

<span class="token keyword">defmodule</span> MyApp<span class="token punctuation">.</span>Operators<span class="token punctuation">.</span>Query <span class="token keyword">do</span>
  <span class="token keyword">import</span> Ecto<span class="token punctuation">.</span>Query
  <span class="token attribute variable">@role_id</span> <span class="token number">1</span>

  <span class="token keyword">def</span> where_operator<span class="token punctuation">(</span>queryable<span class="token punctuation">)</span> <span class="token keyword">do</span>
    queryable
    <span class="token operator">|></span> where<span class="token punctuation">(</span><span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>role_id <span class="token operator">==</span> <span class="token operator">^</span><span class="token attribute variable">@role_id</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> order_by_event_date<span class="token punctuation">(</span>queryable<span class="token punctuation">)</span> <span class="token keyword">do</span>
    queryable
    <span class="token operator">|></span> join<span class="token punctuation">(</span><span class="token atom symbol">:left</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">,</span> event <span class="token operator">in</span> assoc<span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token atom symbol">:event</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> order_by<span class="token punctuation">(</span><span class="token punctuation">[</span>_<span class="token punctuation">,</span> event<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token attr-name">desc:</span> event<span class="token punctuation">.</span>inserted_at<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> where_assigned<span class="token punctuation">(</span>queryable<span class="token punctuation">)</span> <span class="token keyword">do</span>
    queryable
    <span class="token operator">|></span> where<span class="token punctuation">(</span><span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">,</span> is_nil<span class="token punctuation">(</span>q<span class="token punctuation">.</span>unassigned_at<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> where_activity<span class="token punctuation">(</span>queryable<span class="token punctuation">,</span> activity<span class="token punctuation">)</span> <span class="token keyword">do</span>
    queryable
    <span class="token operator">|></span> join<span class="token punctuation">(</span><span class="token atom symbol">:inner</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">,</span> assignment <span class="token operator">in</span> assoc<span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token atom symbol">:assignments</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> where<span class="token punctuation">(</span><span class="token punctuation">[</span>_<span class="token punctuation">,</span> assignment<span class="token punctuation">]</span><span class="token punctuation">,</span> assignment<span class="token punctuation">.</span>activity_id <span class="token operator">==</span> <span class="token operator">^</span>activity_id<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<p>This has been my preferred way of organizing code so far. It encourages less
god-modules that I’ve learned to dislike so much. I believe that Phoenix will
need to be more careful about their generators accidentally encouraging
god-modules, lest they start to look like monolith Rails applications with
models that know too much about the application, except now in a context.</p>
<p><a name="maybeumbrella"></a></p>
<h3>Consider Before Umbrellas</h3>
<p>Elixir allows applications to live in umbrellas, which is an awesome concept. If
you’re not familiar with umbrellas, <a href="https://elixir-lang.org/getting-started/mix-otp/dependencies-and-umbrella-apps.html">read up about
it</a>.
What I love about umbrellas is that it allows me to draw boundaries between
related applications. This is difficult to do in other frameworks and languages,
so the fact that <code class="language-text">mix</code> gives this tool for free is <em>incredible</em>. Before I heard
about Phoenix contexts, I was drawn to organize my application via umbrellas
because I didn’t see other tools that made it easy.</p>
<p>Umbrellas, in a sense, help accomplish the same thing as contexts: it helps you
draw boundaries. The difference is that umbrella applications are about
separating applications instead of APIs.</p>
<p>A lot of typical web applications don’t need separated sub-applications. If
you’re considering one, determine if having separately-deployable applications
fixes or avoids problems, or if the boundaries need to be large enough to
deserve a separation. Avoid jumping to umbrellas like I did earlier if you only
need to organize yourself.</p>
<p><a href="https://youtu.be/tMO28ar0lW8?t=27m54s">Chris gives some good examples of when umbrellas could be a good
option</a></p>
<h2>Give It a Shot<a name="giveitago"></a></h2>
<p>At thoughtbot, we pride ourselves in the practices of designing experiences, and
<em>then</em> developing; <a href="https://thoughtbot.com/playbook">that’s what makes thoughtbot
different</a>. That process also helps establish
where these boundaries are up front, and it’s up to the artist to determine
whether it’s a new context, just a new schema, maybe a new application
altogether, maybe a support module, or none of the above.  Regardless, I believe
Phoenix 1.3 teaches <em>great</em> ideas that will win in the long run and make
developers think before doing.</p></div></article><div class="flex flex-wrap justify-between"><div class="w-full p-2 lg:w-1/2"><a class="text-white no-underline inline-flex items-center flex-1 button bg-purple-darker" href="/blog/simple-phoenix-text-inputs-with-formulator/"><svg class="w-6 h-6 mr-2 fill-current" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1408 960v-128q0-26-19-45t-45-19h-502l189-189q19-19 19-45t-19-45l-91-91q-18-18-45-18t-45 18l-362 362-91 91q-18 18-18 45t18 45l91 91 362 362q18 18 45 18t45-18l91-91q18-18 18-45t-18-45l-189-189h502q26 0 45-19t19-45zm256-64q0 209-103 385.5t-279.5 279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5 385.5-103 385.5 103 279.5 279.5 103 385.5z"></path></svg><span>Simple Phoenix Text Inputs with Formulator</span></a></div><div class="w-full p-2 lg:w-1/2"><a class="text-white no-underline inline-flex items-center flex-1 button bg-purple-darker" href="/blog/testing-emails-with-bamboo/"><span>Testing Random Data in Emails with Bamboo</span><svg class="w-6 h-6 ml-2 fill-current" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1413 896q0-27-18-45l-91-91-362-362q-18-18-45-18t-45 18l-91 91q-18 18-18 45t18 45l189 189h-502q-26 0-45 19t-19 45v128q0 26 19 45t45 19h502l-189 189q-19 19-19 45t19 45l91 91q18 18 45 18t45-18l362-362 91-91q18-18 18-45zm251 0q0 209-103 385.5t-279.5 279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5 385.5-103 385.5 103 279.5 279.5 103 385.5z"></path></svg></a></div></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/lessons-from-using-phoenix-1-3/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-e49f8733b8aee9471acf.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-8dc5b1de7df84c955e11.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-2780d9b33f550a804e84.js"],"component---src-pages-404-js":["/component---src-pages-404-js-f9633554493dddb1c536.js"],"component---src-pages-index-js":["/component---src-pages-index-js-da8729d9d0343d295966.js"],"component---src-pages-projects-js":["/component---src-pages-projects-js-757737b55f5d38274a17.js"]};/*]]>*/</script><script src="/webpack-runtime-41d54de024c2d1f9252e.js" async=""></script><script src="/app-e49f8733b8aee9471acf.js" async=""></script><script src="/framework-1cbcc4f69858806ac5db.js" async=""></script><script src="/1777bc0a756dace6068a54d243c7071eee1627a0-9e9727b36538e6264ac4.js" async=""></script><script src="/component---src-templates-blog-post-js-2780d9b33f550a804e84.js" async=""></script><script src="/styles-48fa8a050a65bb8447bd.js" async=""></script></body></html>