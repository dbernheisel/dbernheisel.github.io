<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.e44330c69abc2040b9ea.css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}main{display:block}h1{font-size:2em;margin:.67em 0}a{background-color:transparent}img{border-style:none}button{font-family:inherit;font-size:100%;line-height:1.15;margin:0;overflow:visible;text-transform:none}[type=button],[type=reset],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[hidden]{display:none}h1,h2,p{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}ul{list-style:none;margin:0;padding:0}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Droid Sans,Helvetica Neue,Fira Sans,sans-serif;line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid}img{border-style:solid}button{cursor:pointer}h1,h2{font-size:inherit;font-weight:inherit}a{text-decoration:inherit}a,button{color:inherit}button{padding:0;line-height:inherit}img,object,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}ul{list-style-type:disc;padding-left:1rem}@font-face{font-family:Fira Code;src:url(/FiraCode-Light.woff2) format("woff2"),url(/FiraCode-Light.woff) format("woff");font-weight:300;font-style:normal}@font-face{font-family:Fira Code;src:url(/FiraCode-Regular.woff2) format("woff2"),url(/FiraCode-Regular.woff) format("woff");font-weight:400;font-style:normal}@font-face{font-family:Fira Code;src:url(/FiraCode-Medium.woff2) format("woff2"),url(/FiraCode-Medium.woff) format("woff");font-weight:500;font-style:normal}@font-face{font-family:Fira Code;src:url(/FiraCode-SemiBold.woff2) format("woff2"),url(/FiraCode-SemiBold.woff) format("woff");font-weight:600;font-style:normal}@font-face{font-family:Fira Code;src:url(/FiraCode-Bold.woff2) format("woff2"),url(/FiraCode-Bold.woff) format("woff");font-weight:700;font-style:normal}@font-face{font-family:Fira Code VF;src:url(/FiraCode-VF.woff2) format("woff2-variations"),url(/FiraCode-VF.woff) format("woff-variations");font-weight:300 700;font-style:normal}body{background:#22292f;color:#fefefe;font-weight:300;margin:0;line-height:1.5;letter-spacing:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Droid Sans,Helvetica Neue,Fira Sans,sans-serif}h1,h2{margin-top:2rem;margin-bottom:1rem;color:#ed6a5a}h1{font-size:1.875rem}h2{font-size:1.5rem}h1:before,h2:before{color:#f6bbb4;margin-right:1rem}h1:before{content:"#";margin-left:-2.25rem}h2:before{content:"##"}p{margin-top:1rem;margin-bottom:1rem}article a{text-decoration:none}article a,article a:focus,article a:visited{color:#f6bbb4}article a:hover{color:#f6bbb4;border-bottom-width:1px;border-color:#31708e;text-decoration:none}nav a{color:#ed6a5a}nav a:focus,nav a:visited{color:#fefefe}nav a:hover{text-decoration:none;border-width:0}.post-header{font-size:1.875rem;font-weight:600}.post-header a{color:#ed6a5a;text-decoration:none}.frontmatter{color:#dae1e7;font-size:.75rem}.frontmatter a{color:#f6bbb4;text-decoration:none}.button{padding:.5rem 1rem;border-radius:.25rem}.bg-red{background-color:#ed6a5a}.bg-teal{background-color:#31708e}.bg-blue-dark{background-color:#324a69}.bg-purple-lighter{background-color:#f3e1f6}.hover\:bg-blue-darker:hover{background-color:#1c293b}.border-teal-light{border-color:#568aa2}.hover\:border-white:hover{border-color:#fefefe}.hover\:border-blue-darker:hover{border-color:#1c293b}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.border-2{border-width:2px}.border{border-width:1px}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.inline-flex{display:inline-flex}.hidden{display:none}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-between{justify-content:space-between}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.font-medium{font-weight:500}.font-black{font-weight:900}.h-3{height:.75rem}.h-6{height:1.5rem}.h-7{height:1.75rem}.leading-normal{line-height:1.5}.m-auto{margin:auto}.mx-2{margin-left:.5rem;margin-right:.5rem}.mt-0{margin-top:0}.mb-0{margin-bottom:0}.mr-2{margin-right:.5rem}.mb-2{margin-bottom:.5rem}.ml-2{margin-left:.5rem}.mt-4{margin-top:1rem}.mr-4{margin-right:1rem}.mb-8{margin-bottom:2rem}.max-w-lg{max-width:50rem}.p-2{padding:.5rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.shadow{box-shadow:0 2px 4px 0 rgba(0,0,0,.1)}.shadow-md{box-shadow:0 4px 8px 0 rgba(0,0,0,.12),0 2px 4px 0 rgba(0,0,0,.08)}.fill-current{fill:currentColor}.text-black{color:#22292f}.text-gray-light{color:#afadae}.hover\:text-white:hover,.text-white{color:#fefefe}.text-lg{font-size:1.125rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.hover\:no-underline:hover,.no-underline{text-decoration:none}.align-middle{vertical-align:middle}.w-3{width:.75rem}.w-6{width:1.5rem}.w-16{width:4rem}.w-full{width:100%}@media (min-width:576px){.sm\:text-4xl{font-size:2.25rem}}@media (min-width:992px){.lg\:inline-block{display:inline-block}.lg\:flex{display:flex}.lg\:hidden{display:none}.lg\:items-center{align-items:center}.lg\:h-32{height:8rem}.lg\:mt-0{margin-top:0}.lg\:text-5xl{font-size:3rem}.lg\:w-32{width:8rem}.lg\:w-auto{width:auto}.lg\:w-1\/2{width:50%}}</style><meta name="generator" content="Gatsby 2.20.9"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script>
  
  
  if(!(parseInt(navigator.doNotTrack) === 1 || parseInt(window.doNotTrack) === 1 || parseInt(navigator.msDoNotTrack) === 1 || navigator.doNotTrack === "yes")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-9152758-1', 'auto', {});
      
      
      
      
      
      }</script><link rel="alternate" type="application/rss+xml" title="David Bernheisel&#x27;s Blog RSS Feed" href="/rss.xml"/><link rel="icon" href="/android-chrome-36x36.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="36x36" href="/android-chrome-36x36.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="48x48" href="/android-chrome-48x48.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="72x72" href="/android-chrome-72x72.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="96x96" href="/android-chrome-96x96.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="144x144" href="/android-chrome-144x144.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="192x192" href="/android-chrome-192x192.png?v=611230f76b9c00b58e5b99e8a179a99d"/><title data-react-helmet="true">Querying an Embedded Map in PostgreSQL with Ecto | David Bernheisel</title><meta data-react-helmet="true" name="description" content="Structs and maps are easy to work with in Elixir, but if they are stored
in the database as JSON and accessed via an Ecto Schema, it’s not as
clear how to query them. We’re going to explore how to do that, and make
it clear and easy."/><link as="script" rel="preload" href="/styles-48fa8a050a65bb8447bd.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-dbfeaa6a961b52999927.js"/><link as="script" rel="preload" href="/1777bc0a756dace6068a54d243c7071eee1627a0-ad3445203dc2b623384d.js"/><link as="script" rel="preload" href="/framework-1cbcc4f69858806ac5db.js"/><link as="script" rel="preload" href="/app-e49f8733b8aee9471acf.js"/><link as="script" rel="preload" href="/webpack-runtime-65e74e8724f778ad1c5f.js"/><link as="fetch" rel="preload" href="/page-data/blog/querying-embedded-maps-in-postgresql-with-ecto/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><nav class="flex flex-wrap items-center justify-between p-4 shadow-md bg-teal"><a class="no-underline" href="/"><div class="flex items-center flex-shrink-0 mr-6 text-white"><img src="/static/profile-picture-977b63cbce04bae4479e3185b22bfb1a.jpg" alt="David Bernheisel" class="w-16 h-16 mr-4 border-2 rounded-full shadow-md lg:w-32 lg:h-32 border-teal-light"/><span class="text-2xl font-black sm:text-4xl lg:text-5xl">David Bernheisel</span></div></a><div class="block lg:hidden"><button class="flex items-center px-3 py-2 border rounded text-gray-light border-teal-light hover:text-white hover:border-white"><svg class="w-3 h-3 fill-current" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg></button></div><div class="w-full block lg:mt-0 mt-4 lg:flex lg:items-center lg:w-auto hidden"><a class="no-underline bg-blue-dark hover:border-blue-darker hover:bg-blue-darker text-white font-medium block lg:inline-block mt-4 mr-4 lg:mt-0 shadow rounded py-1 px-3" href="/">Blog</a><a class="no-underline bg-blue-dark hover:border-blue-darker hover:bg-blue-darker text-white font-medium block lg:inline-block mt-4 mr-4 lg:mt-0 shadow rounded py-1 px-3" href="/projects/">Projects</a><a class="block px-3 py-1 mt-4 mr-4 font-medium text-white no-underline rounded shadow bg-blue-dark hover:border-blue-darker hover:bg-blue-darker lg:inline-block lg:mt-0 hover:no-underline" href="https://twitter.com/bernheisel">Twitter</a><div class="py-1 mt-4 lg:mt-0"><a href="/rss.xml"><img class="align-middle h-7" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICAgaWQ9IlJTU2ljb24iCiAgICAgdmlld0JveD0iMCAwIDggOCIgd2lkdGg9IjI1NiIgaGVpZ2h0PSIyNTYiPgoKICA8dGl0bGU+UlNTIGZlZWQgaWNvbjwvdGl0bGU+CgogIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAgICAuYnV0dG9uIHtzdHJva2U6IG5vbmU7IGZpbGw6IG9yYW5nZTt9CiAgICAuc3ltYm9sIHtzdHJva2U6IG5vbmU7IGZpbGw6IHdoaXRlO30KICA8L3N0eWxlPgoKICA8cmVjdCAgIGNsYXNzPSJidXR0b24iIHdpZHRoPSI4IiBoZWlnaHQ9IjgiIHJ4PSIxLjUiIC8+CiAgPGNpcmNsZSBjbGFzcz0ic3ltYm9sIiBjeD0iMiIgY3k9IjYiIHI9IjEiIC8+CiAgPHBhdGggICBjbGFzcz0ic3ltYm9sIiBkPSJtIDEsNCBhIDMsMyAwIDAgMSAzLDMgaCAxIGEgNCw0IDAgMCAwIC00LC00IHoiIC8+CiAgPHBhdGggICBjbGFzcz0ic3ltYm9sIiBkPSJtIDEsMiBhIDUsNSAwIDAgMSA1LDUgaCAxIGEgNiw2IDAgMCAwIC02LC02IHoiIC8+Cgo8L3N2Zz4=" alt="RSS"/></a></div></div></nav><main class="max-w-lg p-4 m-auto text-lg"><article class="blog-post"><h1 class="mb-0 text-3xl">Querying an Embedded Map in PostgreSQL with Ecto</h1><p class="mt-0 mb-8 text-sm frontmatter"><span>Published on <!-- -->March 09, 2018</span><span><span class="mx-2">|</span><a href="https://robots.thoughtbot.com/querying-embedded-maps-in-postgresql-with-ecto">Original Publishing</a></span><span><span class="mx-2">|</span>5<!-- -->m read</span></p><div><p>Structs and maps are easy to work with in Elixir, but if they are stored
in the database as JSON and accessed via an Ecto Schema, it’s not as
clear how to query them. We’re going to explore how to do that, and make
it clear and easy.</p>
<!-- excerpt -->
<p>PostgreSQL has <a href="https://www.postgresql.org/docs/current/static/functions-json.html">great support for objects stored as JSON</a>.
This is useful for those moments when you need to store data that could
be variably structured, such as responses from other services’ APIs, or
data that frequently travels together within your relational tables.</p>
<p>A common trade-off for mixing scalar column data types (like <code class="language-text">varchar</code>
or <code class="language-text">integer</code>) with column data types that handle more-complicated
objects (like <abbr title="JavaScript Object Notation">JSON</abbr>) is
that <abbr title="Object-relational Mapping">ORMs</abbr> or data mappers
sometimes can’t introspect on them for you, which means it becomes much
harder to query that data.</p>
<p>Using Ecto’s <code class="language-text">embedded_schema</code> helps introspect on those known values,
but it doesn’t really assist you with querying those fields in SQL. This
is where I became extremely greatful for <a href="https://hexdocs.pm/ecto/Ecto.Query.html#module-fragments">Ecto’s escape
hatch</a>: <code class="language-text">fragment()</code>.</p>
<h2>Define the Struct or Map in Ecto</h2>
<p>Let’s dive into some code as an example:</p>
<p>I have a <code class="language-text">Vehicle.Photo</code> schema that has several versions of the photo:</p>
<ul>
<li>craigslist_ad</li>
<li>facebook_ad</li>
<li>facebook_carousel_ad</li>
<li>extra_large</li>
<li>extra_small</li>
<li>large</li>
<li>medium</li>
<li>original</li>
<li>small</li>
</ul>
<p>We decided to store the versions’ <abbr title="Uniform Resource
Locators">URLs</abbr> inside a map in the database,
because we’re going to use a set of the URLs at the same time inside of
an HTML <code class="language-text">&lt;img srcset /&gt;</code>. <a href="https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images">You can read more about srcset from
MDN and how it helps with responsive images</a>.</p>
<p>The Ecto migration looks like this:</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">def</span> up <span class="token keyword">do</span>
  alter table<span class="token punctuation">(</span><span class="token atom symbol">:vehicle_photos</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    add <span class="token atom symbol">:standard_urls</span><span class="token punctuation">,</span> <span class="token atom symbol">:map</span>
    add <span class="token atom symbol">:facebook_urls</span><span class="token punctuation">,</span> <span class="token atom symbol">:map</span>
    add <span class="token atom symbol">:craigslist_urls</span><span class="token punctuation">,</span> <span class="token atom symbol">:map</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<p>The Ecto schema looks like this:</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir">schema <span class="token string">"vehicle_photos"</span> <span class="token keyword">do</span>
  field<span class="token punctuation">(</span><span class="token atom symbol">:file</span><span class="token punctuation">,</span> PhotoUploader<span class="token punctuation">.</span>Type<span class="token punctuation">)</span>

  embeds_one <span class="token atom symbol">:standard_urls</span><span class="token punctuation">,</span> StandardUrls<span class="token punctuation">,</span> <span class="token attr-name">on_replace:</span> <span class="token atom symbol">:update</span> <span class="token keyword">do</span>
    field<span class="token punctuation">(</span><span class="token atom symbol">:extra_large</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span><span class="token punctuation">)</span>
    field<span class="token punctuation">(</span><span class="token atom symbol">:extra_small</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span><span class="token punctuation">)</span>
    field<span class="token punctuation">(</span><span class="token atom symbol">:large</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span><span class="token punctuation">)</span>
    field<span class="token punctuation">(</span><span class="token atom symbol">:medium</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span><span class="token punctuation">)</span>
    field<span class="token punctuation">(</span><span class="token atom symbol">:original</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span><span class="token punctuation">)</span>
    field<span class="token punctuation">(</span><span class="token atom symbol">:small</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  embeds_one <span class="token atom symbol">:facebook_urls</span><span class="token punctuation">,</span> FacebookUrls<span class="token punctuation">,</span> <span class="token attr-name">on_replace:</span> <span class="token atom symbol">:update</span> <span class="token keyword">do</span>
    field<span class="token punctuation">(</span><span class="token atom symbol">:hero_ad</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span><span class="token punctuation">)</span>
    field<span class="token punctuation">(</span><span class="token atom symbol">:carousel_ad</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  embeds_one <span class="token atom symbol">:craigslist_urls</span><span class="token punctuation">,</span> CraigslistUrls<span class="token punctuation">,</span> <span class="token attr-name">on_replace:</span> <span class="token atom symbol">:update</span> <span class="token keyword">do</span>
    field<span class="token punctuation">(</span><span class="token atom symbol">:ad</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<p>Since this is a known structure, Ecto can introspect on the JSON values and
cast and dump them to the appropriate Elixir data types, which is immensely
helpful. Here I am achieving that by using <code class="language-text">embeds_one</code> and specifying the
struct. Once pulled from the database, Ecto will decode them.</p>
<p>Other times, you may not be able to do this ahead of time, so the schema
might look like this (the <code class="language-text">api_response</code> field):</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir">schema <span class="token string">"vehicle_photos"</span> <span class="token keyword">do</span>
  field<span class="token punctuation">(</span><span class="token atom symbol">:file</span><span class="token punctuation">,</span> PhotoUploader<span class="token punctuation">.</span>Type<span class="token punctuation">)</span>
  field<span class="token punctuation">(</span><span class="token atom symbol">:api_response</span><span class="token punctuation">,</span> <span class="token atom symbol">:map</span><span class="token punctuation">)</span>
<span class="token keyword">end</span></code></pre></div>
<h2>Query the JSON</h2>
<p>Continuing with the struct example schema, we found out that some of our
URLs weren’t being populated like we expected, so I had to find those
photos and fix them. How do I query for them since they’re stored in
PostgreSQL as JSON? We need to drop down into raw SQL:</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">def</span> where_photo_urls_have_a_null<span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token keyword">do</span>
  query
  <span class="token operator">|></span> where<span class="token punctuation">(</span><span class="token punctuation">[</span>_q<span class="token punctuation">]</span><span class="token punctuation">,</span> fragment<span class="token punctuation">(</span>
    <span class="token string">"""
    (facebook_urls IS NULL) OR
    (facebook_urls->>'ad_version' IS NULL) OR
    (facebook_urls->>'hero_version' IS NULL) OR
    (craigslist_urls->>'ad' IS NULL)
    """</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span></code></pre></div>
<p>The SQL operator <code class="language-text">-&gt;&gt;</code> will leverage <a href="https://www.postgresql.org/docs/current/static/functions-json.html">PostgreSQL’s JSON
functions</a> to retrieve the text or integers that are stored
in the JSON. You can access them using this syntax: <code class="language-text">column-&gt;&gt;key</code>. In
my case, I needed to find if the column was null, or it wasn’t null,
then to ask if the JSON object has any keys that are null.  This will
work regardless of whether you use an embedded struct or a map, because
PostgreSQL sees it as the same thing: JSON.</p>
<p>Here’s an example that checks for substrings:</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">def</span> where_photo_url_wrong<span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token keyword">do</span>
  query
  <span class="token operator">|></span> where<span class="token punctuation">(</span><span class="token punctuation">[</span>_q<span class="token punctuation">]</span><span class="token punctuation">,</span> fragment<span class="token punctuation">(</span>
    <span class="token string">"""
    (facebook_urls->>'hero_ad' NOT ILIKE ?) OR
    (facebook_urls->>'carousel_ad' NOT ILIKE ?) OR
    (craigslist_urls->>'ad' NOT ILIKE ?)
    """</span><span class="token punctuation">,</span>
    <span class="token string">"%facebook_hero_ad%"</span><span class="token punctuation">,</span>
    <span class="token string">"%facebook_carousel_ad%"</span><span class="token punctuation">,</span>
    <span class="token string">"%craigslist_ad%"</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span></code></pre></div>
<h2>Make the Query Composable</h2>
<p>Above is all I needed for my use case, but I wondered how I could continue
querying those fields in a reusable way. For example, how do I chain these
together in an <code class="language-text">OR</code> statement that uses both of these fragments?</p>
<p>To do that, I’ll need to extract the <code class="language-text">fragment</code> expressions and put them
into a macro so they can be used within Ecto’s functions.</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> MyProject<span class="token punctuation">.</span>SampleQuery<span class="token punctuation">.</span>Fragments <span class="token keyword">do</span>
  <span class="token keyword">import</span> Ecto<span class="token punctuation">.</span>Query<span class="token punctuation">.</span>API<span class="token punctuation">,</span> <span class="token attr-name">only:</span> <span class="token punctuation">[</span><span class="token attr-name">fragment:</span> <span class="token number">1</span><span class="token punctuation">]</span>

  defmacro photo_urls_have_a_null <span class="token keyword">do</span>
    quote <span class="token keyword">do</span>
      fragment<span class="token punctuation">(</span>
        <span class="token string">"""
        (facebook_urls IS NULL) OR
        (facebook_urls->>'ad_version' IS NULL) OR
        (facebook_urls->>'hero_version' IS NULL) OR
        (craigslist_urls->>'ad' IS NULL)
        """</span>
      <span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  defmacro photo_urls_not_contain<span class="token punctuation">(</span><span class="token punctuation">[</span>hero_ad_value<span class="token punctuation">,</span> carousel_ad_value<span class="token punctuation">,</span> ad_value<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    quote <span class="token keyword">do</span>
      fragment<span class="token punctuation">(</span>
        <span class="token string">"""
        (facebook_urls->>'hero_ad' NOT ILIKE ?) OR
        (facebook_urls->>'carousel_ad' NOT ILIKE ?) OR
        (craigslist_urls->>'ad' NOT ILIKE ?)
        """</span><span class="token punctuation">,</span>
        <span class="token operator">^</span><span class="token string">"%<span class="token interpolation"><span class="token delimiter punctuation">#{</span>unquote<span class="token punctuation">(</span>hero_ad_value<span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span>%"</span><span class="token punctuation">,</span>
        <span class="token operator">^</span><span class="token string">"%<span class="token interpolation"><span class="token delimiter punctuation">#{</span>unquote<span class="token punctuation">(</span>carousel_ad_value<span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span>%"</span><span class="token punctuation">,</span>
        <span class="token operator">^</span><span class="token string">"%<span class="token interpolation"><span class="token delimiter punctuation">#{</span>unquote<span class="token punctuation">(</span>ad_value<span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span>%"</span>
      <span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<p>Now that those fragments are extracted, let’s use them:</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">import</span> MyProject<span class="token punctuation">.</span>SampleQuery<span class="token punctuation">.</span>Fragments
<span class="token keyword">alias</span> MyProject<span class="token punctuation">.</span>Photo

<span class="token keyword">defmodule</span> MyProject<span class="token punctuation">.</span>SampleQuery <span class="token keyword">do</span>
  <span class="token keyword">def</span> find_bad_photos<span class="token punctuation">(</span>query <span class="token operator">\\</span> Photo<span class="token punctuation">)</span> <span class="token keyword">do</span>
    query
    <span class="token operator">|></span> where<span class="token punctuation">(</span><span class="token punctuation">[</span>_p<span class="token punctuation">]</span><span class="token punctuation">,</span> photo_urls_have_a_null<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> or_where<span class="token punctuation">(</span><span class="token punctuation">[</span>_p<span class="token punctuation">]</span><span class="token punctuation">,</span> photo_urls_not_contain<span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token string">"facebook_hero_ad"</span><span class="token punctuation">,</span>
      <span class="token string">"facebook_carousel_ad"</span><span class="token punctuation">,</span>
      <span class="token string">"craigslist_ad"</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">|></span> Repo<span class="token punctuation">.</span>all
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<p><strong>Beautiful.</strong></p>
<p>If you’d like to check out the code a little more, you can see this
<a href="https://github.com/dbernheisel/sample_json_ecto_queries">sample Ecto and Phoenix repo with tests</a>.</p>
<p>This article only explains how to query a JSON object in the database
and how it works with Ecto querying. If you’re needing to store an array
of maps or structs, then check out Jon’s post <a href="https://robots.thoughtbot.com/why-ecto-s-way-of-storing-embedded-lists-of-maps-makes-querying-hard">Why Ecto’s Way of
Storing Embedded Lists of Maps Makes Querying Hard</a>.</p></div></article><div class="flex flex-wrap justify-between"><div class="w-full p-2 lg:w-1/2"><a class="no-underline text-black inline-flex items-center flex-1 button bg-purple-lighter" href="/blog/testing-emails-with-bamboo/"><svg class="w-6 h-6 mr-2 fill-current" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1408 960v-128q0-26-19-45t-45-19h-502l189-189q19-19 19-45t-19-45l-91-91q-18-18-45-18t-45 18l-362 362-91 91q-18 18-18 45t18 45l91 91 362 362q18 18 45 18t45-18l91-91q18-18 18-45t-18-45l-189-189h502q26 0 45-19t19-45zm256-64q0 209-103 385.5t-279.5 279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5 385.5-103 385.5 103 279.5 279.5 103 385.5z"></path></svg><span>Testing Random Data in Emails with Bamboo</span></a></div><div class="w-full p-2 lg:w-1/2"><a class="no-underline text-black inline-flex items-center flex-1 button bg-purple-lighter" href="/blog/ruby-rails-and-circle-ci-workflows/"><span>Ruby, Rails, and CircleCI 2.0 Workflows</span><svg class="w-6 h-6 ml-2 fill-current" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1413 896q0-27-18-45l-91-91-362-362q-18-18-45-18t-45 18l-91 91q-18 18-18 45t18 45l189 189h-502q-26 0-45 19t-19 45v128q0 26 19 45t45 19h502l-189 189q-19 19-19 45t19 45l91 91q18 18 45 18t45-18l362-362 91-91q18-18 18-45zm251 0q0 209-103 385.5t-279.5 279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5 385.5-103 385.5 103 279.5 279.5 103 385.5z"></path></svg></a></div></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/querying-embedded-maps-in-postgresql-with-ecto/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-e49f8733b8aee9471acf.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-8dc5b1de7df84c955e11.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-dbfeaa6a961b52999927.js"],"component---src-pages-404-js":["/component---src-pages-404-js-f9633554493dddb1c536.js"],"component---src-pages-index-js":["/component---src-pages-index-js-da8729d9d0343d295966.js"],"component---src-pages-projects-js":["/component---src-pages-projects-js-757737b55f5d38274a17.js"]};/*]]>*/</script><script src="/webpack-runtime-65e74e8724f778ad1c5f.js" async=""></script><script src="/app-e49f8733b8aee9471acf.js" async=""></script><script src="/framework-1cbcc4f69858806ac5db.js" async=""></script><script src="/1777bc0a756dace6068a54d243c7071eee1627a0-ad3445203dc2b623384d.js" async=""></script><script src="/component---src-templates-blog-post-js-dbfeaa6a961b52999927.js" async=""></script><script src="/styles-48fa8a050a65bb8447bd.js" async=""></script></body></html>