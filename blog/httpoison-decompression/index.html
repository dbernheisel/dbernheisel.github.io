<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.9841c30ca4b98edfc4a4.css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}main{display:block}h1{font-size:2em;margin:.67em 0}a{background-color:transparent}img{border-style:none}button{font-family:inherit;font-size:100%;line-height:1.15;margin:0;overflow:visible;text-transform:none}[type=button],[type=reset],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[hidden]{display:none}h1,h2,p{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}ul{list-style:none;margin:0;padding:0}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Droid Sans,Helvetica Neue,Fira Sans,sans-serif;line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid}img{border-style:solid}button{cursor:pointer}h1,h2{font-size:inherit;font-weight:inherit}a{text-decoration:inherit}a,button{color:inherit}button{padding:0;line-height:inherit}img,object,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}ul{list-style-type:disc;padding-left:1rem}body{background:#22292f;color:#fefefe;font-weight:300;margin:0;line-height:1.5;letter-spacing:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Droid Sans,Helvetica Neue,Fira Sans,sans-serif}h1,h2{margin-top:2rem;margin-bottom:1rem;color:#ed6a5a}h1{font-size:1.875rem}h2{font-size:1.5rem}h1:before,h2:before{color:#f6bbb4;margin-right:1rem}h1:before{content:"#";margin-left:-2.25rem}h2:before{content:"##"}p{margin-top:1rem;margin-bottom:1rem}article a{text-decoration:none}article a,article a:focus,article a:visited{color:#f6bbb4}article a:hover{color:#f6bbb4;border-bottom-width:1px;border-color:#31708e;text-decoration:none}nav a{color:#ed6a5a}nav a:focus,nav a:visited{color:#fefefe}nav a:hover{text-decoration:none;border-width:0}.post-header{font-size:1.875rem;font-weight:600}.post-header a{color:#ed6a5a;text-decoration:none}.frontmatter{color:#dae1e7;font-size:.75rem}.frontmatter a{color:#f6bbb4;text-decoration:none}.button{padding:.5rem 1rem;border-radius:.25rem}.bg-red{background-color:#ed6a5a}.bg-teal{background-color:#31708e}.bg-blue-dark{background-color:#324a69}.bg-purple-darker{background-color:#bc9cc2}.hover\:bg-blue-darker:hover{background-color:#1c293b}.border-teal-light{border-color:#568aa2}.hover\:border-white:hover{border-color:#fefefe}.hover\:border-blue-darker:hover{border-color:#1c293b}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.border-2{border-width:2px}.border{border-width:1px}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.inline-flex{display:inline-flex}.hidden{display:none}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-between{justify-content:space-between}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.font-medium{font-weight:500}.font-black{font-weight:900}.h-3{height:.75rem}.h-6{height:1.5rem}.h-7{height:1.75rem}.leading-normal{line-height:1.5}.m-auto{margin:auto}.mx-2{margin-left:.5rem;margin-right:.5rem}.mt-0{margin-top:0}.mb-0{margin-bottom:0}.mr-2{margin-right:.5rem}.mb-2{margin-bottom:.5rem}.ml-2{margin-left:.5rem}.mt-4{margin-top:1rem}.mr-4{margin-right:1rem}.mb-8{margin-bottom:2rem}.max-w-lg{max-width:50rem}.p-2{padding:.5rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.shadow{box-shadow:0 2px 4px 0 rgba(0,0,0,.1)}.shadow-md{box-shadow:0 4px 8px 0 rgba(0,0,0,.12),0 2px 4px 0 rgba(0,0,0,.08)}.fill-current{fill:currentColor}.text-gray-light{color:#afadae}.hover\:text-white:hover,.text-white{color:#fefefe}.text-lg{font-size:1.125rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.hover\:no-underline:hover,.no-underline{text-decoration:none}.align-middle{vertical-align:middle}.w-3{width:.75rem}.w-6{width:1.5rem}.w-16{width:4rem}.w-full{width:100%}@media (min-width:576px){.sm\:text-4xl{font-size:2.25rem}}@media (min-width:992px){.lg\:inline-block{display:inline-block}.lg\:flex{display:flex}.lg\:hidden{display:none}.lg\:items-center{align-items:center}.lg\:h-32{height:8rem}.lg\:mt-0{margin-top:0}.lg\:text-5xl{font-size:3rem}.lg\:w-32{width:8rem}.lg\:w-auto{width:auto}.lg\:w-1\/2{width:50%}}code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.20.9"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script>
  
  
  if(!(parseInt(navigator.doNotTrack) === 1 || parseInt(window.doNotTrack) === 1 || parseInt(navigator.msDoNotTrack) === 1 || navigator.doNotTrack === "yes")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-9152758-1', 'auto', {});
      
      
      
      
      
      }</script><link rel="alternate" type="application/rss+xml" title="David Bernheisel&#x27;s Blog RSS Feed" href="/rss.xml"/><link rel="icon" href="/android-chrome-36x36.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="36x36" href="/android-chrome-36x36.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="48x48" href="/android-chrome-48x48.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="72x72" href="/android-chrome-72x72.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="96x96" href="/android-chrome-96x96.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="144x144" href="/android-chrome-144x144.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="192x192" href="/android-chrome-192x192.png?v=611230f76b9c00b58e5b99e8a179a99d"/><title data-react-helmet="true">HTTPoison and Decompression | David Bernheisel</title><meta data-react-helmet="true" name="description" content="Did you know that Ruby’s
Net::HTTP
class automatically decompresses responses? It handles a lot of use cases that
we don’t have to remember…"/><link as="script" rel="preload" href="/styles-48fa8a050a65bb8447bd.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-2780d9b33f550a804e84.js"/><link as="script" rel="preload" href="/1777bc0a756dace6068a54d243c7071eee1627a0-9e9727b36538e6264ac4.js"/><link as="script" rel="preload" href="/framework-1cbcc4f69858806ac5db.js"/><link as="script" rel="preload" href="/app-e49f8733b8aee9471acf.js"/><link as="script" rel="preload" href="/webpack-runtime-41d54de024c2d1f9252e.js"/><link as="fetch" rel="preload" href="/page-data/blog/httpoison-decompression/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><nav class="flex flex-wrap items-center justify-between p-4 shadow-md bg-teal"><a class="text-white no-underline" href="/"><div class="flex items-center flex-shrink-0 mr-6 text-white"><img src="/static/profile-picture-977b63cbce04bae4479e3185b22bfb1a.jpg" alt="David Bernheisel" class="w-16 h-16 mr-4 border-2 rounded-full shadow-md lg:w-32 lg:h-32 border-teal-light"/><span class="text-2xl font-black sm:text-4xl lg:text-5xl">David Bernheisel</span></div></a><div class="block lg:hidden"><button class="flex items-center px-3 py-2 border rounded text-gray-light border-teal-light hover:text-white hover:border-white"><svg class="w-3 h-3 fill-current" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg></button></div><div class="w-full block lg:mt-0 mt-4 lg:flex lg:items-center lg:w-auto hidden"><a class="text-white no-underline bg-blue-dark hover:border-blue-darker hover:bg-blue-darker text-white font-medium block lg:inline-block mt-4 mr-4 lg:mt-0 shadow rounded py-1 px-3" href="/">Blog</a><a class="text-white no-underline bg-blue-dark hover:border-blue-darker hover:bg-blue-darker text-white font-medium block lg:inline-block mt-4 mr-4 lg:mt-0 shadow rounded py-1 px-3" href="/projects/">Projects</a><a class="block px-3 py-1 mt-4 mr-4 font-medium text-white no-underline rounded shadow bg-blue-dark hover:border-blue-darker hover:bg-blue-darker lg:inline-block lg:mt-0 hover:no-underline" href="https://twitter.com/bernheisel">Twitter</a><div class="py-1 mt-4 lg:mt-0"><a href="/rss.xml"><img class="align-middle h-7" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICAgaWQ9IlJTU2ljb24iCiAgICAgdmlld0JveD0iMCAwIDggOCIgd2lkdGg9IjI1NiIgaGVpZ2h0PSIyNTYiPgoKICA8dGl0bGU+UlNTIGZlZWQgaWNvbjwvdGl0bGU+CgogIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAgICAuYnV0dG9uIHtzdHJva2U6IG5vbmU7IGZpbGw6IG9yYW5nZTt9CiAgICAuc3ltYm9sIHtzdHJva2U6IG5vbmU7IGZpbGw6IHdoaXRlO30KICA8L3N0eWxlPgoKICA8cmVjdCAgIGNsYXNzPSJidXR0b24iIHdpZHRoPSI4IiBoZWlnaHQ9IjgiIHJ4PSIxLjUiIC8+CiAgPGNpcmNsZSBjbGFzcz0ic3ltYm9sIiBjeD0iMiIgY3k9IjYiIHI9IjEiIC8+CiAgPHBhdGggICBjbGFzcz0ic3ltYm9sIiBkPSJtIDEsNCBhIDMsMyAwIDAgMSAzLDMgaCAxIGEgNCw0IDAgMCAwIC00LC00IHoiIC8+CiAgPHBhdGggICBjbGFzcz0ic3ltYm9sIiBkPSJtIDEsMiBhIDUsNSAwIDAgMSA1LDUgaCAxIGEgNiw2IDAgMCAwIC02LC02IHoiIC8+Cgo8L3N2Zz4=" alt="RSS"/></a></div></div></nav><main class="max-w-lg p-4 m-auto text-lg"><article class="blog-post"><h1 class="mb-0 text-3xl">HTTPoison and Decompression</h1><p class="mt-0 mb-8 text-sm frontmatter"><span>Published on <!-- -->June 01, 2019</span><span><span class="mx-2">|</span>11<!-- -->m read</span></p><div><p>Did you know that Ruby’s
<a href="https://ruby-doc.org/stdlib-2.6.3/libdoc/net/http/rdoc/Net/HTTP.html#class-Net::HTTP-label-Compression">Net::HTTP</a>
class automatically decompresses responses? It handles a lot of use cases that
we don’t have to remember ourselves. It’s built into Ruby!</p>
<p>When I came across a JSON API service that was returning binary, I was a bit
puzzled; “what is this binary? I’m supposed to be getting text back…” and,
it’s not consistent either: sometimes I get text <em>on the same exact request</em> a
minute later. Baffling.</p>
<p>On top of that, I was using <a href="https://github.com/parroty/exvcr">ExVCR</a> in some tests which serializes the
request/response chain into JSON. ExVCR takes binary responses, encodes it into
Erlang Term format, then Base64 encodes that, and then puts <em>that</em> in the JSON
file it writes; and does all that in reverse when it’s replaying the “cassette”
when the tests run.</p>
<p>I’ve seen text before on this endpoint, and now I’m getting binary
sometimes; and wait-a-second, don’t HTTP clients decompress responses? I’m
pretty sure I didn’t worry about this with Ruby’s Net::HTTP or HTTParty.</p>
<p>Turns out, in the Elixir ecosystem, HTTPoison along with other common HTTP
clients like HTTPotion, the new Mint, Gun, and probably others don’t do this
automatically.</p>
<h2>Let’s back up</h2>
<p>HTTP requests and responses have some headers that tell the client/server what
format of content we’re looking for. The ones we care about here is
<b><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-Encoding">Accept-Encoding</a></b> and <b><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Encoding">Content-Encoding</a></b>. There’s another one
that’s related called <b><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type">Content-Type</a></b>, but that’s not exactly about
compression, but we’ll get to this one later.</p>
<p>Accept-Encoding is what the client will use to say “YO SERVER! I need some of
this resource, and I can handle it compressed with <a href="https://github.com/google/brotli">brotli</a>”</p>
<p>Content-Encoding is what the server will respond with, as in “Oh hay Client!
Nice to see you; here’s your content as requested. I even compressed it in
brotli”</p>
<p>What <em>REALLY</em> happens (in my experience), is that Accept-Encoding is ignored,
and <strong>the server’s gonna give whatever it wants to you</strong>. To complicate it more,
there are layers between the client and server that may compress data and modify
headers (or not). So, the server might have sent plaintext and provided a
Content-Encoding of <code class="language-text">identity</code> or not a Content-Encoding at all (both of these
mean there is no compression.), but a load balancer, router, CDN, whatever,
might have compressed the body of data on the way back from the server to the
client.</p>
<p>So what’s the client to do? It has to guess. This is probably why some clients
don’t automatically decompress data for you.</p>
<p>Here are some of the options for <code class="language-text">Content-Encoding</code>:</p>
<table>
<thead>
<tr>
<th>value</th>
<th>meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">gzip</code></td>
<td>Compressed with Lempel-Ziv (LZ77). On desktops, this is a <code class="language-text">.gz</code> file</td>
</tr>
<tr>
<td><code class="language-text">x-gzip</code></td>
<td>Same as above, just an older expression</td>
</tr>
<tr>
<td><code class="language-text">compress</code></td>
<td>Compressed with Lempel-Ziv-Welch (LZW)</td>
</tr>
<tr>
<td><code class="language-text">deflate</code></td>
<td>Compressed with zlib. On desktops, this is a normal <code class="language-text">.zip</code> file</td>
</tr>
<tr>
<td><code class="language-text">br</code></td>
<td>Compressed with brotli.</td>
</tr>
<tr>
<td><code class="language-text">identity</code></td>
<td>No compression</td>
</tr>
<tr>
<td>(missing)</td>
<td>No compression</td>
</tr>
</tbody>
</table>
<p>As an interesting sidenote, Phoenix supports compression into Brotli, but
otherwise there’s not yet built-in support for decompressing Brotli in
Erlang/Elixir. There’s also no built-in support for LZW, but that’s ok because
it’s not as good or popular as the other formats. The only built-ins for Erlang
and Elixir are <code class="language-text">gzip</code> and <code class="language-text">deflate</code> so that’s what I’ll support on this first
iteration.</p>
<h2>HTTPoison</h2>
<p>In Elixir, the most popular HTTP client is <a href="https://github.com/edgurgel/httpoison">HTTPoison</a> according to <a href="https://hex.pm/packages">hex.pm</a>.
Actually, let me clarify: HTTPoison itself doesn’t do any HTTP requests itself;
what I mean is it’s a wrapper for the Erlang HTTP client called <a href="https://github.com/benoitc/hackney">hackney</a> which
actually does the HTTP requests, and HTTPoison wraps around that to make the API
a bit friendlier for Elixir.</p>
<p>Let me re-word that for my use-case: I’m making a wrapper for a wrapper.</p>
<p>I’m not the first to notice that it doesn’t decompress responses automatically.
There’s been an <a href="https://github.com/edgurgel/httpoison/issues/81">issue</a> open
since 2015 for them to auto-decompress, but the author has decided, (me
paraphrasing), “I’m not going to do it, but hackney is so we’ll get to benefit
from it soon enough!”, and <em>that</em>
<a href="https://github.com/benoitc/hackney/issues/155">issue</a> has been open for a since
Jan 2015. We’re still waiting. It’s June 2019. 4.5 years.</p>
<p>Ok, cool, but I need to handle this now, and it doesn’t seem like there’s
movement in the popular library of choice.</p>
<h2>It’s a little unfair</h2>
<p>It’s unfair for me to suggest these libraries should absolutely support
decompression out of the box, because these clients are really powerful. They
also support streaming which complicates decompression. But, for simple JSON
request/responses and for most APIs, we’re not streaming.</p>
<p>Major props for these libraries making my life easier; my issue is that I didn’t
know about these concepts before diving in, and through an issue I learned
about HTTP decompression.</p>
<p><img src="/3b9749e92576dae35e059a75d733a18d/til.gif" alt="TIL"></p>
<h2>One more problem: Character Encoding</h2>
<p>I am also working with an API service that responds with characters encoded in
ISO-8859-1 sometimes; not in UTF-8. In Elixir, strings are UTF-8 so I need to
make sure I can convert those characters to something readable for my logs, and
ultimately the clients. This character encoding is indicated in the HTTP header
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type">Content-Type</a>, paired with the format of content, like JSON or XML. It’s going
to look something like <code class="language-text">text/plain;charset=utf-8</code> or
<code class="language-text">application/json;charset=ISO-8859-1</code>.</p>
<h2>Let’s do it</h2>
<p>Let’s stick with HTTPoison out of pure laziness. If you’re implementing from
scratch, I’d recommend you to look at <a href="https://github.com/ericmj/mint">Mint</a> first because it has no
dependencies and has a better philosophy with OTP, which is a <em>good thing</em>.
<a href="https://github.com/teamon/tesla">Tesla</a> is also a good HTTP client to consider.</p>
<p>Let me re-word that again: I’m going to write a wrapper (MyApp.HTTPClient) for a
wrapper (HTTPoison) of hackney for a wrapper (my layer that covers the 3rd party
API) of a 3rd party service. Exciting.</p>
<p>Also please know that my project also includes Phoenix and Plug, so you might
see some helpers in the tests and implementation. If you’re not using Phoenix or
Plug, it should be pretty easy to replace these functions with your own.</p>
<h2>My interface</h2>
<p>It’s going to be exactly like HTTPoison’s. Creative, I know. But, this way I can
replace any usage of <code class="language-text">HTTPoison.get</code> or <code class="language-text">HTTPoison.post</code> with my own
<code class="language-text">HttpClient.get</code> or <code class="language-text">HttpClient.post</code>. Easy peasy.</p>
<p>I’m also going to give room for dependency-injection so I can test this easily.
And, maybe one day I won’t want to use HTTPoison anymore, so this new interface
might also help transition my app to another HTTP client without disrupting too
much.</p>
<p>Let’s write tests first:</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> MyApp<span class="token punctuation">.</span>HttpClientTest <span class="token keyword">do</span>
  <span class="token keyword">use</span> MyApp<span class="token punctuation">.</span>DataCase<span class="token punctuation">,</span> <span class="token attr-name">async:</span> <span class="token boolean">true</span>
  <span class="token keyword">import</span> ExUnit<span class="token punctuation">.</span>CaptureLog
  <span class="token keyword">alias</span> MyApp<span class="token punctuation">.</span>HTTPClient
  <span class="token keyword">require</span> HTTPoison

  <span class="token comment"># I used Erlang's :zlib.gzip("Hello")</span>
  <span class="token attribute variable">@gzipped_response</span> <span class="token punctuation">&lt;&lt;</span><span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">139</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">243</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">205</span><span class="token punctuation">,</span> <span class="token number">201</span><span class="token punctuation">,</span> <span class="token number">201</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">130</span><span class="token punctuation">,</span> <span class="token number">137</span><span class="token punctuation">,</span> <span class="token number">209</span><span class="token punctuation">,</span> <span class="token number">247</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">>></span>
  <span class="token comment"># I used Erlang's :zlib.zip("Hello")</span>
  <span class="token attribute variable">@zipped_response</span> <span class="token punctuation">&lt;&lt;</span><span class="token number">243</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">205</span><span class="token punctuation">,</span> <span class="token number">201</span><span class="token punctuation">,</span> <span class="token number">201</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">>></span>
  <span class="token attribute variable">@decoded</span> <span class="token string">"Hello"</span>

  describe <span class="token string">"get"</span> <span class="token keyword">do</span>
    test <span class="token string">"decompresses a gzipped body"</span> <span class="token keyword">do</span>
      requester <span class="token operator">=</span> <span class="token keyword">fn</span> _url<span class="token punctuation">,</span> _headers<span class="token punctuation">,</span> _options <span class="token operator">-></span>
        <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
          <span class="token attr-name">body:</span> <span class="token attribute variable">@gzipped_response</span><span class="token punctuation">,</span>
          <span class="token attr-name">headers:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"Content-Encoding"</span><span class="token punctuation">,</span> <span class="token string">"gzip"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token keyword">end</span>

      assert <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">body:</span> <span class="token attribute variable">@decoded</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> HTTPClient<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token attr-name">requester:</span> requester<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    test <span class="token string">"decompresses a gzipped body with x-gzip header"</span> <span class="token keyword">do</span>
      requester <span class="token operator">=</span> <span class="token keyword">fn</span> _url<span class="token punctuation">,</span> _headers<span class="token punctuation">,</span> _options <span class="token operator">-></span>
        <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
          <span class="token attr-name">body:</span> <span class="token attribute variable">@gzipped_response</span><span class="token punctuation">,</span>
          <span class="token attr-name">headers:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"Content-Encoding"</span><span class="token punctuation">,</span> <span class="token string">"x-gzip"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token keyword">end</span>

      assert <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">body:</span> <span class="token attribute variable">@decoded</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> HTTPClient<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token attr-name">requester:</span> requester<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    test <span class="token string">"does not attempt to decompress a plain body with gzip header"</span> <span class="token keyword">do</span>
      body <span class="token operator">=</span> <span class="token string">"Hallo"</span>
      requester <span class="token operator">=</span> <span class="token keyword">fn</span> _url<span class="token punctuation">,</span> _headers<span class="token punctuation">,</span> _options <span class="token operator">-></span>
        <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
          <span class="token attr-name">body:</span> body<span class="token punctuation">,</span>
          <span class="token attr-name">headers:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"Content-Encoding"</span><span class="token punctuation">,</span> <span class="token string">"gzip"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token keyword">end</span>

      assert <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">body:</span> <span class="token operator">^</span>body<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> HTTPClient<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token attr-name">requester:</span> requester<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    test <span class="token string">"decompresses a zipped body"</span> <span class="token keyword">do</span>
      requester <span class="token operator">=</span> <span class="token keyword">fn</span> _url<span class="token punctuation">,</span> _headers<span class="token punctuation">,</span> _options <span class="token operator">-></span>
        <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
          <span class="token attr-name">body:</span> <span class="token attribute variable">@zipped_response</span><span class="token punctuation">,</span>
          <span class="token attr-name">headers:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"Content-Encoding"</span><span class="token punctuation">,</span> <span class="token string">"deflate"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token keyword">end</span>

      assert <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">body:</span> <span class="token attribute variable">@decoded</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> HTTPClient<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token attr-name">requester:</span> requester<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    test <span class="token string">"emits log when encountering unsupported compression"</span> <span class="token keyword">do</span>
      requester <span class="token operator">=</span> <span class="token keyword">fn</span> _url<span class="token punctuation">,</span> _headers<span class="token punctuation">,</span> _options <span class="token operator">-></span>
        <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
          <span class="token attr-name">body:</span> <span class="token string">"Hallo"</span><span class="token punctuation">,</span>
          <span class="token attr-name">headers:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"Content-Encoding"</span><span class="token punctuation">,</span> <span class="token string">"br"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token keyword">end</span>

      assert capture_log<span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token operator">-></span>
        assert <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> _<span class="token punctuation">}</span> <span class="token operator">=</span> HTTPClient<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token attr-name">requester:</span> requester<span class="token punctuation">)</span>
      <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token operator">=~</span> <span class="token string">"No support for decompression of body using 'br' algorithm"</span>
    <span class="token keyword">end</span>

    test <span class="token string">"emits log when failing to decompress"</span> <span class="token keyword">do</span>
      requester <span class="token operator">=</span> <span class="token keyword">fn</span> _url<span class="token punctuation">,</span> _headers<span class="token punctuation">,</span> _options <span class="token operator">-></span>
        <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
          <span class="token attr-name">body:</span> <span class="token punctuation">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">>></span><span class="token punctuation">,</span>
          <span class="token attr-name">headers:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"Content-Encoding"</span><span class="token punctuation">,</span> <span class="token string">"deflate"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token keyword">end</span>

      assert capture_log<span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token operator">-></span>
        assert <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> _<span class="token punctuation">}</span> <span class="token operator">=</span> HTTPClient<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token attr-name">requester:</span> requester<span class="token punctuation">)</span>
      <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token operator">=~</span> <span class="token string">"Failed to decompress response"</span>
    <span class="token keyword">end</span>

    test <span class="token string">"re-encodes a latin1 body to UTF-8"</span> <span class="token keyword">do</span>
      latin1 <span class="token operator">=</span> <span class="token punctuation">&lt;&lt;</span><span class="token number">163</span><span class="token punctuation">,</span> <span class="token number">233</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">117</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">>></span>
      utf8 <span class="token operator">=</span> <span class="token string">"£éduff"</span>
      requester <span class="token operator">=</span> <span class="token keyword">fn</span> _url<span class="token punctuation">,</span> _headers<span class="token punctuation">,</span> _options <span class="token operator">-></span>
        <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
          <span class="token attr-name">body:</span> latin1<span class="token punctuation">,</span>
          <span class="token attr-name">headers:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/plain;charset=ISO-8859-1"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token keyword">end</span>

      assert <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">body:</span> <span class="token operator">^</span>utf8<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> HTTPClient<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token attr-name">requester:</span> requester<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    test <span class="token string">"does not re-encode utf8 bodies"</span> <span class="token keyword">do</span>
      utf8 <span class="token operator">=</span> <span class="token string">"£éduff"</span>
      requester <span class="token operator">=</span> <span class="token keyword">fn</span> _url<span class="token punctuation">,</span> _headers<span class="token punctuation">,</span> _options <span class="token operator">-></span>
        <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
          <span class="token attr-name">body:</span> utf8<span class="token punctuation">,</span>
          <span class="token attr-name">headers:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/plain;charset=utf-8"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token keyword">end</span>

      assert <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">body:</span> <span class="token operator">^</span>utf8<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> HTTPClient<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token attr-name">requester:</span> requester<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    test <span class="token string">"emits log when encountering unknown encoding"</span> <span class="token keyword">do</span>
      requester <span class="token operator">=</span> <span class="token keyword">fn</span> _url<span class="token punctuation">,</span> _headers<span class="token punctuation">,</span> _options <span class="token operator">-></span>
        <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
          <span class="token attr-name">body:</span> <span class="token string">"Hallo"</span><span class="token punctuation">,</span>
          <span class="token attr-name">headers:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/plain;charset=duurf"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token keyword">end</span>

      assert capture_log<span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token operator">-></span>
        assert <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> _<span class="token punctuation">}</span> <span class="token operator">=</span> HTTPClient<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token attr-name">requester:</span> requester<span class="token punctuation">)</span>
      <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token operator">=~</span> <span class="token string">"Need to implement re-encoding support for: duurf"</span>
    <span class="token keyword">end</span>

    test <span class="token string">"emits log when failing to reencode"</span> <span class="token keyword">do</span>
      body <span class="token operator">=</span> <span class="token punctuation">&lt;&lt;</span><span class="token number">163</span><span class="token punctuation">,</span> <span class="token number">233</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">117</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">833</span><span class="token operator">::</span><span class="token number">3</span><span class="token punctuation">>></span>
      requester <span class="token operator">=</span> <span class="token keyword">fn</span> _url<span class="token punctuation">,</span> _headers<span class="token punctuation">,</span> _options <span class="token operator">-></span>
        <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
          <span class="token attr-name">body:</span> body<span class="token punctuation">,</span>
          <span class="token attr-name">headers:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/plain;charset=ISO-8859-1"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token keyword">end</span>

      assert capture_log<span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token operator">-></span>
        assert <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> _<span class="token punctuation">}</span> <span class="token operator">=</span> HTTPClient<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token attr-name">requester:</span> requester<span class="token punctuation">)</span>
      <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token operator">=~</span> <span class="token string">"Failed to re-encode response"</span>
    <span class="token keyword">end</span>

    test <span class="token string">"does not re-encode un-specified bodies"</span> <span class="token keyword">do</span>
      body <span class="token operator">=</span> <span class="token string">"£éduff"</span> <span class="token operator">&lt;></span> <span class="token punctuation">&lt;&lt;</span><span class="token number">163</span><span class="token punctuation">,</span> <span class="token number">233</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">117</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">>></span>
      requester <span class="token operator">=</span> <span class="token keyword">fn</span> _url<span class="token punctuation">,</span> _headers<span class="token punctuation">,</span> _options <span class="token operator">-></span>
        <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span>HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
          <span class="token attr-name">body:</span> body<span class="token punctuation">,</span>
          <span class="token attr-name">headers:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token keyword">end</span>

      assert <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">body:</span> <span class="token operator">^</span>body<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> HTTPClient<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token attr-name">requester:</span> requester<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token comment"># copy/paste above, but adjust it for the post/4 function. Or, if you</span>
  <span class="token comment"># want to be creative, make a macro to generate these tests for you.</span>
<span class="token keyword">end</span></code></pre></div>
<p>Cool. That’s a lot of tests.</p>
<p>Let’s make those tests pass:</p>
<div class="gatsby-highlight" data-language="elixir"><pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> MyApp<span class="token punctuation">.</span>HTTPClient <span class="token keyword">do</span>
  <span class="token attribute variable">@moduledoc</span> <span class="token string">"""
  A wrapper around HTTPoison that takes care of post-processing depending on the response, namely:
    1) decompress the response if gzipped
    2) re-encode the body into UTF-8 if ISO-8859-1
  """</span>
  <span class="token attribute variable">@default_getter</span> <span class="token capture function">&amp;HTTPoison.get/3</span>
  <span class="token attribute variable">@default_poster</span> <span class="token capture function">&amp;HTTPoison.post/4</span>
  <span class="token attribute variable">@default_options</span> <span class="token punctuation">[</span><span class="token attr-name">timeout:</span> <span class="token number">300_000</span><span class="token punctuation">,</span> <span class="token attr-name">recv_timeout:</span> <span class="token number">60_000</span><span class="token punctuation">]</span>

  <span class="token keyword">require</span> Logger

  <span class="token attribute variable">@doc</span> <span class="token string">"""
  GET a URL with headers. Supported options:
    requester: fn(url, headers, request_options)
  """</span>
  <span class="token attribute variable">@spec</span> get<span class="token punctuation">(</span>String<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HTTPoison<span class="token punctuation">.</span>headers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token atom symbol">:error</span><span class="token punctuation">,</span> HTTPoison<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token keyword">def</span> get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> request_options <span class="token operator">\\</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    opts <span class="token operator">=</span> request_options <span class="token operator">++</span> <span class="token attribute variable">@default_options</span>
    <span class="token punctuation">{</span>get<span class="token punctuation">,</span> opts<span class="token punctuation">}</span> <span class="token operator">=</span> Keyword<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token atom symbol">:requester</span><span class="token punctuation">,</span> <span class="token attribute variable">@default_getter</span><span class="token punctuation">)</span>

    url
    <span class="token operator">|></span> get<span class="token punctuation">.</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
    <span class="token operator">|></span> process_response
  <span class="token keyword">end</span>

  <span class="token attribute variable">@doc</span> <span class="token string">"""
  POST a URL with a body, headers. Supported options:
    requester: fn(url, body, headers, request_options)
  """</span>
  <span class="token attribute variable">@spec</span> post<span class="token punctuation">(</span>String<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HTTPoison<span class="token punctuation">.</span>body<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HTTPoison<span class="token punctuation">.</span>headers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> HTTPoison<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token atom symbol">:error</span><span class="token punctuation">,</span> HTTPoison<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token keyword">def</span> post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> request_options <span class="token operator">\\</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    opts <span class="token operator">=</span> request_options <span class="token operator">++</span> <span class="token attribute variable">@default_options</span>
    <span class="token punctuation">{</span>post<span class="token punctuation">,</span> opts<span class="token punctuation">}</span> <span class="token operator">=</span> Keyword<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token atom symbol">:requester</span><span class="token punctuation">,</span> <span class="token attribute variable">@default_poster</span><span class="token punctuation">)</span>

    url
    <span class="token operator">|></span> post<span class="token punctuation">.</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
    <span class="token operator">|></span> process_response
  <span class="token keyword">end</span>

  <span class="token keyword">defp</span> process_response<span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token keyword">do</span>
    response
    <span class="token operator">|></span> decompress_response
    <span class="token operator">|></span> reencode_response_to_utf8
  <span class="token keyword">end</span>

  <span class="token keyword">defp</span> decompress_response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token atom symbol">:error</span><span class="token punctuation">,</span> response<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token punctuation">{</span><span class="token atom symbol">:error</span><span class="token punctuation">,</span> response<span class="token punctuation">}</span>
  <span class="token keyword">defp</span> decompress_response<span class="token punctuation">(</span><span class="token punctuation">{</span>status<span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">headers:</span> headers<span class="token punctuation">,</span> <span class="token attr-name">body:</span> body<span class="token punctuation">}</span> <span class="token operator">=</span> response<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">try</span> <span class="token keyword">do</span>
      decompressed_body <span class="token operator">=</span>
        headers
        <span class="token operator">|></span> find_header<span class="token punctuation">(</span><span class="token string">"content-encoding"</span><span class="token punctuation">)</span>
        <span class="token operator">|></span> decompress_body<span class="token punctuation">(</span>body<span class="token punctuation">)</span>

      <span class="token punctuation">{</span>status<span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span>response <span class="token operator">|</span> <span class="token attr-name">body:</span> decompressed_body<span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token keyword">rescue</span>
      _ <span class="token operator">-></span>
        Logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Failed to decompress response: <span class="token interpolation"><span class="token delimiter punctuation">#{</span>inspect response<span class="token delimiter punctuation">}</span></span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>status<span class="token punctuation">,</span> response<span class="token punctuation">}</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defp</span> reencode_response_to_utf8<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token atom symbol">:error</span><span class="token punctuation">,</span> response<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token punctuation">{</span><span class="token atom symbol">:error</span><span class="token punctuation">,</span> response<span class="token punctuation">}</span>
  <span class="token keyword">defp</span> reencode_response_to_utf8<span class="token punctuation">(</span><span class="token punctuation">{</span>status<span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">headers:</span> headers<span class="token punctuation">,</span> <span class="token attr-name">body:</span> body<span class="token punctuation">}</span> <span class="token operator">=</span> response<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">try</span> <span class="token keyword">do</span>
      reencoded_body <span class="token operator">=</span>
        headers
        <span class="token operator">|></span> find_header<span class="token punctuation">(</span><span class="token string">"content-type"</span><span class="token punctuation">)</span>
        <span class="token operator">|></span> parse_charset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|></span> reencode_body<span class="token punctuation">(</span>body<span class="token punctuation">)</span>

      <span class="token punctuation">{</span>status<span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span>response <span class="token operator">|</span> <span class="token attr-name">body:</span> reencoded_body<span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token keyword">rescue</span>
      _ <span class="token operator">-></span>
        Logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Failed to re-encode response: <span class="token interpolation"><span class="token delimiter punctuation">#{</span>inspect response<span class="token delimiter punctuation">}</span></span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>status<span class="token punctuation">,</span> response<span class="token punctuation">}</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defp</span> find_header<span class="token punctuation">(</span>headers<span class="token punctuation">,</span> header_name<span class="token punctuation">)</span> <span class="token keyword">do</span>
    Enum<span class="token punctuation">.</span>find_value<span class="token punctuation">(</span>
      headers<span class="token punctuation">,</span>
      <span class="token keyword">fn</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span> value<span class="token punctuation">}</span> <span class="token operator">-></span>
        name <span class="token operator">=~</span> <span class="token regex">~r/#{header_name}/i</span> <span class="token operator">&amp;&amp;</span> String<span class="token punctuation">.</span>downcase<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token keyword">end</span>
    <span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token comment"># gzip's magic header is 0x1F 0x8B, with the 3rd byte specifying the compression method, 0x08</span>
  <span class="token comment"># meaning "deflate". More info https://en.wikipedia.org/wiki/Gzip</span>
  <span class="token keyword">defp</span> decompress_body<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> body
  <span class="token keyword">defp</span> decompress_body<span class="token punctuation">(</span><span class="token string">"identity"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> body
  <span class="token keyword">defp</span> decompress_body<span class="token punctuation">(</span><span class="token string">"gzip"</span><span class="token punctuation">,</span> <span class="token punctuation">&lt;&lt;</span><span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">139</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> _<span class="token operator">::</span>binary<span class="token punctuation">>></span> <span class="token operator">=</span> body<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token atom symbol">:zlib</span><span class="token punctuation">.</span>gunzip<span class="token punctuation">(</span>body<span class="token punctuation">)</span>
  <span class="token keyword">defp</span> decompress_body<span class="token punctuation">(</span><span class="token string">"gzip"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> body
  <span class="token keyword">defp</span> decompress_body<span class="token punctuation">(</span><span class="token string">"x-gzip"</span><span class="token punctuation">,</span> <span class="token punctuation">&lt;&lt;</span><span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">139</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> _<span class="token operator">::</span>binary<span class="token punctuation">>></span> <span class="token operator">=</span> body<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token atom symbol">:zlib</span><span class="token punctuation">.</span>gunzip<span class="token punctuation">(</span>body<span class="token punctuation">)</span>
  <span class="token keyword">defp</span> decompress_body<span class="token punctuation">(</span><span class="token string">"x-gzip"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> body
  <span class="token keyword">defp</span> decompress_body<span class="token punctuation">(</span><span class="token string">"deflate"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token atom symbol">:zlib</span><span class="token punctuation">.</span>unzip<span class="token punctuation">(</span>body<span class="token punctuation">)</span>
  <span class="token keyword">defp</span> decompress_body<span class="token punctuation">(</span>other<span class="token punctuation">,</span> body<span class="token punctuation">)</span> <span class="token keyword">do</span>
    Logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"No support for decompression of body using '<span class="token interpolation"><span class="token delimiter punctuation">#{</span>other<span class="token delimiter punctuation">}</span></span>' algorithm."</span><span class="token punctuation">)</span>
    body
  <span class="token keyword">end</span>

  <span class="token keyword">defp</span> parse_charset<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token boolean">nil</span>
  <span class="token keyword">defp</span> parse_charset<span class="token punctuation">(</span>content_type<span class="token punctuation">)</span> <span class="token keyword">do</span>
    with <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token string">"charset"</span> <span class="token operator">=></span> charset<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&lt;-</span> Plug<span class="token punctuation">.</span>Conn<span class="token punctuation">.</span>Utils<span class="token punctuation">.</span>content_type<span class="token punctuation">(</span>content_type<span class="token punctuation">)</span> <span class="token keyword">do</span>
      <span class="token keyword">cond</span> <span class="token keyword">do</span>
        charset <span class="token operator">=~</span> <span class="token regex">~r/utf-?8/</span> <span class="token operator">-></span> <span class="token atom symbol">:utf8</span>
        charset <span class="token operator">=~</span> <span class="token regex">~r/iso-?8859-?1/</span> <span class="token operator">-></span> <span class="token atom symbol">:latin1</span>
        <span class="token boolean">true</span> <span class="token operator">-></span> charset
      <span class="token keyword">end</span>
    <span class="token keyword">else</span>
      _ <span class="token operator">-></span> <span class="token boolean">nil</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token comment"># When the header isn't sent, the RFC spec says we should assume ISO-8859-1, but the default is</span>
  <span class="token comment"># actually different per format, eg, XML should be assumed UTF-8. We're going to not re-encode</span>
  <span class="token comment"># if it's not sent and assume UTF-8. This should be safe for most cases.</span>
  <span class="token keyword">defp</span> reencode_body<span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> body
  <span class="token keyword">defp</span> reencode_body<span class="token punctuation">(</span><span class="token atom symbol">:utf8</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> body
  <span class="token keyword">defp</span> reencode_body<span class="token punctuation">(</span><span class="token atom symbol">:latin1</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">case</span> <span class="token atom symbol">:unicode</span><span class="token punctuation">.</span>characters_to_binary<span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token atom symbol">:latin1</span><span class="token punctuation">,</span> <span class="token atom symbol">:utf8</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
      <span class="token punctuation">{</span><span class="token atom symbol">:error</span><span class="token punctuation">,</span> binary<span class="token punctuation">,</span> rest<span class="token punctuation">}</span> <span class="token operator">-></span>
        Logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Failed to re-encode text. BODY: <span class="token interpolation"><span class="token delimiter punctuation">#{</span>inspect binary<span class="token delimiter punctuation">}</span></span> REST: <span class="token interpolation"><span class="token delimiter punctuation">#{</span>inspect rest<span class="token delimiter punctuation">}</span></span>"</span><span class="token punctuation">)</span>
        body

      <span class="token punctuation">{</span><span class="token atom symbol">:incomplete</span><span class="token punctuation">,</span> reencoded_text<span class="token punctuation">,</span> rest<span class="token punctuation">}</span> <span class="token operator">-></span>
        Logger<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">"Failed to re-encode entire text. Dropping characters: <span class="token interpolation"><span class="token delimiter punctuation">#{</span>inspect rest<span class="token delimiter punctuation">}</span></span>"</span><span class="token punctuation">)</span>
        reencoded_text

      reencoded_text <span class="token operator">-></span>
        reencoded_text
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
  <span class="token keyword">defp</span> reencode_body<span class="token punctuation">(</span>other<span class="token punctuation">,</span> body<span class="token punctuation">)</span> <span class="token keyword">do</span>
    Logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Need to implement re-encoding support for: <span class="token interpolation"><span class="token delimiter punctuation">#{</span>other<span class="token delimiter punctuation">}</span></span>"</span><span class="token punctuation">)</span>
    body
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<h2>and… Done!</h2>
<p>Hope this helps. Hit me up at <a href="https://twitter.com/bernheisel">@bernheisel</a> if I
missed anything or you have another cool idea.</p>
<p>I’m not really interested in pulling this into a library, because that’s exactly
what we don’t need: yet another HTTP client. But, if you found yourself needing
to decompress responses with HTTPoison, then this will be a good start.</p>
<p>You’ll notice that this doesn’t implement all the calls (we’re missing the ones
like <code class="language-text">delete</code> and <code class="language-text">head</code>), nor is it the smartest way to solve the problem. I’ll
leave the gaps to inspire you.</p>
<h2>Or use <a href="https://github.com/teamon/tesla">Tesla</a></h2>
<p>Tesla supports decompression out of the box; so if you started on that HTTP
client, you probably didn’t have to worry about any of this :)</p></div></article><div class="flex flex-wrap justify-between"><div class="w-full p-2 lg:w-1/2"><a class="text-white no-underline inline-flex items-center flex-1 button bg-purple-darker" href="/blog/ruby-rails-and-circle-ci-workflows/"><svg class="w-6 h-6 mr-2 fill-current" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1408 960v-128q0-26-19-45t-45-19h-502l189-189q19-19 19-45t-19-45l-91-91q-18-18-45-18t-45 18l-362 362-91 91q-18 18-18 45t18 45l91 91 362 362q18 18 45 18t45-18l91-91q18-18 18-45t-18-45l-189-189h502q26 0 45-19t19-45zm256-64q0 209-103 385.5t-279.5 279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5 385.5-103 385.5 103 279.5 279.5 103 385.5z"></path></svg><span>Ruby, Rails, and CircleCI 2.0 Workflows</span></a></div><div class="w-full p-2 lg:w-1/2"><a class="text-white no-underline inline-flex items-center flex-1 button bg-purple-darker" href="/blog/vim-workflow/"><span>VIM Testing and Workflow</span><svg class="w-6 h-6 ml-2 fill-current" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1413 896q0-27-18-45l-91-91-362-362q-18-18-45-18t-45 18l-91 91q-18 18-18 45t18 45l189 189h-502q-26 0-45 19t-19 45v128q0 26 19 45t45 19h502l-189 189q-19 19-19 45t19 45l91 91q18 18 45 18t45-18l362-362 91-91q18-18 18-45zm251 0q0 209-103 385.5t-279.5 279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5 385.5-103 385.5 103 279.5 279.5 103 385.5z"></path></svg></a></div></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/httpoison-decompression/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-e49f8733b8aee9471acf.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-8dc5b1de7df84c955e11.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-2780d9b33f550a804e84.js"],"component---src-pages-404-js":["/component---src-pages-404-js-f9633554493dddb1c536.js"],"component---src-pages-index-js":["/component---src-pages-index-js-da8729d9d0343d295966.js"],"component---src-pages-projects-js":["/component---src-pages-projects-js-757737b55f5d38274a17.js"]};/*]]>*/</script><script src="/webpack-runtime-41d54de024c2d1f9252e.js" async=""></script><script src="/app-e49f8733b8aee9471acf.js" async=""></script><script src="/framework-1cbcc4f69858806ac5db.js" async=""></script><script src="/1777bc0a756dace6068a54d243c7071eee1627a0-9e9727b36538e6264ac4.js" async=""></script><script src="/component---src-templates-blog-post-js-2780d9b33f550a804e84.js" async=""></script><script src="/styles-48fa8a050a65bb8447bd.js" async=""></script></body></html>