<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.4d9ef65815fd18f73322.css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}main{display:block}h1{font-size:2em;margin:.67em 0}hr{-webkit-box-sizing:content-box;box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{-webkit-box-sizing:border-box;box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{-webkit-box-sizing:border-box;box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,Arial,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}*,:after,:before{-webkit-box-sizing:border-box;box-sizing:border-box;border:0 solid #e2e8f0}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-webkit-input-placeholder,textarea::-webkit-input-placeholder{color:#a0aec0}input::-moz-placeholder,textarea::-moz-placeholder{color:#a0aec0}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#a0aec0}input::-ms-input-placeholder,textarea::-ms-input-placeholder{color:#a0aec0}input::placeholder,textarea::placeholder{color:#a0aec0}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@font-face{font-family:Fira Code;src:url(/FiraCode-Light.woff2) format("woff2"),url(/FiraCode-Light.woff) format("woff");font-weight:300;font-style:normal}@font-face{font-family:Fira Code;src:url(/FiraCode-Regular.woff2) format("woff2"),url(/FiraCode-Regular.woff) format("woff");font-weight:400;font-style:normal}@font-face{font-family:Fira Code;src:url(/FiraCode-Medium.woff2) format("woff2"),url(/FiraCode-Medium.woff) format("woff");font-weight:500;font-style:normal}@font-face{font-family:Fira Code;src:url(/FiraCode-SemiBold.woff2) format("woff2"),url(/FiraCode-SemiBold.woff) format("woff");font-weight:600;font-style:normal}@font-face{font-family:Fira Code;src:url(/FiraCode-Bold.woff2) format("woff2"),url(/FiraCode-Bold.woff) format("woff");font-weight:700;font-style:normal}@font-face{font-family:Fira Code VF;src:url(/FiraCode-VF.woff2) format("woff2-variations"),url(/FiraCode-VF.woff) format("woff-variations");font-weight:300 700;font-style:normal}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,Arial,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-size:1.125rem;line-height:1.5;letter-spacing:.025em;--text-opacity:1;color:#000;color:rgba(0,0,0,var(--text-opacity));background-color:#f7fafc;background-color:rgba(247,250,252,var(--bg-opacity))}.navbar,body{--bg-opacity:1}.navbar{background-color:#e2e8f0;background-color:rgba(226,232,240,var(--bg-opacity))}code,pre{font-weight:400;letter-spacing:0;font-family:Fira Code!important;border:none!important}.avatar{border-width:2px;--border-opacity:1;border-color:#f7fafc;border-color:rgba(247,250,252,var(--border-opacity));border-radius:9999px;-webkit-box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.button{padding:.5rem .75rem;font-weight:500;--text-opacity:1;color:#fff;color:rgba(255,255,255,var(--text-opacity));text-decoration:none;background-color:#a0aec0;background-color:rgba(160,174,192,var(--bg-opacity));border-color:#718096;border-color:rgba(113,128,150,var(--border-opacity));border-radius:.25rem;-webkit-box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06);box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06);-webkit-transition-duration:.1s;transition-duration:.1s;-webkit-transition-timing-function:cubic-bezier(.4,0,.2,1);transition-timing-function:cubic-bezier(.4,0,.2,1);-webkit-transition-property:background-color,border-color,color,fill,stroke;transition-property:background-color,border-color,color,fill,stroke}.button,.button.disabled{--bg-opacity:1;--border-opacity:1}.button.disabled{background-color:#718096;background-color:rgba(113,128,150,var(--bg-opacity));border-color:#4a5568;border-color:rgba(74,85,104,var(--border-opacity));cursor:default}.button:hover{--bg-opacity:1;background-color:#718096;background-color:rgba(113,128,150,var(--bg-opacity));--border-opacity:1;border-color:#4a5568;border-color:rgba(74,85,104,var(--border-opacity))}.button:focus{--bg-opacity:1;background-color:#718096;background-color:rgba(113,128,150,var(--bg-opacity));--border-opacity:1;border-color:#4a5568;border-color:rgba(74,85,104,var(--border-opacity))}.post-container{--border-opacity:1;border-color:#4a5568;border-bottom:2px;border-style:dotted;border-color:rgba(74,85,104,var(--border-opacity))}.link{font-weight:500;--text-opacity:1;color:#9b2c2c;color:rgba(155,44,44,var(--text-opacity));text-decoration:none;-webkit-transition-duration:.1s;transition-duration:.1s;-webkit-transition-timing-function:cubic-bezier(.4,0,.2,1);transition-timing-function:cubic-bezier(.4,0,.2,1);-webkit-transition-property:background-color,border-color,color,fill,stroke;transition-property:background-color,border-color,color,fill,stroke}.link:visited{--text-opacity:1;color:#553c9a;color:rgba(85,60,154,var(--text-opacity))}.link:hover{--text-opacity:1;color:#9b2c2c;color:rgba(155,44,44,var(--text-opacity));border-bottom-width:1px;--border-opacity:1;border-color:#38b2ac;border-color:rgba(56,178,172,var(--border-opacity))}h1.post-content:before,h1.post-header:before,h2.post-content:before,h2.post-header:before,h3.post-content:before,h3.post-header:before,h4.post-content:before,h4.post-header:before,h5.post-content:before,h5.post-header:before,h6.post-content:before,h6.post-header:before{--text-opacity:1;color:#cbd5e0;color:rgba(203,213,224,var(--text-opacity))}h1.post-content:before,h1.post-header:before{margin-right:1rem;content:"#"}h2.post-content:before,h2.post-header:before{margin-right:.75rem;content:"##"}h3.post-content:before,h3.post-header:before{margin-right:.5rem;content:"###"}h4.post-content:before,h4.post-header:before,h5.post-content:before,h5.post-header:before,h6.post-content:before,h6.post-header:before{margin-right:.25rem;content:"####"}.blog-post h1{font-weight:600;font-size:2.25rem}.blog-post h2{font-weight:600;font-size:1.875rem}.blog-post h3{font-weight:600;font-size:1.5rem}.blog-post h4,.blog-post h5{font-weight:600;font-size:1.25rem}.blog-post h6{font-weight:600;font-size:1.125rem}.post-content blockquote{padding-left:1.5rem;border-left-width:4px;--border-opacity:1;border-color:#9f7aea;border-color:rgba(159,122,234,var(--border-opacity))}.post-content p{margin-top:1rem;margin-bottom:1rem}.post-content ul{list-style-type:disc}.post-content ol,.post-content ul{margin-left:1rem;padding-left:1rem}.post-content ol{list-style-type:decimal}.post-content li{margin-top:.5rem;margin-bottom:.5rem}.post-content strong{font-weight:600}.post-content a{--text-opacity:1;color:#9b2c2c;color:rgba(155,44,44,var(--text-opacity));text-decoration:none;-webkit-transition-property:background-color,border-color,color,fill,stroke;transition-property:background-color,border-color,color,fill,stroke;-webkit-transition-duration:.1s;transition-duration:.1s;-webkit-transition-timing-function:cubic-bezier(.4,0,.2,1);transition-timing-function:cubic-bezier(.4,0,.2,1)}.post-content a:focus{--text-opacity:1;color:#9b2c2c;color:rgba(155,44,44,var(--text-opacity))}.post-content a:visited{--text-opacity:1;color:#553c9a;color:rgba(85,60,154,var(--text-opacity))}.post-content a:hover{--text-opacity:1;color:#9b2c2c;color:rgba(155,44,44,var(--text-opacity));border-bottom-width:1px;--border-opacity:1;border-color:#38b2ac;border-color:rgba(56,178,172,var(--border-opacity));text-decoration:none}.post-content a.gatsby-resp-image-link:hover{border-width:0}@media (prefers-color-scheme:dark){body{background-color:#1a202c;background-color:rgba(26,32,44,var(--bg-opacity));--text-opacity:1;color:#e2e8f0;color:rgba(226,232,240,var(--text-opacity))}.navbar,body{--bg-opacity:1}.navbar{background-color:#fff;background-color:rgba(255,255,255,var(--bg-opacity));--bg-opacity:0.25}.avatar{--border-opacity:1;border-color:#2d3748;border-color:rgba(45,55,72,var(--border-opacity))}.button{--text-opacity:1;color:#fff;color:rgba(255,255,255,var(--text-opacity));background-color:#718096;background-color:rgba(113,128,150,var(--bg-opacity));border-color:#a0aec0;border-color:rgba(160,174,192,var(--border-opacity))}.button,.button.disabled{--bg-opacity:1;--border-opacity:1}.button.disabled{background-color:#a0aec0;background-color:rgba(160,174,192,var(--bg-opacity));border-color:#cbd5e0;border-color:rgba(203,213,224,var(--border-opacity))}.button:hover{--bg-opacity:1;background-color:#a0aec0;background-color:rgba(160,174,192,var(--bg-opacity));--border-opacity:1;border-color:#cbd5e0;border-color:rgba(203,213,224,var(--border-opacity))}.button:focus{--bg-opacity:1;background-color:#a0aec0;background-color:rgba(160,174,192,var(--bg-opacity));--border-opacity:1;border-color:#cbd5e0;border-color:rgba(203,213,224,var(--border-opacity))}.post-content a{--text-opacity:1;color:#fed7d7;color:rgba(254,215,215,var(--text-opacity))}.post-content a:focus{--text-opacity:1;color:#fed7d7;color:rgba(254,215,215,var(--text-opacity))}.post-content a:visited{--text-opacity:1;color:#e9d8fd;color:rgba(233,216,253,var(--text-opacity))}.post-content a:hover{--text-opacity:1;color:#fed7d7;color:rgba(254,215,215,var(--text-opacity))}.link{--text-opacity:1;color:#fed7d7;color:rgba(254,215,215,var(--text-opacity))}.link:visited{--text-opacity:1;color:#e9d8fd;color:rgba(233,216,253,var(--text-opacity))}.link:hover{--text-opacity:1;color:#fed7d7;color:rgba(254,215,215,var(--text-opacity));--border-opacity:1;border-color:#38b2ac;border-color:rgba(56,178,172,var(--border-opacity))}}.space-x-1>:not(template)~:not(template){--space-x-reverse:0;margin-right:calc(0.25rem*var(--space-x-reverse));margin-left:calc(0.25rem*(1 - var(--space-x-reverse)))}.space-y-4>:not(template)~:not(template){--space-y-reverse:0;margin-top:calc(1rem*(1 - var(--space-y-reverse)));margin-bottom:calc(1rem*var(--space-y-reverse))}.space-x-4>:not(template)~:not(template){--space-x-reverse:0;margin-right:calc(1rem*var(--space-x-reverse));margin-left:calc(1rem*(1 - var(--space-x-reverse)))}.block{display:block}.flex{display:-webkit-box;display:-ms-flexbox;display:flex}.inline-flex{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.hidden{display:none}.flex-col{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}.flex-wrap{-ms-flex-wrap:wrap;flex-wrap:wrap}.items-center{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.justify-between{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.flex-1{-webkit-box-flex:1;-ms-flex:1 1 0%;flex:1 1 0%}.flex-shrink-0{-ms-flex-negative:0;flex-shrink:0}.font-semibold{font-weight:600}.font-bold{font-weight:700}.h-3{height:.75rem}.h-6{height:1.5rem}.h-8{height:2rem}.text-xs{font-size:.75rem}.text-sm{font-size:.875rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.leading-6{line-height:1.5rem}.leading-normal{line-height:1.5}.list-disc{list-style-type:disc}.m-auto{margin:auto}.my-2{margin-top:.5rem;margin-bottom:.5rem}.mx-2{margin-left:.5rem;margin-right:.5rem}.mt-0{margin-top:0}.ml-0{margin-left:0}.mt-2{margin-top:.5rem}.mr-2{margin-right:.5rem}.ml-2{margin-left:.5rem}.mt-4{margin-top:1rem}.mr-4{margin-right:1rem}.mb-4{margin-bottom:1rem}.mb-8{margin-bottom:2rem}.max-w-3xl{max-width:48rem}.p-2{padding:.5rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.px-3{padding-left:.75rem;padding-right:.75rem}.pl-4{padding-left:1rem}.pb-10{padding-bottom:2.5rem}.shadow-md{-webkit-box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.fill-current{fill:currentColor}.no-underline{text-decoration:none}.tracking-wider{letter-spacing:.05em}.align-middle{vertical-align:middle}.w-3{width:.75rem}.w-6{width:1.5rem}.w-16{width:4rem}.w-full{width:100%}@media (min-width:768px){.md\:font-extrabold{font-weight:800}.md\:text-4xl{font-size:2.25rem}.md\:ml-4{margin-left:1rem}.md\:w-24{width:6rem}}@media (min-width:1024px){.lg\:inline-block{display:inline-block}.lg\:flex{display:-webkit-box;display:-ms-flexbox;display:flex}.lg\:hidden{display:none}.lg\:items-center{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.lg\:mt-0{margin-top:0}.lg\:w-32{width:8rem}.lg\:w-auto{width:auto}.lg\:w-1\/2{width:50%}}.grvsc-container{overflow:auto;position:relative;-webkit-overflow-scrolling:touch;padding-top:1rem;padding-top:var(--grvsc-padding-top,var(--grvsc-padding-v,1rem));padding-bottom:1rem;padding-bottom:var(--grvsc-padding-bottom,var(--grvsc-padding-v,1rem));border-radius:8px;border-radius:var(--grvsc-border-radius,8px);-webkit-font-feature-settings:normal;font-feature-settings:normal;line-height:1.4}.grvsc-code{display:table}.grvsc-line{display:table-row;-webkit-box-sizing:border-box;box-sizing:border-box;width:100%;position:relative}.grvsc-line>*{position:relative}.grvsc-gutter-pad{display:table-cell;padding-left:.75rem;padding-left:calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem))/2)}.grvsc-gutter{display:table-cell;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.grvsc-gutter:before{content:attr(data-content)}.grvsc-source{display:table-cell;padding-left:1.5rem;padding-left:var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem));padding-right:1.5rem;padding-right:var(--grvsc-padding-right,var(--grvsc-padding-h,1.5rem))}.grvsc-source:empty:after{content:" ";-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.grvsc-gutter+.grvsc-source{padding-left:.75rem;padding-left:calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem))/2)}.grvsc-has-line-highlighting>.grvsc-code>.grvsc-line:before{content:" ";position:absolute;width:100%}.grvsc-line-diff-add:before{background-color:rgba(0,255,60,.2);background-color:var(--grvsc-line-diff-add-background-color,rgba(0,255,60,.2))}.grvsc-line-diff-del:before{background-color:rgba(255,0,20,.2);background-color:var(--grvsc-line-diff-del-background-color,rgba(255,0,20,.2))}.grvsc-line-number{padding:0 2px;text-align:right;opacity:.7}</style><meta name="generator" content="Gatsby 2.20.9"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script>
  
  
  if(!(parseInt(navigator.doNotTrack) === 1 || parseInt(window.doNotTrack) === 1 || parseInt(navigator.msDoNotTrack) === 1 || navigator.doNotTrack === "yes")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-9152758-1', 'auto', {});
      
      
      
      
      
      }</script><link rel="alternate" type="application/rss+xml" title="David Bernheisel&#x27;s Blog RSS Feed" href="/rss.xml"/><link rel="icon" href="/android-chrome-36x36.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="36x36" href="/android-chrome-36x36.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="48x48" href="/android-chrome-48x48.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="72x72" href="/android-chrome-72x72.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="96x96" href="/android-chrome-96x96.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="144x144" href="/android-chrome-144x144.png?v=611230f76b9c00b58e5b99e8a179a99d"/><link rel="apple-touch-icon" sizes="192x192" href="/android-chrome-192x192.png?v=611230f76b9c00b58e5b99e8a179a99d"/><title data-react-helmet="true">Syncing an External USB Drive with a Network NAS | David Bernheisel</title><meta data-react-helmet="true" name="description" content="I recently bought a MacBook Pro with a limited 256GB SSD. It’s great, btw, but it requires me to now store all my music, movies, and archival-type files on an external drive. It scares me a bit to have all that stuff on a single USB-powered drive, so I also set up a network NAS that contains 2 mirrored 1TB drives (I salvaged these from my desktop that I sold to buy my MacBook). Enter problem: I’m lazy. I don’t like manually backing everything up. I just want to manage the stuff I put on the external drive, not the NAS drive. Enter solution: BASH script, and launchd."/><meta data-react-helmet="true" name="twitter:creator" content="@bernheisel"/><link as="script" rel="preload" href="/styles-48fa8a050a65bb8447bd.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-f933526302f141ff5bf0.js"/><link as="script" rel="preload" href="/1777bc0a756dace6068a54d243c7071eee1627a0-c8bbedbe2105888d6327.js"/><link as="script" rel="preload" href="/framework-1cbcc4f69858806ac5db.js"/><link as="script" rel="preload" href="/app-e49f8733b8aee9471acf.js"/><link as="script" rel="preload" href="/webpack-runtime-5be88de751054daa4121.js"/><link as="fetch" rel="preload" href="/page-data/blog/syncing-external-drive-with-network-nas/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><nav class="flex flex-wrap items-center justify-between p-4 shadow-md navbar"><a class="no-underline" href="/"><div class="flex items-center space-x-1"><div class="flex-shrink-0"><img src="/static/profile-picture-977b63cbce04bae4479e3185b22bfb1a.jpg" alt="David Bernheisel" class="w-16 avatar md:w-24 lg:w-32"/></div><div><h3 class="ml-0 text-xl font-bold md:ml-4 md:text-4xl md:font-extrabold leading-6">David Bernheisel</h3></div></div></a><div class="block lg:hidden"><button class="flex items-center px-3 button"><svg class="w-3 h-3 fill-current" viewBox="0 0 20 20"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg></button></div><div class="w-full block lg:mt-0 mt-4 lg:flex lg:items-center lg:w-auto hidden"><a class="no-underline block lg:inline-block mt-4 mr-4 lg:mt-0 button" href="/">Blog</a><a class="no-underline block lg:inline-block mt-4 mr-4 lg:mt-0 button" href="/projects/">Projects</a><a class="block mt-4 mr-4 button lg:inline-block lg:mt-0" href="https://elixir-utilities.herokuapp.com">Utilities</a><a class="block mt-4 mr-4 button lg:inline-block lg:mt-0" href="https://twitter.com/bernheisel">Twitter</a><div class="py-1 mt-4 lg:mt-0"><a href="/rss.xml"><img class="h-8 align-middle" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICAgaWQ9IlJTU2ljb24iCiAgICAgdmlld0JveD0iMCAwIDggOCIgd2lkdGg9IjI1NiIgaGVpZ2h0PSIyNTYiPgoKICA8dGl0bGU+UlNTIGZlZWQgaWNvbjwvdGl0bGU+CgogIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAgICAuYnV0dG9uIHtzdHJva2U6IG5vbmU7IGZpbGw6IG9yYW5nZTt9CiAgICAuc3ltYm9sIHtzdHJva2U6IG5vbmU7IGZpbGw6IHdoaXRlO30KICA8L3N0eWxlPgoKICA8cmVjdCAgIGNsYXNzPSJidXR0b24iIHdpZHRoPSI4IiBoZWlnaHQ9IjgiIHJ4PSIxLjUiIC8+CiAgPGNpcmNsZSBjbGFzcz0ic3ltYm9sIiBjeD0iMiIgY3k9IjYiIHI9IjEiIC8+CiAgPHBhdGggICBjbGFzcz0ic3ltYm9sIiBkPSJtIDEsNCBhIDMsMyAwIDAgMSAzLDMgaCAxIGEgNCw0IDAgMCAwIC00LC00IHoiIC8+CiAgPHBhdGggICBjbGFzcz0ic3ltYm9sIiBkPSJtIDEsMiBhIDUsNSAwIDAgMSA1LDUgaCAxIGEgNiw2IDAgMCAwIC02LC02IHoiIC8+Cgo8L3N2Zz4=" alt="RSS"/></a></div></div></nav><main class="max-w-3xl p-4 m-auto text-lg"><article class="blog-post"><h1 class="post-content text-3xl">Syncing an External USB Drive with a Network NAS</h1><p class="mt-2 mb-4 text-sm frontmatter"><span>Published on <!-- -->June 02, 2013</span><span><span class="mx-2">|</span>8<!-- -->m read</span></p><div class="post-content"><p>I recently bought a MacBook Pro with a limited 256GB SSD. It’s great, btw, but it requires me to now store all my music, movies, and archival-type files on an external drive. It scares me a bit to have all that stuff on a single USB-powered drive, so I also set up a network NAS that contains 2 mirrored 1TB drives (I salvaged these from my desktop that I sold to buy my MacBook).</p>
<p>Enter problem: I’m lazy. I don’t like manually backing everything up. I just want to manage the stuff I put on the external drive, not the NAS drive. Enter solution: BASH script, and launchd.</p>
<!-- excerpt -->
<h2>Overview</h2>
<ol>
<li>I write BASH scripts at work, so this was my goto place for automating something I don’t want to do.</li>
<li>I use a mac, so I used launchd to kick off the script when relevant</li>
<li>I want to know when its running, so I used an icon I found on the internet to make it look pretty, and placed the lock folder on my desktop.</li>
</ol>
<h2>Getting the core logic:</h2>
<p>Here’s the BASH Script in its entirety:</p>
<pre class="grvsc-container atom-one-light grvsc-mm-t88nfI" data-language="bash" data-index="0"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3">#!/bin/bash</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">remote=</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;/Volumes/Volume_1&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">local=</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;/Volumes/Storage&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">LOCK=</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">~</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">/Desktop/Syncing</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">logging=</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">~</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">/backup-rsync-log.txt</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">sleeptime=20</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">maxthreads=20</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">set</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> -e</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-14 grvsc-t88nfI-10 grvsc-t88nfI-i">function</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-9 grvsc-t88nfI-5">cleanup</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">  </span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">echo</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;Removing Syncing folder&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">  rm -rf </span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-1">$LOCK</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">trap</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> cleanup EXIT</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">mkdir </span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-1">$LOCK</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">||</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> { </span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">echo</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;Backup already running&quot;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">exit</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> 1 </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">Rez -append </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">~</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">/backup.rsrc -o </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">~</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">/Desktop/Syncing/</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">$&#39;Icon</span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-4">\r</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&#39;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3"># set the icon to lock folder</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">SetFile -a C </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">~</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">/Desktop/Syncing </span><span class="grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3"># initiate the icon</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">SetFile -a V </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">~</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">/Desktop/Syncing/</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">$&#39;Icon</span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-4">\r</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&#39;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3"># hide the icon file</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">sleep 15 </span><span class="grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3"># give time for mounting</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3"># Check if external drive is mounted</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">if</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> mount </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">|</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> grep </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;on </span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">${local}</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">&gt;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> /dev/null</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">then</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">  </span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">echo</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;Storage drive is mounted&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">  </span><span class="grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3"># Check if network NAS is mounted</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">  </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">if</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> mount </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">|</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> grep </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;on </span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">${remote}</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">&gt;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> /dev/null</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">then</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">    </span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">echo</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;Remote NAS is mounted&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">    </span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">echo</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;Running rsync&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">    </span><span class="grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3"># loop over all root external drive folders and do an rsync for each, up to a limit</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">    </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">for</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-1">dir</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">in</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">$local</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">/</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">*</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">/</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">do</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">      folder=</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">`basename &quot;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">$dir</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;`</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">      </span><span class="grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3"># create the folder if it doesn&#39;t exist, keeping permissions</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">      </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">if</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> [ </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">!</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">-d</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">${remote}</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">/</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">${folder}</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> ]</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">then</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">        mkdir -p </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">$remote</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">/</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">$folder</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">        chown --reference=</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">$dir</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">${remote}</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">/</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">${folder}</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">        chmod --reference=</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">$dir</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">${remote}</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">/</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">${folder}</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">      </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">fi</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">      </span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">echo</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> -e </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;\nStarting rsync $(date +%Y%m%d_%H%M%S) of&quot;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-1">$dir</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">&gt;&gt;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-1">$logging</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">      </span><span class="grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3"># don&#39;t go crazy with rsync, so limit it</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">      </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">while</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> [ </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">`ps -ef </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">|</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6"> grep -c [r]sync`</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">-gt</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-1">${maxthreads}</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> ]</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">do</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">        sleep </span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-1">${sleeptime}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">      </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">done</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">      </span><span class="grvsc-t5WxC3-7 grvsc-t5WxC3-i grvsc-t88nfI-3"># start rsync parallel threads.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">      nohup rsync -avh --delete </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">$dir</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">$remote</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">/</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-6">$folder</span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">/ </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">&gt;</span><span class="grvsc-t5WxC3-5 grvsc-t88nfI-1">$logging</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">2&gt;&amp;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">amp</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">1 </span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">&amp;</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">amp</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-7">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">    </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">done</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">    </span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">wait</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">    </span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">echo</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;Done&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">  </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">else</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">    </span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">echo</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;Remote NAS is NOT mounted&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">  </span><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">fi</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">else</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1">  </span><span class="grvsc-t5WxC3-8 grvsc-t88nfI-10">echo</span><span class="grvsc-t5WxC3-1 grvsc-t88nfI-1"> </span><span class="grvsc-t5WxC3-10 grvsc-t88nfI-6">&quot;Storage drive is NOT mounted&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t5WxC3-14 grvsc-t88nfI-7">fi</span></span></span></code></pre>
<p>There’s a good amount of logic in there, so let’s go through it.</p>
<p>I don’t like hardcoding stuff I have to say over and over, so I start by naming the variables in case I need to reuse this code later. The variables are</p>
<ul>
<li>My external hard drive, put into <code>$local</code></li>
<li>My network NAS drive, put into <code>$remote</code></li>
<li>My rsync limiter, put into <code>$maxthreads</code></li>
<li>How long I want rsync to wait before trying to launch another thread, put into <code>$sleeptime</code></li>
<li>Where I want the double-purposed folder, 1) to ensure I only have one of these scripts running at a time, and 2) visually tell me when the script is running; this is put into <code>$LOCK</code></li>
<li>Lastly, so I can debug if needed, I log all the actions into a text file, put into <code>$logging</code></li>
</ul>
<p>So now that I have everything named. Now it’s time for some real logic.</p>
<p>I start out by checking whether my script is already running. I check by attempting to create a folder. If the folder is already created, it’ll fail, and then exit the script. Pretty simple. I can’t tell you the specifics, but creating a folder is a great way of setting up a lock without conflicts, from what I’ve read online. In my script, I also used the folder as a status to inform me when the script is running. I also thought about creating a simple menubar app that’ll show a spinning gear, but I don’t really feel like overengineering this.</p>
<p>So, I have my safety set so I’m not executing this script over on top of itself. Now I need to determine whether my necessary drives are mounted, I do this by nesting two if statements; one to check if the external drive is mounted, and another to check if the NAS is mounted. Obviously, I don’t want anything to happen unless the drives are mounted. If they’re not mounted, I exit.</p>
<p>Next, I go through the folders in the root of the external drive. I want to be somewhat recursive, so I do a for loop over the root folders on the drive, and start an rsync on each folder. For that to work, I need to make sure the destination folder is created, preferably with the same permissions.</p>
<p>If you have one root folder with a bunch of subfolders (for example a Music folder with a bunch of Artist subfolders), then it might be good for you to start your loop there so this is a more-effective script.</p>
<p>Inside every folder, I start an rsync thread distributed among the folders. However, I don’t want to stress my computer out with a thousand rsync threads, so before I start a new thread, I check to see how many there are and possibly limit it (for me, I arbitrarily chose a 20 thread cap). I determine this by counting how many rsync processes there are, so I execute ps, pipe it to grep to grab what I need. the grep -c flag counts them. Then, I compare it to my previously-defined cap. If it’s at the limit, then I put it in a while loop that sleeps until the thread count is back down.</p>
<p>If you’re familiar with command line operations, then you should read up on the rsync manual (run “man rsync” in the terminal). There’s a lot of nifty things you can do with this, for example, you can backup over SSH or SFTP. I opted for the flags -a (archive, aka carry over all the permissions and recurse any subdirectories), -v (be verbose, I want this so I can catch everything it’s doing and redirect that to my log file in <code>$logging</code>), and -h (output human-readable stuff, so I don’t have to count the zeros in all the file sizes).</p>
<p>Lastly (as far as the script goes), I want to make sure that whenever my script exits, be it because of an error or anything else, I want my lock/status folder is removed. To accomplish this, I just trapped any kind of exit by executing a small function that removes the lock folder. I put it near the top since it needs to be defined before it could be used. Sometimes I forget that you can create functions in BASH.</p>
<p>This can be optimized more, but this is where I’m finished since it achieves my goal of lazily backing up my external hard drive. If you have ideas, drop them in the comments or link out to your explanation!</p>
<h2>Launching it when I need to.</h2>
<p>So far, we just have a script that we have to manually kick off in order for it to work. I am still too lazy and instead want my $2000 computer to do the work for me. I was tempted to just use cron to have this script run automatically every 5 minutes, but I thought that was wasteful, since it’s probable that this script will fail most times it’s launched. I read around and found Mac’s tool called launchd, which watches for events, and then launches actions.</p>
<p>I’m unfamiliar with plists still, so I really just piggybacked on the <a href="http://rajeev.name/2008/09/01/automated-osx-backups-with-launchd-and-rsync/">backs of other giants</a>. Step 3 on this page shows me how to do this (btw, this  guy solves the same problem here, but does it differently; check his solution out if you’re interested). Summed up, create a plist, place it in your ~/Library/LaunchAgents folder (tilde represents your home folder), and you’re done!</p>
<p>The important bits of the .plist file are the</p>
<ul>
<li>Program</li>
<li>WatchPaths</li>
<li>LowPriorityIO</li>
</ul>
<p>For the program key, I’m putting the path to the BASH script I created above.</p>
<p>For the WatchPaths key, I’m putting in /Volumes directory, since I want this script to launch every time something changes in /Volumes. You could change this to the specific name of your drive as well—it should work the same and probably better.</p>
<p>For the LowPriorityIO key, I’m putting the “YES” value, so I can tell my computer to not really give a lot of resources to this script. Again, I want this to be nearly invisible to me—I’d hate to feel my computer choke just because of a backup script.</p>
<p>You still need to add a label to the plist, so call it whatever you want.</p>
<p>Save it, and place it in your ~/Library/LaunchAgents folder. Restart.</p>
<p>Now you should have a fully working solution.</p>
<h2>Making it look <em>slightly</em> better</h2>
<p>I’m not <em>quite</em> finished yet. I wanted to have my lock folder be pretty with an icon, so I went back to my BASH script and added a couple lines to set the folder icon. I found the commands here <a href="http://apple.stackexchange.com/questions/6901/changing-a-file-or-folder-icon-using-the-terminal">Stack Exchange</a>.</p>
<p>First, grab an icon you want. I supplied one already, but you might have a different preference. I found mine by googling, and you might find it helpful to google with “filetype:png” so you find an icon with transparency. Then go to <a href="http://iconverticons.com/online/">http://iconverticons.com/online/</a> and convert it to Mac-compatible .icns.</p>
<p>Second, create a new temporary folder. We’re going to apply this icon to it so we can grab a file we need from it once it’s set. Then, right-click the folder, and drag-and-drop the .icns file to the Icon in the top left.</p>
<p>Third, run a command-line tool against the folder.</p>
<p><code>DeRez -only icns path/to/tempfolder/$'Icon\r' > backup.rsrc</code></p>
<p>This will give you what you need in order to set the lock folder icon. Store this file somewhere you don’t look often (I stored mine next to the backup script in my home folder). You can delete the temporary folder now and the original image you downloaded.</p>
<p>Fourth, modify the backup script to apply the icon.</p>
<p>After the line where we make the lock folder, run a Rez command and a couple SetFile commands.</p>
<p><code>Rez -append ~/backup.rsrc -o ~/Desktop/Syncing/$'Icon\r' # set the icon to lock folder</code></p>
<p><code>SetFile -a C ~/Desktop/Syncing # initiate the icon</code></p>
<p><code>SetFile -a V ~/Desktop/Syncing/$'Icon\r' # hide the icon file</code></p>
<p>The first command adds the icon to the lock directory.</p>
<p>The second command sets the folder attributes, which allows Finder to appreciate your new icon (otherwise, it won’t recognize that cool icon you added)</p>
<p>The third command sets the folder to invisible. This is totally optional, but if you ever double-click the “Syncing” folder you’ll find the icon resource, and that just seems ugly to me—so let’s hide it.</p>
<p><em>OK! YOU’RE DONE!</em></p>
<p>I guess I’m not so lazy after all.</p>
<style class="grvsc-styles">
  .grvsc-container {
    overflow: auto;
    position: relative;
    -webkit-overflow-scrolling: touch;
    padding-top: 1rem;
    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));
    padding-bottom: 1rem;
    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));
    border-radius: 8px;
    border-radius: var(--grvsc-border-radius, 8px);
    font-feature-settings: normal;
    line-height: 1.4;
  }
  
  .grvsc-code {
    display: table;
  }
  
  .grvsc-line {
    display: table-row;
    box-sizing: border-box;
    width: 100%;
    position: relative;
  }
  
  .grvsc-line > * {
    position: relative;
  }
  
  .grvsc-gutter-pad {
    display: table-cell;
    padding-left: 0.75rem;
    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);
  }
  
  .grvsc-gutter {
    display: table-cell;
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }
  
  .grvsc-gutter::before {
    content: attr(data-content);
  }
  
  .grvsc-source {
    display: table-cell;
    padding-left: 1.5rem;
    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));
    padding-right: 1.5rem;
    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));
  }
  
  .grvsc-source:empty::after {
    content: ' ';
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }
  
  .grvsc-gutter + .grvsc-source {
    padding-left: 0.75rem;
    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);
  }
  
  /* Line transformer styles */
  
  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {
    content: ' ';
    position: absolute;
    width: 100%;
  }
  
  .grvsc-line-diff-add::before {
    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));
  }
  
  .grvsc-line-diff-del::before {
    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));
  }
  
  .grvsc-line-number {
    padding: 0 2px;
    text-align: right;
    opacity: 0.7;
  }
  
  .atom-one-light {
    background-color: #FAFAFA;
    color: #383A42;
  }
  .atom-one-light .grvsc-t5WxC3-i { font-style: italic; }
  .atom-one-light .grvsc-t5WxC3-7 { color: #A0A1A7; }
  .atom-one-light .grvsc-t5WxC3-1 { color: #383A42; }
  .atom-one-light .grvsc-t5WxC3-10 { color: #50A14F; }
  .atom-one-light .grvsc-t5WxC3-8 { color: #0184BC; }
  .atom-one-light .grvsc-t5WxC3-14 { color: #A626A4; }
  .atom-one-light .grvsc-t5WxC3-9 { color: #4078F2; }
  .atom-one-light .grvsc-t5WxC3-5 { color: #E45649; }
  .atom-one-light .grvsc-line-highlighted::before {
    background-color: var(--grvsc-line-highlighted-background-color, rgba(0, 0, 0, 0.05));
    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(0, 0, 0, 0.2));
  }
  
  /* Monokai Phoenix */
  @media (prefers-color-scheme: dark) {
    .grvsc-mm-t88nfI {
      background-color: #1e1e1e;
      color: #F8F8F2;
    }
    .grvsc-mm-t88nfI .grvsc-t88nfI-i { font-style: italic; }
    .grvsc-mm-t88nfI .grvsc-t88nfI-3 { color: #75715E; }
    .grvsc-mm-t88nfI .grvsc-t88nfI-1 { color: #F8F8F2; }
    .grvsc-mm-t88nfI .grvsc-t88nfI-6 { color: #E6DB74; }
    .grvsc-mm-t88nfI .grvsc-t88nfI-7 { color: #F92672; }
    .grvsc-mm-t88nfI .grvsc-t88nfI-10 { color: #66D9EF; }
    .grvsc-mm-t88nfI .grvsc-t88nfI-5 { color: #A6E22E; }
    .grvsc-mm-t88nfI .grvsc-t88nfI-4 { color: #AE81FF; }
    .grvsc-mm-t88nfI .grvsc-line-highlighted::before {
      background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));
      box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));
    }
  }
</style></div></article><div class="flex flex-wrap justify-between"><div class="w-full p-2 lg:w-1/2"><a class="no-underline inline-flex items-center flex-1 dark:button-dark button" href="/blog/refactor/"><span>Refactor</span><svg class="w-6 h-6 ml-2 fill-current" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1413 896q0-27-18-45l-91-91-362-362q-18-18-45-18t-45 18l-91 91q-18 18-18 45t18 45l189 189h-502q-26 0-45 19t-19 45v128q0 26 19 45t45 19h502l-189 189q-19 19-19 45t19 45l91 91q18 18 45 18t45-18l362-362 91-91q18-18 18-45zm251 0q0 209-103 385.5t-279.5 279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5 385.5-103 385.5 103 279.5 279.5 103 385.5z"></path></svg></a></div></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/syncing-external-drive-with-network-nas/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-e49f8733b8aee9471acf.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-8dc5b1de7df84c955e11.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-f933526302f141ff5bf0.js"],"component---src-pages-404-js":["/component---src-pages-404-js-f9633554493dddb1c536.js"],"component---src-pages-index-js":["/component---src-pages-index-js-f71e923739c6685c4443.js"],"component---src-pages-projects-js":["/component---src-pages-projects-js-f429883c2208f057e721.js"]};/*]]>*/</script><script src="/webpack-runtime-5be88de751054daa4121.js" async=""></script><script src="/app-e49f8733b8aee9471acf.js" async=""></script><script src="/framework-1cbcc4f69858806ac5db.js" async=""></script><script src="/1777bc0a756dace6068a54d243c7071eee1627a0-c8bbedbe2105888d6327.js" async=""></script><script src="/component---src-templates-blog-post-js-f933526302f141ff5bf0.js" async=""></script><script src="/styles-48fa8a050a65bb8447bd.js" async=""></script></body></html>